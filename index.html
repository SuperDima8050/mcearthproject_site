<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revival Minecraft Earth</title>
    <link rel="icon" type="image/png" href="https://mcearthproject.qzz.io/favicon.ico">
    <link href="https://fonts.cdnfonts.com/css/minecraft-4" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    
    <meta name="description" content="An AR project to revive Minecraft Earth using the Vienna Docker">
    <meta name="keywords" content="minecraft earth, minecraft earth revival
minecraft earth server, minecraft earth
download, minecraft ar, mobile ar game, sandbox ar
minecraft earth android, minecraft earth
ios, geolocation game, docker
minecraft community, ar gaming.
survival game, building game, crafting game,ar, minecraft texture, block game">
    <meta name="author" content="Revival Minecraft Earth Team">
    <meta name="robots" content="index, follow">
    <meta http-equiv="Content-Security-Policy" content="default-src *; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; img-src * data: blob:; font-src * data:; connect-src *; frame-src *;">
    
    
    <meta property="og:title" content="Revival Minecraft Earth">
    <meta property="og:description" content="An AR project to revive Minecraft Earth using the Vienna Docker">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mcearthproject.qzz.io/">
    <meta property="og:image" content="https://mcearthproject.qzz.io/favicon.ico">
    
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Revival Minecraft Earth">
    <meta name="twitter:description" content="An AR project to revive Minecraft Earth using the Vienna Docker">

    
    <link rel="manifest" href="manifest.json">

    
    <meta name="theme-color" content="#6b8e23">

    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MCEarth">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icon-192.png">

    
    <meta name="msapplication-TileColor" content="#6b8e23">
    <meta name="msapplication-TileImage" content="icon-192.png">
    <meta name="msapplication-config" content="none">
    
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Minecraft', sans-serif);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            background: url('https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/backgrounds/splash_screen.png') center center / cover no-repeat fixed;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.45);
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .container {
            background: #f5eed9;
            border-radius: 4px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5), inset 0 0 0 4px #8b7355;
            max-width: 1000px;
            width: 100%;
            padding: 40px;
            padding-bottom: 50px;
            position: relative;
            z-index: 1;
            max-height: 90vh;
            overflow-y: auto;
            border: 4px solid #5a4a3a;
        }

        .container::-webkit-scrollbar {
            width: 14px;
        }

        .container::-webkit-scrollbar-track {
            background: #d4c5a0;
            border-radius: 0px;
            border: 2px solid #8b7355;
        }

        .container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            border-radius: 0px;
            border: 2px solid #4a5d23;
        }

        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 6px;
            background: #d4c5a0;
            border-radius: 2px;
            padding: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 2px 0 rgba(255,255,255,0.2);
            border: 3px solid #8b7355;
        }

        .lang-btn, .theme-btn {
            padding: 10px 20px;
            border: 2px solid #5a4a3a;
            background: #f5eed9;
            color: #3e2723;
            cursor: pointer;
            border-radius: 0px;
            font-weight: 700;
            transition: all 0.15s;
            font-size: 0.9rem;
            box-shadow: 0 4px 0 #3e2f1f;
            text-transform: uppercase;
            font-family: 'Minecraft', sans-serif;
            letter-spacing: 1px;
        }

        .lang-btn.active, .theme-btn.active {
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            box-shadow: 0 4px 0 #3d4f1c, inset 0 2px 0 rgba(255,255,255,0.15);
            border-color: #4a5d23;
        }

        .lang-btn:hover:not(.active), .theme-btn:hover:not(.active) {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #3e2f1f;
        }

        .lang-btn:active, .theme-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #3e2f1f;
        }

        body.dark-theme {
            background: url('https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/backgrounds/splash_screen.png') center center / cover no-repeat fixed;
        }
        body.dark-theme::before {
            background: rgba(0, 0, 0, 0.65);
        }

        body.dark-theme .container {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #1a1a1a;
            box-shadow: 0 8px 24px rgba(0,0,0,0.7), inset 0 0 0 4px #3a3a3a;
        }

        body.dark-theme h1 {
            color: #8bc34a;
            text-shadow: 0 4px 12px rgba(139, 195, 74, 0.6), 0 0 30px rgba(139, 195, 74, 0.3);
        }

        body.dark-theme .subtitle {
            color: #b0b0b0;
        }

        body.dark-theme .section-title {
            color: #81c784;
        }

        body.dark-theme .language-switcher {
            background: #1a1a1a;
            border-color: #3a3a3a;
        }

        body.dark-theme .lang-btn, body.dark-theme .theme-btn {
            color: #e0e0e0;
            background: #2a2a2a;
            border-color: #3a3a3a;
            box-shadow: 0 4px 0 #0a0a0a;
        }

        body.dark-theme .lang-btn.active, body.dark-theme .theme-btn.active {
            background: linear-gradient(180deg, #7cb342 0%, #558b2f 100%);
            box-shadow: 0 4px 0 #33691e, inset 0 2px 0 rgba(255,255,255,0.15);
            border-color: #33691e;
        }

        body.dark-theme .author-card,
        body.dark-theme .info-card,
        body.dark-theme .step,
        body.dark-theme .faq-item {
            background: #1a1a1a;
            color: #e0e0e0;
            border-color: #3a3a3a;
        }

        body.dark-theme .author-name {
            color: #e0e0e0;
        }

        body.dark-theme .author-role {
            color: #81c784;
        }

        body.dark-theme .link {
            color: #8bc34a;
        }

        body.dark-theme .link:hover {
            color: #aed581;
        }

        body.dark-theme .zerotier-code,
        body.dark-theme .code-text {
            background: #1a1a1a;
            color: #8bc34a;
            border-color: #3a3a3a;
        }

        body.dark-theme .copy-btn {
            background: linear-gradient(180deg, #7cb342 0%, #558b2f 100%);
            border-color: #33691e;
        }

        body.dark-theme .copy-btn:hover {
            background: linear-gradient(180deg, #8bc34a 0%, #689f38 100%);
        }

        body.dark-theme .info-note {
            background: #1a1a1a;
            border-left-color: #81c784;
        }

        body.dark-theme .info-note i {
            color: #81c784;
        }

        body.dark-theme .info-note span {
            color: #b0b0b0;
        }

        body.dark-theme .info-card p {
            color: #e0e0e0;
            font-family: 'Minecraft', sans-serif;
        }

        body.dark-theme .step-content h3 {
            color: #e0e0e0;
        }

        body.dark-theme .step-content p {
            color: #b0b0b0;
            font-family: 'Minecraft', sans-serif;
        }

        body.dark-theme .zerotier-code p:first-child {
            color: #b0b0b0;
        }

        body.dark-theme .faq-question {
            color: #8bc34a;
        }

        body.dark-theme .faq-answer {
            color: #b0b0b0;
            font-family: 'Minecraft', sans-serif;
        }

        h1 {
            text-align: center;
            color: #6b8e23;
            margin-bottom: 10px;
            font-size: 2.5rem;
            margin-top: 60px;
            font-family: 'Minecraft', sans-serif;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2);
            filter: drop-shadow(0 6px 12px rgba(107, 142, 35, 0.4));
        }

        @keyframes glow {
            from { filter: drop-shadow(3px 3px 0px #000) drop-shadow(0 0 8px rgba(100,200,255,0.2)); }
            to   { filter: drop-shadow(3px 3px 0px #000) drop-shadow(0 0 18px rgba(100,200,255,0.5)); }
        }

        .subtitle {
            text-align: center;
            color: #5a4a3a;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-family: 'Minecraft', sans-serif;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .discord-banner {
            text-align: center;
            margin-bottom: 40px;
        }

        .discord-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 30px;
            background: #5865F2;
            color: white;
            border: 3px solid #4752c4;
            border-radius: 2px;
            font-size: 1.05rem;
            font-weight: 900;
            font-family: 'Minecraft', sans-serif;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            box-shadow: 0 5px 0 #2e3799, 0 0 18px rgba(88,101,242,0.35);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 2px 0 rgba(0,0,0,0.4);
        }

        .discord-btn:hover {
            background: #4752c4;
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #3d47a0;
        }

        .discord-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #3d47a0;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #4a5d23;
            font-weight: 800;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 4px solid #6b8e23;
            font-family: 'Minecraft', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .info-card {
            background: #fffbf0;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 3px solid #8b7355;
            box-shadow: 0 6px 0 #5a4a3a, 0 8px 20px rgba(0,0,0,0.2);
        }

        .info-card p {
            line-height: 1.8;
            color: #4a4a4a;
            font-family: 'Minecraft', sans-serif;
            font-weight: 400;
            font-size: 0.82rem;
        }

        .authors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .author-card {
            background: #fffbf0;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            transition: all 0.15s;
            border: 3px solid #8b7355;
            box-shadow: 0 6px 0 #5a4a3a, 0 8px 20px rgba(0,0,0,0.2);
        }

        .author-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 0 #5a4a3a, 0 12px 25px rgba(0,0,0,0.3);
        }

        .author-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #3e2723;
            margin-bottom: 5px;
            font-family: 'Minecraft', sans-serif;
        }

        .author-role {
            font-size: 0.9rem;
            color: #6b8e23;
            margin-bottom: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .author-links {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .link {
            color: #6b8e23;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
        }

        .link:hover {
            color: #556b2f;
            transform: translateX(3px);
        }

        .steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .step {
            display: flex;
            align-items: start;
            gap: 15px;
            background: #fffbf0;
            padding: 20px;
            border-radius: 4px;
            border: 3px solid #8b7355;
            box-shadow: 0 5px 0 #5a4a3a, 0 7px 15px rgba(0,0,0,0.15);
        }

        .step-number {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.4rem;
            flex-shrink: 0;
            border: 2px solid #4a5d23;
            box-shadow: 0 4px 0 #3d4f1c;
            font-family: 'Minecraft', sans-serif;
        }

        .step-content h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #3e2723;
            font-weight: 700;
        }

        .step-content p {
            color: #5a4a3a;
            line-height: 1.6;
            font-family: 'Minecraft', sans-serif;
            font-weight: 400;
            font-size: 0.82rem;
        }

        .zerotier-code {
            background: #f0ede0;
            padding: 16px;
            border-radius: 4px;
            margin: 16px auto;
            text-align: center;
            border: 2px solid #8b7355;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 380px;
        }

        .zerotier-code p:first-child {
            color: #5a4a3a;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .code-container {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .code-text {
            background: #fffbf0;
            padding: 12px 20px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: #3e2723;
            border: 3px solid #8b7355;
            letter-spacing: 2px;
        }

        .copy-btn {
            padding: 12px 20px;
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border: 2px solid #4a5d23;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 0 #3d4f1c;
            text-transform: uppercase;
            font-family: 'Minecraft', sans-serif;
            letter-spacing: 1px;
        }

        .copy-btn:hover {
            background: linear-gradient(180deg, #7cb342 0%, #689f38 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #3d4f1c;
        }

        .copy-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #3d4f1c;
        }

        .faq-item {
            background: #fffbf0;
            padding: 15px 20px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 3px solid #8b7355;
            box-shadow: 0 4px 0 #5a4a3a, 0 6px 15px rgba(0,0,0,0.15);
        }

        .faq-question {
            font-weight: 700;
            color: #4a5d23;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.05rem;
        }

        .faq-answer {
            color: #5a4a3a;
            line-height: 1.6;
            font-family: 'Minecraft', sans-serif;
            font-weight: 400;
            font-size: 0.82rem;
        }

        .info-note {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #fffbf0;
            border-left: 5px solid #f39c12;
            border-radius: 2px;
            margin-top: 20px;
            border: 3px solid #e67e22;
            box-shadow: 0 4px 8px rgba(243, 156, 18, 0.2);
        }

        .info-note i {
            color: #f39c12;
            font-size: 1.3rem;
        }

        .info-note span {
            color: #8b6914;
            font-weight: 700;
            font-family: 'Minecraft', sans-serif;
        }


        .nav-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 4px solid #8b7355;
            padding-bottom: 0px;
            justify-content: stretch;
            width: 100%;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 8px;
            border: 3px solid #8b7355;
            border-bottom: none;
            border-right: none;
            background: #d4c5a0;
            color: #3e2723;
            cursor: pointer;
            border-radius: 0;
            font-weight: 700;
            font-size: 0.78rem;
            transition: all 0.15s;
            position: relative;
            box-shadow: inset 0 -3px 0 rgba(0,0,0,0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Minecraft', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            text-align: center;
            line-height: 1.2;
        }

        .nav-tab:first-child {
            border-radius: 4px 0 0 0;
            border-left: 3px solid #8b7355;
        }

        .nav-tab:last-child {
            border-radius: 0 4px 0 0;
            border-right: 3px solid #8b7355;
        }

        .nav-icon {
            font-size: 1.2rem;
            line-height: 1;
        }

        .nav-icon img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            image-rendering: pixelated;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
            transition: transform 0.15s;
        }

        .nav-tab.active .nav-icon img {
            filter: drop-shadow(0 2px 6px rgba(255,255,255,0.4)) brightness(1.1);
        }

        .nav-tab:hover .nav-icon img {
            transform: scale(1.15) translateY(-2px);
        }

        .nav-tab:hover {
            background: #e0d5b0;
            transform: translateY(-3px);
        }

        .nav-tab.active {
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.15), 0 5px 10px rgba(0,0,0,0.2);
            border-color: #4a5d23;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .news-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .news-item {
            position: relative;
            border-radius: 4px;
            padding: 0;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            transition: all 0.2s;
            overflow: hidden;
            min-height: 300px;
            border: 4px solid #5a4a3a;
        }

        .news-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(8px);
            transform: scale(1.1);
            z-index: 1;
        }

        .news-item.has-image::before {
            background-image: var(--news-image);
        }

        .news-item:not(.has-image) {
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
        }

        .news-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .news-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }

        .news-item:hover::before {
            filter: blur(6px);
        }

        .news-content-wrapper {
            position: relative;
            z-index: 3;
            padding: 30px;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 300px;
            justify-content: center;
        }

        .news-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .news-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
            margin: 0;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            font-family: 'Minecraft', sans-serif;
            letter-spacing: 1px;
        }

        .news-date {
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
            font-weight: 600;
        }

        .news-date i {
            color: rgba(255, 255, 255, 0.95);
        }

        .news-content {
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.8;
            font-size: 1.05rem;
            white-space: pre-wrap;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
        }

        .news-author {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
            margin-top: 5px;
            font-weight: 600;
        }

        .news-author i {
            color: rgba(255, 255, 255, 0.8);
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #1da1f2;
            border-radius: 50%;
            margin-left: 4px;
            flex-shrink: 0;
            vertical-align: middle;
        }

        .verified-badge::before { display: none; }

        .verified-badge i {
            color: white;
            font-size: 10px;
        }

        .news-footer {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .like-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .like-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.15s;
            color: white;
            font-size: 0.95rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            font-weight: 600;
        }

        .like-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.4);
        }

        .like-btn.active {
            background: rgba(76, 175, 80, 0.4);
            border-color: #4caf50;
        }

        .like-btn.active i {
            color: #4caf50;
        }

        .dislike-btn.active {
            background: rgba(244, 67, 54, 0.4);
            border-color: #f44336;
        }

        .dislike-btn.active i {
            color: #f44336;
        }

        .like-btn i {
            font-size: 1rem;
        }

        .like-count {
            font-weight: 700;
        }

        .share-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.15s;
            color: white;
            font-size: 0.95rem;
            backdrop-filter: blur(10px);
            margin-left: auto;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            font-weight: 600;
        }

        .share-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.4);
        }

        .share-btn i {
            font-size: 1rem;
        }

        .dots-menu-wrap {
            position: relative;
        }
        .dots-menu-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 2px;
            cursor: pointer;
            color: white;
            font-size: 1.1rem;
            transition: all 0.15s;
            backdrop-filter: blur(10px);
        }
        .dots-menu-btn:hover { background: rgba(255,255,255,0.35); }
        .dots-dropdown {
            display: none;
            position: absolute;
            bottom: calc(100% + 6px);
            right: 0;
            background: #f5eed9;
            border: 3px solid #8b7355;
            border-radius: 4px;
            box-shadow: 0 6px 0 #5a4a3a, 0 8px 20px rgba(0,0,0,0.3);
            min-width: 160px;
            z-index: 200;
            overflow: hidden;
        }
        .dots-dropdown.open { display: block; }
        .dots-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 14px;
            font-family: 'Minecraft', sans-serif;
            font-size: 0.83rem;
            font-weight: 700;
            color: #3e2723;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.1s;
        }
        .dots-dropdown-item:hover { background: #e8dfc0; }
        .dots-dropdown-item.danger { color: #c62828; }
        .dots-dropdown-item.danger:hover { background: #fde0e0; }
        body.dark-theme .dots-dropdown { background: #2a2a2a; border-color: #3a3a3a; box-shadow: 0 6px 0 #0a0a0a; }
        body.dark-theme .dots-dropdown-item { color: #e0e0e0; }
        body.dark-theme .dots-dropdown-item:hover { background: #3a3a3a; }
        body.dark-theme .dots-dropdown-item.danger { color: #ef9a9a; }

        .bp-dots-wrap {
            position: relative;
        }
        .bp-dots-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: #f5eed9;
            border: 2px solid #8b7355;
            border-radius: 2px;
            cursor: pointer;
            color: #5a4a3a;
            font-size: 1rem;
            transition: all 0.15s;
            box-shadow: 0 3px 0 #5a4a3a;
        }
        .bp-dots-btn:hover { background: #e8dfc0; transform: translateY(-1px); }
        .bp-dots-dropdown {
            display: none;
            position: absolute;
            bottom: calc(100% + 6px);
            right: 0;
            background: #f5eed9;
            border: 3px solid #8b7355;
            border-radius: 4px;
            box-shadow: 0 6px 0 #5a4a3a, 0 8px 20px rgba(0,0,0,0.3);
            min-width: 150px;
            z-index: 200;
            overflow: hidden;
        }
        .bp-dots-dropdown.open { display: block; }
        .bp-dots-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            font-family: 'Minecraft', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            color: #3e2723;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.1s;
        }
        .bp-dots-item:hover { background: #e8dfc0; }
        .bp-dots-item.danger { color: #c62828; }
        .bp-dots-item.danger:hover { background: #fde0e0; }
        body.dark-theme .bp-dots-btn { background: #2a2a2a; border-color: #3a3a3a; color: #e0e0e0; box-shadow: 0 3px 0 #0a0a0a; }
        body.dark-theme .bp-dots-dropdown { background: #2a2a2a; border-color: #3a3a3a; }
        body.dark-theme .bp-dots-item { color: #e0e0e0; }
        body.dark-theme .bp-dots-item:hover { background: #3a3a3a; }
        body.dark-theme .bp-dots-item.danger { color: #ef9a9a; }


            text-align: center;
            padding: 40px;
            color: #5a4a3a;

        .news-loading i {
            font-size: 2rem;
            color: #6b8e23;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .news-empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .news-empty i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }

        .news-empty p {
            font-size: 1.1rem;
        }

        body.dark-theme #bp-daily-limit {
            background: #1a1a1a;
            border-color: #3a3a3a;
        }
        body.dark-theme #bp-limit-title { color: #8bc34a; }
        body.dark-theme #bp-limit-text { color: #b0b0b0; }
        body.dark-theme #bp-limit-reset { color: #666; }

        body.dark-theme .nav-tabs {
            border-bottom-color: #3a3a3a;
        }

        body.dark-theme .nav-tab {
            color: #e0e0e0;
            background: #1a1a1a;
            border-color: #3a3a3a;
        }

        body.dark-theme .nav-tab:hover {
            color: #e0e0e0;
            background: #2a2a2a;
        }

        body.dark-theme .nav-tab.active {
            color: white;
            background: linear-gradient(180deg, #7cb342 0%, #558b2f 100%);
            border-color: #33691e;
        }

        .news-delete-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(180deg, #c62828 0%, #8b0000 100%);
            color: #fff;
            border: 2px solid #7f0000;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
            font-family: 'Minecraft', sans-serif;
            box-shadow: 0 4px 0 #5a0000;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .news-delete-btn:hover {
            background: linear-gradient(180deg, #e53935 0%, #b71c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #5a0000;
        }
        .news-delete-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #5a0000;
        }
        body.dark-theme .news-delete-btn {
            background: linear-gradient(180deg, #b71c1c 0%, #7f0000 100%);
            border-color: #5a0000;
            box-shadow: 0 4px 0 #3a0000;
        }

        body.dark-theme .news-item:not(.has-image) {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
        }

        body.dark-theme .news-item::after {
            background: rgba(0, 0, 0, 0.6);
        }

        body.dark-theme .news-loading,
        body.dark-theme .news-empty {
            color: #b0b0b0;
        }

        body.dark-theme .container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-color: #3a3a3a;
        }

        body.dark-theme .container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #7cb342 0%, #558b2f 100%);
            border-color: #33691e;
        }

        .bp-upload-card {
            background: #fffbf0;
            padding: 28px;
            border-radius: 4px;
            border: 3px solid #8b7355;
            box-shadow: 0 6px 0 #5a4a3a, 0 8px 20px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .bp-form-row {
            margin-bottom: 16px;
        }

        .bp-form-row label {
            display: block;
            font-weight: 700;
            color: #3e2723;
            margin-bottom: 6px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Minecraft', sans-serif;
        }

        .bp-form-row input[type="text"] {
            width: 100%;
            padding: 12px 14px;
            border: 3px solid #8b7355;
            border-radius: 2px;
            background: #f5eed9;
            color: #3e2723;
            font-family: 'Minecraft', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            transition: border-color 0.15s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .bp-form-row input[type="text"]:focus {
            border-color: #6b8e23;
        }

        .bp-form-row input[type="password"],
        .bp-form-row input[type="text"].pass-text {
            width: 100%;
            padding: 12px 44px 12px 14px;
            border: 3px solid #8b7355;
            border-radius: 2px;
            background: #f5eed9;
            color: #3e2723;
            font-family: 'Minecraft', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            transition: border-color 0.15s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .bp-form-row input[type="password"]:focus,
        .bp-form-row input[type="text"].pass-text:focus { border-color: #6b8e23; }

        body.dark-theme .bp-form-row input[type="password"],
        body.dark-theme .bp-form-row input[type="text"].pass-text {
            background: #3a3a3a;
            color: #e0e0e0;
            border-color: #555;
        }

        .pass-wrap {
            position: relative;
            width: 100%;
        }

        .pass-wrap input {
            width: 100% !important;
        }

        .pass-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #8b7355;
            font-size: 1rem;
            padding: 4px;
            transition: color 0.15s;
            z-index: 2;
        }

        .pass-toggle:hover { color: #6b8e23; }
        body.dark-theme .pass-toggle { color: #888; }
        body.dark-theme .pass-toggle:hover { color: #8bc34a; }

        .bp-auth-box {
            background: #eee8d0;
            border: 3px solid #8b7355;
            border-radius: 2px;
            padding: 16px;
            margin-bottom: 16px;
        }

        body.dark-theme .bp-auth-box {
            background: #333;
            border-color: #555;
        }

        .bp-auth-title {
            font-weight: 800;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #3e2723;
            margin-bottom: 12px;
            font-family: 'Minecraft', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-theme .bp-auth-title { color: #e0e0e0; }

        .bp-auth-status {
            font-size: 0.82rem;
            font-weight: 600;
            font-family: 'Minecraft', sans-serif;
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 2px;
            display: none;
        }

        .bp-auth-status.ok { background: #c8e6c9; color: #2e7d32; display: block; }
        .bp-auth-status.err { background: #ffcdd2; color: #c62828; display: block; }
        .bp-auth-status.info { background: #fff9c4; color: #f57f17; display: block; }

        .bp-auth-toggle {
            font-size: 0.8rem;
            color: #6b8e23;
            cursor: pointer;
            text-decoration: underline;
            font-family: 'Minecraft', sans-serif;
            font-weight: 600;
            background: none;
            border: none;
            padding: 0;
            margin-top: 6px;
        }

        .bp-logged-in {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            padding: 10px 14px;
            background: #c8e6c9;
            border: 2px solid #4caf50;
            border-radius: 2px;
            margin-bottom: 16px;
        }

        body.dark-theme .bp-logged-in { background: #1b5e20; border-color: #388e3c; }

        .bp-logged-in-name {
            font-weight: 800;
            font-family: 'Minecraft', sans-serif;
            color: #1b5e20;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        body.dark-theme .bp-logged-in-name { color: #a5d6a7; }

        .bp-logout-btn {
            font-size: 0.78rem;
            background: none;
            border: 2px solid #388e3c;
            color: #2e7d32;
            cursor: pointer;
            padding: 4px 10px;
            font-weight: 700;
            font-family: 'Minecraft', sans-serif;
            border-radius: 2px;
        }

        body.dark-theme .bp-logout-btn { color: #a5d6a7; border-color: #4caf50; }

        .bp-verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            font-size: 0.65rem;
            font-weight: 800;
            font-family: 'Minecraft', sans-serif;
            padding: 2px 6px;
            border-radius: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 4px;
            vertical-align: middle;
        }

        .bp-verified-badge i { font-size: 0.65rem; }

        .ref-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 3px;
            font-size: 11px;
            font-weight: 900;
            flex-shrink: 0;
            vertical-align: middle;
            cursor: help;
            border: 2px solid rgba(0,0,0,0.15);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .ref-badge-bronze { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff3e0; }
        .ref-badge-silver { background: linear-gradient(135deg, #c0c0c0, #888); color: #fff; }
        .ref-badge-gold   { background: linear-gradient(135deg, #ffd700, #ffa500); color: #5a3e00; }
        .ref-badge-diamond{ background: linear-gradient(135deg, #a8edff, #5bc8e8); color: #003d5c; }
        .ref-mob-badge {
            display: inline-block;
            vertical-align: middle;
            margin-left: 4px;
            flex-shrink: 0;
            cursor: help;
            image-rendering: pixelated;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.35));
        }
        .ref-profile-block {
            margin-top: 10px;
            padding: 10px 12px;
            background: rgba(107,142,35,0.1);
            border: 2px solid rgba(107,142,35,0.3);
            border-radius: 2px;
            font-family: 'Minecraft', sans-serif;
        }
        .ref-profile-title {
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #4a5d23;
            margin-bottom: 6px;
        }
        .ref-link-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ref-link-input {
            flex: 1;
            font-size: 0.7rem;
            font-family: 'Minecraft', sans-serif;
            font-weight: 700;
            padding: 5px 8px;
            border: 2px solid #8b7355;
            border-radius: 2px;
            background: #fffbf0;
            color: #3e2723;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .ref-copy-btn {
            flex-shrink: 0;
            padding: 5px 10px;
            background: linear-gradient(180deg, #6b8e23, #556b2f);
            color: #fff;
            border: 2px solid #4a5d23;
            border-radius: 2px;
            font-size: 0.72rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Minecraft', sans-serif;
            box-shadow: 0 3px 0 #3d4f1c;
        }
        .ref-stats {
            margin-top: 6px;
            font-size: 0.72rem;
            font-weight: 700;
            color: #5a4a3a;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.dark-theme .ref-profile-block { background: rgba(124,179,66,0.08); border-color: rgba(124,179,66,0.25); }
        body.dark-theme .ref-profile-title { color: #81c784; }
        body.dark-theme .ref-link-input { background: #1a1a1a; border-color: #3a3a3a; color: #e0e0e0; }
        body.dark-theme .ref-stats { color: #b0b0b0; }

        /* === XP BAR === */
        .ref-xp-wrap {
            margin-top: 10px;
            background: rgba(0,0,0,0.82);
            border: 3px solid #4a5d23;
            border-radius: 2px;
            padding: 10px 10px 8px;
            box-shadow: 0 4px 0 #2a3a10;
        }
        body.dark-theme .ref-xp-wrap { border-color: #3a5a1a; }
        .ref-xp-label {
            font-family: 'Minecraft', sans-serif;
            font-size: 0.6rem;
            font-weight: 700;
            color: #80ff00;
            text-shadow: 0 0 6px rgba(128,255,0,0.8), 1px 1px 0 #000;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            margin-bottom: 8px;
        }
        .ref-xp-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ref-xp-mob-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            flex-shrink: 0;
            width: 42px;
        }
        .ref-xp-mob-box img {
            width: 36px;
            height: 36px;
            image-rendering: pixelated;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.8));
        }
        .ref-xp-mob-box .xp-mob-placeholder {
            width: 36px;
            height: 36px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            filter: grayscale(1);
        }
        .ref-xp-mob-name {
            font-family: 'Minecraft', sans-serif;
            font-size: 0.52rem;
            font-weight: 700;
            color: #666;
            text-align: center;
            line-height: 1.1;
            max-width: 42px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .ref-xp-mob-name.earned { color: #80ff00; text-shadow: 0 0 4px rgba(128,255,0,0.5); }
        .ref-xp-mob-name.next { color: #aaa; }
        .ref-xp-bar-section {
            flex: 1;
            min-width: 0;
        }
        .ref-xp-bar-bg {
            width: 100%;
            height: 16px;
            background: #1c1c1c;
            border: 2px solid #000;
            border-radius: 1px;
            overflow: hidden;
            box-shadow: inset 0 2px 0 rgba(0,0,0,0.5), 0 0 0 1px #444;
            position: relative;
        }
        .ref-xp-bar-fill {
            height: 100%;
            background: linear-gradient(180deg,
                #a0ff20 0%,
                #70e000 40%,
                #50c000 50%,
                #38a000 51%,
                #60d010 100%
            );
            box-shadow: 0 0 10px rgba(112,224,0,0.7), 0 0 20px rgba(80,192,0,0.3), inset 0 1px 0 rgba(255,255,255,0.25);
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-width: 2px;
        }
        /* Minecraft XP bar scanlines */
        .ref-xp-bar-fill::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent 0px,
                transparent 3px,
                rgba(0,0,0,0.08) 3px,
                rgba(0,0,0,0.08) 4px
            );
        }
        /* Shine */
        .ref-xp-bar-fill::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 40%;
            background: rgba(255,255,255,0.18);
        }
        .ref-xp-bar-count {
            font-family: 'Minecraft', sans-serif;
            font-size: 0.6rem;
            font-weight: 700;
            color: #80ff00;
            text-shadow: 1px 1px 0 #000, 0 0 6px rgba(128,255,0,0.6);
            text-align: center;
            margin-top: 4px;
        }
        .ref-xp-bar-count.maxed {
            color: #ffd700;
            text-shadow: 0 0 8px rgba(255,215,0,0.7), 1px 1px 0 #000;
            animation: xpGoldGlow 2s ease-in-out infinite;
        }
        @keyframes xpGoldGlow {
            0%, 100% { text-shadow: 0 0 6px rgba(255,215,0,0.4), 1px 1px 0 #000; }
            50% { text-shadow: 0 0 14px rgba(255,215,0,0.9), 0 0 28px rgba(255,215,0,0.4), 1px 1px 0 #000; }
        }
        /* XP bar gain animation */
        @keyframes xpPulse {
            0% { box-shadow: 0 0 10px rgba(112,224,0,0.7), 0 0 20px rgba(80,192,0,0.3); }
            50% { box-shadow: 0 0 20px rgba(160,255,32,1), 0 0 40px rgba(128,255,0,0.6); }
            100% { box-shadow: 0 0 10px rgba(112,224,0,0.7), 0 0 20px rgba(80,192,0,0.3); }
        }
        .ref-xp-bar-fill.animate { animation: xpPulse 0.6s ease-out; }
        /* Arrow between mobs */
        .ref-xp-arrow {
            font-family: 'Minecraft', sans-serif;
            font-size: 0.55rem;
            color: #444;
            text-align: center;
            margin-top: 2px;
        }
        /* All tiers row */
        .ref-xp-tiers {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #222;
            gap: 4px;
        }
        .ref-xp-tier-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            flex: 1;
            min-width: 0;
            position: relative;
        }
        .ref-xp-tier-item img {
            width: 28px;
            height: 28px;
            image-rendering: pixelated;
            transition: all 0.3s;
        }
        .ref-xp-tier-item.locked img { filter: grayscale(1) brightness(0.4); }
        .ref-xp-tier-item.earned img { filter: drop-shadow(0 0 4px rgba(128,255,0,0.7)); }
        .ref-xp-tier-item.earned::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -2px;
            background: #50c000;
            color: white;
            font-size: 8px;
            font-weight: 900;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #000;
            line-height: 12px;
            text-align: center;
        }
        .ref-xp-tier-thresh {
            font-family: 'Minecraft', sans-serif;
            font-size: 0.5rem;
            font-weight: 700;
            color: #555;
            text-align: center;
        }
        .ref-xp-tier-thresh.earned { color: #80ff00; text-shadow: 0 0 4px rgba(128,255,0,0.5); }
        .ref-xp-tier-connector {
            height: 2px;
            background: #222;
            flex: 0.5;
            margin-bottom: 16px;
        }
        .ref-xp-tier-connector.filled { background: #50c000; box-shadow: 0 0 4px rgba(80,192,0,0.5); }

        .bp-file-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border: 3px dashed #8b7355;
            border-radius: 2px;
            background: #f5eed9;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'Minecraft', sans-serif;
            font-weight: 600;
            color: #5a4a3a;
        }

        .bp-file-label:hover {
            border-color: #6b8e23;
            background: #eee8d0;
        }

        .bp-file-label i {
            font-size: 1.3rem;
            color: #6b8e23;
        }

        .bp-file-label input[type="file"] {
            display: none;
        }

        .bp-file-label.drag-over {
            border-color: #6b8e23;
            background: #e4edcc;
            transform: scale(1.01);
        }

        body.dark-theme .bp-file-label.drag-over {
            background: #2a3a1a;
            border-color: #7cb342;
        }

        .bp-formats {
            margin-left: auto;
            font-size: 0.72rem;
            color: #8b7355;
            font-weight: 600;
            white-space: nowrap;
        }

        body.dark-theme .bp-formats {
            color: #888;
        }

        .bp-file-name {
            font-size: 0.85rem;
            color: #6b8e23;
            margin-top: 6px;
            font-weight: 600;
        }

        .bp-submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border: 2px solid #4a5d23;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 0 #3d4f1c;
            text-transform: uppercase;
            font-family: 'Minecraft', sans-serif;
            letter-spacing: 1px;
            margin-top: 20px;
        }

        .bp-submit-btn:hover:not(:disabled) {
            background: linear-gradient(180deg, #7cb342 0%, #689f38 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #3d4f1c;
        }

        .bp-submit-btn:active:not(:disabled) {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #3d4f1c;
        }

        .bp-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .bp-status {
            margin-top: 14px;
            padding: 12px 16px;
            border-radius: 2px;
            font-weight: 700;
            text-align: center;
            display: none;
            font-family: 'Minecraft', sans-serif;
        }

        .bp-status.success {
            background: rgba(76, 175, 80, 0.15);
            border: 2px solid #4caf50;
            color: #2e7d32;
            display: block;
        }

        .bp-status.error {
            background: rgba(244, 67, 54, 0.15);
            border: 2px solid #f44336;
            color: #c62828;
            display: block;
        }

        .bp-gallery-title {
            font-size: 1.2rem;
            color: #4a5d23;
            font-weight: 800;
            margin-bottom: 16px;
            font-family: 'Minecraft', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .bp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
            padding-bottom: 8px;
        }

        .bp-card {
            background: #fffbf0;
            border-radius: 4px;
            border: 3px solid #8b7355;
            box-shadow: 0 5px 0 #5a4a3a, 0 7px 15px rgba(0,0,0,0.15);
            overflow: visible;
            display: flex;
            flex-direction: column;
            transition: all 0.15s;
        }

        .bp-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 9px 0 #5a4a3a, 0 11px 20px rgba(0,0,0,0.25);
        }

        .bp-card-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
            background: #d4c5a0;
            border-radius: 1px 1px 0 0;
        }

        .bp-card-img-placeholder {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #d4c5a0, #c4b590);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            border-radius: 1px 1px 0 0;
        }

        .bp-card-body {
            padding: 14px 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .bp-card-name {
            font-weight: 800;
            color: #3e2723;
            font-size: 1rem;
            margin-bottom: 6px;
            font-family: 'Minecraft', sans-serif;
            letter-spacing: 0.5px;
            word-break: break-word;
        }

        .bp-card-meta {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-bottom: 10px;
        }

        .bp-card-author,
        .bp-card-date {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.78rem;
            color: #7a6340;
            font-weight: 600;
        }

        .bp-card-author i,
        .bp-card-date i {
            color: #8b7355;
            width: 12px;
            text-align: center;
        }

        .bp-card-author .verified-badge i,
        .verified-badge i {
            color: #fff !important;
            width: auto;
            font-size: 10px;
        }
        body.dark-theme .bp-card-author .verified-badge i,
        body.dark-theme .verified-badge i {
            color: #fff !important;
        }

        .bp-verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: #1da1f2;
            border-radius: 50%;
            margin-left: 4px;
            cursor: help;
        }

        .bp-verified-badge i {
            color: white;
            font-size: 9px;
        }

        body.dark-theme .bp-card-author,
        body.dark-theme .bp-card-date {
            color: #999;
        }

        body.dark-theme .bp-card-author i,
        body.dark-theme .bp-card-date i {
            color: #666;
        }

        .bp-card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%;
        }

        .bp-download-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            padding: 10px 8px;
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border: 2px solid #4a5d23;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.78rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 #3d4f1c;
            text-transform: uppercase;
            font-family: 'Minecraft', sans-serif;
            letter-spacing: 0;
            text-decoration: none;
            justify-content: center;
            min-width: 0;
            white-space: nowrap;
        }
        .bp-download-btn span {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bp-download-btn:hover {
            background: linear-gradient(180deg, #7cb342 0%, #689f38 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #3d4f1c;
        }

        .bp-like-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 12px;
            background: #f5eed9;
            color: #5a4a3a;
            border: 2px solid #8b7355;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 #5a4a3a;
            font-family: 'Minecraft', sans-serif;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .bp-like-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #5a4a3a;
            background: #ffe0e0;
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .bp-like-btn.liked {
            background: linear-gradient(180deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-color: #1a6a9a;
            box-shadow: 0 4px 0 #1a5276;
        }

        @media (hover: hover) {
            .bp-like-btn.liked:hover {
                background: linear-gradient(180deg, #4aa8e8 0%, #3498db 100%);
            }
        }

        body.dark-theme .bp-like-btn {
            background: #2a2a2a;
            color: #b0b0b0;
            border-color: #3a3a3a;
            box-shadow: 0 4px 0 #0a0a0a;
        }

        body.dark-theme .bp-like-btn.liked {
            background: linear-gradient(180deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-color: #1a6a9a;
        }

        .bp-dislike-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 12px;
            background: #f5eed9;
            color: #5a4a3a;
            border: 2px solid #8b7355;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 #5a4a3a;
            font-family: 'Minecraft', sans-serif;
            flex-shrink: 0;
        }

        .bp-dislike-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #5a4a3a;
            background: #e0e8ff;
            border-color: #3498db;
            color: #3498db;
        }

        .bp-dislike-btn.disliked {
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border-color: #922b21;
            box-shadow: 0 4px 0 #7b241c;
        }

        body.dark-theme .bp-dislike-btn {
            background: #2a2a2a;
            color: #b0b0b0;
            border-color: #3a3a3a;
            box-shadow: 0 4px 0 #0a0a0a;
        }

        body.dark-theme .bp-dislike-btn.disliked {
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border-color: #922b21;
        }

        .bp-share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 12px;
            background: #f5eed9;
            color: #5a4a3a;
            border: 2px solid #8b7355;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 #5a4a3a;
            flex-shrink: 0;
        }

        .bp-share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #5a4a3a;
            background: #e8f5e9;
            border-color: #27ae60;
            color: #27ae60;
        }

        body.dark-theme .bp-share-btn {
            background: #2a2a2a;
            color: #b0b0b0;
            border-color: #3a3a3a;
            box-shadow: 0 4px 0 #0a0a0a;
        }

        .bp-loading, .bp-empty {
            text-align: center;
            padding: 50px 20px;
            color: #5a4a3a;
        }

        .bp-loading i, .bp-empty i {
            font-size: 2.5rem;
            color: #6b8e23;
            margin-bottom: 12px;
            display: block;
        }

        .bp-loading i {
            animation: spin 1s linear infinite;
        }

        .bp-empty p {
            font-size: 1.05rem;
            font-weight: 600;
        }

        body.dark-theme .bp-upload-card,
        body.dark-theme .bp-card {
            background: #1a1a1a;
            border-color: #3a3a3a;
        }

        body.dark-theme .bp-form-row label {
            color: #e0e0e0;
        }

        body.dark-theme .bp-form-row input[type="text"] {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #3a3a3a;
        }

        body.dark-theme .bp-file-label {
            background: #2a2a2a;
            border-color: #3a3a3a;
            color: #b0b0b0;
        }

        body.dark-theme .bp-file-label:hover {
            border-color: #7cb342;
            background: #333;
        }

        body.dark-theme .bp-card-name {
            color: #e0e0e0;
        }

        body.dark-theme .bp-card-img-placeholder {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
        }

        body.dark-theme .bp-loading,
        body.dark-theme .bp-empty {
            color: #b0b0b0;
        }

        body.dark-theme .bp-gallery-title {
            color: #81c784;
        }

        body.dark-theme .bp-card {
            box-shadow: 0 5px 0 #0a0a0a, 0 7px 15px rgba(0,0,0,0.3);
        }

        .bp-filters {
            display: flex;
            gap: 10px;
            margin: 16px 0 14px;
            flex-wrap: wrap;
            align-items: center;
        }

        .bp-search-wrap {
            flex: 1;
            min-width: 160px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .bp-search-wrap i {
            position: absolute;
            left: 12px;
            color: #8b7355;
            font-size: 0.9rem;
            pointer-events: none;
        }

        .bp-search-wrap input {
            width: 100%;
            padding: 10px 12px 10px 34px;
            border: 3px solid #8b7355;
            border-radius: 2px;
            background: #fffbf0;
            color: #3e2723;
            font-family: 'Minecraft', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            outline: none;
            box-shadow: 0 4px 0 #5a4a3a, inset 0 2px 4px rgba(0,0,0,.08);
            transition: border-color .15s;
        }

        .bp-search-wrap input::placeholder { color: #a0927c; font-weight: 500; }
        .bp-search-wrap input:focus { border-color: #6b8e23; }

        .bp-sort-select {
            padding: 10px 14px;
            border: 3px solid #8b7355;
            border-radius: 2px;
            background: #fffbf0;
            color: #3e2723;
            font-family: 'Minecraft', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 0 #5a4a3a;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238b7355'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
            transition: border-color .15s;
        }
        .bp-sort-select:focus { border-color: #6b8e23; }

        .bp-filter-mine-btn {
            padding: 10px 16px;
            border: 3px solid #8b7355;
            border-radius: 2px;
            background: #fffbf0;
            color: #5a4a3a;
            font-family: 'Minecraft', sans-serif;
            font-size: 0.82rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 0 #5a4a3a;
            transition: all .15s;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .bp-filter-mine-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #5a4a3a; }
        .bp-filter-mine-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #5a4a3a; }
        .bp-filter-mine-btn.active {
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border-color: #4a5d23;
            box-shadow: 0 4px 0 #3d4f1c;
        }

        .bp-results-count {
            font-size: 0.78rem;
            font-weight: 700;
            color: #8b7355;
            padding: 0 2px;
            font-family: 'Minecraft', sans-serif;
            white-space: nowrap;
        }

        body.dark-theme .bp-search-wrap input,
        body.dark-theme .bp-sort-select,
        body.dark-theme .bp-filter-mine-btn {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #3a3a3a;
            box-shadow: 0 4px 0 #0a0a0a;
        }
        body.dark-theme .bp-search-wrap i { color: #666; }
        body.dark-theme .bp-search-wrap input::placeholder { color: #666; }
        body.dark-theme .bp-search-wrap input:focus,
        body.dark-theme .bp-sort-select:focus { border-color: #7cb342; }
        body.dark-theme .bp-sort-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23666'/%3E%3C/svg%3E");
        }
        body.dark-theme .bp-filter-mine-btn { color: #b0b0b0; }
        body.dark-theme .bp-filter-mine-btn.active {
            background: linear-gradient(180deg, #7cb342 0%, #558b2f 100%);
            color: white;
            border-color: #33691e;
            box-shadow: 0 4px 0 #1b5e20;
        }
        body.dark-theme .bp-results-count { color: #666; }

        .bp-delete-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 9px 14px;
            background: linear-gradient(180deg, #c0392b 0%, #922b21 100%);
            color: white;
            border: 2px solid #7b241c;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.82rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 #641e16;
            text-transform: uppercase;
            font-family: 'Minecraft', sans-serif;
            letter-spacing: 0.5px;
            justify-content: center;
        }

        .bp-delete-btn:hover {
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #641e16;
        }

        .bp-delete-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #641e16;
        }

        .bp-delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .bp-logged-in-top {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bp-avatar {
            width: 42px;
            height: 42px;
            border-radius: 2px;
            object-fit: cover;
            border: 2px solid #4caf50;
            flex-shrink: 0;
        }
        .bp-avatar-placeholder {
            width: 42px;
            height: 42px;
            border-radius: 2px;
            background: linear-gradient(135deg, #6b8e23, #4a5d23);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
            border: 2px solid #4caf50;
        }
        .bp-profile-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(76,175,80,0.3);
        }
        .bp-profile-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.75rem;
            background: none;
            border: 2px solid #388e3c;
            color: #2e7d32;
            cursor: pointer;
            padding: 9px 4px;
            font-weight: 700;
            font-family: 'Minecraft', sans-serif;
            border-radius: 2px;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
            box-sizing: border-box;
        }
        .bp-profile-btn:hover { background: rgba(76,175,80,0.1); transform: translateY(-1px); }
        .bp-profile-btn.danger { border-color: #c62828; color: #c62828; }
        .bp-profile-btn.danger:hover { background: rgba(198,40,40,0.1); }
        body.dark-theme .bp-profile-btn { color: #a5d6a7; border-color: #4caf50; }
        body.dark-theme .bp-profile-btn.danger { color: #ef9a9a; border-color: #c62828; }
        .bp-profile-file-input { display: none; }
        .bp-email-text { color: #2e7d32; }
        body.dark-theme .bp-email-text { color: #ffffff; }
        .bp-profile-actions-delete {
            margin-top: 6px;
        }

        .bp-card-avatar {
            width: 22px;
            height: 22px;
            border-radius: 2px;
            object-fit: cover;
            border: 1px solid #8b7355;
            flex-shrink: 0;
        }
        .bp-card-avatar-placeholder {
            width: 22px;
            height: 22px;
            border-radius: 2px;
            background: linear-gradient(135deg, #6b8e23, #4a5d23);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.65rem;
            flex-shrink: 0;
            border: 1px solid #4a5d23;
        }
        .bp-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 100001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bp-modal {
            background: #f5eed9;
            border: 4px solid #8b7355;
            border-radius: 4px;
            padding: 28px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 8px 0 #5a4a3a, 0 12px 30px rgba(0,0,0,0.5);
        }
        body.dark-theme .bp-modal { background: #2a2a2a; border-color: #3a3a3a; color: #e0e0e0; }
        .bp-modal h3 {
            font-family: 'Minecraft', sans-serif;
            color: #4a5d23;
            margin-bottom: 16px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        body.dark-theme .bp-modal h3 { color: #81c784; }
        .bp-modal-btns { display: flex; gap: 10px; margin-top: 16px; }

        .bp-auth-captcha {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            width: 100%;
            overflow: hidden;
        }

        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99999;
            background: #f5eed9;
            border-top: 4px solid #5a4a3a;
            box-shadow: 0 -8px 30px rgba(0,0,0,0.4);
            padding: 20px 28px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: space-between;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16,1,0.3,1);
        }
        .cookie-banner.show { transform: translateY(0); }
        body.dark-theme .cookie-banner {
            background: #2a2a2a;
            border-top-color: #3a3a3a;
        }
        .cookie-banner-text {
            flex: 1;
            min-width: 200px;
        }
        .cookie-banner-title {
            font-family: 'Minecraft', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: #4a5d23;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.dark-theme .cookie-banner-title { color: #81c784; }
        .cookie-banner-desc {
            font-size: 12px;
            font-weight: 600;
            color: #5a4a3a;
            line-height: 1.6;
            font-family: 'Minecraft', sans-serif;
        }
        body.dark-theme .cookie-banner-desc { color: #b0b0b0; }
        .cookie-banner-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .cookie-accept-btn {
            padding: 11px 24px;
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border: 2px solid #4a5d23;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.82rem;
            font-family: 'Minecraft', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 0 #3d4f1c;
            transition: all 0.15s;
        }
        .cookie-accept-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #3d4f1c; }
        .cookie-decline-btn {
            padding: 11px 20px;
            background: #ede8d6;
            color: #5a4a3a;
            border: 2px solid #8b7355;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.82rem;
            font-family: 'Minecraft', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 0 #5a4a3a;
            transition: all 0.15s;
        }
        .cookie-decline-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #5a4a3a; }
        body.dark-theme .cookie-decline-btn { background: #1a1a1a; color: #b0b0b0; border-color: #3a3a3a; }

        .cookie-settings-btn {
            padding: 10px 20px;
            border: 2px solid #5a4a3a;
            background: #f5eed9;
            color: #3e2723;
            cursor: pointer;
            border-radius: 0px;
            font-weight: 700;
            transition: all 0.15s;
            font-size: 0.85rem;
            box-shadow: 0 4px 0 #3e2f1f;
            text-transform: uppercase;
            font-family: 'Minecraft', sans-serif;
            letter-spacing: 1px;
        }
        .cookie-settings-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #3e2f1f; }
        body.dark-theme .cookie-settings-btn { color: #e0e0e0; background: #2a2a2a; border-color: #3a3a3a; box-shadow: 0 4px 0 #0a0a0a; }

        .cookie-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.65);
            z-index: 99998;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .cookie-modal {
            background: #f5eed9;
            border: 4px solid #8b7355;
            border-radius: 4px;
            padding: 32px;
            max-width: 440px;
            width: 100%;
            box-shadow: 0 8px 0 #5a4a3a, 0 12px 30px rgba(0,0,0,0.5);
        }
        body.dark-theme .cookie-modal { background: #2a2a2a; border-color: #3a3a3a; color: #e0e0e0; }
        .cookie-modal h3 {
            font-family: 'Minecraft', sans-serif;
            color: #4a5d23;
            margin-bottom: 16px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        body.dark-theme .cookie-modal h3 { color: #81c784; }
        .cookie-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 2px solid #d4c5a0;
            gap: 12px;
        }
        body.dark-theme .cookie-toggle-row { border-bottom-color: #3a3a3a; }
        .cookie-toggle-row:last-of-type { border-bottom: none; }
        .cookie-toggle-info { flex: 1; }
        .cookie-toggle-name {
            font-weight: 800;
            font-size: 0.88rem;
            color: #3e2723;
            font-family: 'Minecraft', sans-serif;
            margin-bottom: 3px;
        }
        body.dark-theme .cookie-toggle-name { color: #e0e0e0; }
        .cookie-toggle-desc {
            font-size: 0.75rem;
            color: #7a6340;
            font-family: 'Minecraft', sans-serif;
            line-height: 1.4;
            font-weight: 600;
        }
        body.dark-theme .cookie-toggle-desc { color: #999; }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #c5b89a;
            border: 2px solid #8b7355;
            transition: 0.2s;
            border-radius: 2px;
        }
        .toggle-slider:before {
            position: absolute;
            content: '';
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.2s;
            border-radius: 1px;
        }
        .toggle-switch input:checked + .toggle-slider { background: #6b8e23; border-color: #4a5d23; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(18px); }
        .toggle-switch input:disabled + .toggle-slider { opacity: 0.6; cursor: not-allowed; }

        .auth-locked {
            position: relative;
            cursor: not-allowed !important;
            opacity: 0.55 !important;
        }
        .auth-locked::after {
            content: ' Login required';
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #3e2723;
            color: white;
            font-size: 11px;
            font-weight: 700;
            font-family: 'Minecraft', sans-serif;
            padding: 6px 10px;
            border-radius: 2px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
            z-index: 100;
            border: 2px solid #8b7355;
        }
        .auth-locked:hover::after { opacity: 1; }

        /* === GALLERY  lightbox only, cards reuse bp-* classes === */
        .gallery-lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.88);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }
        .gallery-lightbox img {
            max-width: 92vw;
            max-height: 92vh;
            object-fit: contain;
            border: 4px solid #5a4a3a;
            border-radius: 4px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            cursor: pointer;
        }
        .gallery-lightbox-close {
            position: absolute;
            top: 18px;
            right: 22px;
            background: none;
            border: 3px solid #fff;
            color: #fff;
            font-size: 1.3rem;
            padding: 5px 14px;
            cursor: pointer;
            border-radius: 2px;
            font-family: 'Minecraft', sans-serif;
            font-weight: 700;
        }
        /* bp-card-img clickable cursor for gallery */
        .gallery-tab-img { cursor: zoom-in; }
        body.dark-theme #gallery-daily-limit { background: #1a1a1a; border-color: #3a3a3a; }
        body.dark-theme #gallery-limit-title,
        body.dark-theme #gallery-limit-text { color: #b0b0b0; }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
                margin-top: 0;
            }

            .language-switcher {
                position: static;
                margin-bottom: 20px;
                justify-content: center;
            }

            .container {
                padding: 30px 20px;
            }

            .authors {
                grid-template-columns: 1fr;
            }

            .zerotier-code {
                margin: 14px auto;
                max-width: 340px;
                text-align: center;
            }

            .code-container {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .code-text {
                font-size: 1rem;
                letter-spacing: 2px;
                text-align: center;
                word-break: break-all;
                width: 100%;
                box-sizing: border-box;
            }

            .copy-btn {
                justify-content: center;
                width: 100%;
                box-sizing: border-box;
            }

            .nav-tab {
                font-size: 0.68rem;
                padding: 10px 4px;
            }

            .nav-icon {
                font-size: 1.1rem;
            }
        }
    </style>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        const EMAILJS_PUBLIC_KEY  = 'GekBvpWazW6ogvM3_';   // Account  API Keys
        const EMAILJS_SERVICE_ID  = 'service_2j4ldbe';           // Email Services
        const EMAILJS_VERIFY_TPL  = 'template_htad8aq';   // Email Templates ()
        const EMAILJS_RESET_TPL   = 'template_rxtcd4f';    // Email Templates ( )
        const SITE_URL = 'https://mcearthproject.qzz.io';        // URL  

        (function() {
            if (EMAILJS_PUBLIC_KEY !== 'YOUR_EMAILJS_PUBLIC_KEY') {
                emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
            }
        })();
    </script>
</head>
<body>

<div id="page-load-bar" style="position:fixed;top:0;left:0;width:0%;height:3px;background:linear-gradient(90deg,#4a8c00,#6abf00,#8bc34a,#6abf00);z-index:99999;box-shadow:0 0 8px #6abf00,0 0 2px #fff;transition:width 0.3s ease;border-radius:0 2px 2px 0;"></div>
<script>
(function(){
    const bar = document.getElementById('page-load-bar');
    let w = 0;
    const iv = setInterval(() => {
        w += Math.random() * 15;
        if (w > 85) w = 85;
        bar.style.width = w + '%';
    }, 200);
    window.addEventListener('load', () => {
        clearInterval(iv);
        bar.style.width = '100%';
        bar.style.transition = 'width 0.2s ease, opacity 0.5s ease 0.3s';
        setTimeout(() => { bar.style.opacity = '0'; }, 300);
        setTimeout(() => { bar.style.display = 'none'; }, 900);
    });
})();
</script>
    <div class="container">
        <div class="language-switcher">
            <button class="lang-btn active" onclick="switchLanguage('ru', event)"> RU</button>
            <button class="lang-btn" onclick="switchLanguage('en', event)"> EN</button>
            <button class="theme-btn" onclick="toggleTheme()">
                <span class="theme-icon"></span>
            </button>
            <button class="cookie-settings-btn" onclick="showCookieModal()" title="Cookie Settings"></button>
        </div>

        <h1>PROJECT EARTH</h1>
        <p class="subtitle" data-ru=" Minecraft Earth  " 
           data-en="Sustaining Minecraft Earth, beyond the closing">
             Minecraft Earth  
        </p>

        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('home')" data-ru="" data-en="Home"><span class="nav-icon"><img src="shop_icon.png" alt="Home"></span><span data-ru="" data-en="Home"></span></button>
            <button class="nav-tab" onclick="switchTab('news')" data-ru="" data-en="News"><span class="nav-icon"><img src="journal_icon.png" alt="News"></span><span data-ru="" data-en="News"></span></button>
            <button class="nav-tab" onclick="switchTab('buildplates')" data-ru="Buildplates" data-en="Buildplates"><span class="nav-icon"><img src="buildplate_icon.png" alt="Buildplates"></span><span data-ru="Buildplates" data-en="Buildplates">Buildplates</span></button>
            <button class="nav-tab" id="gallery-nav-tab" onclick="switchTab('gallery')" data-ru="" data-en="Gallery" style="border-right:3px solid #8b7355;border-radius:0 4px 0 0;"><span class="nav-icon"><img src="paint_item.png" alt="Gallery"></span><span data-ru="" data-en="Gallery"></span></button>
            <button class="nav-tab" id="reports-nav-tab" onclick="switchTab('reports')" data-ru="" data-en="Reports" style="display:none;"><span class="nav-icon"><img src="settings_icon.png" alt="Reports"></span><span data-ru="" data-en="Reports"></span></button>
        </div>

        
        <div id="home-tab" class="tab-content active">
        <div class="discord-banner">
            <a href="https://discord.gg/tWb8RFEMC" target="_blank" class="discord-btn">
                <i class="fab fa-discord"></i>
                <span data-ru="   Discord!" data-en="Join our Discord!">
                       Discord!
                </span>
            </a>
        </div>

        <div class="section">
            <h2 class="section-title" data-icon="earth_icon.png">
                <span data-ru="  Project Earth?" data-en="What is Project Earth?">  Project Earth?</span>
            </h2>
            <div class="info-card">
                <p data-ru="Minecraft Earth   2021     . Project Earth  ,     . .  ."
                   data-en="Minecraft Earth shut down in 2021  but we brought it back. Project Earth is a server where the game works again. Free. For everyone.">
                    Minecraft Earth   2021     . Project Earth  ,     . .  .
                </p>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-icon="scan_code_icon.png">
                <span data-ru="  ?" data-en="How Does It Work?">  ?</span>
            </h2>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3 data-ru=" Vienna Docker" data-en="Using Vienna Docker">
                             Vienna Docker
                        </h3>    
                        <p data-ru="   Vienna       ."
                           data-en="We run the open-source Vienna server  it recreates the full game backend.">
                               Vienna       .
                        </p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3 data-ru=" " data-en="Patch the Client">
                             
                        </h3>
                        <p data-ru=" APK         ."
                           data-en="We patch the APK  the game connects to our server instead of the closed official one.">
                             APK         .
                        </p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3 data-ru="!" data-en="Play!">
                            !
                        </h3>
                        <p data-ru=" .   ."
                           data-en="All set. Jump in and play.">
                             .   .
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-icon="friend_icon.png">
                <span data-ru="  ?" data-en="How to Start Playing?">  ?</span>
            </h2>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3 data-ru=" ZeroTier One" data-en="Install ZeroTier One">
                             ZeroTier One
                        </h3>
                        <p data-ru="   ZeroTier One   ."
                           data-en="Download and install ZeroTier One on your device.">
                               ZeroTier One   .
                        </p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3 data-ru="  " data-en="Enter Network Code">
                              
                        </h3>
                        <p data-ru=" ZeroTier One     :"
                           data-en="Open ZeroTier One and enter our network code:">
                             ZeroTier One     :
                        </p>
                        <div class="zerotier-code">
                            <p>Network ID:</p>
                            <div class="code-container">
                                <span class="code-text">3b19b3a716030d76</span>
                                <button class="copy-btn" onclick="copyZeroTier()">
                                    <i class="fas fa-copy"></i>
                                    <span data-ru="" data-en="Copy"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3 data-ru=" " data-en="Wait for Authorization">
                             
                        </h3>
                        <p data-ru="         ."
                           data-en="After joining the network, wait a few minutes to be authorized.">
                                     .
                        </p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h3 data-ru=" APK" data-en="Download APK">
                             APK
                        </h3>
                        <p data-ru="   APK  Discord ."
                           data-en="Download our patched APK from the Discord server.">
                               APK  Discord .
                        </p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <h3 data-ru=" !" data-en="Launch the Game!">
                             !
                        </h3>
                        <p data-ru=" APK  .   ! "
                           data-en="Install the APK and launch. Welcome back! ">
                             APK  .   ! 
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-icon="mob_of_me_icon.png">
                <span data-ru="" data-en="Creators"></span>
            </h2>
            <div class="authors">
                <div class="author-card">
                    <div class="author-name">SuperDima8050</div>
                    <div class="author-role" data-ru=" |  |  " 
                         data-en="Assistant | Developer | Website Creator">
                         |  |  
                    </div>
                    <div class="author-links">
                        <a href="https://discord.com/users/1203235739752595487" class="link" target="_blank">
                            <i class="fab fa-discord"></i>
                            <span>@superdima8050</span>
                        </a>
                        <a href="https://github.com/SuperDima8050" class="link" target="_blank">
                            <i class="fab fa-github"></i>
                            <span>github.com/SuperDima8050</span>
                        </a>
                        <a href="https://mcearthproject.qzz.io" class="link" target="_blank">
                            <i class="fas fa-globe"></i>
                            <span>mcearthproject.qzz.io</span>
                        </a>
                    </div>
                </div>

                <div class="author-card">
                    <div class="author-name">Kostyaniche</div>
                    <div class="author-role" data-ru=".   | " 
                         data-en="Lead Developer | Host">
                        .   | 
                    </div>
                    <div class="author-links">
                        <a href="https://discord.com/users/1285524289361154061" class="link" target="_blank">
                            <i class="fab fa-discord"></i>
                            <span>@kostyaniche</span>
                        </a>
                    </div>
                </div>

                <div class="author-card">
                    <div class="author-name">Micheal65536</div>
                    <div class="author-role" data-ru="" data-en="Founder">
                        
                    </div>
                    <div class="author-links">
                        <a href="https://discord.com/users/864232575853658183" class="link" target="_blank">
                            <i class="fab fa-discord"></i>
                            <span>@micheal65536</span>
                        </a>
                    </div>
                </div>

                <div class="author-card">
                    <div class="author-name">Halolamemes</div>
                    <div class="author-role" data-ru="" data-en="Assistant">
                        
                    </div>
                    <div class="author-links">
                        <a href="https://discord.com/users/1122063385811496970" class="link" target="_blank">
                            <i class="fab fa-discord"></i>
                            <span>@halolamemes</span>
                        </a>
                    </div>
                </div>

                <div class="author-card">
                    <div class="author-name">Prostofanatdeltaruna</div>
                    <div class="author-role" data-ru="" data-en="Assistant">
                        
                    </div>
                    <div class="author-links">
                        <a href="https://discord.com/users/1438966243276099664" class="link" target="_blank">
                            <i class="fab fa-discord"></i>
                            <span>@prostofanatdeltaruna</span>
                             </a>
                        <a href="https://projectreviver.qzz.io" class="link" target="_blank">
                            <i class="fas fa-globe"></i>
                            <span>projectreviver.qzz.io</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
            
        <div class="section">
            <h2 class="section-title" data-icon="journal_open_icon.png">
                <span data-ru="  " data-en="FAQ">  </span>
            </h2>
            
            <div class="faq-item">
                <div class="faq-question">
                    <i class="fas fa-question-circle"></i>
                    <span data-ru=" ?" data-en="Is it free?">
                         ?
                    </span>
                </div>
                <div class="faq-answer" data-ru="! Project Earth     ." 
                     data-en="Yes! Project Earth is completely free for all players.">
                    ! Project Earth     .
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question">
                    <i class="fas fa-question-circle"></i>
                    <span data-ru="  Project Genoa?" data-en="What is Project Genoa?">
                          Project Genoa?
                    </span>
                </div>
                <div class="faq-answer" data-ru="Project Genoa -        Minecraft Earth.   Vienna Docker    ." 
                     data-en="Project Genoa is an open-source project to recreate the server-side of Minecraft Earth. We use their Vienna Docker to run our server">
                    Project Genoa -        Minecraft Earth.    Vienna Docker    .
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question">
                    <i class="fas fa-question-circle"></i>
                    <span data-ru="  APK?" data-en="Where to download APK?">
                          APK?
                    </span>
                </div>
                <div class="faq-answer" data-ru=" APK    Discord .    !" 
                     data-en="The modified APK is available on our Discord server. Join and follow the instructions!">
                     APK    Discord .    !
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question">
                    <i class="fas fa-question-circle"></i>
                    <span data-ru="   ZeroTier?" data-en="Do I need ZeroTier?">
                           ZeroTier?
                    </span>
                </div>
                <div class="faq-answer" data-ru="! ZeroTier      .       ." 
                     data-en="Yes! ZeroTier is required to connect to our server. It creates a secure virtual network for the game.">
                    ! ZeroTier      .       .
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-icon="adventure_icon.png">
                <span data-ru=" " data-en="Useful Links"> </span>
            </h2>
            <div class="info-card">
                <p style="margin-bottom: 15px;">
                    <strong>Project Genoa (API):</strong><br>
                    <a href="https://github.com/Project-Genoa" target="_blank" style="color: #667eea;">
                        <i class="fab fa-github"></i> github.com/Project-Genoa
                    </a>
                </p>
                <p style="margin-bottom: 15px;">
                    <strong data-ru=" Discord:" data-en="Our Discord:"> Discord:</strong><br>
                    <a href="https://discord.gg/tWb8RFEMC" target="_blank" style="color: #5865F2;">
                        <i class="fab fa-discord"></i> discord.gg/tWb8RFEMC
                    </a>
                </p>
                <p>
                    <strong data-ru="Reddit :" data-en="Reddit Community:">Reddit :</strong><br>
                    <a href="https://reddit.com/r/ProjectEarth" target="_blank" style="color: #FF4500;">
                        <i class="fab fa-reddit-alien"></i> r/ProjectEarth
                    </a>
                </p>
                <p style="margin-top: 15px;">
                    <strong data-ru=" YouTube:" data-en="Our YouTube:"> YouTube:</strong><br>
                    <a href="https://www.youtube.com/@ProjectReviverminecraft" target="_blank" style="color: #FF0000;">
                        <i class="fab fa-youtube"></i> @ProjectReviverminecraft
                    </a>
                </p>
            </div>
        </div>
        </div>
        

        
        <div id="news-tab" class="tab-content">
            <div class="section">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
                    <h2 class="section-title" data-icon="journal_icon.png" style="margin-bottom:0;border-bottom:none;padding-bottom:0;"><span data-ru=" " data-en="Project News"> </span></h2>
                    <button class="copy-btn" onclick="showNewsAdminPanel()" style="font-size:0.8rem;padding:8px 14px;">
                        <img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/journal_icon.png" alt="" style="width:16px;height:16px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;"> <span data-ru=" " data-en="Add News"> </span>
                    </button>
                </div>
                <div id="news-container" class="news-container">
                    <div class="news-empty">
                        <i class="fas fa-newspaper"></i>
                        <p data-ru=" " data-en="No news"> </p>
                    </div>
                </div>
            </div>
        </div>
        

        
        <div id="buildplates-tab" class="tab-content">
            <div class="section">
                <h2 class="section-title" data-icon="buildplate_icon.png">
                    <span data-ru=" Buildplate" data-en="Share Buildplate"> Buildplate</span>
                </h2>

                
                <div class="bp-upload-card">
                    <div class="bp-form-row">
                        <label data-ru="" data-en="Name"></label>
                        <input type="text" id="bp-name" placeholder=", plains_16x16" data-placeholder-ru="  Buildplate" data-placeholder-en="For example, plains_16x16" maxlength="60" />
                    </div>

                    
                    <div id="bp-auth-section">
                        
                        <div id="bp-auth-form" class="bp-auth-box">
                            <div class="bp-auth-title"><i class="fas fa-lock"></i> <span id="bp-auth-mode-title" data-ru=" / " data-en="Login / Register"> / </span></div>
                            <div class="bp-form-row" style="margin-bottom:10px;">
                                <label data-ru="" data-en="Nickname"></label>
                                <input type="text" id="bp-auth-nick" placeholder="Halolamemes" maxlength="40" />
                            </div>
                            
                            <div class="bp-form-row" id="bp-email-row" style="margin-bottom:10px; display:none;">
                                <label data-ru="Email" data-en="Email">Email</label>
                                <input type="email" id="bp-auth-email" placeholder="you@example.com" maxlength="120" style="width:100%;padding:12px 14px;border:3px solid #8b7355;border-radius:2px;background:#f5eed9;color:#3e2723;font-family:Minecraft,sans-serif;font-size:1rem;font-weight:600;outline:none;transition:border-color .15s;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);" />
                            </div>
                            <div class="bp-form-row" style="margin-bottom:10px;">
                                <label data-ru="" data-en="Password"></label>
                                <div class="pass-wrap"><input type="password" id="bp-auth-pass" placeholder="" maxlength="100" /><button type="button" class="pass-toggle" onclick="togglePass('bp-auth-pass',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                            </div>
                            
                            <div class="bp-form-row" id="bp-pass2-row" style="margin-bottom:10px; display:none;">
                                <label data-ru=" " data-en="Confirm Password"> </label>
                                <div class="pass-wrap"><input type="password" id="bp-auth-pass2" placeholder="" maxlength="100" style="width:100%;padding:12px 44px 12px 14px;border:3px solid #8b7355;border-radius:2px;background:#f5eed9;color:#3e2723;font-family:Minecraft,sans-serif;font-size:1rem;font-weight:600;outline:none;transition:border-color .15s;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);" /><button type="button" class="pass-toggle" onclick="togglePass('bp-auth-pass2',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                            </div>
                            <button class="bp-submit-btn" style="margin-top:4px; font-size:0.85rem; padding:10px;" onclick="doAuth()">
                                <i class="fas fa-sign-in-alt"></i>
                                <span id="bp-auth-btn-text" data-ru="" data-en="Login"></span>
                            </button>
                            <div class="bp-auth-status" id="bp-auth-status"></div>
                            <div class="bp-auth-captcha" id="auth-captcha-wrap"></div>
                            <script>
                            (function() {
                                var wrap = document.getElementById('auth-captcha-wrap');
                                var isCompact = window.innerWidth <= 480;
                                var savedTheme = localStorage.getItem('theme');
                                var isDark = savedTheme === 'dark'
                                    || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
                                var div = document.createElement('div');
                                div.className = 'cf-turnstile';
                                div.id = 'auth-turnstile';
                                div.setAttribute('data-sitekey', '0x4AAAAAACZyA1UOix1SiYwF');
                                div.setAttribute('data-theme', isDark ? 'dark' : 'light');
                                div.setAttribute('data-size', isCompact ? 'compact' : 'normal');
                                wrap.appendChild(div);
                            })();
                            </script>
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px;margin-top:6px;">
                                <button class="bp-auth-toggle" onclick="toggleAuthMode()" id="bp-auth-toggle-btn" data-ru=" ? " data-en="No account? Register"> ? </button>
                                <button class="bp-auth-toggle" id="bp-forgot-btn" onclick="showForgotModal()" style="color:#e67e22;" data-ru=" ?" data-en="Forgot password?"> ?</button>
                            </div>

                        </div>
                        
                        <div id="bp-logged-in-box" class="bp-logged-in" style="display:none;">
                            
                            <div class="bp-logged-in-top">
                                <div id="bp-profile-avatar-wrap">
                                    <div class="bp-avatar-placeholder" id="bp-avatar-placeholder"><i class="fas fa-user"></i></div>
                                    <img class="bp-avatar" id="bp-avatar-img" src="" alt="avatar" style="display:none;" />
                                </div>
                                <div style="flex:1;min-width:0;overflow:hidden;">
                                    <div class="bp-logged-in-name" id="bp-logged-in-name"></div>
                                    <div id="bp-email-verified-badge" style="display:none;margin-top:4px;" class="bp-email-text"></div>
                                    <div id="bp-join-date" style="display:none;font-size:0.72rem;font-weight:600;margin-top:3px;opacity:0.75;"></div>
                                </div>
                            </div>
                            
                            <div class="bp-profile-actions">
                                <label class="bp-profile-btn" style="cursor:pointer;">
                                    <i class="fas fa-image"></i>
                                    <span data-ru="" data-en="Avatar"></span>
                                    <input type="file" class="bp-profile-file-input" id="bp-avatar-upload" accept=".png,.jpg,.jpeg,.gif,.webp" onchange="uploadAvatar(this)" />
                                </label>
                                <button class="bp-profile-btn" onclick="showRenameModal()">
                                    <i class="fas fa-pencil-alt"></i>
                                    <span data-ru="" data-en="Username"></span>
                                </button>
                                <button class="bp-profile-btn" onclick="showChangePassModal()">
                                    <i class="fas fa-key"></i>
                                    <span data-ru="" data-en="Password"></span>
                                </button>
                                <button class="bp-profile-btn" onclick="doLogout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span data-ru="" data-en="Logout"></span>
                                </button>
                            </div>
                            <div class="bp-profile-actions-delete">
                                <button class="bp-profile-btn danger" onclick="deleteAccount()">
                                    <i class="fas fa-trash-alt"></i>
                                    <span data-ru=" " data-en="Delete Account"> </span>
                                </button>
                            </div>
                            
                            <div class="ref-profile-block" id="ref-profile-block" style="display:none;">
                                <div class="ref-profile-title"><img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/friend_icon.png" width="16" height="16" style="object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:5px;"> <span data-ru=" " data-en="Referral Link"> </span></div>
                                <div class="ref-link-row">
                                    <input class="ref-link-input" id="ref-link-input" readonly />
                                    <button class="ref-copy-btn" onclick="copyRefLink()"><i class="fas fa-copy"></i></button>
                                </div>
                                <div class="ref-stats" id="ref-stats-line">
                                    <i class="fas fa-users" style="color:#6b8e23;"></i>
                                    <span id="ref-count-text">0 </span>
                                </div>
                                <div id="ref-xp-bar-container"></div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="bp-author" />

                    <div class="bp-form-row">
                        <label data-ru="" data-en="Screenshot"></label>
                        <label class="bp-file-label" id="bp-image-label-wrap" for="bp-image-input">
                            <i class="fas fa-image"></i>
                            <span id="bp-image-label" data-ru="   ..." data-en="Choose or drag here...">   ...</span>
                            <span class="bp-formats">PNG  JPEG  GIF  WebP</span>
                            <input type="file" id="bp-image-input" accept=".png,.jpg,.jpeg,.gif,.webp" />
                        </label>
                        <div class="bp-file-name" id="bp-image-name"></div>
                    </div>

                    <div class="bp-form-row">
                        <label data-ru=" Buildplate (world)" data-en="Buildplate File (world)"> Buildplate (world)</label>
                        <label class="bp-file-label" id="bp-world-label-wrap" for="bp-world-input">
                            <i class="fas fa-cube"></i>
                            <span id="bp-world-label" data-ru="   world ..." data-en="Choose or drag world file...">   world ...</span>
                            <input type="file" id="bp-world-input" />
                        </label>
                        <div class="bp-file-name" id="bp-world-name"></div>
                    </div>

                    <div id="bp-daily-limit" style="display:none;align-items:center;gap:10px;margin-bottom:12px;padding:12px 16px;background:#fffbf0;border:3px solid #8b7355;border-radius:2px;box-shadow:0 4px 0 #5a4a3a;">
                        <img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/timer_icon.png" alt="timer" style="width:36px;height:36px;object-fit:contain;image-rendering:pixelated;flex-shrink:0;">
                        <div style="flex:1;">
                            <div style="font-family:'Minecraft', sans-serif;font-size:0.78rem;font-weight:700;color:#4a5d23;text-transform:uppercase;letter-spacing:1px;" id="bp-limit-title">  </div>
                            <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
                                <div id="bp-limit-dots" style="display:flex;gap:5px;"></div>
                                <span id="bp-limit-text" style="font-family:'Minecraft', sans-serif;font-size:0.8rem;font-weight:700;color:#5a4a3a;"></span>
                            </div>
                            <div id="bp-limit-reset" style="font-family:'Minecraft', sans-serif;font-size:0.72rem;color:#8b7355;margin-top:2px;"></div>
                        </div>
                    </div>

                    <button class="bp-submit-btn" id="bp-submit-btn" onclick="uploadBuildplate()">
                        <i class="fas fa-upload"></i>
                        <span data-ru=" Buildplate" data-en="Upload Buildplate"> Buildplate</span>
                    </button>
                    <div class="bp-status" id="bp-status"></div>
                </div>

                
                <div class="bp-gallery-title" data-icon="buildplate_icon.png">
                    <span data-ru="Buildplates " data-en="Community Buildplates">Buildplates </span>
                </div>

                
                <div class="bp-filters" id="bp-filters" style="display:none;">
                    <div class="bp-search-wrap">
                        <i class="fas fa-search"></i>
                        <input type="text" id="bp-search"
                               data-placeholder-ru="    ..."
                               data-placeholder-en="Search by name or author..."
                               placeholder="    ..." />
                    </div>
                    <select class="bp-sort-select" id="bp-sort">
                        <option value="newest" data-ru="  " data-en=" Newest first">  </option>
                        <option value="oldest" data-ru="  " data-en=" Oldest first">  </option>
                        <option value="liked" data-ru="  " data-en=" Most liked">  </option>
                        <option value="rating" data-ru="  " data-en=" By rating">  </option>
                    </select>
                    <button class="bp-filter-mine-btn" id="bp-filter-mine"
                            data-ru="" data-en="Mine"
                            onclick="toggleFilterMine()"><img class="mce-icon" src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/mob_of_me_icon.png" style="width:20px;height:20px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:5px;"><span data-ru="" data-en="Mine"></span></button>
                    <span class="bp-results-count" id="bp-results-count"></span>
                </div>

                <div id="bp-gallery">
                    <div class="bp-loading">
                        <i class="fas fa-spinner"></i>
                        <p data-ru="..." data-en="Loading...">...</p>
                    </div>
                </div>
            </div>
        </div>
        

        
        <div id="reports-tab" class="tab-content">
            <div class="section">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
                    <h2 class="section-title" data-icon="settings_icon.png" style="margin-bottom:0;border-bottom:none;padding-bottom:0;"><span data-ru="" data-en="Reports"></span></h2>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="copy-btn" id="reports-filter-pending" onclick="window.filterReports('pending')" style="font-size:0.78rem;padding:6px 12px;background:linear-gradient(180deg,#c62828,#8b1a1a);border-color:#8b1a1a;box-shadow:0 4px 0 #5a0d0d;">
                            <img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/timer_icon.png" style="width:18px;height:18px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:4px;"> <span data-ru="" data-en="Pending"></span>
                        </button>
                        <button class="copy-btn" id="reports-filter-resolved" onclick="window.filterReports('resolved')" style="font-size:0.78rem;padding:6px 12px;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 4px 0 #222;">
                            <img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/emerald_block.png" style="width:16px;height:16px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:4px;"> <span data-ru="" data-en="Resolved"></span>
                        </button>
                    </div>
                </div>
                <div id="reports-container">
                    <div class="news-empty"><i class="fas fa-flag"></i><p data-ru=" " data-en="No reports"> </p></div>
                </div>
            </div>
        </div>
        

        <!-- GALLERY TAB -->
        <div id="gallery-tab" class="tab-content">
            <div class="section">
                <h2 class="section-title" data-icon="paint_item.png">
                    <span data-ru="" data-en="Gallery"></span>
                </h2>

                <!-- Upload card -->
                <div class="bp-upload-card" id="gallery-upload-section">
                    <!-- Not logged in message -->
                    <div id="gallery-not-logged" style="text-align:center;padding:20px 10px;">
                        <i class="fas fa-lock" style="font-size:2rem;color:#8b7355;margin-bottom:12px;display:block;"></i>
                        <p style="font-family:Minecraft,sans-serif;font-size:0.85rem;color:#5a4a3a;font-weight:700;line-height:1.6;"
                           data-ru="  ,      &laquo;Buildplates&raquo;"
                           data-en="To upload photos, please log in from the &laquo;Buildplates&raquo; tab">
                              ,      Buildplates
                        </p>
                    </div>

                    <!-- Upload form (shown when logged in) -->
                    <div id="gallery-upload-form" style="display:none;">
                        <div class="bp-form-row">
                            <label data-ru="" data-en="Title"></label>
                            <input type="text" id="gallery-title" maxlength="60"
                                   data-placeholder-ru="  "
                                   data-placeholder-en="My cool screenshot"
                                   placeholder="  " />
                        </div>
                        <div class="bp-form-row">
                            <label data-ru=" (PNG / JPG / WEBP)" data-en="Photo (PNG / JPG / WEBP)"> (PNG / JPG / WEBP)</label>
                            <label class="bp-file-label" id="gallery-image-label" for="gallery-image-input">
                                <i class="fas fa-image"></i>
                                <span data-ru=",   " data-en="Click to choose image">,   </span>
                            </label>
                            <input type="file" id="gallery-image-input" accept=".png,.jpg,.jpeg,.webp" style="display:none;" />
                        </div>

                        <!-- Daily limit shared with buildplates -->
                        <div id="gallery-daily-limit" style="margin:12px 0;background:#f0ede0;border:2px solid #8b7355;border-radius:2px;padding:12px;display:flex;align-items:center;gap:12px;">
                            <img src="" id="gallery-limit-icon" style="width:22px;height:22px;image-rendering:pixelated;object-fit:contain;flex-shrink:0;">
                            <div style="flex:1;">
                                <div id="gallery-limit-title" style="font-family:Minecraft,sans-serif;font-size:0.82rem;font-weight:700;color:#5a4a3a;margin-bottom:4px;"></div>
                                <div id="gallery-limit-dots" style="display:flex;gap:4px;margin-bottom:5px;"></div>
                                <div id="gallery-limit-text" style="font-family:Minecraft,sans-serif;font-size:0.78rem;color:#5a4a3a;font-weight:600;"></div>
                            </div>
                        </div>

                        <div id="gallery-status" style="font-family:Minecraft,sans-serif;font-size:0.85rem;font-weight:700;"></div>
                        <button class="bp-submit-btn" id="gallery-submit-btn" onclick="uploadGalleryPhoto()">
                            <i class="fas fa-upload"></i>
                            <span data-ru=" " data-en="Publish photo"> </span>
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="bp-filters" id="gallery-filters" style="display:none;">
                    <div class="bp-search-wrap">
                        <i class="fas fa-search"></i>
                        <input type="text" id="gallery-search"
                               placeholder="..."
                               data-placeholder-ru="..."
                               data-placeholder-en="Search..."
                               oninput="filterGallery()" />
                    </div>
                    <select class="bp-sort-select" id="gallery-sort" onchange="filterGallery()">
                        <option value="newest" data-ru=" " data-en="Newest first"> </option>
                        <option value="oldest" data-ru=" " data-en="Oldest first"> </option>
                        <option value="liked" data-ru=" " data-en="By likes"> </option>
                    </select>
                    <button class="bp-filter-mine-btn" id="gallery-filter-mine"
                            data-ru="" data-en="Mine"
                            onclick="toggleGalleryFilterMine()"><img class="mce-icon" src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/mob_of_me_icon.png" style="width:20px;height:20px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:5px;"><span data-ru="" data-en="Mine"></span></button>
                    <span class="bp-results-count" id="gallery-count"></span>
                </div>

                <!-- Photo grid -->
                <div id="gallery-gallery"></div>
            </div>
        </div>

        <div class="info-note" style="margin-bottom:0;">
            <i class="fas fa-info-circle"></i>
            <span data-ru="        Mojang  Microsoft" 
                  data-en="This project is created by fans and is not affiliated with Mojang or Microsoft">
                        Mojang  Microsoft
            </span>
        </div>
    </div>

    
    <div class="cookie-banner" id="cookie-banner">
        <div class="cookie-banner-text">
            <div class="cookie-banner-title"><img id="cookie-icon-banner" src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/cookie_item.png" alt="cookie" style="width:24px;height:24px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:6px;"> Cookie Notice</div>
            <div class="cookie-banner-desc" data-ru="  cookies   ,   .       ." data-en="We use cookies to save your session, likes and preferences. Without them the site won't work correctly.">
                We use cookies to save your session, likes and preferences. Without them the site won't work correctly.
            </div>
        </div>
        <div class="cookie-banner-btns">
            <button class="cookie-accept-btn" onclick="acceptCookies()" data-ru="  " data-en=" Accept All"> Accept All</button>
            <button class="cookie-decline-btn" onclick="declineCookies()" data-ru=" " data-en="Essential Only">Essential Only</button>
        </div>
    </div>

    
    <script>

        function makeLinksClickable(text) {
            if (!text) return '';
            return text.replace(/(https?:\/\/[^\s<>"]+)/g, '<a href="$1" target="_blank" rel="noopener" style="color:#6b8e23;word-break:break-all;">$1</a>');
        }

        let _newsCache = null;
        let _newsIsAdmin = false;
        let _lastRefCount = 0;

        function renderNews(newsArray, isAdmin) {
            const newsContainer = document.getElementById('news-container');
            if (!newsContainer) return;
            if (!newsArray || newsArray.length === 0) {
                newsContainer.innerHTML = `<div class="news-empty"><i class="fas fa-newspaper"></i><p>${currentLang === 'ru' ? ' ' : 'No news'}</p></div>`;
                return;
            }
            newsContainer.innerHTML = '';
            const userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');
            newsArray.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                if (news.image_url) { newsItem.classList.add('has-image'); newsItem.style.setProperty('--news-image', `url(${news.image_url})`); }
                const date = new Date(news.created_at);
                const formattedDateRu = date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const formattedDateEn = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const userLiked = userLikes[news.id] === 'like';
                const userDisliked = userLikes[news.id] === 'dislike';
                const likes = news.likes || 0;
                const dislikes = news.dislikes || 0;
                const ru = currentLang === 'ru';
                let authorHTML = '';
                if (news.author) {
                    const verifiedBadge = news.author_verified ? '<span class="verified-badge"><i class="fas fa-check"></i></span>' : '';
                    authorHTML = `<div class="news-author"><i class="fas fa-user"></i><span>${news.author}${verifiedBadge}</span></div>`;
                }
                newsItem.innerHTML = `
                    <div class="news-content-wrapper">
                        <div class="news-header">
                            <h3 class="news-title">${ru ? (news.title || ' ') : (news.title_en || news.title || 'Untitled')}</h3>
                            <div class="news-date"><i class="fas fa-clock"></i><span>${ru ? formattedDateRu : formattedDateEn}</span></div>
                            ${authorHTML}
                        </div>
                        <div class="news-content">${makeLinksClickable(ru ? (news.content || '') : (news.content_en || news.content || ''))}</div>
                        <div class="news-footer">
                            <div class="like-buttons">
                                <button class="like-btn ${userLiked ? 'active' : ''}" data-action="like"><i class="fas fa-thumbs-up"></i><span class="like-count">${likes}</span></button>
                                <button class="like-btn dislike-btn ${userDisliked ? 'active' : ''}" data-action="dislike"><i class="fas fa-thumbs-down"></i><span class="like-count">${dislikes}</span></button>
                            </div>
                            <div class="dots-menu-wrap">
                                <button class="dots-menu-btn" data-dots="true">&#8943;</button>
                                <div class="dots-dropdown" id="dots-dd-${news.id}">
                                    <button class="dots-dropdown-item" data-share="true"><i class="fas fa-share-alt"></i> ${ru ? '' : 'Share'}</button>
                                    ${!isAdmin ? `<button class="dots-dropdown-item danger" data-report="true"><i class="fas fa-flag"></i> ${ru ? '' : 'Report'}</button>` : ''}
                                    ${isAdmin ? `<button class="dots-dropdown-item danger" data-delete="true"><i class="fas fa-trash"></i> ${ru ? '' : 'Delete'}</button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>`;
                const likeBtn = newsItem.querySelector('[data-action="like"]');
                const dislikeBtn = newsItem.querySelector('[data-action="dislike"]');
                const dotsBtn = newsItem.querySelector('[data-dots="true"]');
                const shareBtn = newsItem.querySelector('[data-share="true"]');
                likeBtn.addEventListener('click', () => handleNewsLike(news.id, 'like', likeBtn, dislikeBtn));
                dislikeBtn.addEventListener('click', () => handleNewsLike(news.id, 'dislike', likeBtn, dislikeBtn));
                if (dotsBtn) dotsBtn.addEventListener('click', e => {
                    e.stopPropagation();
                    document.querySelectorAll('.dots-dropdown.open, .bp-dots-dropdown.open').forEach(d => d.classList.remove('open'));
                    newsItem.querySelector('.dots-dropdown')?.classList.toggle('open');
                });
                if (shareBtn) shareBtn.addEventListener('click', () => {
                    newsItem.querySelector('.dots-dropdown')?.classList.remove('open');
                    handleNewsShare(news, shareBtn);
                });
                if (!isAdmin) {
                    const repBtn = newsItem.querySelector('[data-report="true"]');
                    if (repBtn) repBtn.addEventListener('click', () => {
                        newsItem.querySelector('.dots-dropdown')?.classList.remove('open');
                        if (!currentAccount) { showInfoBanner(currentLang === 'ru' ? '   ,  !' : ' Please log in to report!', 'error'); return; }
                        showReportModal('news', news.id, news.title || ' ', news.author, news.image_url || null);
                    });
                }
                if (isAdmin) {
                    const delBtn = newsItem.querySelector('[data-delete="true"]');
                    if (delBtn) delBtn.addEventListener('click', () => {
                        newsItem.querySelector('.dots-dropdown')?.classList.remove('open');
                        confirmDeleteNews(news.id, news.title || ' ', newsItem);
                    });
                }
                newsContainer.appendChild(newsItem);
            });
            setTimeout(attachRefBadges, 100);
        }

        async function loadNews() {
            if (!sbClient) return;
            document.getElementById('news-container').innerHTML = '<div class="news-loading"><i class="fas fa-spinner fa-spin"></i></div>';
            try {
                const result = await Promise.all([
                    sbClient.from('news').select('*').order('created_at', { ascending: false }).limit(50),
                    checkNewsAdmin()
                ]);
                _newsCache = result[0].data || [];
                _newsIsAdmin = result[1];
                renderNews(_newsCache, _newsIsAdmin);
            } catch(e) { document.getElementById('news-container').innerHTML = ''; }
        }

        async function confirmDeleteNews(newsId, newsTitle, newsItemEl) {
            const ru = currentLang === 'ru';
            if (!confirm(ru ? `  "${newsTitle}"?\n   .` : `Delete news "${newsTitle}"?\nThis cannot be undone.`)) return;
            await deleteNews(newsId, newsItemEl);
        }

        async function deleteNews(newsId, newsItemEl) {
            const ru = currentLang === 'ru';
            const isAdmin = await checkNewsAdmin();
            if (!isAdmin) {
                showInfoBanner(ru ? '      !' : ' You have no permission to delete news!', 'error');
                return;
            }
            const { error } = await sbClient.from('news').delete().eq('id', newsId);
            if (error) {
                showInfoBanner(ru ? '   : ' + error.message : ' Delete error: ' + error.message, 'error');
                return;
            }
            const { data: check } = await sbClient.from('news').select('id').eq('id', newsId).limit(1);
            if (check && check.length > 0) {
                showInfoBanner(ru ? '       Supabase SQL Editor:\nGRANT DELETE ON news TO anon;' : ' Delete failed  run in Supabase SQL Editor:\nGRANT DELETE ON news TO anon;', 'error');
                return;
            }
            if (_newsCache) _newsCache = _newsCache.filter(n => String(n.id) !== String(newsId));
            newsItemEl.style.transition = 'opacity 0.3s, transform 0.3s';
            newsItemEl.style.opacity = '0';
            newsItemEl.style.transform = 'scale(0.95)';
            setTimeout(() => newsItemEl.remove(), 300);
            showInfoBanner(ru ? '  !' : ' News deleted!', 'success');
        }

        window.deleteNews = deleteNews;

        async function handleNewsLike(newsId, action, likeBtn, dislikeBtn) {
            if (!currentAccount) {
                showInfoBanner(currentLang === 'ru' ? '      !' : ' Login to like news!', 'error');
                return;
            }

            const userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');
            const currentAction = userLikes[newsId];

            const { data, error } = await sbClient.from('news').select('likes, dislikes').eq('id', newsId).single();
            if (error) return;

            let likes = data.likes || 0;
            let dislikes = data.dislikes || 0;

            if (currentAction === action) {
                if (action === 'like') likes = Math.max(0, likes - 1);
                else dislikes = Math.max(0, dislikes - 1);
                delete userLikes[newsId];
            } else {
                if (currentAction === 'like') { likes = Math.max(0, likes - 1); dislikes += 1; }
                else if (currentAction === 'dislike') { dislikes = Math.max(0, dislikes - 1); likes += 1; }
                else { if (action === 'like') likes += 1; else dislikes += 1; }
                userLikes[newsId] = action;
            }

            localStorage.setItem('userLikes', JSON.stringify(userLikes));
            likeBtn.querySelector('.like-count').textContent = likes;
            dislikeBtn.querySelector('.like-count').textContent = dislikes;

            if (userLikes[newsId] === 'like') { likeBtn.classList.add('active'); dislikeBtn.classList.remove('active'); }
            else if (userLikes[newsId] === 'dislike') { dislikeBtn.classList.add('active'); likeBtn.classList.remove('active'); }
            else { likeBtn.classList.remove('active'); dislikeBtn.classList.remove('active'); }

            await sbClient.from('news').update({ likes, dislikes }).eq('id', newsId);
        }

        async function handleNewsShare(news, shareBtn) {
            const shareData = { title: news.title, text: (news.content || '').substring(0, 100) + '...', url: window.location.href };
            try {
                if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                } else {
                    await navigator.clipboard.writeText(`${news.title}\n\n${news.content}\n\n${window.location.href}`);
                    const orig = shareBtn.innerHTML;
                    shareBtn.innerHTML = currentLang === 'ru' ? '<i class="fas fa-check"></i> <span>!</span>' : '<i class="fas fa-check"></i> <span>Copied!</span>';
                    shareBtn.style.background = 'rgba(76,175,80,0.3)';
                    shareBtn.style.borderColor = '#4caf50';
                    setTimeout(() => { shareBtn.innerHTML = orig; shareBtn.style.background = ''; shareBtn.style.borderColor = ''; }, 2000);
                }
            } catch(e) {}
        }

        async function checkNewsAdmin() {
            if (!currentAccount || !sbClient) return false;
            const { data } = await sbClient.from('news_admins').select('nick').ilike('nick', currentAccount.nick).limit(1);
            return data && data.length > 0;
        }

        async function showNewsAdminPanel() {
            const isAdmin = await checkNewsAdmin();
            if (!isAdmin) {
                showInfoBanner(currentLang === 'ru' ? '      !' : ' You have no permission to post news!', 'error');
                return;
            }
            const ru = currentLang === 'ru';
            const ex = document.getElementById('news-admin-modal'); if (ex) ex.remove();
            const overlay = document.createElement('div');
            overlay.className = 'bp-modal-overlay'; overlay.id = 'news-admin-modal';
            const inputStyle = 'width:100%;padding:10px 12px;border:3px solid #8b7355;border-radius:2px;background:#f5eed9;color:#3e2723;font-family:Minecraft,sans-serif;font-size:0.9rem;font-weight:600;outline:none;box-sizing:border-box;margin-top:4px;';
            overlay.innerHTML = `
                <div class="bp-modal" style="max-width:520px;">
                    <h3 style="font-family:Minecraft,sans-serif;color:#4a5d23;margin-bottom:16px;"><img src="${iconUrl('journal_icon.png')}" alt="" style="width:20px;height:20px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:6px;"> ${ru ? ' ' : 'Add News'}</h3>
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;padding:10px;background:rgba(107,142,35,0.1);border-radius:3px;border:2px solid #8b7355;">
                        <i class="fas fa-user" style="color:#6b8e23;"></i>
                        <span style="font-family:Minecraft,sans-serif;font-size:0.85rem;font-weight:700;color:#3e2723;">${currentAccount.nick}${currentAccount.verified ? ' <span class=\"verified-badge\" title=\"\"><i class=\"fas fa-check\"></i></span>' : ''}</span>
                    </div>
                    <div class="bp-form-row" style="margin-bottom:10px;">
                        <label>${ru ? ' (RU)' : 'Title (RU)'}</label>
                        <input id="nadmin-title" style="${inputStyle}" maxlength="200" />
                    </div>
                    <div class="bp-form-row" style="margin-bottom:10px;">
                        <label>${ru ? ' (EN)' : 'Title (EN)'}</label>
                        <input id="nadmin-title-en" style="${inputStyle}" maxlength="200" />
                    </div>
                    <div class="bp-form-row" style="margin-bottom:10px;">
                        <label>${ru ? ' (RU)' : 'Content (RU)'}</label>
                        <textarea id="nadmin-content" style="${inputStyle}height:100px;resize:vertical;" maxlength="5000"></textarea>
                    </div>
                    <div class="bp-form-row" style="margin-bottom:10px;">
                        <label>${ru ? ' (EN)' : 'Content (EN)'}</label>
                        <textarea id="nadmin-content-en" style="${inputStyle}height:100px;resize:vertical;" maxlength="5000"></textarea>
                    </div>
                    <div class="bp-form-row" style="margin-bottom:10px;">
                        <label>${ru ? '  ()' : ' Image (optional)'}</label>
                        <label class="bp-file-label" id="nadmin-image-wrap" for="nadmin-image-input" style="cursor:pointer;">
                            <i class="fas fa-image" style="color:#6b8e23;font-size:1.3rem;"></i>
                            <span id="nadmin-image-label">${ru ? '   ...' : 'Choose or drag here...'}</span>
                            <span class="bp-formats">PNG  JPEG  GIF  WebP</span>
                            <input type="file" id="nadmin-image-input" accept=".png,.jpg,.jpeg,.gif,.webp" />
                        </label>
                        <div class="bp-file-name" id="nadmin-image-name"></div>
                    </div>
                    <div id="nadmin-status" style="font-size:0.85rem;font-weight:600;font-family:Minecraft,sans-serif;margin-bottom:10px;min-height:20px;"></div>
                    <div style="display:flex;gap:10px;">
                        <button class="bp-submit-btn" style="flex:1;margin-top:0;font-size:0.85rem;padding:10px;" onclick="submitNews()">
                            <i class="fas fa-paper-plane"></i> ${ru ? '' : 'Publish'}
                        </button>
                        <button class="bp-submit-btn" style="flex:1;margin-top:0;font-size:0.85rem;padding:10px;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;" onclick="document.getElementById('news-admin-modal').remove()">
                            ${ru ? '' : 'Cancel'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
        }

        async function submitNews() {
            const ru = currentLang === 'ru';
            const title = document.getElementById('nadmin-title').value.trim();
            const titleEn = document.getElementById('nadmin-title-en').value.trim();
            const content = document.getElementById('nadmin-content').value.trim();
            const contentEn = document.getElementById('nadmin-content-en').value.trim();
            const imageFile = document.getElementById('nadmin-image-input')?.files[0] || null;
            const statusEl = document.getElementById('nadmin-status');

            if (!title || !content) {
                statusEl.textContent = ru ? '    !' : ' Title and content are required!';
                statusEl.style.color = '#c62828'; return;
            }
            if (containsProfanity(title) || containsProfanity(titleEn) || containsProfanity(content) || containsProfanity(contentEn)) {
                statusEl.textContent = profanityError(ru); statusEl.style.color = '#c62828'; return;
            }

            if (imageFile) {
                const allowed = ['image/png','image/jpeg','image/gif','image/webp'];
                if (!allowed.includes(imageFile.type)) {
                    statusEl.textContent = ru ? '   . PNG, JPEG, GIF, WebP' : ' Unsupported format. Use PNG, JPEG, GIF or WebP';
                    statusEl.style.color = '#c62828'; return;
                }
            }

            statusEl.textContent = ru ? ' ...' : ' Publishing...';
            statusEl.style.color = '#f57f17';

            let imageUrl = null;
            if (imageFile) {
                statusEl.textContent = ru ? '  ...' : ' Uploading image...';
                const ext = imageFile.name.split('.').pop().toLowerCase();
                const imagePath = 'news/' + Date.now() + '_' + Math.random().toString(36).slice(2,8) + '.' + ext;
                const { error: imgError } = await sbClient.storage
                    .from('buildplates')
                    .upload(imagePath, imageFile, { cacheControl: '3600', upsert: false });
                if (imgError) {
                    statusEl.textContent = ' ' + (imgError.message || 'Upload error');
                    statusEl.style.color = '#c62828'; return;
                }
                const { data: urlData } = sbClient.storage.from('buildplates').getPublicUrl(imagePath);
                imageUrl = urlData.publicUrl;
                statusEl.textContent = ru ? ' ...' : ' Saving...';
            }

            const { error } = await sbClient.from('news').insert([{
                title, title_en: titleEn || title,
                content, content_en: contentEn || content,
                image_url: imageUrl || null,
                author: currentAccount.nick,
                author_verified: currentAccount.verified || false,
                likes: 0, dislikes: 0
            }]);

            if (error) {
                statusEl.textContent = ' ' + (error.message || 'Error');
                statusEl.style.color = '#c62828'; return;
            }

            statusEl.textContent = ru ? '  !' : ' News published!';
            statusEl.style.color = '#2e7d32';
            setTimeout(() => { document.getElementById('news-admin-modal')?.remove(); loadNews(); }, 1200);
        }

        window.showNewsAdminPanel = showNewsAdminPanel;
        window.submitNews = submitNews;

        async function downloadWorld(url, name, event) {
            const ru = currentLang === 'ru';
            const btn = event.currentTarget;
            const origHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const blob = await resp.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                const safeName = (name || 'buildplate').replace(/[^a-zA-Za--0-9 _-]/g, '').trim().replace(/\s+/g, '_') || 'buildplate';
                a.download = safeName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            } catch(e) {
                showInfoBanner(ru ? '  : ' + e.message : ' Download error: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = origHTML;
            }
        }
        window.downloadWorld = downloadWorld;

        window.loadNews = loadNews;
        window.addEventListener('languageChanged', () => { if (_newsCache !== null) renderNews(_newsCache, _newsIsAdmin); });


        function showReportModal(postType, postId, postTitle, postAuthor, imageUrl) {
            const ru = currentLang === 'ru';
            const ex = document.getElementById('report-modal');
            if (ex) ex.remove();
            const overlay = document.createElement('div');
            overlay.id = 'report-modal';
            overlay.className = 'bp-modal-overlay';
            const isDark = document.body.classList.contains('dark-theme');
            const boxStyle = `
                background: ${isDark ? '#2a2a2a' : '#f5eed9'};
                border: 4px solid ${isDark ? '#3a3a3a' : '#8b7355'};
                border-radius: 4px;
                padding: 28px;
                width: 100%;
                max-width: 420px;
                box-shadow: 0 8px 0 ${isDark ? '#0a0a0a' : '#5a4a3a'}, 0 12px 30px rgba(0,0,0,0.5);
                box-sizing: border-box;
                position: relative;
                cursor: default;
                user-select: none;
            `;
            overlay.innerHTML = `
                <div id="report-modal-box" style="${boxStyle}">
                    <div id="report-drag-handle" style="
                        font-family: 'Minecraft', sans-serif;
                        font-size: 1rem;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        color: #c62828;
                        margin-bottom: 16px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        border-bottom: 3px solid #c62828;
                        padding-bottom: 12px;
                        cursor: grab;
                    ">
                        <i class="fas fa-flag"></i> ${ru ? '' : 'Report'}
                        <span style="margin-left:auto;font-size:0.7rem;opacity:0.5;font-family:Minecraft,sans-serif;"> ${ru ? '' : 'drag'}</span>
                    </div>
                    <div style="font-family:Minecraft,sans-serif;font-size:0.82rem;color:${isDark ? '#aaa' : '#8b7355'};margin-bottom:14px;font-weight:600;">
                        ${ru ? ':' : 'Post:'} <b style="color:${isDark ? '#e0e0e0' : '#3e2723'};">${postTitle}</b>
                    </div>
                    <div style="font-family:Minecraft,sans-serif;font-size:0.84rem;font-weight:700;color:${isDark ? '#81c784' : '#4a5d23'};margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;">
                        ${ru ? ' :' : 'Reason:'}
                    </div>
                    <div id="report-reasons" style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px;">
                        ${['spam','inappropriate','misinformation','copyright','other'].map(r => {
                            const labels = {
                                spam: ru ? ' ' : ' Spam',
                                inappropriate: ru ? '  ' : ' Inappropriate content',
                                misinformation: ru ? '  ' : ' Misinformation',
                                copyright: ru ? '   ' : ' Copyright violation',
                                other: ru ? ' ' : ' Other'
                            };
                            return `<label style="display:flex;align-items:center;gap:10px;font-family:Minecraft,sans-serif;font-size:0.85rem;font-weight:600;cursor:pointer;padding:8px 10px;border:2px solid ${isDark ? '#3a3a3a' : '#d4c5a0'};border-radius:2px;background:${isDark ? '#1a1a1a' : '#fffbf0'};color:${isDark ? '#e0e0e0' : '#3e2723'};transition:border-color 0.15s;user-select:none;">
                                <input type="radio" name="report-reason" value="${r}" style="accent-color:#c62828;width:16px;height:16px;flex-shrink:0;"> ${labels[r]}
                            </label>`;
                        }).join('')}
                    </div>
                    <textarea id="report-details" placeholder="${ru ? '  ()...' : 'Additional details (optional)...'}" rows="2" style="width:100%;box-sizing:border-box;font-family:Minecraft,sans-serif;font-size:0.82rem;font-weight:600;padding:10px;border:2px solid ${isDark ? '#3a3a3a' : '#8b7355'};border-radius:2px;background:${isDark ? '#1a1a1a' : '#fffbf0'};color:${isDark ? '#e0e0e0' : '#3e2723'};resize:vertical;margin-bottom:10px;cursor:text;user-select:text;"></textarea>
                    <label class="bp-file-label" style="margin-bottom:14px;" id="report-img-label-wrap">
                        <i class="fas fa-image" style="color:#6b8e23;font-size:1rem;"></i>
                        <span id="report-img-label">${ru ? '   ...' : 'Choose or drag photo...'}</span>
                        <span style="margin-left:auto;font-size:0.72rem;color:${isDark?'#666':'#8b7355'};font-weight:600;white-space:nowrap;">PNG  JPEG  GIF  WebP</span>
                        <input type="file" id="report-img-input" accept="image/*" style="display:none;" onchange="window._reportImgChanged(this)">
                    </label>
                    <div style="display:flex;gap:10px;">
                        <button class="bp-submit-btn" style="background:linear-gradient(180deg,#c62828,#8b1a1a);border-color:#7f0000;box-shadow:0 5px 0 #5a0000;margin-top:0;flex:1;" onclick="submitReport('${postType}','${postId}','${encodeURIComponent(postTitle)}','${encodeURIComponent(postAuthor||'')}','${encodeURIComponent(imageUrl||'')}')">
                            <i class="fas fa-flag"></i> ${ru ? '' : 'Send'}
                        </button>
                        <button class="bp-submit-btn" onclick="document.getElementById('report-modal').remove()" style="background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;margin-top:0;flex:1;">
                            ${ru ? '' : 'Cancel'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });

            window._reportImgChanged = function(input) {
                const label = document.getElementById('report-img-label');
                if (input.files && input.files[0]) {
                    label.textContent = input.files[0].name;
                } else {
                    label.textContent = ru ? '   ...' : 'Choose or drag photo...';
                }
            };

            const box = document.getElementById('report-modal-box');
            const handle = document.getElementById('report-drag-handle');
            if (box && handle) {
                let dragging = false, startX, startY, origX, origY;
                handle.addEventListener('mousedown', e => {
                    dragging = true;
                    startX = e.clientX; startY = e.clientY;
                    const rect = box.getBoundingClientRect();
                    origX = rect.left; origY = rect.top;
                    box.style.position = 'fixed';
                    box.style.left = origX + 'px';
                    box.style.top = origY + 'px';
                    box.style.margin = '0';
                    overlay.style.alignItems = 'flex-start';
                    overlay.style.justifyContent = 'flex-start';
                    handle.style.cursor = 'grabbing';
                    e.preventDefault();
                });
                document.addEventListener('mousemove', e => {
                    if (!dragging) return;
                    box.style.left = (origX + e.clientX - startX) + 'px';
                    box.style.top = (origY + e.clientY - startY) + 'px';
                });
                document.addEventListener('mouseup', () => {
                    dragging = false;
                    handle.style.cursor = 'grab';
                }, { once: true });
            }
        }
        window.showReportModal = showReportModal;

        async function submitReport(postType, postId, postTitleEnc, postAuthorEnc, imageUrlEnc) {
            const ru = currentLang === 'ru';
            const reasonEl = document.querySelector('input[name="report-reason"]:checked');
            if (!reasonEl) { showInfoBanner(ru ? '   !' : ' Please select a reason!', 'error'); return; }
            const details = document.getElementById('report-details')?.value?.trim() || '';
            const postTitle = decodeURIComponent(postTitleEnc);
            const postAuthor = decodeURIComponent(postAuthorEnc);
            const imageUrl = decodeURIComponent(imageUrlEnc);
            const { error } = await sbClient.from('reports').insert([{
                post_type: postType,
                post_id: postId,
                post_title: postTitle,
                post_author: postAuthor,
                image_url: imageUrl || null,
                reporter_nick: currentAccount.nick,
                reason: reasonEl.value,
                details: details || null,
                status: 'pending'
            }]);
            if (error) { showInfoBanner(' ' + error.message, 'error'); return; }
            document.getElementById('report-modal')?.remove();
            showInfoBanner(ru ? '  ! .' : ' Report sent! Thank you.', 'success');
        }
        window.submitReport = submitReport;

        let reportsCurrentFilter = 'pending';

        window.filterReports = function(filter) {
            reportsCurrentFilter = filter;
            const pending = document.getElementById('reports-filter-pending');
            const resolved = document.getElementById('reports-filter-resolved');
            if (filter === 'pending') {
                pending.style.background = 'linear-gradient(180deg,#c62828,#8b1a1a)';
                pending.style.borderColor = '#8b1a1a';
                pending.style.boxShadow = '0 4px 0 #5a0d0d';
                resolved.style.background = 'linear-gradient(180deg,#888,#555)';
                resolved.style.borderColor = '#333';
                resolved.style.boxShadow = '0 4px 0 #222';
            } else {
                resolved.style.background = 'linear-gradient(180deg,#6b8e23,#556b2f)';
                resolved.style.borderColor = '#4a5d23';
                resolved.style.boxShadow = '0 4px 0 #3d4f1c';
                pending.style.background = 'linear-gradient(180deg,#888,#555)';
                pending.style.borderColor = '#333';
                pending.style.boxShadow = '0 4px 0 #222';
            }
            window.loadReports();
        };

        window.loadReports = async function() {
            const ru = currentLang === 'ru';
            const container = document.getElementById('reports-container');
            if (!container) return;
            const isAdm = await checkNewsAdmin();
            if (!isAdm) {
                container.innerHTML = '<div class="news-empty"><i class="fas fa-lock"></i><p>Access denied</p></div>';
                return;
            }
            container.innerHTML = '<div class="news-loading"><i class="fas fa-spinner fa-spin"></i><p>...</p></div>';
            const statusFilter = reportsCurrentFilter === 'pending' ? ['pending'] : ['approved', 'rejected'];
            const { data, error } = await sbClient.from('reports')
                .select('*')
                .in('status', statusFilter)
                .order('created_at', { ascending: false })
                .limit(100);
            if (error || !data || data.length === 0) {
                container.innerHTML = '<div class="news-empty"><i class="fas fa-flag"></i><p>' + (ru ? ' ' : 'No reports') + '</p></div>';
                return;
            }
            container.innerHTML = '';
            data.forEach(rep => {
                const card = document.createElement('div');
                const isDarkMode = document.body.classList.contains('dark-theme');
                card.id = 'report-card-' + rep.id;
                card.style.cssText = `background:${isDarkMode ? '#1e2a1e' : '#f0fff0'};border:2px solid ${isDarkMode ? '#3a5c3a' : '#6b8e23'};border-radius:6px;padding:14px;margin-bottom:12px;box-shadow:0 4px 0 ${isDarkMode ? '#0a1a0a' : '#4a5d23'};transition:opacity 0.5s ease,transform 0.5s ease,max-height 0.5s ease,padding 0.5s ease,margin 0.5s ease;overflow:hidden;`;
                const reasonLabels = { spam: ru ? '' : 'Spam', inappropriate: ru ? ' ' : 'Inappropriate', misinformation: ru ? ' ' : 'Misinformation', copyright: ru ? ' ' : 'Copyright', other: ru ? '' : 'Other' };
                const statusColors = { pending: '#c62828', approved: '#2e7d32', rejected: '#757575' };
                const ICO = 'https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon';
                const iStyle = 'width:16px;height:16px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:3px;';
                const iTimer    = `<img src="${ICO}/timer_icon.png" style="${iStyle}">`;
                const iEmerald  = `<img src="${ICO}/emerald_block.png" style="${iStyle}">`;
                const iRedstone = `<img src="${ICO}/block_of_redstone.png" style="${iStyle}">`;
                const iPost     = `<img src="${ICO}/journal_icon.png" style="${iStyle}">`;
                const iAuthor   = `<img src="${ICO}/mob_of_me_icon.png" style="${iStyle}">`;
                const iReporter = `<img src="${ICO}/settings_icon.png" style="${iStyle}">`;
                const statusLabels = { pending: `${iTimer}${ru ? '' : 'Pending'}`, approved: `${iEmerald}${ru ? '' : 'Approved'}`, rejected: `${iRedstone}${ru ? '' : 'Rejected'}` };
                const date = new Date(rep.created_at).toLocaleDateString(ru ? 'ru-RU' : 'en-US', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const imgPreview = rep.image_url ? `<div style="margin:8px 0;"><img src="${rep.image_url}" style="max-width:100%;max-height:120px;border-radius:3px;border:1px solid #6b8e23;object-fit:cover;"></div>` : '';
                const actionBtns = rep.status === 'pending' ? `
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
                        <button onclick="resolveReport('${rep.id}','${rep.post_type}','${rep.post_id}','${encodeURIComponent(rep.image_url||'')}','${encodeURIComponent(rep.post_author||'')}','approve',false)" style="font-family:Minecraft,sans-serif;font-size:0.78rem;font-weight:700;padding:7px 12px;background:linear-gradient(180deg,#2e7d32,#1b5e20);color:#fff;border:2px solid #1b5e20;border-radius:2px;cursor:pointer;box-shadow:0 3px 0 #0a3d0a;">
                            <img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/emerald_block.png" style="width:14px;height:14px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:3px;"> ${ru ? ' ( )' : 'Approve (delete post)'}
                        </button>
                        <button onclick="resolveReport('${rep.id}','${rep.post_type}','${rep.post_id}','${encodeURIComponent(rep.image_url||'')}','${encodeURIComponent(rep.post_author||'')}','approve',true)" style="font-family:Minecraft,sans-serif;font-size:0.78rem;font-weight:700;padding:7px 12px;background:linear-gradient(180deg,#b71c1c,#7f0000);color:#fff;border:2px solid #7f0000;border-radius:2px;cursor:pointer;box-shadow:0 3px 0 #4a0000;">
                            <img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/block_of_redstone.png" style="width:14px;height:14px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:3px;"> ${ru ? ' + ' : 'Delete + ban'}
                        </button>
                        <button onclick="resolveReport('${rep.id}','${rep.post_type}','${rep.post_id}','${encodeURIComponent(rep.image_url||'')}','${encodeURIComponent(rep.post_author||'')}','reject',false)" style="font-family:Minecraft,sans-serif;font-size:0.78rem;font-weight:700;padding:7px 12px;background:linear-gradient(180deg,#888,#555);color:#fff;border:2px solid #333;border-radius:2px;cursor:pointer;box-shadow:0 3px 0 #222;">
                            <img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/block_of_redstone.png" style="width:14px;height:14px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:3px;"> ${ru ? '' : 'Reject'}
                        </button>
                    </div>` : `<div style="font-family:Minecraft,sans-serif;font-size:0.78rem;color:${statusColors[rep.status]};font-weight:700;margin-top:8px;">${statusLabels[rep.status]}</div>`;
                const textColor = isDarkMode ? '#d0e8d0' : '#3e2723';
                const subColor  = isDarkMode ? '#8ab08a' : '#5a4a3a';
                const dateColor = isDarkMode ? '#6a8a6a' : '#8b7355';
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
                        <div>
                            <span style="font-family:Minecraft,sans-serif;font-size:0.85rem;font-weight:700;color:${isDarkMode ? '#8bc34a' : '#4a5d23'};">${reasonLabels[rep.reason] || rep.reason}</span>
                            <span style="font-family:Minecraft,sans-serif;font-size:0.72rem;color:${dateColor};margin-left:8px;">${date}</span>
                        </div>
                        <span style="font-family:Minecraft,sans-serif;font-size:0.75rem;font-weight:700;color:${statusColors[rep.status]};background:${isDarkMode ? 'rgba(255,255,255,0.07)' : 'rgba(0,0,0,0.06)'};padding:3px 9px;border-radius:10px;border:1px solid ${statusColors[rep.status]}44;display:inline-flex;align-items:center;gap:4px;">${statusLabels[rep.status]}</span>
                    </div>
                    <div style="font-family:Minecraft,sans-serif;font-size:0.82rem;margin-bottom:5px;color:${textColor};display:flex;align-items:center;flex-wrap:wrap;gap:6px;">
                        ${iPost} <b>${ru ? ':' : 'Post:'}</b>&nbsp;<span style="color:${subColor}">${rep.post_title || rep.post_id}</span>
                        ${rep.post_author ? `&nbsp;${iAuthor}&nbsp;<b>${ru ? ':' : 'Author:'}</b>&nbsp;<span style="color:${subColor}">${rep.post_author}</span>` : ''}
                    </div>
                    <div style="font-family:Minecraft,sans-serif;font-size:0.82rem;margin-bottom:6px;color:${textColor};display:flex;align-items:center;gap:6px;">
                        ${iReporter} <b>${ru ? ':' : 'Reporter:'}</b>&nbsp;<span style="color:${subColor}">${rep.reporter_nick}</span>
                    </div>
                    ${rep.details ? `<div style="font-family:Minecraft,sans-serif;font-size:0.78rem;color:${subColor};margin-bottom:6px;background:${isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.04)'};padding:7px 10px;border-radius:4px;border-left:3px solid ${isDarkMode ? '#3a5c3a' : '#6b8e23'};"> ${rep.details}</div>` : ''}
                    ${imgPreview}
                    ${actionBtns}`;
                container.appendChild(card);
            });
        };

        window.resolveReport = async function(reportId, postType, postId, imageUrlEnc, postAuthorEnc, action, banUser) {
            const ru = currentLang === 'ru';
            const imageUrl = decodeURIComponent(imageUrlEnc);
            const postAuthor = decodeURIComponent(postAuthorEnc);
            const confirmMsg = banUser
                ? (ru ? '    ?' : 'Delete post AND ban the author?')
                : action === 'approve'
                    ? (ru ? ' ?' : 'Delete post?')
                    : (ru ? ' ?' : 'Reject this report?');
            if (!confirm(confirmMsg)) return;

            if (action === 'approve') {
                if (postType === 'news') {
                    await sbClient.from('news').delete().eq('id', postId);
                } else if (postType === 'buildplate') {
                    const { data: bp } = await sbClient.from('buildplates').select('image_path,world_path').eq('id', postId).single();
                    if (bp) {
                        const toRemove = [bp.image_path, bp.world_path].filter(Boolean);
                        if (toRemove.length) await sbClient.storage.from('buildplates').remove(toRemove).catch(() => {});
                    }
                    await sbClient.from('buildplates').delete().eq('id', postId);
                }
                if (imageUrl && postType === 'news' && imageUrl.includes('supabase')) {
                    try {
                        const parts = imageUrl.split('/object/public/buildplates/');
                        if (parts[1]) await sbClient.storage.from('buildplates').remove([parts[1]]);
                    } catch(e) {}
                }
                if (banUser && postAuthor) {
                    await sbClient.from('accounts').update({ banned: true }).ilike('nick', postAuthor);
                }
            }

            await sbClient.from('reports')
                .update({ status: action === 'approve' ? 'approved' : 'rejected', resolved_at: new Date().toISOString() })
                .eq('post_id', postId);

            const bannerMsg = action === 'approve'
                ? (banUser ? (ru ? '  ,  !' : ' Post deleted, user banned!') : (ru ? '  !' : ' Post deleted!'))
                : (ru ? '  .' : ' Report rejected.');
            showInfoBanner(bannerMsg, 'success');

            const affectedCards = document.querySelectorAll('[id^="report-card-"]');
            const isDark = document.body.classList.contains('dark-theme');
            affectedCards.forEach(card => {
                const cardReportId = card.id.replace('report-card-', '');
                const hasBtns = card.querySelector('button[onclick*="resolveReport"]');
                if (!hasBtns) return;

                const isApprove = action === 'approve';
                const overlayColor = isApprove ? (banUser ? '#7f0000' : '#2e7d32') : '#555';
                const overlayBorder = isApprove ? (banUser ? '#4a0000' : '#1b5e20') : '#333';
                const overlayIcon = isApprove ? (banUser ? '' : '') : '';
                const overlayText = isApprove
                    ? (banUser ? (ru ? ' + ' : 'Deleted + banned') : (ru ? ' ' : 'Report approved'))
                    : (ru ? ' ' : 'Report rejected');

                const btnsDiv = card.querySelector('div[style*="display:flex;gap:8px"]');
                if (btnsDiv) {
                    btnsDiv.innerHTML = `<div style="font-family:Minecraft,sans-serif;font-size:0.82rem;font-weight:700;color:#fff;background:${overlayColor};border:2px solid ${overlayBorder};border-radius:2px;padding:7px 14px;display:inline-flex;align-items:center;gap:6px;">${overlayIcon} ${overlayText}</div>`;
                }
                card.style.border = '2px solid ' + overlayBorder;
                card.style.boxShadow = '0 4px 0 ' + (isApprove ? (banUser ? '#4a0000' : '#0a3d0a') : '#222');
                card.style.background = isDark ? '#1a1a1a' : (isApprove ? (banUser ? '#fff0f0' : '#f0fff0') : '#f5f5f5');

                setTimeout(() => {
                    const h = card.scrollHeight;
                    card.style.maxHeight = h + 'px';
                    card.style.overflow = 'hidden';
                    requestAnimationFrame(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(30px)';
                        card.style.maxHeight = '0';
                        card.style.padding = '0';
                        card.style.marginBottom = '0';
                    });
                    setTimeout(() => {
                        card.remove();
                        const cont = document.getElementById('reports-container');
                        if (cont && !cont.querySelector('[id^="report-card-"]')) {
                            cont.innerHTML = '<div class="news-empty"><i class="fas fa-flag"></i><p>' + (ru ? ' ' : 'No reports') + '</p></div>';
                        }
                    }, 520);
                }, 1500);
            });
        };

    </script>

    <script>
        let currentLang = 'ru';

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            const tabEl = document.getElementById(tabName + '-tab');
            if (tabEl) tabEl.classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("'" + tabName + "'")) {
                    btn.classList.add('active');
                }
            });
        }

        function switchLanguage(lang, ev) {
            currentLang = lang;

            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            if (ev && ev.target) {
                ev.target.classList.add('active');
            } else {
                //        
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    const onclick = btn.getAttribute('onclick') || '';
                    if (onclick.includes("'" + lang + "'")) btn.classList.add('active');
                });
            }

            document.documentElement.lang = lang;

            document.querySelectorAll('[data-ru][data-en]').forEach(el => {
                const text = el.getAttribute(lang === 'ru' ? 'data-ru' : 'data-en');
                if (!text) return;

                //          
                // (        )
                const ownTextNodes = Array.from(el.childNodes).filter(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim() !== '');
                const hasTranslatableChild = el.querySelector('[data-ru][data-en]');

                if (hasTranslatableChild && ownTextNodes.length === 0) return;

                if (ownTextNodes.length > 0) {
                    ownTextNodes[0].textContent = text;
                    for (let i = 1; i < ownTextNodes.length; i++) ownTextNodes[i].textContent = '';
                } else if (el.children.length === 0) {
                    el.textContent = text;
                } else {
                    //           
                    let lastText = Array.from(el.childNodes).reverse().find(n => n.nodeType === Node.TEXT_NODE);
                    if (lastText) {
                        lastText.textContent = text;
                    } else {
                        el.insertBefore(document.createTextNode(text), el.firstChild);
                    }
                }
            });

            document.querySelectorAll('[data-placeholder-ru][data-placeholder-en]').forEach(input => {
                input.placeholder = input.getAttribute(lang === 'ru' ? 'data-placeholder-ru' : 'data-placeholder-en');
            });

            //   select  
            document.querySelectorAll('select').forEach(select => {
                select.querySelectorAll('option').forEach(opt => {
                    const label = opt.getAttribute(lang === 'ru' ? 'data-ru' : 'data-en');
                    if (label) opt.textContent = label;
                });
            });

            localStorage.setItem('preferred-language', lang);

            document.querySelectorAll('.bp-download-btn span').forEach(span => {
                span.textContent = lang === 'ru' ? '' : 'Download';
            });

            if (_newsCache !== null) renderNews(_newsCache, _newsIsAdmin);
            if (typeof renderRefXPBar === 'function') renderRefXPBar(_lastRefCount);
            if (typeof _bpAllData !== 'undefined' && _bpAllData && _bpAllData.length > 0) applyBpFilters();
            if (typeof _galleryCache !== 'undefined' && _galleryCache && _galleryCache.length > 0) filterGallery();

            if (typeof updateDailyLimitUI === 'function') updateDailyLimitUI();

            const refCountText = document.getElementById('ref-count-text');
            if (refCountText) {
                const currentCount = parseInt(refCountText.dataset.count || '0') || 0;
                refCountText.dataset.count = currentCount;
                refCountText.textContent = lang === 'ru' ? `${currentCount} ` : `${currentCount} referrals`;
            }

            window.dispatchEvent(new Event('languageChanged'));
        }

        function toggleTheme() {
            const body = document.body;
            const themeBtn = document.querySelector('.theme-btn');
            const themeIcon = themeBtn.querySelector('.theme-icon');
            
            body.classList.toggle('dark-theme');
            const isDark = body.classList.contains('dark-theme');
            
            if (isDark) {
                themeIcon.textContent = '';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.textContent = '';
                localStorage.setItem('theme', 'light');
            }

            rerenderAuthCaptcha(isDark ? 'dark' : 'light');
        }

        function rerenderAuthCaptcha(theme) {
            const wrap = document.getElementById('auth-captcha-wrap');
            if (!wrap) return;
            wrap.innerHTML = '';
            const isCompact = window.innerWidth <= 480;
            const div = document.createElement('div');
            div.className = 'cf-turnstile';
            div.id = 'auth-turnstile';
            div.setAttribute('data-sitekey', '0x4AAAAAACZyA1UOix1SiYwF');
            div.setAttribute('data-theme', theme || 'light');
            div.setAttribute('data-size', isCompact ? 'compact' : 'normal');
            wrap.appendChild(div);
            if (window.turnstile) window.turnstile.render(div);
        }

        function copyZeroTier() {
            const code = '3b19b3a716030d76';
            copyToClipboard(code);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showSuccess();
                }).catch(err => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            tempInput.style.position = 'fixed';
            tempInput.style.top = '0';
            tempInput.style.left = '0';
            tempInput.style.opacity = '0';
            document.body.appendChild(tempInput);
            tempInput.focus();
            tempInput.select();
            
            try {
                document.execCommand('copy');
                showSuccess();
            } catch (err) {
                console.error('Copy failed:', err);
            }
            
            document.body.removeChild(tempInput);
        }

        function showSuccess() {
            const btn = document.querySelector('.copy-btn');
            const originalHTML = btn.innerHTML;
            
            const copiedText = currentLang === 'ru' ? 
                '<i class="fas fa-check"></i> <span>!</span>' : 
                '<i class="fas fa-check"></i> <span>Copied!</span>';
            
            btn.innerHTML = copiedText;
            btn.style.background = '#28a745';
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '';
            }, 2000);
        }

        window.addEventListener('DOMContentLoaded', () => {
            let savedLang; try { savedLang = localStorage.getItem('preferred-language'); } catch(e) { savedLang = null; }
            const initLang = (savedLang === 'en') ? 'en' : 'ru';
            //   switchLanguage    
            switchLanguage(initLang);

            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.querySelector('.theme-icon');
            
            if (savedTheme) {
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-theme');
                    themeIcon.textContent = '';
                } else {
                    themeIcon.textContent = '';
                }
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    document.body.classList.add('dark-theme');
                    themeIcon.textContent = '';
                } else {
                    themeIcon.textContent = '';
                }
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                const manualTheme = localStorage.getItem('theme');
                if (!manualTheme) {
                    if (e.matches) {
                        document.body.classList.add('dark-theme');
                        themeIcon.textContent = '';
                    } else {
                        document.body.classList.remove('dark-theme');
                        themeIcon.textContent = '';
                    }
                }
            });
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://sqlylxcnoqehorlgmztm.supabase.co';

        function iconUrl(filename) {
            return `${SUPABASE_URL}/storage/v1/object/public/icons/icon/${filename}`;
        }

        function applyMceIcons() {
            const map = {
                'home':       'shop_icon.png',
                'news':       'journal_icon.png',
                'buildplates':'buildplate_icon.png',
                'reports':    'settings_icon.png',
                'gallery':    'paint_item.png',
            };
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const onclick = tab.getAttribute('onclick') || '';
                const match = onclick.match(/'(\w+)'/);
                if (!match) return;
                const tabName = match[1];
                const file = map[tabName];
                if (!file) return;
                const iconSpan = tab.querySelector('.nav-icon');
                if (iconSpan) iconSpan.innerHTML = `<img src="${iconUrl(file)}" alt="${tabName}">`;
            });

            document.querySelectorAll('[data-icon]').forEach(el => {
                const file = el.getAttribute('data-icon');
                if (!file) return;
                if (el.querySelector('img.mce-icon')) return;
                const img = `<img class="mce-icon" src="${iconUrl(file)}" alt="" style="width:28px;height:28px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:8px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));">`;
                el.insertAdjacentHTML('afterbegin', img);
            });

            const timerImg = document.querySelector('#bp-daily-limit img');
            if (timerImg) timerImg.src = iconUrl('timer_icon.png');

            const mineBtnIcon = document.getElementById('mine-btn-icon');
            if (mineBtnIcon) mineBtnIcon.src = iconUrl('mob_of_me_icon.png');

            const cookieUrl = iconUrl('cookie_item.png');
            const cookieBannerIcon = document.getElementById('cookie-icon-banner');
            if (cookieBannerIcon) cookieBannerIcon.src = cookieUrl;
            const cookieObserver = new MutationObserver(() => {
                const modalIcon = document.getElementById('cookie-icon-modal');
                if (modalIcon && !modalIcon.src.includes('cookie_item')) {
                    modalIcon.src = cookieUrl;
                }
            });
            cookieObserver.observe(document.body, { childList: true, subtree: false });
        }
        const SUPABASE_ANON_KEY = 'sb_publishable_nhY94pR0kxA70QI__Zy_Hw_OD5nUm7F';

        let sbClient = null;
        try {
            if (SUPABASE_ANON_KEY === 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxbHlseGNub3FlaG9ybGdtenRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0OTUwMDgsImV4cCI6MjA4NzA3MTAwOH0.stZw4M4I3W0fbVD1X-rP8eDWYWyye2MTswqSTR_UC3Y') {
                console.warn('Supabase:  ANON KEY!');
            } else {
                sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch(e) {
            console.error('Supabase init error:', e);
        }

        if (typeof window.loadNews === 'function') window.loadNews();

        document.getElementById('bp-image-input').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('bp-image-label').textContent = ' ' + file.name;
                document.getElementById('bp-image-name').textContent = '';
            }
        });

        (function() {
            const wrap = document.getElementById('bp-image-label-wrap');
            if (!wrap) return;
            const input = document.getElementById('bp-image-input');
            const nameEl = document.getElementById('bp-image-name');
            const labelSpan = document.getElementById('bp-image-label');
            const allowed = ['image/png','image/jpeg','image/gif','image/webp'];
            wrap.addEventListener('dragover', e => { e.preventDefault(); wrap.classList.add('drag-over'); });
            wrap.addEventListener('dragleave', e => { if (!wrap.contains(e.relatedTarget)) wrap.classList.remove('drag-over'); });
            wrap.addEventListener('drop', e => {
                e.preventDefault(); wrap.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (!file) return;
                if (!allowed.includes(file.type)) {
                    nameEl.style.color = '#c62828';
                    nameEl.textContent = currentLang === 'ru' ? '   ' : ' Unsupported format';
                    return;
                }
                const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files;
                labelSpan.textContent = ' ' + file.name;
                nameEl.style.color = ''; nameEl.textContent = '';
            });
        })();

        document.addEventListener('dragover', e => {
            const wrap = e.target.closest('#nadmin-image-wrap');
            if (wrap) { e.preventDefault(); wrap.classList.add('drag-over'); }
        });
        document.addEventListener('dragleave', e => {
            const wrap = e.target.closest('#nadmin-image-wrap');
            if (wrap && !wrap.contains(e.relatedTarget)) wrap.classList.remove('drag-over');
        });
        document.addEventListener('drop', e => {
            const wrap = e.target.closest('#nadmin-image-wrap');
            if (!wrap) return;
            e.preventDefault(); wrap.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (!file) return;
            const allowed = ['image/png','image/jpeg','image/gif','image/webp'];
            const nameEl = document.getElementById('nadmin-image-name');
            const labelSpan = document.getElementById('nadmin-image-label');
            if (!allowed.includes(file.type)) {
                if (nameEl) { nameEl.style.color = '#c62828'; nameEl.textContent = currentLang === 'ru' ? '   ' : ' Unsupported format'; }
                return;
            }
            const input = document.getElementById('nadmin-image-input');
            if (input) { const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files; }
            if (labelSpan) labelSpan.textContent = ' ' + file.name;
            if (nameEl) { nameEl.style.color = ''; nameEl.textContent = ''; }
        });
        document.addEventListener('change', e => {
            if (e.target.id !== 'nadmin-image-input') return;
            const file = e.target.files[0];
            const labelSpan = document.getElementById('nadmin-image-label');
            if (file && labelSpan) labelSpan.textContent = ' ' + file.name;
        });

        document.getElementById('bp-world-input').addEventListener('change', async function() {
            const file = this.files[0];
            const nameEl = document.getElementById('bp-world-name');
            if (!file) return;

            if (file.name.toLowerCase() !== 'world') {
                nameEl.style.color = '#c62828';
                nameEl.textContent = currentLang === 'ru'
                    ? '    "world" ( )!'
                    : ' File must be named "world" (no extension)!';
                this.value = '';
                return;
            }

            if (file.size === 0) {
                nameEl.style.color = '#c62828';
                nameEl.textContent = currentLang === 'ru' ? '  !' : ' File is empty!';
                this.value = '';
                return;
            }

            nameEl.style.color = '#2e7d32';
            nameEl.textContent = ' ' + file.name + ' (' + formatSize(file.size) + ')';
        });

        document.addEventListener('dragover', e => {
            const wrap = e.target.closest('#report-img-label-wrap');
            if (wrap) { e.preventDefault(); wrap.classList.add('drag-over'); }
        });
        document.addEventListener('dragleave', e => {
            const wrap = e.target.closest('#report-img-label-wrap');
            if (wrap && !wrap.contains(e.relatedTarget)) wrap.classList.remove('drag-over');
        });
        document.addEventListener('drop', e => {
            const wrap = e.target.closest('#report-img-label-wrap');
            if (!wrap) return;
            e.preventDefault();
            wrap.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (!file) return;
            const allowed = ['image/png','image/jpeg','image/gif','image/webp'];
            const labelSpan = document.getElementById('report-img-label');
            const input = document.getElementById('report-img-input');
            const ru = window.currentLang === 'ru';
            if (!allowed.includes(file.type)) {
                if (labelSpan) labelSpan.textContent = ru ? '   ' : ' Unsupported format';
                return;
            }
            const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files;
            if (labelSpan) labelSpan.textContent = ' ' + file.name;
        });

        document.addEventListener('dragover', e => {
            if (e.target.closest('#bp-world-label-wrap')) { e.preventDefault(); document.getElementById('bp-world-label-wrap').classList.add('drag-over'); }
        });
        document.addEventListener('dragleave', e => {
            const wrap = document.getElementById('bp-world-label-wrap');
            if (wrap && !wrap.contains(e.relatedTarget)) wrap.classList.remove('drag-over');
        });
        document.addEventListener('drop', e => {
            const wrap = document.getElementById('bp-world-label-wrap');
            if (!wrap || !wrap.contains(e.target)) return;
            e.preventDefault();
            wrap.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (!file) return;
            const nameEl = document.getElementById('bp-world-name');
            const labelSpan = document.getElementById('bp-world-label');
            const input = document.getElementById('bp-world-input');
            if (file.name.toLowerCase() !== 'world') {
                nameEl.style.color = '#c62828';
                nameEl.textContent = currentLang === 'ru'
                    ? '    "world" ( )!'
                    : ' File must be named "world" (no extension)!';
                return;
            }
            if (file.size === 0) {
                nameEl.style.color = '#c62828';
                nameEl.textContent = currentLang === 'ru' ? '  !' : ' File is empty!';
                return;
            }
            const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files;
            if (labelSpan) labelSpan.textContent = ' ' + file.name;
            nameEl.style.color = '#2e7d32';
            nameEl.textContent = ' ' + file.name + ' (' + formatSize(file.size) + ')';
        });

        async function checkImageMagicBytes(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arr = new Uint8Array(e.target.result);
                    if (arr[0] === 0x89 && arr[1] === 0x50 && arr[2] === 0x4E && arr[3] === 0x47) {
                        resolve({ valid: true, type: 'png' });
                    } else if (arr[0] === 0xFF && arr[1] === 0xD8 && arr[2] === 0xFF) {
                        resolve({ valid: true, type: 'jpeg' });
                    } else {
                        resolve({ valid: false });
                    }
                };
                reader.readAsArrayBuffer(file.slice(0, 4));
            });
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1024 / 1024).toFixed(1) + ' MB';
        }

        const SITE_URL_REF = window.location.origin + window.location.pathname;

        const REF_MOB_BASE = `https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/ref-badges/`;

        function getRefBadgeHTML(count, large = false) {
            const size = large ? '40px' : '24px';
            if (count >= 200) return `<img class="ref-mob-badge" src="${REF_MOB_BASE}jolly_llama_mob.gif" width="${size}" height="${size}" title="${count}   Jolly Llama " />`;
            if (count >= 100) return `<img class="ref-mob-badge" src="${REF_MOB_BASE}furnace_golem_mob.gif" width="${size}" height="${size}" title="${count}   Furnace Golem " />`;
            if (count >= 10)  return `<img class="ref-mob-badge" src="${REF_MOB_BASE}horned_sheep_mob.gif" width="${size}" height="${size}" title="${count}   Horned Sheep " />`;
            if (count >= 1)   return `<img class="ref-mob-badge" src="${REF_MOB_BASE}rabbit_mob.gif" width="${size}" height="${size}" title="${count}   Rabbit " />`;
            return '';
        }

        async function loadRefData(nick) {
            if (!sbClient || !nick) return 0;
            try {
                const { data, error } = await sbClient.from('referrals').select('id').eq('referrer_nick', nick);
                if (error) return 0;
                return data ? data.length : 0;
            } catch(e) { return 0; }
        }

        const REF_XP_TIERS = [
            { threshold: 1,   mob: 'rabbit_mob.gif',       nameRu: '',       nameEn: 'Rabbit'        },
            { threshold: 10,  mob: 'horned_sheep_mob.gif',  nameRu: '. ',    nameEn: 'H. Sheep'      },
            { threshold: 100, mob: 'furnace_golem_mob.gif', nameRu: '',        nameEn: 'F. Golem'      },
            { threshold: 200, mob: 'jolly_llama_mob.gif',   nameRu: '',         nameEn: 'J. Llama'      },
        ];

        function renderRefXPBar(count) {
            const container = document.getElementById('ref-xp-bar-container');
            if (!container) return;
            const ru = currentLang === 'ru';

            let earnedIdx = -1;
            for (let i = REF_XP_TIERS.length - 1; i >= 0; i--) {
                if (count >= REF_XP_TIERS[i].threshold) { earnedIdx = i; break; }
            }
            const isMaxed = earnedIdx === REF_XP_TIERS.length - 1;

            const curTier = earnedIdx >= 0 ? REF_XP_TIERS[earnedIdx] : null;
            const nextTier = !isMaxed ? REF_XP_TIERS[earnedIdx + 1] : null;

            let pct = 0, barCountText = '';
            if (!isMaxed) {
                const from = curTier ? curTier.threshold : 0;
                const to   = nextTier.threshold;
                pct = Math.min(100, Math.max(0, ((count - from) / (to - from)) * 100));
                barCountText = `${count} / ${to} ${ru ? '' : 'referrals'}`;
            } else {
                pct = 100;
                barCountText = ru ? '   ' : ' MAX LEVEL ';
            }

            const curMobHTML = curTier
                ? `<img src="${REF_MOB_BASE}${curTier.mob}" title="${ru ? curTier.nameRu : curTier.nameEn}">`
                : `<div class="xp-mob-placeholder" style="width:36px;height:36px;background:#1a1a1a;border:2px solid #333;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-family:Minecraft,sans-serif;color:#555;">0</div>`;
            const curName = curTier
                ? `<div class="ref-xp-mob-name earned">${ru ? curTier.nameRu : curTier.nameEn}</div>`
                : `<div class="ref-xp-mob-name">${ru ? '' : 'None'}</div>`;

            const nextMobHTML = nextTier
                ? `<img src="${REF_MOB_BASE}${nextTier.mob}" title="${ru ? nextTier.nameRu : nextTier.nameEn}" style="opacity:0.45;filter:grayscale(0.5) drop-shadow(0 2px 6px rgba(0,0,0,0.8));">`
                : `<img src="${REF_MOB_BASE}jolly_llama_mob.gif" title="MAX">`;
            const nextName = nextTier
                ? `<div class="ref-xp-mob-name next">${ru ? nextTier.nameRu : nextTier.nameEn}</div>`
                : `<div class="ref-xp-mob-name earned">MAX</div>`;

            let tiersHTML = '';
            REF_XP_TIERS.forEach((tier, i) => {
                const isEarned = count >= tier.threshold;
                const isCurrent = i === earnedIdx + 1 && !isMaxed;
                const connFilled = i <= earnedIdx;
                if (i > 0) {
                    tiersHTML += `<div class="ref-xp-tier-connector${connFilled ? ' filled' : ''}"></div>`;
                }
                tiersHTML += `
                    <div class="ref-xp-tier-item ${isEarned ? 'earned' : 'locked'}" title="${ru ? tier.nameRu : tier.nameEn}: ${tier.threshold}+ ${ru ? '' : 'refs'}">
                        <img src="${REF_MOB_BASE}${tier.mob}" alt="${ru ? tier.nameRu : tier.nameEn}">
                        <div class="ref-xp-tier-thresh${isEarned ? ' earned' : ''}">${tier.threshold}+</div>
                    </div>`;
            });

            container.innerHTML = `
                <div class="ref-xp-wrap">
                    <div class="ref-xp-label"><img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/adventure_icon.png" width="14" height="14" style="object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:4px;"> ${ru ? '  ' : ' Referral XP'}</div>
                    <div class="ref-xp-row">
                        <div class="ref-xp-mob-box">
                            ${curMobHTML}
                            ${curName}
                        </div>
                        <div class="ref-xp-bar-section">
                            <div class="ref-xp-bar-bg">
                                <div class="ref-xp-bar-fill" id="ref-xp-fill" style="width:0%"></div>
                            </div>
                            <div class="ref-xp-bar-count${isMaxed ? ' maxed' : ''}">${barCountText}</div>
                        </div>
                        <div class="ref-xp-mob-box">
                            ${nextMobHTML}
                            ${nextName}
                        </div>
                    </div>
                    <div class="ref-xp-tiers">${tiersHTML}</div>
                </div>`;

            requestAnimationFrame(() => {
                const fill = document.getElementById('ref-xp-fill');
                if (fill) {
                    setTimeout(() => {
                        fill.style.width = pct + '%';
                        fill.classList.add('animate');
                        setTimeout(() => fill.classList.remove('animate'), 700);
                    }, 150);
                }
            });
        }

        async function showRefBlock(nick) {
            const block = document.getElementById('ref-profile-block');
            const input = document.getElementById('ref-link-input');
            const countText = document.getElementById('ref-count-text');
            if (!block || !input) return;
            const refLink = `${SITE_URL_REF}?ref=${encodeURIComponent(nick)}`;
            input.value = refLink;
            block.style.display = 'block';
            const count = await loadRefData(nick);
            const ru = currentLang === 'ru';
            countText.dataset.count = count; countText.textContent = ru ? `${count} ` : `${count} referrals`;
            _lastRefCount = count;
            renderRefXPBar(count);
        }

        window.copyRefLink = function() {
            const input = document.getElementById('ref-link-input');
            if (!input) return;
            navigator.clipboard.writeText(input.value).then(() => {
                showInfoBanner(currentLang === 'ru' ? '   !' : ' Referral link copied!', 'success');
            }).catch(() => {
                input.select(); document.execCommand('copy');
                showInfoBanner(currentLang === 'ru' ? ' !' : ' Copied!', 'success');
            });
        };

        (function checkRefParam() {
            const params = new URLSearchParams(window.location.search);
            const ref = params.get('ref');
            if (ref) {
                localStorage.setItem('pending_referrer', ref);
                const url = new URL(window.location.href);
                url.searchParams.delete('ref');
                window.history.replaceState({}, '', url.toString());
            }
        })();

        async function recordReferral(newNick) {
            const referrer = localStorage.getItem('pending_referrer');
            if (!referrer || !sbClient) return;
            if (referrer.toLowerCase() === newNick.toLowerCase()) return;
            try {
                const { data: ex } = await sbClient.from('referrals').select('id').eq('referred_nick', newNick).limit(1);
                if (ex && ex.length > 0) {
                    localStorage.removeItem('pending_referrer');
                    return;
                }
                const { data: dup } = await sbClient.from('referrals').select('id')
                    .eq('referrer_nick', referrer).eq('referred_nick', newNick).limit(1);
                if (dup && dup.length > 0) {
                    localStorage.removeItem('pending_referrer');
                    return;
                }
                const { error: insErr } = await sbClient.from('referrals').insert({ referrer_nick: referrer, referred_nick: newNick });
                if (!insErr) {
                    localStorage.removeItem('pending_referrer');
                }
            } catch(e) {}
        }

        async function attachRefBadges() {
            if (!sbClient) return;
            try {
                const { data } = await sbClient.from('referrals').select('referrer_nick');
                if (!data) return;
                const counts = {};
                data.forEach(r => { counts[r.referrer_nick] = (counts[r.referrer_nick] || 0) + 1; });
                document.querySelectorAll('.news-author span, .bp-card-author span').forEach(el => {
                    const nick = Array.from(el.childNodes)
                        .filter(n => n.nodeType === 3)
                        .map(n => n.textContent.trim())
                        .join('').trim();
                    const count = counts[nick] || 0;
                    if (count >= 1 && !el.parentElement.querySelector('.ref-mob-badge')) {
                        el.insertAdjacentHTML('afterend', getRefBadgeHTML(count));
                    }
                });
            } catch(e) {}
        }

        let currentAccount = null; // { nick, email, verified, email_verified, avatar_url }
        let authMode = 'login'; // 'login' | 'register'

        function generateToken(len = 48) {
            const arr = new Uint8Array(len);
            crypto.getRandomValues(arr);
            return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function hashPassword(pass) {
            const enc = new TextEncoder().encode(pass);
            const buf = await crypto.subtle.digest('SHA-256', enc);
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function sendEmail(templateId, params) {
            if (EMAILJS_PUBLIC_KEY === 'YOUR_EMAILJS_PUBLIC_KEY') {
                console.warn('EmailJS      . :', params);
                return;
            }
            await emailjs.send(EMAILJS_SERVICE_ID, templateId, params);
        }

        function toggleAuthMode() {
            const ru = currentLang === 'ru';
            authMode = authMode === 'login' ? 'register' : 'login';
            const isReg = authMode === 'register';

            document.getElementById('bp-auth-btn-text').textContent = isReg
                ? (ru ? '' : 'Register')
                : (ru ? '' : 'Login');
            document.getElementById('bp-auth-mode-title').textContent = isReg
                ? (ru ? '' : 'Register')
                : (ru ? '' : 'Login');
            document.getElementById('bp-auth-toggle-btn').textContent = isReg
                ? (ru ? '  ? ' : 'Already have account? Login')
                : (ru ? ' ? ' : 'No account? Register');

            document.getElementById('bp-email-row').style.display  = isReg ? 'block' : 'none';
            document.getElementById('bp-pass2-row').style.display  = isReg ? 'block' : 'none';
            document.getElementById('bp-forgot-btn').style.display = isReg ? 'none'  : 'inline';

            document.getElementById('bp-auth-status').className = 'bp-auth-status';
            document.getElementById('bp-auth-status').textContent = '';
        }

        function showAuthStatus(type, msg) {
            const el = document.getElementById('bp-auth-status');
            el.className = 'bp-auth-status ' + type;
            el.textContent = msg;
        }

        const _badWords = [
            '','','','','','',
            '','','','','','','','','',
            '','','','','','',
            '','','','','','','','','','','','','',
            '','','','',
            '','','',
            '','',
            '','','','yoba',
            '','','','','',
            '','','',
            '','',
            '','',
            '','',
            '','','','',
            '','',
            '','','','',
            '','','','',
            '','',
            '','',
            '','',
            '','',
            '','','','',
            'fuck','fucked','fucker','fucking','fucks','motherfucker','motherfucking',
            'shit','shits','shitty','bullshit',
            'bitch','bitches','bitchy',
            'ass','asshole','assholes','asses',
            'cunt','cunts',
            'dick','dicks','dickhead',
            'cock','cocks','cocksucker',
            'pussy','pussies',
            'nigger','niggers','nigga','niggas',
            'faggot','faggots','fag',
            'bastard','bastards',
            'whore','whores',
            'slut','sluts',
            'piss','pissed',
            'damn','damnit',
            'retard','retarded','retards',
            'twat','twats',
            'wanker','wankers',
        ];

        function containsProfanity(text) {
            if (!text) return false;
            const normalized = text.toLowerCase()
                .replace(/[a]/g,'').replace(/[e]/g,'').replace(/[o]/g,'')
                .replace(/[p]/g,'').replace(/[c]/g,'').replace(/[y]/g,'')
                .replace(/[x]/g,'').replace(/[b]/g,'').replace(/[0]/g,'')
                .replace(/[1]/g,'').replace(/[3]/g,'').replace(/[@]/g,'')
                .replace(/\*/g,'').replace(/\./g,'').replace(/_/g,'').replace(/-/g,'');
            return _badWords.some(w => normalized.includes(w));
        }

        function profanityError(ru) {
            return ru
                ? '    !'
                : ' Text contains inappropriate words!';
        }

        async function doAuth() {
            const ru = currentLang === 'ru';
            const nick = document.getElementById('bp-auth-nick').value.trim();
            const pass = document.getElementById('bp-auth-pass').value;

            if (!nick) { showAuthStatus('err', ru ? '  !' : ' Enter nickname!'); return; }
            if (containsProfanity(nick)) { showAuthStatus('err', profanityError(ru)); return; }
            if (!pass || pass.length < 4) { showAuthStatus('err', ru ? '   4 !' : ' Password min 4 chars!'); return; }
            if (!sbClient) { showAuthStatus('err', ' Supabase  '); return; }

            const captchaVal = document.querySelector('[name="cf-turnstile-response"]')?.value;
            if (!captchaVal) {
                showAuthStatus('err', ru ? '   !' : ' Please complete the captcha!');
                return;
            }

            if (authMode === 'register') {
                const email = document.getElementById('bp-auth-email').value.trim();
                const pass2 = document.getElementById('bp-auth-pass2').value;
                if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    showAuthStatus('err', ru ? '   Email!' : ' Enter a valid email!');
                    return;
                }
                if (pass !== pass2) {
                    showAuthStatus('err', ru ? '   !' : ' Passwords do not match!');
                    return;
                }
            }

            showAuthStatus('info', ru ? ' ...' : ' Checking...');
            const passHash = await hashPassword(pass);

            try {
                const { data, error } = await sbClient
                    .from('accounts')
                    .select('nick, password_hash, verified, avatar_url, email, email_verified, banned')
                    .ilike('nick', nick)
                    .limit(1);
                if (error) throw error;

                if (authMode === 'register') {
                    if (data && data.length > 0) {
                        showAuthStatus('err', ru ? '    !' : ' Nickname already taken!');
                        return;
                    }
                    const email = document.getElementById('bp-auth-email').value.trim();

                    const { data: emailCheck } = await sbClient.from('accounts').select('nick').ilike('email', email).limit(1);
                    if (emailCheck && emailCheck.length > 0) {
                        showAuthStatus('err', ru ? '  email  !' : ' Email already in use!');
                        return;
                    }

                    const verifyToken = generateToken();
                    const { error: insErr } = await sbClient.from('accounts').insert({
                        nick, password_hash: passHash, verified: false,
                        avatar_url: null, email, email_verified: false,
                        email_verify_token: verifyToken, reset_token: null, reset_token_expires: null
                    });
                    if (insErr) throw insErr;

                    await recordReferral(nick);

                    const verifyLink = `${SITE_URL}?verify=${verifyToken}`;
                    try {
                        await sendEmail(EMAILJS_VERIFY_TPL, {
                            to_email: email, to_name: nick,
                            verify_link: verifyLink, site_url: SITE_URL
                        });
                    } catch(emailErr) {}

                    const exPending = document.getElementById('bp-verify-pending');
                    if (exPending) exPending.remove();
                    const pendingBox = document.createElement('div');
                    pendingBox.id = 'bp-verify-pending';
                    pendingBox.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
                    const gmailDomain = email.split('@')[1] || '';
                    let mailUrl = 'https://mail.google.com';
                    if (gmailDomain.includes('yandex') || gmailDomain.includes('ya.ru')) mailUrl = 'https://mail.yandex.ru';
                    else if (gmailDomain.includes('mail.ru') || gmailDomain.includes('bk.ru') || gmailDomain.includes('inbox.ru') || gmailDomain.includes('list.ru')) mailUrl = 'https://e.mail.ru';
                    const pendingTitle = ru ? '  email!' : 'Verify your email!';
                    const pendingBody = ru ? ('   <b>' + email + '</b>.<br>        .') : ('Email sent to <b>' + email + '</b>.<br>Click the link  then you can log in.');
                    const pendingWarn = ru ? '   24    .' : 'Account will be deleted in 24h if not verified.';
                    const pendingBtn = ru ? ' ' : 'Open mail';
                    const pendingSpam = ru ? '      .' : 'Check your Spam folder if you do not see it.';
                    pendingBox.innerHTML = '<div style="background:#fffbf0;border:3px solid #6b8e23;border-radius:6px;padding:28px 24px;text-align:center;box-shadow:0 8px 0 #4a5d23,0 20px 60px rgba(0,0,0,0.5);max-width:380px;width:100%;">'
                        + '<div style="font-size:2.5rem;margin-bottom:12px;"></div>'
                        + '<div style="font-family:Minecraft,sans-serif;font-size:1rem;font-weight:700;color:#4a5d23;margin-bottom:10px;">' + pendingTitle + '</div>'
                        + '<div style="font-family:Minecraft,sans-serif;font-size:0.83rem;font-weight:600;color:#5a4a3a;line-height:1.7;margin-bottom:10px;">' + pendingBody + '</div>'
                        + '<div style="font-family:Minecraft,sans-serif;font-size:0.76rem;color:#c62828;font-weight:700;margin-bottom:18px;"> ' + pendingWarn + '</div>'
                        + '<a href="' + mailUrl + '" target="_blank" style="display:inline-block;font-family:Minecraft,sans-serif;font-size:0.85rem;font-weight:700;padding:10px 22px;background:linear-gradient(180deg,#6b8e23,#556b2f);color:#fff;border:2px solid #4a5d23;border-radius:2px;text-decoration:none;box-shadow:0 4px 0 #3d4f1c;"> ' + pendingBtn + '</a>'
                        + '<div style="font-family:Minecraft,sans-serif;font-size:0.72rem;color:#8b7355;margin-top:10px;">' + pendingSpam + '</div>'
                        + '</div>';
                    document.body.appendChild(pendingBox);
                } else {
                    if (!data || data.length === 0) {
                        showAuthStatus('err', ru ? '   !' : ' Account not found!');
                        return;
                    }
                    const acc = data[0];
                    if (acc.password_hash !== passHash) {
                        showAuthStatus('err', ru ? '  !' : ' Wrong password!');
                        return;
                    }
                    if (acc.banned) {
                        showAuthStatus('err', ru
                            ? '   .'
                            : ' Your account has been banned.');
                        return;
                    }
                    if (!acc.email_verified) {
                        showAuthStatus('err', ru
                            ? '   email!  .'
                            : ' Please verify your email first! Check your inbox.');
                        return;
                    }
                    showAuthStatus('ok', ru ? '  !' : ' Logged in!');
                    await recordReferral(acc.nick);
                    setLoggedIn(acc.nick, acc.verified, acc.avatar_url, acc.email, acc.email_verified, acc.created_at);
                }
                if (window.turnstile) window.turnstile.reset('#auth-turnstile');
            } catch(e) {
                showAuthStatus('err', ' ' + (e.message || JSON.stringify(e)));
            }
        }

        function setLoggedIn(nick, verified, avatarUrl, email, emailVerified, joinDate) {
            currentAccount = { nick, verified, avatar_url: avatarUrl || null, email: email || null, email_verified: !!emailVerified, join_date: joinDate || null };
            document.getElementById('bp-author').value = nick;
            document.getElementById('bp-auth-form').style.display = 'none';
            const box = document.getElementById('bp-logged-in-box');
            box.style.display = 'block';

            document.getElementById('bp-logged-in-name').innerHTML =
                nick + (verified ? ' <span class="verified-badge" title=""><i class="fas fa-check"></i></span>' : '');

            const badge = document.getElementById('bp-email-verified-badge');
            if (email) {
                badge.style.display = 'block';
                const maxLen = 18;
                const needToggle = email.length > maxLen;
                const short = needToggle ? email.substring(0, maxLen) + '...' : email;
                if (needToggle) {
                    badge.innerHTML = `<span style="font-size:0.78rem;font-weight:700;word-break:break-all;" id="bp-email-text">${short}</span><button id="bp-email-toggle" onclick="toggleEmail('${email.replace(/'/g,"\\'")}') " style="margin-left:5px;font-size:0.68rem;font-weight:700;background:none;border:1px solid currentColor;opacity:0.75;border-radius:3px;padding:1px 5px;cursor:pointer;color:inherit;font-family:'Minecraft', sans-serif;vertical-align:middle;"></button>`;
                } else {
                    badge.innerHTML = `<span style="font-size:0.78rem;font-weight:700;">${email}</span>`;
                }
            } else {
                badge.style.display = 'none';
            }

            const joinEl = document.getElementById('bp-join-date');
            if (joinDate) {
                const ru = currentLang === 'ru';
                const d = new Date(joinDate);
                const formatted = d.toLocaleDateString(ru ? 'ru-RU' : 'en-US', { day: '2-digit', month: 'long', year: 'numeric' });
                joinEl.style.display = 'block';
                joinEl.innerHTML = `<i class="fas fa-calendar-alt" style="margin-right:4px;opacity:0.7;"></i>${ru ? '  ' : 'Joined'} ${formatted}`;
            } else {
                joinEl.style.display = 'none';
            }

            const avatarImg = document.getElementById('bp-avatar-img');
            const avatarPh = document.getElementById('bp-avatar-placeholder');
            if (avatarUrl) {
                avatarImg.src = avatarUrl; avatarImg.style.display = 'block'; avatarPh.style.display = 'none';
            } else {
                avatarImg.style.display = 'none'; avatarPh.style.display = 'flex';
                avatarPh.innerHTML = '<i class="fas fa-user"></i>';
            }
            localStorage.setItem('bp_session', JSON.stringify({ nick, verified, avatar_url: avatarUrl || null, email: email || null, email_verified: !!emailVerified, join_date: joinDate || null }));

            checkNewsAdmin().then(isAdm => {
                const rTab = document.getElementById('reports-nav-tab');
                const gTab = document.getElementById('gallery-nav-tab');
                if (rTab) rTab.style.display = isAdm ? '' : 'none';
                if (gTab) {
                    gTab.style.borderRight = isAdm ? 'none' : '3px solid #8b7355';
                    gTab.style.borderRadius = isAdm ? '0' : '0 4px 0 0';
                }
            });

            if (_bpAllData && _bpAllData.length > 0) applyBpFilters();

            showRefBlock(nick);

            const limitPanel = document.getElementById('bp-daily-limit');
            if (limitPanel) { limitPanel.style.display = 'flex'; updateDailyLimitUI(); startLimitTimer(); }
        }


        function togglePass(inputId, btn) {
            const input = document.getElementById(inputId);
            if (!input) return;
            const isHidden = input.type === 'password';
            input.type = isHidden ? 'text' : 'password';
            const icon = btn.querySelector('i');
            if (icon) {
                icon.className = isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
            }
        }

        function toggleEmail(fullEmail) {
            const ru = currentLang === 'ru';
            const textEl = document.getElementById('bp-email-text');
            const btnEl = document.getElementById('bp-email-toggle');
            if (!textEl || !btnEl) return;
            if (btnEl.dataset.open === '1') {
                textEl.textContent = fullEmail.substring(0, 18) + '...';
                btnEl.textContent = ru ? '' : 'show';
                btnEl.dataset.open = '0';
            } else {
                textEl.textContent = fullEmail;
                btnEl.textContent = ru ? '' : 'hide';
                btnEl.dataset.open = '1';
            }
        }

        function doLogout() {
            currentAccount = null;
            document.getElementById('bp-author').value = '';
            document.getElementById('bp-auth-form').style.display = 'block';
            document.getElementById('bp-logged-in-box').style.display = 'none';
            document.getElementById('bp-auth-nick').value = '';
            document.getElementById('bp-auth-pass').value = '';
            document.getElementById('bp-auth-status').className = 'bp-auth-status';
            localStorage.removeItem('bp_session');
            const rTab = document.getElementById('reports-nav-tab');
            if (rTab) rTab.style.display = 'none';
            const gTab = document.getElementById('gallery-nav-tab');
            if (gTab) { gTab.style.borderRight = '3px solid #8b7355'; gTab.style.borderRadius = '0 4px 0 0'; }
            const refBlock = document.getElementById('ref-profile-block');
            if (refBlock) refBlock.style.display = 'none';
            const limitPanel = document.getElementById('bp-daily-limit');
            if (limitPanel) limitPanel.style.display = 'none';
            stopLimitTimer();
            if (window.turnstile) window.turnstile.reset('#auth-turnstile');
            else rerenderAuthCaptcha(document.body.classList.contains('dark-theme') ? 'dark' : 'light');
        }

        async function checkUrlTokens() {
            const params = new URLSearchParams(window.location.search);

            const verifyToken = params.get('verify');
            if (verifyToken && sbClient) {
                try {
                    const { data, error } = await sbClient.from('accounts')
                        .select('nick, email')
                        .eq('email_verify_token', verifyToken)
                        .limit(1);
                    if (!error && data && data.length > 0) {
                        await sbClient.from('accounts').update({ email_verified: true, email_verify_token: null }).eq('email_verify_token', verifyToken);
                        showInfoBanner(' Email !    .', 'success');
                        const s = JSON.parse(localStorage.getItem('bp_session') || 'null');
                        if (s && s.nick && s.nick.toLowerCase() === data[0].nick.toLowerCase()) {
                            s.email_verified = true;
                            localStorage.setItem('bp_session', JSON.stringify(s));
                            if (currentAccount) currentAccount.email_verified = true;
                        }
                    } else {
                        showInfoBanner('      .', 'error');
                    }
                } catch(e) { console.error(e); }
                window.history.replaceState({}, '', window.location.pathname);
            }

            const resetToken = params.get('reset');
            if (resetToken && sbClient) {
                window.history.replaceState({}, '', window.location.pathname);
                try {
                    const now = Date.now();
                    const { data, error } = await sbClient.from('accounts')
                        .select('nick, reset_token_expires')
                        .eq('reset_token', resetToken)
                        .limit(1);
                    if (!error && data && data.length > 0) {
                        if (data[0].reset_token_expires && data[0].reset_token_expires > now) {
                            showResetPasswordModal(resetToken, data[0].nick);
                        } else {
                            showInfoBanner('    .  .', 'error');
                        }
                    } else {
                        showInfoBanner('    .', 'error');
                    }
                } catch(e) { console.error(e); }
            }
        }

        function showInfoBanner(msg, type) {
            const banner = document.createElement('div');
            banner.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:99999;padding:16px 28px;border-radius:4px;font-weight:700;font-family:Minecraft,sans-serif;font-size:0.95rem;box-shadow:0 8px 24px rgba(0,0,0,0.4);max-width:90vw;text-align:center;border:3px solid ${type==='success'?'#4caf50':'#f44336'};background:${type==='success'?'#c8e6c9':'#ffcdd2'};color:${type==='success'?'#1b5e20':'#b71c1c'};`;
            banner.textContent = msg;
            document.body.appendChild(banner);
            setTimeout(() => banner.remove(), 6000);
        }

        async function resendVerifyEmail(e) {
            e.preventDefault();
            const ru = currentLang === 'ru';
            if (!currentAccount || !currentAccount.email) return;
            try {
                const token = generateToken();
                await sbClient.from('accounts').update({ email_verify_token: token, email_verified: false }).ilike('nick', currentAccount.nick);
                await sendEmail(EMAILJS_VERIFY_TPL, {
                    to_email: currentAccount.email, to_name: currentAccount.nick,
                    verify_link: `${SITE_URL}?verify=${token}`, site_url: SITE_URL
                });
                showInfoBanner(ru ? '  !  .' : ' Verification email sent!', 'success');
            } catch(err) { showInfoBanner(' ' + err.message, 'error'); }
        }

        function showForgotModal() {
            const ru = currentLang === 'ru';
            const ex = document.getElementById('bp-forgot-modal'); if (ex) ex.remove();
            const isDark = document.body.classList.contains('dark-theme');
            const inputStyle = `width:100%;padding:10px 12px;border:3px solid ${isDark?'#555':'#8b7355'};border-radius:2px;background:${isDark?'#3a3a3a':'#f5eed9'};color:${isDark?'#e0e0e0':'#3e2723'};font-family:Minecraft,sans-serif;font-size:1rem;font-weight:600;outline:none;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);`;
            const overlay = document.createElement('div');
            overlay.className = 'bp-modal-overlay'; overlay.id = 'bp-forgot-modal';
            overlay.innerHTML = `
                <div class="bp-modal">
                    <h3><i class="fas fa-envelope"></i> ${ru ? ' ' : 'Reset Password'}</h3>
                    <p style="font-size:0.85rem;color:${isDark?'#b0b0b0':'#5a4a3a'};margin-bottom:12px;font-family:Minecraft,sans-serif;">
                        ${ru ? '  Email      .' : 'Enter your email  we\'ll send a reset link.'}
                    </p>
                    <div class="bp-form-row">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">Email</label>
                        <input type="email" id="forgot-email-input" placeholder="you@example.com" style="${inputStyle}" />
                    </div>
                    <div id="forgot-status" style="font-size:0.82rem;font-weight:600;font-family:Minecraft,sans-serif;margin-top:6px;"></div>
                    <div class="bp-modal-btns">
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;" onclick="doForgotPassword()">
                            <i class="fas fa-paper-plane"></i> ${ru ? '' : 'Send'}
                        </button>
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;" onclick="document.getElementById('bp-forgot-modal').remove()">
                            ${ru ? '' : 'Cancel'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.getElementById('forgot-email-input').focus();
        }

        async function doForgotPassword() {
            const ru = currentLang === 'ru';
            const email = document.getElementById('forgot-email-input').value.trim();
            const statusEl = document.getElementById('forgot-status');
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                statusEl.textContent = ru ? '   Email' : ' Enter a valid email';
                statusEl.style.color = '#c62828'; return;
            }
            statusEl.textContent = ru ? '  ...' : ' Looking up account...';
            statusEl.style.color = '#f57f17';
            try {
                const { data } = await sbClient.from('accounts').select('nick, email').ilike('email', email).limit(1);
                if (data && data.length > 0) {
                    const resetToken = generateToken();
                    const expires = Date.now() + 60 * 60 * 1000; // 1 
                    await sbClient.from('accounts').update({ reset_token: resetToken, reset_token_expires: expires }).ilike('email', email);
                    await sendEmail(EMAILJS_RESET_TPL, {
                        to_email: email, to_name: data[0].nick,
                        reset_link: `${SITE_URL}?reset=${resetToken}`, site_url: SITE_URL
                    });
                }
                statusEl.textContent = ru
                    ? '      !'
                    : ' If account exists  email sent!';
                statusEl.style.color = '#2e7d32';
            } catch(e) {
                statusEl.textContent = ' ' + (e.message || e);
                statusEl.style.color = '#c62828';
            }
        }

        function showResetPasswordModal(resetToken, nick) {
            const ru = currentLang === 'ru';
            const ex = document.getElementById('bp-reset-modal'); if (ex) ex.remove();
            const isDark = document.body.classList.contains('dark-theme');
            const inputStyle = `width:100%;padding:10px 12px;border:3px solid ${isDark?'#555':'#8b7355'};border-radius:2px;background:${isDark?'#3a3a3a':'#f5eed9'};color:${isDark?'#e0e0e0':'#3e2723'};font-family:Minecraft,sans-serif;font-size:1rem;font-weight:600;outline:none;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);margin-top:4px;`;
            const overlay = document.createElement('div');
            overlay.className = 'bp-modal-overlay'; overlay.id = 'bp-reset-modal';
            overlay.innerHTML = `
                <div class="bp-modal">
                    <h3><i class="fas fa-key"></i> ${ru ? ' ' : 'New Password'}</h3>
                    <p style="font-size:0.85rem;color:${isDark?'#b0b0b0':'#5a4a3a'};margin-bottom:12px;font-family:Minecraft,sans-serif;">
                        ${ru ? `: <b>${nick}</b>` : `Account: <b>${nick}</b>`}
                    </p>
                    <div class="bp-form-row">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?' ':'New Password'}</label>
                        <div class="pass-wrap"><input type="password" id="reset-pass-input" placeholder="" maxlength="100" style="${inputStyle}" /><button type="button" class="pass-toggle" onclick="togglePass('reset-pass-input',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                    </div>
                    <div class="bp-form-row" style="margin-top:10px;">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?' ':'Confirm Password'}</label>
                        <div class="pass-wrap"><input type="password" id="reset-pass2-input" placeholder="" maxlength="100" style="${inputStyle}" /><button type="button" class="pass-toggle" onclick="togglePass('reset-pass2-input',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                    </div>
                    <div id="reset-status" style="font-size:0.82rem;font-weight:600;font-family:Minecraft,sans-serif;margin-top:6px;"></div>
                    <div class="bp-modal-btns">
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;" onclick="doResetPassword('${resetToken}')">
                            <i class="fas fa-check"></i> ${ru ? '' : 'Save'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            document.getElementById('reset-pass-input').focus();
        }

        async function doResetPassword(resetToken) {
            const ru = currentLang === 'ru';
            const pass = document.getElementById('reset-pass-input').value;
            const pass2 = document.getElementById('reset-pass2-input').value;
            const statusEl = document.getElementById('reset-status');
            if (!pass || pass.length < 4) { statusEl.textContent = ru ? '  4 ' : ' Min 4 chars'; statusEl.style.color='#c62828'; return; }
            if (pass !== pass2) { statusEl.textContent = ru ? '   ' : ' Passwords do not match'; statusEl.style.color='#c62828'; return; }
            statusEl.textContent = ru ? ' ...' : ' Saving...';
            statusEl.style.color = '#f57f17';
            try {
                const hash = await hashPassword(pass);
                const { error } = await sbClient.from('accounts')
                    .update({ password_hash: hash, reset_token: null, reset_token_expires: null })
                    .eq('reset_token', resetToken);
                if (error) throw error;
                document.getElementById('bp-reset-modal').remove();
                showInfoBanner(ru ? '  !    .' : ' Password changed! Login with your new password.', 'success');
            } catch(e) {
                statusEl.textContent = ' ' + (e.message || e); statusEl.style.color = '#c62828';
            }
        }

        function showChangePassModal() {
            const ru = currentLang === 'ru';
            const ex = document.getElementById('bp-chpass-modal'); if (ex) ex.remove();
            const isDark = document.body.classList.contains('dark-theme');
            const inputStyle = `width:100%;padding:10px 12px;border:3px solid ${isDark?'#555':'#8b7355'};border-radius:2px;background:${isDark?'#3a3a3a':'#f5eed9'};color:${isDark?'#e0e0e0':'#3e2723'};font-family:Minecraft,sans-serif;font-size:1rem;font-weight:600;outline:none;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);margin-top:4px;`;
            const overlay = document.createElement('div');
            overlay.className = 'bp-modal-overlay'; overlay.id = 'bp-chpass-modal';
            overlay.innerHTML = `
                <div class="bp-modal">
                    <h3><i class="fas fa-key"></i> ${ru ? ' ' : 'Change Password'}</h3>
                    <div class="bp-form-row">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?' ':'Current Password'}</label>
                        <div class="pass-wrap"><input type="password" id="chpass-old" placeholder="" maxlength="100" style="${inputStyle}" /><button type="button" class="pass-toggle" onclick="togglePass('chpass-old',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                    </div>
                    <div class="bp-form-row" style="margin-top:10px;">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?' ':'New Password'}</label>
                        <div class="pass-wrap"><input type="password" id="chpass-new" placeholder="" maxlength="100" style="${inputStyle}" /><button type="button" class="pass-toggle" onclick="togglePass('chpass-new',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                    </div>
                    <div class="bp-form-row" style="margin-top:10px;">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?'  ':'Confirm New Password'}</label>
                        <div class="pass-wrap"><input type="password" id="chpass-new2" placeholder="" maxlength="100" style="${inputStyle}" /><button type="button" class="pass-toggle" onclick="togglePass('chpass-new2',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                    </div>
                    <div id="chpass-status" style="font-size:0.82rem;font-weight:600;font-family:Minecraft,sans-serif;margin-top:6px;"></div>
                    <div class="bp-modal-btns">
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;" onclick="doChangePassword()">
                            <i class="fas fa-check"></i> ${ru ? '' : 'Save'}
                        </button>
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;" onclick="document.getElementById('bp-chpass-modal').remove()">
                            ${ru ? '' : 'Cancel'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.getElementById('chpass-old').focus();
        }

        async function doChangePassword() {
            const ru = currentLang === 'ru';
            const oldPass = document.getElementById('chpass-old').value;
            const newPass = document.getElementById('chpass-new').value;
            const newPass2 = document.getElementById('chpass-new2').value;
            const statusEl = document.getElementById('chpass-status');

            if (!oldPass) { statusEl.textContent = ru?'   ':' Enter current password'; statusEl.style.color='#c62828'; return; }
            if (!newPass || newPass.length < 4) { statusEl.textContent = ru?'    4 ':' New password min 4 chars'; statusEl.style.color='#c62828'; return; }
            if (newPass !== newPass2) { statusEl.textContent = ru?'   ':' Passwords do not match'; statusEl.style.color='#c62828'; return; }

            statusEl.textContent = ru?' ...':' Checking...'; statusEl.style.color='#f57f17';
            try {
                const oldHash = await hashPassword(oldPass);
                const { data } = await sbClient.from('accounts').select('password_hash').ilike('nick', currentAccount.nick).limit(1);
                if (!data || data.length === 0 || data[0].password_hash !== oldHash) {
                    statusEl.textContent = ru?'   ':' Incorrect current password'; statusEl.style.color='#c62828'; return;
                }
                const newHash = await hashPassword(newPass);
                const { error } = await sbClient.from('accounts').update({ password_hash: newHash }).ilike('nick', currentAccount.nick);
                if (error) throw error;
                document.getElementById('bp-chpass-modal').remove();
                showInfoBanner(ru?'   !':' Password changed successfully!', 'success');
            } catch(e) { statusEl.textContent = ' ' + (e.message||e); statusEl.style.color='#c62828'; }
        }


        async function uploadAvatar(input) {
            const ru = currentLang === 'ru';
            if (!currentAccount || !sbClient) return;
            const file = input.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { alert(ru ? '    ( 2MB)' : ' File too large (max 2MB)'); return; }
            try {
                const ext = file.name.split('.').pop().toLowerCase();
                const path = `avatars/${currentAccount.nick.replace(/[^a-zA-Z0-9_]/g,'_')}_${Date.now()}.${ext}`;
                const { error: upErr } = await sbClient.storage.from('buildplates').upload(path, file, { cacheControl: '3600', upsert: true });
                if (upErr) throw upErr;
                const { data: urlData } = sbClient.storage.from('buildplates').getPublicUrl(path);
                const avatarUrl = urlData.publicUrl;
                const { error: dbErr } = await sbClient.from('accounts').update({ avatar_url: avatarUrl }).ilike('nick', currentAccount.nick);
                if (dbErr) throw dbErr;
                currentAccount.avatar_url = avatarUrl;
                setLoggedIn(currentAccount.nick, currentAccount.verified, avatarUrl, currentAccount.email, currentAccount.email_verified);
                showInfoBanner(ru?'  !':' Avatar updated!', 'success');
            } catch(e) { alert(' ' + (e.message || e)); }
        }

        function showRenameModal() {
            const ru = currentLang === 'ru';
            const ex = document.getElementById('bp-rename-modal'); if (ex) ex.remove();
            const isDark = document.body.classList.contains('dark-theme');
            const inputStyle = `width:100%;padding:10px 12px;border:3px solid ${isDark?'#555':'#8b7355'};border-radius:2px;background:${isDark?'#3a3a3a':'#f5eed9'};color:${isDark?'#e0e0e0':'#3e2723'};font-family:Minecraft,sans-serif;font-size:1rem;font-weight:600;outline:none;`;
            const overlay = document.createElement('div');
            overlay.className = 'bp-modal-overlay'; overlay.id = 'bp-rename-modal';
            overlay.innerHTML = `
                <div class="bp-modal">
                    <h3><i class="fas fa-pencil-alt"></i> ${ru ? ' ' : 'Change Username'}</h3>
                    <div class="bp-form-row">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?' ':'New Nickname'}</label>
                        <input type="text" id="rename-input" value="${currentAccount.nick}" maxlength="40" style="${inputStyle}" />
                    </div>
                    <div id="rename-status" style="font-size:0.82rem;font-weight:600;font-family:Minecraft,sans-serif;margin-top:6px;"></div>
                    <div class="bp-modal-btns">
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;" onclick="doRename()">
                            <i class="fas fa-check"></i> ${ru?'':'Save'}
                        </button>
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;" onclick="document.getElementById('bp-rename-modal').remove()">
                            ${ru?'':'Cancel'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.getElementById('rename-input').focus();
        }

        async function doRename() {
            const ru = currentLang === 'ru';
            const newNick = document.getElementById('rename-input').value.trim();
            const statusEl = document.getElementById('rename-status');
            if (!newNick || newNick.length < 2) { statusEl.textContent = ru?'  2 ':' Min 2 characters'; statusEl.style.color='#c62828'; return; }
            if (containsProfanity(newNick)) { statusEl.textContent = profanityError(ru); statusEl.style.color='#c62828'; return; }
            if (newNick.toLowerCase() === currentAccount.nick.toLowerCase()) { document.getElementById('bp-rename-modal').remove(); return; }
            statusEl.textContent = ru?' ...':' Checking...'; statusEl.style.color='#f57f17';
            try {
                const { data: ex } = await sbClient.from('accounts').select('nick').ilike('nick', newNick).limit(1);
                if (ex && ex.length > 0) { statusEl.textContent = ru?'  !':' Nickname taken!'; statusEl.style.color='#c62828'; return; }
                const { error } = await sbClient.from('accounts').update({ nick: newNick }).ilike('nick', currentAccount.nick);
                if (error) throw error;
                currentAccount.nick = newNick;
                setLoggedIn(newNick, currentAccount.verified, currentAccount.avatar_url, currentAccount.email, currentAccount.email_verified);
                document.getElementById('bp-rename-modal').remove();
                showInfoBanner(ru?`    ${newNick}`:` Username changed to ${newNick}`, 'success');
            } catch(e) { statusEl.textContent = ' '+(e.message||e); statusEl.style.color='#c62828'; }
        }

        async function deleteAccount() {
            const ru = currentLang === 'ru';
            if (!window.confirm(ru?`  "${currentAccount.nick}"?    !`:`Delete account "${currentAccount.nick}"? This cannot be undone!`)) return;
            if (!window.confirm(ru?' ?     .':'Are you sure? All your data will be deleted.')) return;
            try {
                const { error } = await sbClient.from('accounts').delete().ilike('nick', currentAccount.nick);
                if (error) throw error;
                doLogout();
                showInfoBanner(ru?'  .':' Account deleted.', 'success');
            } catch(e) { alert(' '+(e.message||e)); }
        }

        (function restoreSession() {
            try {
                const s = JSON.parse(localStorage.getItem('bp_session') || 'null');
                if (s && s.nick) setLoggedIn(s.nick, s.verified, s.avatar_url || null, s.email || null, s.email_verified || false, s.join_date || null);
            } catch(e) {}
        })();

        window.addEventListener('DOMContentLoaded', () => {
            if (sbClient) {
                checkUrlTokens();
            }
            document.addEventListener('click', () => {
                document.querySelectorAll('.dots-dropdown.open, .bp-dots-dropdown.open').forEach(d => d.classList.remove('open'));
            });

            try {
                const s = JSON.parse(localStorage.getItem('bp_session') || 'null');
                if (s && s.nick) {
                    showRefBlock(s.nick);
                }
            } catch(e) {}
        });

                async function uploadBuildplate() {
            const name = document.getElementById('bp-name').value.trim();
            const author = document.getElementById('bp-author').value.trim();
            const imageFile = document.getElementById('bp-image-input').files[0];
            const worldFile = document.getElementById('bp-world-input').files[0];
            const submitBtn = document.getElementById('bp-submit-btn');
            const ru = currentLang === 'ru';

            if (!sbClient) {
                showBpStatus('error', ru
                    ? '   Publishable key (sb_publishable_...)    YOUR_ANON_KEY!'
                    : ' Insert your Publishable key (sb_publishable_...) into the code instead of YOUR_ANON_KEY!');
                return;
            }

            if (!currentAccount) { showBpStatus('error', ru ? '     !' : ' Login before uploading!'); return; }

            if (getDailyPostsLeft() <= 0) {
                showBpStatus('error', ru ? '    (3   ).  !' : ' Daily limit reached (3 posts/day). Try tomorrow!');
                return;
            }
            if (!name) { showBpStatus('error', ru ? '  !' : ' Enter a name!'); return; }
            if (containsProfanity(name)) { showBpStatus('error', profanityError(ru)); return; }
            if (!author) { showBpStatus('error', ru ? '   !' : ' Enter your nickname!'); return; }

            if (!imageFile) {
                showBpStatus('error', ru ? '  !' : ' Choose an image!');
                return;
            }
            if (!worldFile) {
                showBpStatus('error', ru ? '  world !' : ' Choose a world file!');
                return;
            }

            if (worldFile.name.toLowerCase() !== 'world') {
                showBpStatus('error', ru ? '    "world" ( )!' : ' File must be named "world" (no extension)!');
                return;
            }

            if (worldFile.size === 0) {
                showBpStatus('error', ru ? ' World  !' : ' World file is empty!');
                return;
            }

            const imgExt = imageFile.name.split('.').pop().toLowerCase();
            if (!['png', 'jpg', 'jpeg'].includes(imgExt)) {
                showBpStatus('error', ru ? '    PNG  JPEG!' : ' Image must be PNG or JPEG!');
                return;
            }

            const magicCheck = await checkImageMagicBytes(imageFile);
            if (!magicCheck.valid) {
                showBpStatus('error', ru ? '       PNG/JPEG!' : ' Image file is corrupted or not a valid PNG/JPEG!');
                return;
            }

            submitBtn.disabled = true;
            showBpStatus('', '');
            showBpStatus('success', ru ? '  ...' : ' Uploading image...');

            let imagePath, worldPath;

            try {
                const timestamp = Date.now();
                const safeName = name.replace(/[^a-zA-Z0-9_\-]/g, '_').slice(0, 40);

                imagePath = `images/${timestamp}_${safeName}.${imgExt}`;
                const { error: imgError } = await sbClient.storage
                    .from('buildplates')
                    .upload(imagePath, imageFile, { cacheControl: '3600', upsert: false });
                if (imgError) throw new Error(parseSbError(imgError, ru));

                showBpStatus('success', ru ? '  world ...' : ' Uploading world file...');

                worldPath = `worlds/${timestamp}_${safeName}_world`;
                const { error: worldError } = await sbClient.storage
                    .from('buildplates')
                    .upload(worldPath, worldFile, { cacheControl: '3600', upsert: false });
                if (worldError) throw new Error(parseSbError(worldError, ru));

                showBpStatus('success', ru ? '  ...' : ' Saving record...');

                const { data: imgData } = sbClient.storage.from('buildplates').getPublicUrl(imagePath);
                const { data: worldData } = sbClient.storage.from('buildplates').getPublicUrl(worldPath);

                const { data: inserted, error: dbError } = await sbClient.from('buildplates').insert([{
                    name: name,
                    author: author,
                    image_url: imgData.publicUrl,
                    world_url: worldData.publicUrl,
                    created_at: new Date().toISOString()
                }]).select();
                if (dbError) throw new Error(parseSbError(dbError, ru));

                if (!inserted || inserted.length === 0) {
                    throw new Error(ru ? '      !' : 'Record was not created in database!');
                }

                const [imgCheck, worldCheck] = await Promise.all([
                    fetch(imgData.publicUrl, { method: 'HEAD' }),
                    fetch(worldData.publicUrl, { method: 'HEAD' })
                ]);
                if (!imgCheck.ok) throw new Error(ru ? ' ,  !' : 'Image uploaded but not accessible!');
                if (!worldCheck.ok) throw new Error(ru ? 'World  ,  !' : 'World file uploaded but not accessible!');

                const myPosts = JSON.parse(localStorage.getItem('bp_my_posts') || '[]');
                myPosts.push({
                    id: inserted[0].id,
                    image_path: imagePath,
                    world_path: worldPath
                });
                localStorage.setItem('bp_my_posts', JSON.stringify(myPosts));
                incrementDailyPost();
                updateDailyLimitUI();

                showBpStatus('success', ru ? ' Buildplate    !' : ' Buildplate uploaded and verified!');

                document.getElementById('bp-name').value = '';
                document.getElementById('bp-image-input').value = '';
                document.getElementById('bp-world-input').value = '';
                document.getElementById('bp-image-name').textContent = '';
                document.getElementById('bp-world-name').textContent = '';

                loadBuildplates();

            } catch (err) {
                console.error(err);
                showBpStatus('error', ' ' + err.message);

                if (imagePath) await sbClient.storage.from('buildplates').remove([imagePath]).catch(() => {});
                if (worldPath) await sbClient.storage.from('buildplates').remove([worldPath]).catch(() => {});
            } finally {
                submitBtn.disabled = false;
            }
        }

        function showBpStatus(type, message) {
            const el = document.getElementById('bp-status');
            el.className = 'bp-status' + (type ? ' ' + type : '');
            el.textContent = message;
            if (!type) el.style.display = 'none';
        }

        let _bpAllData = [];
        let _bpAvatarMap = {};
        let _bpVerifiedMap = {};
        let _bpFilterMine = false;
        let _bpSearchTimer = null;

        function toggleFilterMine() {
            _bpFilterMine = !_bpFilterMine;
            const btn = document.getElementById('bp-filter-mine');
            if (btn) btn.classList.toggle('active', _bpFilterMine);
            applyBpFilters();
        }

        function applyBpFilters() {
            const ru = currentLang === 'ru';
            const searchVal = (document.getElementById('bp-search')?.value || '').toLowerCase().trim();
            const sortVal = document.getElementById('bp-sort')?.value || 'newest';
            const gallery = document.getElementById('bp-gallery');
            const countEl = document.getElementById('bp-results-count');

            const myPosts = JSON.parse(localStorage.getItem('bp_my_posts') || '[]');
            const myIds = myPosts.map(p => String(p.id));
            const myNicks = [...new Set(myPosts.map(p => (p.author || '').toLowerCase()).filter(Boolean))];
            if (currentAccount) myNicks.push(currentAccount.nick.toLowerCase());

            let filtered = _bpAllData.filter(bp => {
                if (_bpFilterMine) {
                    const isMine = myIds.includes(String(bp.id)) || (bp.author && myNicks.includes(bp.author.toLowerCase()));
                    if (!isMine) return false;
                }
                if (searchVal) {
                    const nameMatch = (bp.name || '').toLowerCase().includes(searchVal);
                    const authorMatch = (bp.author || '').toLowerCase().includes(searchVal);
                    if (!nameMatch && !authorMatch) return false;
                }
                return true;
            });

            filtered = [...filtered].sort((a, b) => {
                if (sortVal === 'newest') return new Date(b.created_at) - new Date(a.created_at);
                if (sortVal === 'oldest') return new Date(a.created_at) - new Date(b.created_at);
                if (sortVal === 'liked') return (b.likes || 0) - (a.likes || 0);
                if (sortVal === 'rating') return ((b.likes || 0) - (b.dislikes || 0)) - ((a.likes || 0) - (a.dislikes || 0));
                return 0;
            });

            if (countEl) {
                const total = _bpAllData.length;
                const shown = filtered.length;
                countEl.textContent = shown < total
                    ? (ru ? `${shown}  ${total}` : `${shown} of ${total}`)
                    : (ru ? `${total} buildplates` : `${total} buildplates`);
            }

            if (filtered.length === 0) {
                gallery.innerHTML = `<div class="bp-empty"><i class="fas fa-search"></i><p>${ru ? '  ' : 'Nothing found'}</p></div>`;
                return;
            }

            gallery.innerHTML = '<div class="bp-grid"></div>';
            const grid = gallery.querySelector('.bp-grid');
            renderBpCards(filtered, grid, myIds, myNicks);
        }

        function renderBpCards(data, grid, myIds, myNicks) {
            const bpLikes = JSON.parse(localStorage.getItem('bp_likes') || '{}');
            const bpDislikes = JSON.parse(localStorage.getItem('bp_dislikes') || '{}');

            data.forEach(bp => {
                const isMine = myIds.includes(String(bp.id)) || (bp.author && myNicks.includes(bp.author.toLowerCase()));
                const card = document.createElement('div');
                card.className = 'bp-card';
                card.id = 'bp-card-' + bp.id;
                const isLiked = bpLikes[bp.id] === true;
                const likeCount = bp.likes || 0;
                const isDisliked = bpDislikes[bp.id] === true;
                const dislikeCount = bp.dislikes || 0;

                const authorLower = (bp.author || '').toLowerCase();
                const authorAvatar = _bpAvatarMap[authorLower];
                const avatarHtml = authorAvatar
                    ? `<img class="bp-card-avatar" src="${authorAvatar}" alt="" loading="lazy">`
                    : `<span class="bp-card-avatar-placeholder"><i class="fas fa-user"></i></span>`;

                card.innerHTML = `
                    ${bp.image_url
                        ? `<img class="bp-card-img" src="${bp.image_url}" alt="${escapeHtml(bp.name)}" loading="lazy">`
                        : `<div class="bp-card-img-placeholder"></div>`
                    }
                    <div class="bp-card-body">
                        <div class="bp-card-name">${escapeHtml(bp.name)}</div>
                        <div class="bp-card-meta">
                            <div class="bp-card-author">
                                ${avatarHtml}
                                <span>${escapeHtml(bp.author || (currentLang === 'ru' ? '' : 'Unknown'))}${_bpVerifiedMap[authorLower] ? `<span class="verified-badge" title="${currentLang === 'ru' ? ' ' : 'Verified author'}"><i class="fas fa-check"></i></span>` : ''}</span>
                            </div>
                            <div class="bp-card-date">
                                <i class="fas fa-calendar-alt"></i>
                                <span>${bp.created_at
                                    ? new Date(bp.created_at).toLocaleDateString(currentLang === 'ru' ? 'ru-RU' : 'en-US', { day: '2-digit', month: 'long', year: 'numeric' }) + ', ' + new Date(bp.created_at).toLocaleTimeString(currentLang === 'ru' ? 'ru-RU' : 'en-US', { hour: '2-digit', minute: '2-digit' })
                                    : (currentLang === 'ru' ? ' ' : 'Unknown date')
                                }</span>
                            </div>
                        </div>
                        <div class="bp-card-actions">
                            <button class="bp-download-btn" data-bp-dl="${bp.id}">
                                <i class="fas fa-download"></i>
                                <span>${currentLang === 'ru' ? '' : 'Download'}</span>
                            </button>
                            <button class="bp-like-btn ${isLiked ? 'liked' : ''}" data-id="${bp.id}">
                                <i class="fas fa-thumbs-up"></i>
                                <span class="bp-like-count">${likeCount}</span>
                            </button>
                            <button class="bp-dislike-btn ${isDisliked ? 'disliked' : ''}" data-id="${bp.id}">
                                <i class="fas fa-thumbs-down"></i>
                                <span class="bp-dislike-count">${dislikeCount}</span>
                            </button>
                            <button class="bp-share-btn" data-id="${bp.id}" style="display:none;"></button>
                            <div class="bp-dots-wrap">
                                <button class="bp-dots-btn" data-bp-dots="${bp.id}">&#8943;</button>
                                <div class="bp-dots-dropdown" id="bp-dots-dd-${bp.id}">
                                    <button class="bp-dots-item" data-bp-share="${bp.id}">
                                        <i class="fas fa-share-alt"></i> ${currentLang === 'ru' ? '' : 'Share'}
                                    </button>
                                    ${!isMine ? `<button class="bp-dots-item danger" data-bp-report="${bp.id}">
                                        <i class="fas fa-flag"></i> ${currentLang === 'ru' ? '' : 'Report'}
                                    </button>` : ''}
                                </div>
                            </div>
                        </div>
                        ${isMine ? `
                        <button class="bp-delete-btn" onclick="deleteBuildplate('${bp.id}', this)">
                            <i class="fas fa-trash"></i>
                            <span>${currentLang === 'ru' ? '' : 'Delete'}</span>
                        </button>` : ''}
                    </div>`;
                grid.appendChild(card);

                const likeBtn = card.querySelector('.bp-like-btn');
                const dislikeBtn = card.querySelector('.bp-dislike-btn');
                const dotsBtn = card.querySelector(`[data-bp-dots="${bp.id}"]`);
                const bpShareBtn = card.querySelector(`[data-bp-share="${bp.id}"]`);
                const reportBtn = card.querySelector(`[data-bp-report="${bp.id}"]`);
                const dlBtn = card.querySelector(`[data-bp-dl="${bp.id}"]`);

                if (likeBtn) likeBtn.addEventListener('click', () => handleBpLike(bp.id, likeBtn, dislikeBtn));
                if (dislikeBtn) dislikeBtn.addEventListener('click', () => handleBpDislike(bp.id, dislikeBtn, likeBtn));
                if (dlBtn) dlBtn.addEventListener('click', () => {
                    if (!currentAccount) {
                        showInfoBanner(currentLang === 'ru' ? '     !' : ' Login to download!', 'error');
                        return;
                    }
                    downloadWorld(bp.world_url, bp.name);
                });
                if (dotsBtn) dotsBtn.addEventListener('click', e => {
                    e.stopPropagation();
                    document.querySelectorAll('.dots-dropdown.open, .bp-dots-dropdown.open').forEach(d => d.classList.remove('open'));
                    const dd = card.querySelector(`#bp-dots-dd-${bp.id}`);
                    if (dd) dd.classList.toggle('open');
                });
                if (bpShareBtn) bpShareBtn.addEventListener('click', () => {
                    card.querySelector(`#bp-dots-dd-${bp.id}`)?.classList.remove('open');
                    handleBpShare(bp.name, bp.world_url);
                });
                if (reportBtn) reportBtn.addEventListener('click', () => {
                    card.querySelector(`#bp-dots-dd-${bp.id}`)?.classList.remove('open');
                    if (!currentAccount) {
                        showInfoBanner(currentLang === 'ru' ? '   ,  !' : ' Please log in to report!', 'error');
                        return;
                    }
                    showReportModal('buildplate', bp.id, bp.name, bp.author, bp.image_url || null);
                });
            });
            setTimeout(attachRefBadges, 150);
        }

        async function loadBuildplates() {
            const gallery = document.getElementById('bp-gallery');
            const filtersEl = document.getElementById('bp-filters');

            if (!sbClient) {
                gallery.innerHTML = `<div class="bp-empty"><i class="fas fa-exclamation-triangle"></i><p> Publishable key   (YOUR_ANON_KEY)</p></div>`;
                return;
            }

            gallery.innerHTML = '<div class="bp-loading"><i class="fas fa-spinner"></i><p>...</p></div>';
            if (filtersEl) filtersEl.style.display = 'none';

            try {
                const { data, error } = await sbClient
                    .from('buildplates')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    gallery.innerHTML = `
                        <div class="bp-empty">
                            <i class="fas fa-cubes"></i>
                            <p>${currentLang === 'ru' ? '  buildplates.  !' : 'No buildplates yet. Be the first!'}</p>
                        </div>`;
                    return;
                }

                const authors = [...new Set(data.map(bp => bp.author).filter(Boolean))];
                _bpAvatarMap = {};
                _bpVerifiedMap = {};
                if (authors.length > 0) {
                    try {
                        const { data: accs } = await sbClient.from('accounts').select('nick, avatar_url, verified').in('nick', authors);
                        if (accs) accs.forEach(a => {
                            const key = a.nick.toLowerCase();
                            if (a.avatar_url) _bpAvatarMap[key] = a.avatar_url;
                            if (a.verified) _bpVerifiedMap[key] = true;
                        });
                    } catch(e) {}
                }

                _bpAllData = data;

                if (filtersEl) {
                    filtersEl.style.display = 'flex';
                    const searchInput = document.getElementById('bp-search');
                    if (searchInput) {
                        const attr = currentLang === 'ru' ? 'data-placeholder-ru' : 'data-placeholder-en';
                        searchInput.placeholder = searchInput.getAttribute(attr) || searchInput.placeholder;
                        searchInput.oninput = () => {
                            clearTimeout(_bpSearchTimer);
                            _bpSearchTimer = setTimeout(applyBpFilters, 250);
                        };
                    }
                    const sortSelect = document.getElementById('bp-sort');
                    if (sortSelect) {
                        sortSelect.querySelectorAll('option').forEach(opt => {
                            const label = opt.getAttribute(currentLang === 'ru' ? 'data-ru' : 'data-en');
                            if (label) opt.textContent = label;
                        });
                        sortSelect.onchange = applyBpFilters;
                    }
                    const mineBtn = document.getElementById('bp-filter-mine');
                    if (mineBtn) {
                        const label = mineBtn.getAttribute(currentLang === 'ru' ? 'data-ru' : 'data-en');
                        if (label) mineBtn.textContent = label;
                    }
                }

                applyBpFilters();

            } catch (err) {
                console.error(err);
                gallery.innerHTML = `<div class="bp-empty"><i class="fas fa-exclamation-triangle"></i><p>${currentLang === 'ru' ? ' ' : 'Load error'}: ${err.message}</p></div>`;
            }
        }

        function parseSbError(err, ru) {
            if (!err || (typeof err === 'object' && Object.keys(err).length === 0)) {
                return ru
                    ? 'Supabase: bucket "buildplates"     . : 1) bucket  2) Storage   INSERT 3) RLS   INSERT'
                    : 'Supabase: bucket "buildplates" not found or no permissions. Check: 1) bucket exists 2) Storage policies allow INSERT 3) Table RLS allows INSERT';
            }
            const msg = err.message || err.error_description || err.error || JSON.stringify(err);
            if (msg.includes('Bucket not found') || msg.includes('bucket_not_found')) {
                return ru ? 'Bucket "buildplates"  .    Supabase Dashboard  Storage' : 'Bucket "buildplates" does not exist. Create it in Supabase Dashboard  Storage';
            }
            if (msg.includes('row-level security') || msg.includes('violates row') || msg.includes('new row')) {
                return ru ? 'RLS  .   INSERT   buildplates' : 'RLS is blocking insert. Add INSERT policy for buildplates table';
            }
            if (msg.includes('storage/unauthorized') || msg.includes('401') || msg.includes('403')) {
                return ru ? '   .   INSERT  Storage bucket buildplates' : 'No upload permission. Add INSERT policy for Storage bucket buildplates';
            }
            if (msg.includes('mime') || msg.includes('content-type') || msg.includes('type')) {
                return ru ? 'Supabase   .   MIME   bucket' : 'Supabase rejected file type. Remove MIME restrictions in bucket settings';
            }
            return (ru ? ': ' : 'Error: ') + msg;
        }

        function escapeHtml(str) {
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        async function deleteBuildplate(id, btn) {
            const ru = currentLang === 'ru';
            const confirm = window.confirm(ru ? '  buildplate?' : 'Delete this buildplate?');
            if (!confirm) return;

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>${ru ? '...' : 'Deleting...'}</span>`;

            try {
                const myPosts = JSON.parse(localStorage.getItem('bp_my_posts') || '[]');
                const post = myPosts.find(p => String(p.id) === String(id));

                const { data: deletedBp, error: dbError } = await sbClient.from('buildplates').delete().eq('id', id).select();
                if (dbError) throw new Error((ru ? ' : ' : 'DB error: ') + dbError.message);
                if (!deletedBp || deletedBp.length === 0) throw new Error(ru ? '       ' : 'No permission to delete or record not found');

                if (post) {
                    const filesToRemove = [];
                    if (post.image_path) filesToRemove.push(post.image_path);
                    if (post.world_path) filesToRemove.push(post.world_path);
                    if (filesToRemove.length > 0) {
                        await sbClient.storage.from('buildplates').remove(filesToRemove).catch(e => console.warn('Storage remove:', e));
                    }

                    const updated = myPosts.filter(p => String(p.id) !== String(id));
                    localStorage.setItem('bp_my_posts', JSON.stringify(updated));
                }

                const card = document.getElementById('bp-card-' + id);
                if (card) {
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.8)';
                    setTimeout(() => { card.remove(); }, 300);
                }

            } catch (err) {
                console.error(err);
                alert(' ' + err.message);
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-trash"></i> <span>${ru ? '' : 'Delete'}</span>`;
            }
        }

        const bpProcessing = {}; //    

        async function handleBpLike(id, likeBtn, dislikeBtn) {
            if (!currentAccount) {
                showInfoBanner(currentLang === 'ru' ? '      !' : ' Login to like buildplates!', 'error');
                return;
            }
            if (bpProcessing[id]) return; //    
            bpProcessing[id] = true;
            likeBtn.disabled = true;
            dislikeBtn.disabled = true;

            const bpLikes = JSON.parse(localStorage.getItem('bp_likes') || '{}');
            const bpDislikes = JSON.parse(localStorage.getItem('bp_dislikes') || '{}');
            const isLiked = bpLikes[id] === true;
            const isDisliked = bpDislikes[id] === true;

            try {
                const { data, error } = await sbClient.from('buildplates').select('likes, dislikes').eq('id', id).single();
                if (error) throw error;

                let newLikes = data.likes || 0;
                let newDislikes = data.dislikes || 0;

                if (isLiked) {
                    newLikes = Math.max(0, newLikes - 1);
                    delete bpLikes[id];
                    likeBtn.classList.remove('liked');
                } else {
                    newLikes += 1;
                    bpLikes[id] = true;
                    likeBtn.classList.add('liked');
                    if (isDisliked) {
                        newDislikes = Math.max(0, newDislikes - 1);
                        delete bpDislikes[id];
                        dislikeBtn.classList.remove('disliked');
                        dislikeBtn.querySelector('.bp-dislike-count').textContent = newDislikes;
                    }
                }

                await sbClient.from('buildplates').update({ likes: newLikes, dislikes: newDislikes }).eq('id', id);
                localStorage.setItem('bp_likes', JSON.stringify(bpLikes));
                localStorage.setItem('bp_dislikes', JSON.stringify(bpDislikes));
                likeBtn.querySelector('.bp-like-count').textContent = newLikes;
            } catch (err) {
                console.error('Like error:', err);
            } finally {
                likeBtn.disabled = false;
                dislikeBtn.disabled = false;
                bpProcessing[id] = false;
            }
        }

        async function handleBpDislike(id, dislikeBtn, likeBtn) {
            if (!currentAccount) {
                showInfoBanner(currentLang === 'ru' ? '      !' : ' Login to like buildplates!', 'error');
                return;
            }
            if (bpProcessing[id]) return; //    
            bpProcessing[id] = true;
            likeBtn.disabled = true;
            dislikeBtn.disabled = true;

            const bpLikes = JSON.parse(localStorage.getItem('bp_likes') || '{}');
            const bpDislikes = JSON.parse(localStorage.getItem('bp_dislikes') || '{}');
            const isLiked = bpLikes[id] === true;
            const isDisliked = bpDislikes[id] === true;

            try {
                const { data, error } = await sbClient.from('buildplates').select('likes, dislikes').eq('id', id).single();
                if (error) throw error;

                let newLikes = data.likes || 0;
                let newDislikes = data.dislikes || 0;

                if (isDisliked) {
                    newDislikes = Math.max(0, newDislikes - 1);
                    delete bpDislikes[id];
                    dislikeBtn.classList.remove('disliked');
                } else {
                    newDislikes += 1;
                    bpDislikes[id] = true;
                    dislikeBtn.classList.add('disliked');
                    if (isLiked) {
                        newLikes = Math.max(0, newLikes - 1);
                        delete bpLikes[id];
                        likeBtn.classList.remove('liked');
                        likeBtn.querySelector('.bp-like-count').textContent = newLikes;
                    }
                }

                await sbClient.from('buildplates').update({ likes: newLikes, dislikes: newDislikes }).eq('id', id);
                localStorage.setItem('bp_likes', JSON.stringify(bpLikes));
                localStorage.setItem('bp_dislikes', JSON.stringify(bpDislikes));
                dislikeBtn.querySelector('.bp-dislike-count').textContent = newDislikes;
            } catch (err) {
                console.error('Dislike error:', err);
            } finally {
                likeBtn.disabled = false;
                dislikeBtn.disabled = false;
                bpProcessing[id] = false;
            }
        }

        async function handleBpShare(name, worldUrl) {
            const ru = currentLang === 'ru';
            if (navigator.share) {
                try { await navigator.share({ title: name, url: worldUrl }); } catch (e) {}
            } else {
                try {
                    await navigator.clipboard.writeText(worldUrl);
                    alert(ru ? '  !' : ' Link copied!');
                } catch (e) {
                    alert(ru ? '   ' : ' Could not copy');
                }
            }
        }

        const DAILY_LIMIT = 3;
        const DAILY_LIMIT_KEY = 'bp_daily_posts';

        function getTodayStr() {
            const d = new Date();
            return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        }

        function getDailyPostData() {
            try {
                const raw = JSON.parse(localStorage.getItem(DAILY_LIMIT_KEY) || '{}');
                const today = getTodayStr();
                if (raw.date !== today) return { date: today, count: 0 };
                return raw;
            } catch(e) { return { date: getTodayStr(), count: 0 }; }
        }

        function incrementDailyPost() {
            const data = getDailyPostData();
            data.count = (data.count || 0) + 1;
            localStorage.setItem(DAILY_LIMIT_KEY, JSON.stringify(data));
        }

        function getDailyPostsLeft() {
            return Math.max(0, DAILY_LIMIT - getDailyPostData().count);
        }

        function updateDailyLimitUI() {
            const panel = document.getElementById('bp-daily-limit');
            if (!panel) return;
            const ru = currentLang === 'ru';
            const left = getDailyPostsLeft();
            const used = DAILY_LIMIT - left;

            document.getElementById('bp-limit-title').textContent = ru ? '  ' : 'Daily post limit';

            const dotsEl = document.getElementById('bp-limit-dots');
            dotsEl.innerHTML = '';
            for (let i = 0; i < DAILY_LIMIT; i++) {
                const dot = document.createElement('div');
                dot.style.cssText = `width:14px;height:14px;border-radius:2px;border:2px solid #8b7355;background:${i < used ? '#c0392b' : '#6b8e23'};box-shadow:0 2px 0 ${i < used ? '#922b21' : '#4a5d23'};image-rendering:pixelated;`;
                dotsEl.appendChild(dot);
            }

            document.getElementById('bp-limit-text').textContent = ru
                ? `: ${left}  ${DAILY_LIMIT}`
                : `Remaining: ${left} of ${DAILY_LIMIT}`;

            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0);
            const diff = midnight - now;
            const hh = String(Math.floor(diff / 3600000)).padStart(2,'0');
            const mm = String(Math.floor((diff % 3600000) / 60000)).padStart(2,'0');
            const ss = String(Math.floor((diff % 60000) / 1000)).padStart(2,'0');
            document.getElementById('bp-limit-reset').textContent = ru
                ? `  ${hh}:${mm}:${ss}`
                : `Resets in ${hh}:${mm}:${ss}`;

            const submitBtn = document.getElementById('bp-submit-btn');
            if (submitBtn) {
                submitBtn.disabled = left <= 0;
                if (left <= 0) {
                    submitBtn.title = ru ? '   ' : 'Daily post limit reached';
                } else {
                    submitBtn.title = '';
                }
            }
        }

        let _limitTimerInterval = null;
        function startLimitTimer() { if (!_limitTimerInterval) _limitTimerInterval = setInterval(updateDailyLimitUI, 1000); }
        function stopLimitTimer() { if (_limitTimerInterval) { clearInterval(_limitTimerInterval); _limitTimerInterval = null; } }


        const origSwitchTab = window.switchTab;
        window.switchTab = function(tabName) {
            origSwitchTab && origSwitchTab.call(this, tabName);
            if (tabName === 'buildplates') { loadBuildplates(); updateDailyLimitUI(); }
            if (tabName === 'news') { if (_newsCache !== null) renderNews(_newsCache, _newsIsAdmin); else loadNews(); }
            if (tabName === 'reports') { if (typeof window.loadReports === 'function') window.loadReports(); }
            if (tabName === 'gallery') { loadGallery(); updateGalleryDailyLimitUI(); }
        };

        const COOKIE_KEY = 'pe_cookie_consent';

        function getCookieConsent() {
            try { return JSON.parse(localStorage.getItem(COOKIE_KEY)); } catch(e) { return null; }
        }

        function saveCookieConsent(prefs) {
            try { localStorage.setItem(COOKIE_KEY, JSON.stringify({ ...prefs, date: Date.now() })); } catch(e) {}
        }

        function acceptCookies() {
            saveCookieConsent({ essential: true, functional: true, analytics: true });
            hideCookieBanner();
        }

        function declineCookies() {
            saveCookieConsent({ essential: true, functional: false, analytics: false });
            hideCookieBanner();
        }

        function hideCookieBanner() {
            const banner = document.getElementById('cookie-banner');
            if (banner) { banner.classList.remove('show'); }
        }

        function showCookieBanner() {
            const banner = document.getElementById('cookie-banner');
            if (banner) { setTimeout(() => banner.classList.add('show'), 800); }
        }

        function showCookieModal() {
            const ex = document.getElementById('cookie-modal-overlay'); if (ex) ex.remove();
            const prefs = getCookieConsent() || { essential: true, functional: true, analytics: true };
            const isDark = document.body.classList.contains('dark-theme');
            const ru = currentLang === 'ru';
            const overlay = document.createElement('div');
            overlay.className = 'cookie-modal-overlay'; overlay.id = 'cookie-modal-overlay';
            overlay.innerHTML = `
                <div class="cookie-modal">
                    <h3><img id="cookie-icon-modal" src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/cookie_item.png" alt="cookie" style="width:22px;height:22px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:6px;"> ${ru ? ' Cookie' : 'Cookie Settings'}</h3>
                    <p style="font-size:0.82rem;font-family:Minecraft,sans-serif;color:${isDark?'#b0b0b0':'#5a4a3a'};margin-bottom:16px;line-height:1.6;font-weight:600;">
                        ${ru ? ' ,       .' : 'Control what data we store in your browser.'}
                    </p>

                    <div class="cookie-toggle-row">
                        <div class="cookie-toggle-info">
                            <div class="cookie-toggle-name"><img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/settings_icon.png" width="14" height="14" style="object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:4px;"> ${ru ? ' ' : ' Essential'}</div>
                            <div class="cookie-toggle-desc">${ru ? ', , .     .' : 'Session, theme, language. Required for the site to work.'}</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked disabled />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="cookie-toggle-row">
                        <div class="cookie-toggle-info">
                            <div class="cookie-toggle-name"><img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/scan_code_icon.png" width="14" height="14" style="object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:4px;"> ${ru ? ' ' : ' Functional'}</div>
                            <div class="cookie-toggle-desc">${ru ? ' ,  buildplates.' : 'Remember your account and uploaded buildplates.'}</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="cookie-functional" ${prefs.functional !== false ? 'checked' : ''} />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="cookie-toggle-row">
                        <div class="cookie-toggle-info">
                            <div class="cookie-toggle-name"><img src="https://sqlylxcnoqehorlgmztm.supabase.co/storage/v1/object/public/icons/icon/journal_open_icon.png" width="14" height="14" style="object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:4px;"> ${ru ? ' ' : ' Analytics'}</div>
                            <div class="cookie-toggle-desc">${ru ? '     buildplates.' : 'News and buildplate likes/dislikes.'}</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="cookie-analytics" ${prefs.analytics !== false ? 'checked' : ''} />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;">
                        <button class="bp-submit-btn" style="flex:1;margin-top:0;font-size:0.82rem;padding:11px;" onclick="saveCookieFromModal()">
                            <i class="fas fa-check"></i> ${ru ? '' : 'Save'}
                        </button>
                        <button class="bp-submit-btn" style="flex:1;margin-top:0;font-size:0.82rem;padding:11px;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;" onclick="document.getElementById('cookie-modal-overlay').remove()">
                            ${ru ? '' : 'Close'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
        }

        function saveCookieFromModal() {
            const functional = document.getElementById('cookie-functional')?.checked ?? true;
            const analytics = document.getElementById('cookie-analytics')?.checked ?? true;
            saveCookieConsent({ essential: true, functional, analytics });
            document.getElementById('cookie-modal-overlay')?.remove();
            hideCookieBanner();
            showInfoBanner(currentLang === 'ru' ? '  cookie !' : ' Cookie settings saved!', 'success');
        }

        (function initCookies() {
            const consent = getCookieConsent();
            if (!consent) showCookieBanner();
        })();

        // ============================================================
        //  GALLERY TAB  
        // ============================================================

        let _galleryCache = null;
        let _galleryAvatarMap = {};
        let _galleryVerifiedMap = {};
        let _galleryFilterMine = false;

        // Update gallery auth state based on buildplates login
        function updateGalleryAuthState() {
            const notLogged = document.getElementById('gallery-not-logged');
            const form = document.getElementById('gallery-upload-form');
            if (!notLogged || !form) return;
            if (currentAccount) {
                notLogged.style.display = 'none';
                form.style.display = 'block';
                updateGalleryDailyLimitUI();
            } else {
                notLogged.style.display = 'block';
                form.style.display = 'none';
            }
        }

        function toggleGalleryFilterMine() {
            _galleryFilterMine = !_galleryFilterMine;
            const btn = document.getElementById('gallery-filter-mine');
            if (btn) btn.classList.toggle('active', _galleryFilterMine);
            filterGallery();
        }

        // Shared daily limit  reads same key as buildplates
        function updateGalleryDailyLimitUI() {
            const panel = document.getElementById('gallery-daily-limit');
            if (!panel) return;
            const ru = currentLang === 'ru';
            const left = getDailyPostsLeft();
            const used = DAILY_LIMIT - left;

            const titleEl = document.getElementById('gallery-limit-title');
            if (titleEl) titleEl.textContent = ru ? '  ' : 'Daily post limit';

            const dotsEl = document.getElementById('gallery-limit-dots');
            if (dotsEl) {
                dotsEl.innerHTML = '';
                for (let i = 0; i < DAILY_LIMIT; i++) {
                    const dot = document.createElement('div');
                    dot.style.cssText = `width:14px;height:14px;border-radius:2px;border:2px solid #8b7355;background:${i < used ? '#c0392b' : '#6b8e23'};box-shadow:0 2px 0 ${i < used ? '#922b21' : '#4a5d23'};image-rendering:pixelated;`;
                    dotsEl.appendChild(dot);
                }
            }

            const textEl = document.getElementById('gallery-limit-text');
            if (textEl) textEl.textContent = ru
                ? `: ${left}  ${DAILY_LIMIT} (  Buildplates)`
                : `Remaining: ${left} of ${DAILY_LIMIT} (shared with Buildplates)`;

            const iconEl = document.getElementById('gallery-limit-icon');
            if (iconEl && !iconEl.src.includes('timer')) iconEl.src = iconUrl('timer_icon.png');

            const submitBtn = document.getElementById('gallery-submit-btn');
            if (submitBtn) {
                submitBtn.disabled = left <= 0;
                submitBtn.title = left <= 0
                    ? (ru ? '   ' : 'Daily post limit reached')
                    : '';
            }
        }

        // Lightbox
        function openGalleryLightbox(imgSrc) {
            const lb = document.createElement('div');
            lb.className = 'gallery-lightbox';
            lb.innerHTML = `
                <button class="gallery-lightbox-close" onclick="this.parentElement.remove()"></button>
                <img src="${imgSrc}" alt="">`;
            lb.addEventListener('click', e => { if (e.target === lb) lb.remove(); });
            document.body.appendChild(lb);
        }

        async function uploadGalleryPhoto() {
            const ru = currentLang === 'ru';
            const title = document.getElementById('gallery-title').value.trim();
            const imageFile = document.getElementById('gallery-image-input').files[0];
            const statusEl = document.getElementById('gallery-status');
            const submitBtn = document.getElementById('gallery-submit-btn');

            const showStatus = (type, msg) => {
                statusEl.textContent = msg;
                statusEl.style.color = type === 'error' ? '#c62828' : '#2e7d32';
            };

            if (!sbClient) { showStatus('error', ru ? ' Supabase  !' : ' Supabase not connected!'); return; }
            if (!currentAccount) { showStatus('error', ru ? '   !' : ' Log in first!'); return; }
            if (getDailyPostsLeft() <= 0) {
                showStatus('error', ru ? '    (3   ).' : ' Daily limit reached (3 posts/day).');
                return;
            }
            if (!title) { showStatus('error', ru ? '  !' : ' Enter a title!'); return; }
            if (typeof containsProfanity === 'function' && containsProfanity(title)) {
                showStatus('error', typeof profanityError === 'function' ? profanityError(ru) : (ru ? '  !' : ' Inappropriate word!'));
                return;
            }
            if (!imageFile) { showStatus('error', ru ? '  !' : ' Choose a photo!'); return; }

            const ext = imageFile.name.split('.').pop().toLowerCase();
            if (!['png','jpg','jpeg','webp'].includes(ext)) {
                showStatus('error', ru ? ' : PNG, JPG  WEBP' : ' Format: PNG, JPG or WEBP');
                return;
            }

            // Check magic bytes
            if (typeof checkImageMagicBytes === 'function') {
                const check = await checkImageMagicBytes(imageFile);
                if (!check.valid) { showStatus('error', ru ? '      !' : ' File corrupted or not a valid image!'); return; }
            }

            submitBtn.disabled = true;
            showStatus('', ru ? '  ...' : ' Uploading photo...');

            try {
                const ts = Date.now();
                const safeName = (currentAccount.nick || 'user').replace(/[^a-zA-Z0-9_]/g, '_');
                const imagePath = `gallery/${safeName}_${ts}.${ext}`;

                const { error: uploadErr } = await sbClient.storage
                    .from('buildplates')
                    .upload(imagePath, imageFile, { contentType: imageFile.type, upsert: false });
                if (uploadErr) throw uploadErr;

                const { data: urlData } = sbClient.storage.from('buildplates').getPublicUrl(imagePath);
                const imageUrl = urlData?.publicUrl || '';

                const { error: insertErr } = await sbClient.from('gallery').insert([{
                    title,
                    author: currentAccount.nick,
                    image_url: imageUrl,
                    image_path: imagePath,
                    likes: 0,
                    dislikes: 0,
                }]);
                if (insertErr) throw insertErr;

                incrementDailyPost();
                updateGalleryDailyLimitUI();
                updateDailyLimitUI();
                showStatus('success', ru ? '  !' : ' Photo published!');
                document.getElementById('gallery-title').value = '';
                document.getElementById('gallery-image-input').value = '';
                document.getElementById('gallery-image-label').innerHTML =
                    `<i class="fas fa-image"></i> <span>${ru ? ',   ' : 'Click to choose image'}</span>`;
                _galleryCache = null;
                loadGallery();
            } catch(e) {
                showStatus('error', ' ' + (e.message || e));
            } finally {
                submitBtn.disabled = getDailyPostsLeft() <= 0;
            }
        }

        async function loadGallery() {
            const gallery = document.getElementById('gallery-gallery');
            const filtersEl = document.getElementById('gallery-filters');
            updateGalleryAuthState();

            if (!sbClient) {
                gallery.innerHTML = `<div class="bp-empty"><i class="fas fa-exclamation-triangle"></i><p>${currentLang === 'ru' ? 'Supabase  ' : 'Supabase not connected'}</p></div>`;
                return;
            }

            if (_galleryCache) { renderGalleryGrid(_galleryCache); return; }

            gallery.innerHTML = '<div class="bp-loading"><i class="fas fa-spinner"></i><p>' + (currentLang === 'ru' ? '...' : 'Loading...') + '</p></div>';

            try {
                const { data, error } = await sbClient.from('gallery')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(200);
                if (error) throw error;

                _galleryCache = data || [];

                // Load avatars  use original author names to match DB nick column
                const authors = [...new Set(_galleryCache.map(p => p.author).filter(Boolean))];
                _galleryAvatarMap = {};
                _galleryVerifiedMap = {};
                if (authors.length > 0) {
                    try {
                        const { data: accs } = await sbClient.from('accounts')
                            .select('nick, avatar_url, verified')
                            .in('nick', authors)
                            .limit(100);
                        (accs || []).forEach(acc => {
                            const k = (acc.nick||'').toLowerCase();
                            if (acc.avatar_url) _galleryAvatarMap[k] = acc.avatar_url;
                            if (acc.verified) _galleryVerifiedMap[k] = true;
                        });
                    } catch(e) { console.warn('Gallery avatars:', e); }
                }

                if (filtersEl) filtersEl.style.display = _galleryCache.length > 0 ? 'flex' : 'none';
                renderGalleryGrid(_galleryCache);
            } catch(e) {
                gallery.innerHTML = `<div class="bp-empty"><i class="fas fa-exclamation-triangle"></i><p>${currentLang === 'ru' ? ' : ' : 'Load error: '}${e.message||e}</p></div>`;
            }
        }

        function filterGallery() {
            if (!_galleryCache) return;
            const query = (document.getElementById('gallery-search')?.value || '').toLowerCase().trim();
            const sort = document.getElementById('gallery-sort')?.value || 'newest';
            const myNick = currentAccount ? currentAccount.nick.toLowerCase() : null;

            let filtered = _galleryCache.filter(p => {
                if (_galleryFilterMine) {
                    const isMine = myNick && (p.author||'').toLowerCase() === myNick;
                    if (!isMine) return false;
                }
                return !query || (p.title||'').toLowerCase().includes(query) || (p.author||'').toLowerCase().includes(query);
            });

            if (sort === 'oldest') filtered = [...filtered].sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
            else if (sort === 'liked') filtered = [...filtered].sort((a,b) => (b.likes||0) - (a.likes||0));
            else filtered = [...filtered].sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

            const countEl = document.getElementById('gallery-count');
            if (countEl) countEl.textContent = currentLang === 'ru'
                ? `${filtered.length} `
                : `${filtered.length} photo${filtered.length !== 1 ? 's' : ''}`;

            const gallery = document.getElementById('gallery-gallery');
            if (filtered.length === 0) {
                gallery.innerHTML = `<div class="bp-empty"><i class="fas fa-image"></i><p>${currentLang === 'ru' ? '  ' : 'Nothing found'}</p></div>`;
                return;
            }
            gallery.innerHTML = '<div class="bp-grid"></div>';
            renderGalleryCards(filtered, gallery.querySelector('.bp-grid'));
        }

        function renderGalleryGrid(data) {
            const gallery = document.getElementById('gallery-gallery');
            const countEl = document.getElementById('gallery-count');

            if (!data || data.length === 0) {
                gallery.innerHTML = `<div class="bp-empty"><i class="fas fa-image"></i><p>${currentLang === 'ru' ? '  .  !' : 'No photos yet. Be the first!'}</p></div>`;
                if (countEl) countEl.textContent = '';
                return;
            }

            // Apply current filter/sort
            const search = (document.getElementById('gallery-search')?.value || '').toLowerCase().trim();
            const sort = document.getElementById('gallery-sort')?.value || 'newest';
            let filtered = search
                ? data.filter(p => (p.title||'').toLowerCase().includes(search) || (p.author||'').toLowerCase().includes(search))
                : [...data];
            if (sort === 'oldest') filtered.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
            else if (sort === 'liked') filtered.sort((a,b) => (b.likes||0) - (a.likes||0));
            else filtered.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

            if (countEl) countEl.textContent = currentLang === 'ru'
                ? `${filtered.length} `
                : `${filtered.length} photo${filtered.length !== 1 ? 's' : ''}`;

            gallery.innerHTML = '<div class="bp-grid"></div>';
            renderGalleryCards(filtered, gallery.querySelector('.bp-grid'));
        }

        function renderGalleryCards(data, grid) {
            const glLikes = JSON.parse(localStorage.getItem('gallery_likes') || '{}');
            const glDislikes = JSON.parse(localStorage.getItem('gallery_dislikes') || '{}');
            const myNick = currentAccount ? currentAccount.nick.toLowerCase() : null;

            data.forEach(photo => {
                const isMine = myNick && (photo.author||'').toLowerCase() === myNick;
                const isLiked = glLikes[photo.id] === true;
                const isDisliked = glDislikes[photo.id] === true;
                const authorLower = (photo.author||'').toLowerCase();
                const authorAvatar = _galleryAvatarMap[authorLower];
                const isVerified = _galleryVerifiedMap[authorLower];
                const ru = currentLang === 'ru';

                // Same avatar html as buildplates
                const avatarHtml = authorAvatar
                    ? `<img class="bp-card-avatar" src="${authorAvatar}" alt="" loading="lazy">`
                    : `<span class="bp-card-avatar-placeholder"><i class="fas fa-user"></i></span>`;

                const dateStr = photo.created_at
                    ? new Date(photo.created_at).toLocaleDateString(ru ? 'ru-RU' : 'en-US', { day: '2-digit', month: 'long', year: 'numeric' }) + ', ' + new Date(photo.created_at).toLocaleTimeString(ru ? 'ru-RU' : 'en-US', { hour: '2-digit', minute: '2-digit' })
                    : (ru ? ' ' : 'Unknown date');

                const card = document.createElement('div');
                card.className = 'bp-card'; //  same class as buildplates
                card.id = 'gallery-card-' + photo.id;

                card.innerHTML = `
                    ${photo.image_url
                        ? `<img class="bp-card-img gallery-tab-img" src="${photo.image_url}" alt="${escapeHtml(photo.title||'')}" loading="lazy">`
                        : `<div class="bp-card-img-placeholder"></div>`}
                    <div class="bp-card-body">
                        <div class="bp-card-name">${escapeHtml(photo.title || (ru ? ' ' : 'Untitled'))}</div>
                        <div class="bp-card-meta">
                            <div class="bp-card-author">
                                ${avatarHtml}
                                <span>${escapeHtml(photo.author || (ru ? '' : 'Unknown'))}${isVerified ? `<span class="verified-badge" title="${ru ? ' ' : 'Verified author'}"><i class="fas fa-check"></i></span>` : ''}</span>
                            </div>
                            <div class="bp-card-date">
                                <i class="fas fa-calendar-alt"></i>
                                <span>${dateStr}</span>
                            </div>
                        </div>
                        <div class="bp-card-actions">
                            <button class="bp-like-btn ${isLiked ? 'liked' : ''}" data-gl-like="${photo.id}">
                                <i class="fas fa-thumbs-up"></i>
                                <span class="gl-like-count">${photo.likes||0}</span>
                            </button>
                            <button class="bp-dislike-btn ${isDisliked ? 'disliked' : ''}" data-gl-dislike="${photo.id}">
                                <i class="fas fa-thumbs-down"></i>
                                <span class="gl-dislike-count">${photo.dislikes||0}</span>
                            </button>
                            <div class="bp-dots-wrap">
                                <button class="bp-dots-btn" data-gl-dots="${photo.id}">&#8943;</button>
                                <div class="bp-dots-dropdown" id="gl-dd-${photo.id}">
                                    <button class="bp-dots-item" data-gl-share="${photo.id}">
                                        <i class="fas fa-share-alt"></i> ${ru ? '' : 'Share'}
                                    </button>
                                    ${!isMine ? `<button class="bp-dots-item danger" data-gl-report="${photo.id}">
                                        <i class="fas fa-flag"></i> ${ru ? '' : 'Report'}
                                    </button>` : ''}
                                </div>
                            </div>
                        </div>
                        ${isMine ? `
                        <button class="bp-delete-btn" id="gl-del-${photo.id}">
                            <i class="fas fa-trash"></i>
                            <span>${ru ? '' : 'Delete'}</span>
                        </button>` : ''}
                    </div>`;

                // Events
                const imgEl = card.querySelector('.gallery-tab-img');
                if (imgEl) imgEl.addEventListener('click', () => openGalleryLightbox(photo.image_url));

                const likeBtn = card.querySelector(`[data-gl-like="${photo.id}"]`);
                const dislikeBtn = card.querySelector(`[data-gl-dislike="${photo.id}"]`);
                const dotsBtn = card.querySelector(`[data-gl-dots="${photo.id}"]`);
                const shareBtn = card.querySelector(`[data-gl-share="${photo.id}"]`);
                const reportBtn = card.querySelector(`[data-gl-report="${photo.id}"]`);
                const deleteBtn = card.querySelector(`#gl-del-${photo.id}`);

                if (likeBtn) likeBtn.addEventListener('click', () => handleGalleryLike(photo.id, likeBtn, dislikeBtn));
                if (dislikeBtn) dislikeBtn.addEventListener('click', () => handleGalleryDislike(photo.id, dislikeBtn, likeBtn));
                if (dotsBtn) dotsBtn.addEventListener('click', e => {
                    e.stopPropagation();
                    document.querySelectorAll('.bp-dots-dropdown.open, .dots-dropdown.open').forEach(d => d.classList.remove('open'));
                    document.getElementById(`gl-dd-${photo.id}`)?.classList.toggle('open');
                });
                if (shareBtn) shareBtn.addEventListener('click', () => {
                    document.getElementById(`gl-dd-${photo.id}`)?.classList.remove('open');
                    const shareUrl = photo.image_url || window.location.href;
                    if (navigator.share) {
                        navigator.share({ title: photo.title, url: shareUrl }).catch(() => {});
                    } else {
                        navigator.clipboard.writeText(shareUrl).then(() =>
                            showInfoBanner(ru ? '  !' : ' Link copied!', 'success')
                        ).catch(() => {});
                    }
                });
                if (reportBtn) reportBtn.addEventListener('click', () => {
                    document.getElementById(`gl-dd-${photo.id}`)?.classList.remove('open');
                    if (!currentAccount) {
                        showInfoBanner(ru ? '   ,  !' : ' Log in to report!', 'error');
                        return;
                    }
                    if (typeof showReportModal === 'function') {
                        showReportModal('gallery', photo.id, photo.title, photo.author, photo.image_url || null);
                    }
                });
                if (deleteBtn) deleteBtn.addEventListener('click', () => deleteGalleryPhoto(photo.id, photo.image_path, deleteBtn));

                grid.appendChild(card);
            });
        }

        async function handleGalleryLike(id, likeBtn, dislikeBtn) {
            if (!sbClient) return;
            if (!currentAccount) {
                showInfoBanner(currentLang === 'ru' ? '      !' : ' Login to like!', 'error');
                return;
            }
            const glLikes = JSON.parse(localStorage.getItem('gallery_likes') || '{}');
            const glDislikes = JSON.parse(localStorage.getItem('gallery_dislikes') || '{}');
            const wasLiked = glLikes[id] === true;
            const wasDisliked = glDislikes[id] === true;
            likeBtn.disabled = true; dislikeBtn.disabled = true;

            const countEl = likeBtn.querySelector('.gl-like-count');
            let count = parseInt(countEl?.textContent || '0');
            const dislikeCountEl = dislikeBtn?.querySelector('.gl-dislike-count');
            let dCount = parseInt(dislikeCountEl?.textContent || '0');

            if (wasLiked) {
                delete glLikes[id]; likeBtn.classList.remove('liked'); count = Math.max(0, count - 1);
                await sbClient.from('gallery').update({ likes: count }).eq('id', id);
            } else {
                glLikes[id] = true; likeBtn.classList.add('liked'); count++;
                if (wasDisliked) {
                    delete glDislikes[id]; dislikeBtn?.classList.remove('disliked'); dCount = Math.max(0, dCount - 1);
                    await sbClient.from('gallery').update({ likes: count, dislikes: dCount }).eq('id', id);
                } else {
                    await sbClient.from('gallery').update({ likes: count }).eq('id', id);
                }
            }
            if (countEl) countEl.textContent = count;
            if (dislikeCountEl) dislikeCountEl.textContent = dCount;
            localStorage.setItem('gallery_likes', JSON.stringify(glLikes));
            localStorage.setItem('gallery_dislikes', JSON.stringify(glDislikes));
            likeBtn.disabled = false; dislikeBtn.disabled = false;
        }

        async function handleGalleryDislike(id, dislikeBtn, likeBtn) {
            if (!sbClient) return;
            if (!currentAccount) {
                showInfoBanner(currentLang === 'ru' ? '      !' : ' Login to like!', 'error');
                return;
            }
            const glLikes = JSON.parse(localStorage.getItem('gallery_likes') || '{}');
            const glDislikes = JSON.parse(localStorage.getItem('gallery_dislikes') || '{}');
            const wasDisliked = glDislikes[id] === true;
            const wasLiked = glLikes[id] === true;
            dislikeBtn.disabled = true; likeBtn.disabled = true;

            const countEl = dislikeBtn.querySelector('.gl-dislike-count');
            let count = parseInt(countEl?.textContent || '0');
            const likeCountEl = likeBtn?.querySelector('.gl-like-count');
            let lCount = parseInt(likeCountEl?.textContent || '0');

            if (wasDisliked) {
                delete glDislikes[id]; dislikeBtn.classList.remove('disliked'); count = Math.max(0, count - 1);
                await sbClient.from('gallery').update({ dislikes: count }).eq('id', id);
            } else {
                glDislikes[id] = true; dislikeBtn.classList.add('disliked'); count++;
                if (wasLiked) {
                    delete glLikes[id]; likeBtn?.classList.remove('liked'); lCount = Math.max(0, lCount - 1);
                    await sbClient.from('gallery').update({ dislikes: count, likes: lCount }).eq('id', id);
                } else {
                    await sbClient.from('gallery').update({ dislikes: count }).eq('id', id);
                }
            }
            if (countEl) countEl.textContent = count;
            if (likeCountEl) likeCountEl.textContent = lCount;
            localStorage.setItem('gallery_likes', JSON.stringify(glLikes));
            localStorage.setItem('gallery_dislikes', JSON.stringify(glDislikes));
            dislikeBtn.disabled = false; likeBtn.disabled = false;
        }

        async function deleteGalleryPhoto(id, imagePath, btn) {
            const ru = currentLang === 'ru';
            if (!window.confirm(ru ? '  ?' : 'Delete this photo?')) return;

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>${ru ? '...' : 'Deleting...'}</span>`;

            try {
                // Delete from DB and check result (like deleteBuildplate)
                const { data: deleted, error: dbErr } = await sbClient.from('gallery').delete().eq('id', id).select();
                if (dbErr) throw new Error((ru ? ' : ' : 'DB error: ') + dbErr.message);
                if (!deleted || deleted.length === 0) throw new Error(ru ? '       ' : 'No permission or record not found');

                // Delete from storage
                if (imagePath) {
                    await sbClient.storage.from('buildplates').remove([imagePath]).catch(e => console.warn('Storage:', e));
                }

                // Update cache
                _galleryCache = _galleryCache ? _galleryCache.filter(p => String(p.id) !== String(id)) : null;

                // Animate card removal
                const card = document.getElementById('gallery-card-' + id);
                if (card) {
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.8)';
                    setTimeout(() => { card.remove(); }, 300);
                }
                showInfoBanner(ru ? '  .' : ' Photo deleted.', 'success');
            } catch(err) {
                console.error(err);
                alert(' ' + err.message);
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-trash"></i> <span>${currentLang === 'ru' ? '' : 'Delete'}</span>`;
            }
        }

        // Wire up file input label for gallery
        document.addEventListener('DOMContentLoaded', () => {
            const galleryInput = document.getElementById('gallery-image-input');
            if (galleryInput) {
                galleryInput.addEventListener('change', function() {
                    const file = this.files[0];
                    const label = document.getElementById('gallery-image-label');
                    if (label) {
                        if (file) {
                            label.innerHTML = `<i class="fas fa-check" style="color:#6b8e23;"></i>  ${file.name}`;
                        } else {
                            const ru = currentLang === 'ru';
                            label.innerHTML = `<i class="fas fa-image"></i> <span>${ru ? ',   ' : 'Click to choose image'}</span>`;
                        }
                    }
                });
            }
        });

        // Hook into setLoggedIn/doLogout to update gallery auth state
        const _origSetLoggedIn = window.setLoggedIn;
        if (typeof _origSetLoggedIn === 'function') {
            window.setLoggedIn = function(...args) {
                _origSetLoggedIn.apply(this, args);
                updateGalleryAuthState();
            };
        }
        const _origDoLogout = window.doLogout;
        if (typeof _origDoLogout === 'function') {
            window.doLogout = function(...args) {
                _origDoLogout.apply(this, args);
                updateGalleryAuthState();
            };
        }

        applyMceIcons();

    </script>    </script>
</body>
</html>
