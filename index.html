<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revival Minecraft Earth</title>
    <link rel="icon" type="image/png" href="https://mcearthproject.qzz.io/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Poppins:wght@400;500;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="An AR project to revive Minecraft Earth using the Vienna Docker">
    <meta name="keywords" content="minecraft earth, minecraft earth revival
minecraft earth server, minecraft earth
download, minecraft ar, mobile ar game, sandbox ar
minecraft earth android, minecraft earth
ios, geolocation game, docker
minecraft community, ar gaming.
survival game, building game, crafting game,ar, minecraft texture, block game">
    <meta name="author" content="Revival Minecraft Earth Team">
    <meta name="robots" content="index, follow">
    <meta http-equiv="Content-Security-Policy" content="default-src *; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; img-src * data: blob:; font-src * data:; connect-src *; frame-src *;">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Revival Minecraft Earth">
    <meta property="og:description" content="An AR project to revive Minecraft Earth using the Vienna Docker">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mcearthproject.qzz.io/">
    <meta property="og:image" content="https://mcearthproject.qzz.io/favicon.ico">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Revival Minecraft Earth">
    <meta name="twitter:description" content="An AR project to revive Minecraft Earth using the Vienna Docker">

    <!-- ===== PWA / HOME SCREEN BANNER ===== -->
    <link rel="manifest" href="manifest.json">

    <!-- Android Chrome: цвет адресной строки и заголовка -->
    <meta name="theme-color" content="#6b8e23">

    <!-- iOS Safari: добавить на главный экран -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MCEarth">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icon-192.png">

    <!-- Microsoft / Windows tiles -->
    <meta name="msapplication-TileColor" content="#6b8e23">
    <meta name="msapplication-TileImage" content="icon-192.png">
    <meta name="msapplication-config" content="none">
    <!-- ===== END PWA ===== -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', 'Arial', sans-serif;
            background: linear-gradient(180deg, #3d5a47 0%, #2d4538 50%, #1e2f28 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(0deg, transparent 24%, rgba(92, 184, 92, 0.03) 25%, rgba(92, 184, 92, 0.03) 26%, transparent 27%, transparent 74%, rgba(92, 184, 92, 0.03) 75%, rgba(92, 184, 92, 0.03) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(92, 184, 92, 0.03) 25%, rgba(92, 184, 92, 0.03) 26%, transparent 27%, transparent 74%, rgba(92, 184, 92, 0.03) 75%, rgba(92, 184, 92, 0.03) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .container {
            background: #f5eed9;
            border-radius: 4px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5), inset 0 0 0 4px #8b7355;
            max-width: 1000px;
            width: 100%;
            padding: 40px;
            padding-bottom: 50px;
            position: relative;
            z-index: 1;
            max-height: 90vh;
            overflow-y: auto;
            border: 4px solid #5a4a3a;
        }

        .container::-webkit-scrollbar {
            width: 14px;
        }

        .container::-webkit-scrollbar-track {
            background: #d4c5a0;
            border-radius: 0px;
            border: 2px solid #8b7355;
        }

        .container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            border-radius: 0px;
            border: 2px solid #4a5d23;
        }

        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 6px;
            background: #d4c5a0;
            border-radius: 2px;
            padding: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 2px 0 rgba(255,255,255,0.2);
            border: 3px solid #8b7355;
        }

        .lang-btn, .theme-btn {
            padding: 10px 20px;
            border: 2px solid #5a4a3a;
            background: #f5eed9;
            color: #3e2723;
            cursor: pointer;
            border-radius: 0px;
            font-weight: 700;
            transition: all 0.15s;
            font-size: 0.9rem;
            box-shadow: 0 4px 0 #3e2f1f;
            text-transform: uppercase;
            font-family: 'Orbitron', monospace;
            letter-spacing: 1px;
        }

        .lang-btn.active, .theme-btn.active {
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            box-shadow: 0 4px 0 #3d4f1c, inset 0 2px 0 rgba(255,255,255,0.15);
            border-color: #4a5d23;
        }

        .lang-btn:hover:not(.active), .theme-btn:hover:not(.active) {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #3e2f1f;
        }

        .lang-btn:active, .theme-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #3e2f1f;
        }

        body.dark-theme {
            background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 50%, #0a0a0a 100%);
        }

        body.dark-theme .container {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #1a1a1a;
            box-shadow: 0 8px 24px rgba(0,0,0,0.7), inset 0 0 0 4px #3a3a3a;
        }

        body.dark-theme h1 {
            color: #8bc34a;
            text-shadow: 0 4px 12px rgba(139, 195, 74, 0.6), 0 0 30px rgba(139, 195, 74, 0.3);
        }

        body.dark-theme .subtitle {
            color: #b0b0b0;
        }

        body.dark-theme .section-title {
            color: #81c784;
        }

        body.dark-theme .language-switcher {
            background: #1a1a1a;
            border-color: #3a3a3a;
        }

        body.dark-theme .lang-btn, body.dark-theme .theme-btn {
            color: #e0e0e0;
            background: #2a2a2a;
            border-color: #3a3a3a;
            box-shadow: 0 4px 0 #0a0a0a;
        }

        body.dark-theme .lang-btn.active, body.dark-theme .theme-btn.active {
            background: linear-gradient(180deg, #7cb342 0%, #558b2f 100%);
            box-shadow: 0 4px 0 #33691e, inset 0 2px 0 rgba(255,255,255,0.15);
            border-color: #33691e;
        }

        body.dark-theme .author-card,
        body.dark-theme .info-card,
        body.dark-theme .step,
        body.dark-theme .faq-item {
            background: #1a1a1a;
            color: #e0e0e0;
            border-color: #3a3a3a;
        }

        body.dark-theme .author-name {
            color: #e0e0e0;
        }

        body.dark-theme .author-role {
            color: #81c784;
        }

        body.dark-theme .link {
            color: #8bc34a;
        }

        body.dark-theme .link:hover {
            color: #aed581;
        }

        body.dark-theme .zerotier-code,
        body.dark-theme .code-text {
            background: #1a1a1a;
            color: #8bc34a;
            border-color: #3a3a3a;
        }

        body.dark-theme .copy-btn {
            background: linear-gradient(180deg, #7cb342 0%, #558b2f 100%);
            border-color: #33691e;
        }

        body.dark-theme .copy-btn:hover {
            background: linear-gradient(180deg, #8bc34a 0%, #689f38 100%);
        }

        body.dark-theme .info-note {
            background: #1a1a1a;
            border-left-color: #81c784;
        }

        body.dark-theme .info-note i {
            color: #81c784;
        }

        body.dark-theme .info-note span {
            color: #b0b0b0;
        }

        body.dark-theme .info-card p {
            color: #e0e0e0;
        }

        body.dark-theme .step-content h3 {
            color: #e0e0e0;
        }

        body.dark-theme .step-content p {
            color: #b0b0b0;
        }

        body.dark-theme .zerotier-code p:first-child {
            color: #b0b0b0;
        }

        body.dark-theme .faq-question {
            color: #8bc34a;
        }

        body.dark-theme .faq-answer {
            color: #b0b0b0;
        }

        h1 {
            text-align: center;
            color: #6b8e23;
            margin-bottom: 10px;
            font-size: 2.5rem;
            margin-top: 60px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2);
            filter: drop-shadow(0 6px 12px rgba(107, 142, 35, 0.4));
        }

        @keyframes glow {
            from {
                text-shadow: 3px 3px 0 rgba(0,0,0,0.2);
            }
            to {
                text-shadow: 3px 3px 0 rgba(0,0,0,0.2), 0 0 20px rgba(107, 142, 35, 0.3);
            }
        }

        .subtitle {
            text-align: center;
            color: #5a4a3a;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .discord-banner {
            text-align: center;
            margin-bottom: 40px;
        }

        .discord-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 30px;
            background: #5865F2;
            color: white;
            border: 3px solid #4752c4;
            border-radius: 2px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            box-shadow: 0 5px 0 #4752c4;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .discord-btn:hover {
            background: #4752c4;
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #3d47a0;
        }

        .discord-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #3d47a0;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #4a5d23;
            font-weight: 800;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 4px solid #6b8e23;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .info-card {
            background: #fffbf0;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 3px solid #8b7355;
            box-shadow: 0 6px 0 #5a4a3a, 0 8px 20px rgba(0,0,0,0.2);
        }

        .info-card p {
            line-height: 1.8;
            color: #4a4a4a;
        }

        .authors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .author-card {
            background: #fffbf0;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            transition: all 0.15s;
            border: 3px solid #8b7355;
            box-shadow: 0 6px 0 #5a4a3a, 0 8px 20px rgba(0,0,0,0.2);
        }

        .author-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 0 #5a4a3a, 0 12px 25px rgba(0,0,0,0.3);
        }

        .author-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #3e2723;
            margin-bottom: 5px;
            font-family: 'Orbitron', sans-serif;
        }

        .author-role {
            font-size: 0.9rem;
            color: #6b8e23;
            margin-bottom: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .author-links {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .link {
            color: #6b8e23;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
        }

        .link:hover {
            color: #556b2f;
            transform: translateX(3px);
        }

        .steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .step {
            display: flex;
            align-items: start;
            gap: 15px;
            background: #fffbf0;
            padding: 20px;
            border-radius: 4px;
            border: 3px solid #8b7355;
            box-shadow: 0 5px 0 #5a4a3a, 0 7px 15px rgba(0,0,0,0.15);
        }

        .step-number {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.4rem;
            flex-shrink: 0;
            border: 2px solid #4a5d23;
            box-shadow: 0 4px 0 #3d4f1c;
            font-family: 'Orbitron', sans-serif;
        }

        .step-content h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #3e2723;
            font-weight: 700;
        }

        .step-content p {
            color: #5a4a3a;
            line-height: 1.6;
        }

        .zerotier-code {
            background: #f0ede0;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #8b7355;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .zerotier-code p:first-child {
            color: #5a4a3a;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .code-container {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .code-text {
            background: #fffbf0;
            padding: 12px 20px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: #3e2723;
            border: 3px solid #8b7355;
            letter-spacing: 2px;
        }

        .copy-btn {
            padding: 12px 20px;
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border: 2px solid #4a5d23;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 0 #3d4f1c;
            text-transform: uppercase;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 1px;
        }

        .copy-btn:hover {
            background: linear-gradient(180deg, #7cb342 0%, #689f38 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #3d4f1c;
        }

        .copy-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #3d4f1c;
        }

        .faq-item {
            background: #fffbf0;
            padding: 15px 20px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 3px solid #8b7355;
            box-shadow: 0 4px 0 #5a4a3a, 0 6px 15px rgba(0,0,0,0.15);
        }

        .faq-question {
            font-weight: 700;
            color: #4a5d23;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.05rem;
        }

        .faq-answer {
            color: #5a4a3a;
            line-height: 1.6;
        }

        .info-note {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #fffbf0;
            border-left: 5px solid #f39c12;
            border-radius: 2px;
            margin-top: 20px;
            border: 3px solid #e67e22;
            box-shadow: 0 4px 8px rgba(243, 156, 18, 0.2);
        }

        .info-note i {
            color: #f39c12;
            font-size: 1.3rem;
        }

        .info-note span {
            color: #8b6914;
            font-weight: 600;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 4px solid #8b7355;
            padding-bottom: 0px;
            justify-content: stretch;
            width: 100%;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 8px;
            border: 3px solid #8b7355;
            border-bottom: none;
            border-right: none;
            background: #d4c5a0;
            color: #3e2723;
            cursor: pointer;
            border-radius: 0;
            font-weight: 700;
            font-size: 0.78rem;
            transition: all 0.15s;
            position: relative;
            box-shadow: inset 0 -3px 0 rgba(0,0,0,0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            text-align: center;
            line-height: 1.2;
        }

        .nav-tab:first-child {
            border-radius: 4px 0 0 0;
            border-left: 3px solid #8b7355;
        }

        .nav-tab:last-child {
            border-radius: 0 4px 0 0;
            border-right: 3px solid #8b7355;
        }

        .nav-icon {
            font-size: 1.2rem;
            line-height: 1;
        }

        .nav-tab:hover {
            background: #e0d5b0;
            transform: translateY(-3px);
        }

        .nav-tab.active {
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.15), 0 5px 10px rgba(0,0,0,0.2);
            border-color: #4a5d23;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* News Section Styles */
        .news-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .news-item {
            position: relative;
            border-radius: 4px;
            padding: 0;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            transition: all 0.2s;
            overflow: hidden;
            min-height: 300px;
            border: 4px solid #5a4a3a;
        }

        .news-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(8px);
            transform: scale(1.1);
            z-index: 1;
        }

        .news-item.has-image::before {
            background-image: var(--news-image);
        }

        .news-item:not(.has-image) {
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
        }

        .news-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .news-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }

        .news-item:hover::before {
            filter: blur(6px);
        }

        .news-content-wrapper {
            position: relative;
            z-index: 3;
            padding: 30px;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 300px;
            justify-content: center;
        }

        .news-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .news-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
            margin: 0;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
        }

        .news-date {
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
            font-weight: 600;
        }

        .news-date i {
            color: rgba(255, 255, 255, 0.95);
        }

        .news-content {
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.8;
            font-size: 1.05rem;
            white-space: pre-wrap;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
        }

        .news-author {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
            margin-top: 5px;
            font-weight: 600;
        }

        .news-author i {
            color: rgba(255, 255, 255, 0.8);
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #1da1f2;
            border-radius: 50%;
            margin-left: 4px;
            flex-shrink: 0;
            vertical-align: middle;
        }

        .verified-badge::before { display: none; }

        .verified-badge i {
            color: white;
            font-size: 10px;
        }

        .news-footer {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .like-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .like-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.15s;
            color: white;
            font-size: 0.95rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            font-weight: 600;
        }

        .like-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.4);
        }

        .like-btn.active {
            background: rgba(76, 175, 80, 0.4);
            border-color: #4caf50;
        }

        .like-btn.active i {
            color: #4caf50;
        }

        .dislike-btn.active {
            background: rgba(244, 67, 54, 0.4);
            border-color: #f44336;
        }

        .dislike-btn.active i {
            color: #f44336;
        }

        .like-btn i {
            font-size: 1rem;
        }

        .like-count {
            font-weight: 700;
        }

        .share-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.15s;
            color: white;
            font-size: 0.95rem;
            backdrop-filter: blur(10px);
            margin-left: auto;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            font-weight: 600;
        }

        .share-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.4);
        }

        .share-btn i {
            font-size: 1rem;
        }

        .news-loading {
            text-align: center;
            padding: 40px;
            color: #5a4a3a;
        }

        .news-loading i {
            font-size: 2rem;
            color: #6b8e23;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .news-empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .news-empty i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }

        .news-empty p {
            font-size: 1.1rem;
        }

        /* Dark theme for tabs */
        body.dark-theme .nav-tabs {
            border-bottom-color: #3a3a3a;
        }

        body.dark-theme .nav-tab {
            color: #e0e0e0;
            background: #1a1a1a;
            border-color: #3a3a3a;
        }

        body.dark-theme .nav-tab:hover {
            color: #e0e0e0;
            background: #2a2a2a;
        }

        body.dark-theme .nav-tab.active {
            color: white;
            background: linear-gradient(180deg, #7cb342 0%, #558b2f 100%);
            border-color: #33691e;
        }

        .news-delete-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(180deg, #c62828 0%, #8b0000 100%);
            color: #fff;
            border: 2px solid #7f0000;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            box-shadow: 0 4px 0 #5a0000;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .news-delete-btn:hover {
            background: linear-gradient(180deg, #e53935 0%, #b71c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #5a0000;
        }
        .news-delete-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #5a0000;
        }
        body.dark-theme .news-delete-btn {
            background: linear-gradient(180deg, #b71c1c 0%, #7f0000 100%);
            border-color: #5a0000;
            box-shadow: 0 4px 0 #3a0000;
        }

        /* Dark theme for news */
        body.dark-theme .news-item:not(.has-image) {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
        }

        body.dark-theme .news-item::after {
            background: rgba(0, 0, 0, 0.6);
        }

        body.dark-theme .news-loading,
        body.dark-theme .news-empty {
            color: #b0b0b0;
        }

        body.dark-theme .container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-color: #3a3a3a;
        }

        body.dark-theme .container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #7cb342 0%, #558b2f 100%);
            border-color: #33691e;
        }

        /* Buildplates Section */
        .bp-upload-card {
            background: #fffbf0;
            padding: 28px;
            border-radius: 4px;
            border: 3px solid #8b7355;
            box-shadow: 0 6px 0 #5a4a3a, 0 8px 20px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .bp-form-row {
            margin-bottom: 16px;
        }

        .bp-form-row label {
            display: block;
            font-weight: 700;
            color: #3e2723;
            margin-bottom: 6px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Montserrat', sans-serif;
        }

        .bp-form-row input[type="text"] {
            width: 100%;
            padding: 12px 14px;
            border: 3px solid #8b7355;
            border-radius: 2px;
            background: #f5eed9;
            color: #3e2723;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            transition: border-color 0.15s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .bp-form-row input[type="text"]:focus {
            border-color: #6b8e23;
        }

        .bp-form-row input[type="password"],
        .bp-form-row input[type="text"].pass-text {
            width: 100%;
            padding: 12px 44px 12px 14px;
            border: 3px solid #8b7355;
            border-radius: 2px;
            background: #f5eed9;
            color: #3e2723;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            transition: border-color 0.15s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .bp-form-row input[type="password"]:focus,
        .bp-form-row input[type="text"].pass-text:focus { border-color: #6b8e23; }

        body.dark-theme .bp-form-row input[type="password"],
        body.dark-theme .bp-form-row input[type="text"].pass-text {
            background: #3a3a3a;
            color: #e0e0e0;
            border-color: #555;
        }

        .pass-wrap {
            position: relative;
            width: 100%;
        }

        .pass-wrap input {
            width: 100% !important;
        }

        .pass-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #8b7355;
            font-size: 1rem;
            padding: 4px;
            transition: color 0.15s;
            z-index: 2;
        }

        .pass-toggle:hover { color: #6b8e23; }
        body.dark-theme .pass-toggle { color: #888; }
        body.dark-theme .pass-toggle:hover { color: #8bc34a; }

        .bp-auth-box {
            background: #eee8d0;
            border: 3px solid #8b7355;
            border-radius: 2px;
            padding: 16px;
            margin-bottom: 16px;
        }

        body.dark-theme .bp-auth-box {
            background: #333;
            border-color: #555;
        }

        .bp-auth-title {
            font-weight: 800;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #3e2723;
            margin-bottom: 12px;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-theme .bp-auth-title { color: #e0e0e0; }

        .bp-auth-status {
            font-size: 0.82rem;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 2px;
            display: none;
        }

        .bp-auth-status.ok { background: #c8e6c9; color: #2e7d32; display: block; }
        .bp-auth-status.err { background: #ffcdd2; color: #c62828; display: block; }
        .bp-auth-status.info { background: #fff9c4; color: #f57f17; display: block; }

        .bp-auth-toggle {
            font-size: 0.8rem;
            color: #6b8e23;
            cursor: pointer;
            text-decoration: underline;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            background: none;
            border: none;
            padding: 0;
            margin-top: 6px;
        }

        .bp-logged-in {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
            padding: 10px 14px;
            background: #c8e6c9;
            border: 2px solid #4caf50;
            border-radius: 2px;
            margin-bottom: 16px;
        }

        body.dark-theme .bp-logged-in { background: #1b5e20; border-color: #388e3c; }

        .bp-logged-in-name {
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
            color: #1b5e20;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        body.dark-theme .bp-logged-in-name { color: #a5d6a7; }

        .bp-logout-btn {
            font-size: 0.78rem;
            background: none;
            border: 2px solid #388e3c;
            color: #2e7d32;
            cursor: pointer;
            padding: 4px 10px;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            border-radius: 2px;
        }

        body.dark-theme .bp-logout-btn { color: #a5d6a7; border-color: #4caf50; }

        .bp-verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            font-size: 0.65rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
            padding: 2px 6px;
            border-radius: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 4px;
            vertical-align: middle;
        }

        .bp-verified-badge i { font-size: 0.65rem; }

        .bp-file-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border: 3px dashed #8b7355;
            border-radius: 2px;
            background: #f5eed9;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: #5a4a3a;
        }

        .bp-file-label:hover {
            border-color: #6b8e23;
            background: #eee8d0;
        }

        .bp-file-label i {
            font-size: 1.3rem;
            color: #6b8e23;
        }

        .bp-file-label input[type="file"] {
            display: none;
        }

        .bp-file-label.drag-over {
            border-color: #6b8e23;
            background: #e4edcc;
            transform: scale(1.01);
        }

        body.dark-theme .bp-file-label.drag-over {
            background: #2a3a1a;
            border-color: #7cb342;
        }

        .bp-formats {
            margin-left: auto;
            font-size: 0.72rem;
            color: #8b7355;
            font-weight: 600;
            white-space: nowrap;
        }

        body.dark-theme .bp-formats {
            color: #888;
        }

        .bp-file-name {
            font-size: 0.85rem;
            color: #6b8e23;
            margin-top: 6px;
            font-weight: 600;
        }

        .bp-submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border: 2px solid #4a5d23;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 0 #3d4f1c;
            text-transform: uppercase;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 1px;
            margin-top: 20px;
        }

        .bp-submit-btn:hover:not(:disabled) {
            background: linear-gradient(180deg, #7cb342 0%, #689f38 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #3d4f1c;
        }

        .bp-submit-btn:active:not(:disabled) {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #3d4f1c;
        }

        .bp-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .bp-status {
            margin-top: 14px;
            padding: 12px 16px;
            border-radius: 2px;
            font-weight: 700;
            text-align: center;
            display: none;
            font-family: 'Montserrat', sans-serif;
        }

        .bp-status.success {
            background: rgba(76, 175, 80, 0.15);
            border: 2px solid #4caf50;
            color: #2e7d32;
            display: block;
        }

        .bp-status.error {
            background: rgba(244, 67, 54, 0.15);
            border: 2px solid #f44336;
            color: #c62828;
            display: block;
        }

        /* Gallery */
        .bp-gallery-title {
            font-size: 1.2rem;
            color: #4a5d23;
            font-weight: 800;
            margin-bottom: 16px;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .bp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
            padding-bottom: 8px;
        }

        .bp-card {
            background: #fffbf0;
            border-radius: 4px;
            border: 3px solid #8b7355;
            box-shadow: 0 5px 0 #5a4a3a, 0 7px 15px rgba(0,0,0,0.15);
            overflow: visible;
            display: flex;
            flex-direction: column;
            transition: all 0.15s;
        }

        .bp-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 9px 0 #5a4a3a, 0 11px 20px rgba(0,0,0,0.25);
        }

        .bp-card-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
            background: #d4c5a0;
            border-radius: 1px 1px 0 0;
        }

        .bp-card-img-placeholder {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #d4c5a0, #c4b590);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            border-radius: 1px 1px 0 0;
        }

        .bp-card-body {
            padding: 14px 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .bp-card-name {
            font-weight: 800;
            color: #3e2723;
            font-size: 1rem;
            margin-bottom: 6px;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 0.5px;
            word-break: break-word;
        }

        .bp-card-meta {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-bottom: 10px;
        }

        .bp-card-author,
        .bp-card-date {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.78rem;
            color: #7a6340;
            font-weight: 600;
        }

        .bp-card-author i,
        .bp-card-date i {
            color: #8b7355;
            width: 12px;
            text-align: center;
        }

        /* Галочка верификации — всегда белая в любой теме */
        .bp-card-author .verified-badge i,
        .verified-badge i {
            color: #fff !important;
            width: auto;
            font-size: 10px;
        }
        body.dark-theme .bp-card-author .verified-badge i,
        body.dark-theme .verified-badge i {
            color: #fff !important;
        }

        .bp-verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: #1da1f2;
            border-radius: 50%;
            margin-left: 4px;
            cursor: help;
        }

        .bp-verified-badge i {
            color: white;
            font-size: 9px;
        }

        body.dark-theme .bp-card-author,
        body.dark-theme .bp-card-date {
            color: #999;
        }

        body.dark-theme .bp-card-author i,
        body.dark-theme .bp-card-date i {
            color: #666;
        }

        .bp-card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%;
        }

        .bp-download-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            padding: 10px 8px;
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border: 2px solid #4a5d23;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.78rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 #3d4f1c;
            text-transform: uppercase;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0;
            text-decoration: none;
            justify-content: center;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
        }
        .bp-download-btn span {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bp-download-btn:hover {
            background: linear-gradient(180deg, #7cb342 0%, #689f38 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #3d4f1c;
        }

        .bp-like-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 12px;
            background: #f5eed9;
            color: #5a4a3a;
            border: 2px solid #8b7355;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 #5a4a3a;
            font-family: 'Montserrat', sans-serif;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .bp-like-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #5a4a3a;
            background: #ffe0e0;
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .bp-like-btn.liked {
            background: linear-gradient(180deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-color: #1a6a9a;
            box-shadow: 0 4px 0 #1a5276;
        }

        @media (hover: hover) {
            .bp-like-btn.liked:hover {
                background: linear-gradient(180deg, #4aa8e8 0%, #3498db 100%);
            }
        }

        body.dark-theme .bp-like-btn {
            background: #2a2a2a;
            color: #b0b0b0;
            border-color: #3a3a3a;
            box-shadow: 0 4px 0 #0a0a0a;
        }

        body.dark-theme .bp-like-btn.liked {
            background: linear-gradient(180deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-color: #1a6a9a;
        }

        .bp-dislike-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 12px;
            background: #f5eed9;
            color: #5a4a3a;
            border: 2px solid #8b7355;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 #5a4a3a;
            font-family: 'Montserrat', sans-serif;
            flex-shrink: 0;
        }

        .bp-dislike-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #5a4a3a;
            background: #e0e8ff;
            border-color: #3498db;
            color: #3498db;
        }

        .bp-dislike-btn.disliked {
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border-color: #922b21;
            box-shadow: 0 4px 0 #7b241c;
        }

        body.dark-theme .bp-dislike-btn {
            background: #2a2a2a;
            color: #b0b0b0;
            border-color: #3a3a3a;
            box-shadow: 0 4px 0 #0a0a0a;
        }

        body.dark-theme .bp-dislike-btn.disliked {
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border-color: #922b21;
        }

        .bp-share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 12px;
            background: #f5eed9;
            color: #5a4a3a;
            border: 2px solid #8b7355;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 #5a4a3a;
            flex-shrink: 0;
        }

        .bp-share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #5a4a3a;
            background: #e8f5e9;
            border-color: #27ae60;
            color: #27ae60;
        }

        body.dark-theme .bp-share-btn {
            background: #2a2a2a;
            color: #b0b0b0;
            border-color: #3a3a3a;
            box-shadow: 0 4px 0 #0a0a0a;
        }

        .bp-loading, .bp-empty {
            text-align: center;
            padding: 50px 20px;
            color: #5a4a3a;
        }

        .bp-loading i, .bp-empty i {
            font-size: 2.5rem;
            color: #6b8e23;
            margin-bottom: 12px;
            display: block;
        }

        .bp-loading i {
            animation: spin 1s linear infinite;
        }

        .bp-empty p {
            font-size: 1.05rem;
            font-weight: 600;
        }

        /* Dark theme buildplates */
        body.dark-theme .bp-upload-card,
        body.dark-theme .bp-card {
            background: #1a1a1a;
            border-color: #3a3a3a;
        }

        body.dark-theme .bp-form-row label {
            color: #e0e0e0;
        }

        body.dark-theme .bp-form-row input[type="text"] {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #3a3a3a;
        }

        body.dark-theme .bp-file-label {
            background: #2a2a2a;
            border-color: #3a3a3a;
            color: #b0b0b0;
        }

        body.dark-theme .bp-file-label:hover {
            border-color: #7cb342;
            background: #333;
        }

        body.dark-theme .bp-card-name {
            color: #e0e0e0;
        }

        body.dark-theme .bp-card-img-placeholder {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
        }

        body.dark-theme .bp-loading,
        body.dark-theme .bp-empty {
            color: #b0b0b0;
        }

        body.dark-theme .bp-gallery-title {
            color: #81c784;
        }

        body.dark-theme .bp-card {
            box-shadow: 0 5px 0 #0a0a0a, 0 7px 15px rgba(0,0,0,0.3);
        }

        /* ====== BUILDPLATE FILTERS ====== */
        .bp-filters {
            display: flex;
            gap: 10px;
            margin: 16px 0 14px;
            flex-wrap: wrap;
            align-items: center;
        }

        .bp-search-wrap {
            flex: 1;
            min-width: 160px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .bp-search-wrap i {
            position: absolute;
            left: 12px;
            color: #8b7355;
            font-size: 0.9rem;
            pointer-events: none;
        }

        .bp-search-wrap input {
            width: 100%;
            padding: 10px 12px 10px 34px;
            border: 3px solid #8b7355;
            border-radius: 2px;
            background: #fffbf0;
            color: #3e2723;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            outline: none;
            box-shadow: 0 4px 0 #5a4a3a, inset 0 2px 4px rgba(0,0,0,.08);
            transition: border-color .15s;
        }

        .bp-search-wrap input::placeholder { color: #a0927c; font-weight: 500; }
        .bp-search-wrap input:focus { border-color: #6b8e23; }

        .bp-sort-select {
            padding: 10px 14px;
            border: 3px solid #8b7355;
            border-radius: 2px;
            background: #fffbf0;
            color: #3e2723;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 0 #5a4a3a;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238b7355'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
            transition: border-color .15s;
        }
        .bp-sort-select:focus { border-color: #6b8e23; }

        .bp-filter-mine-btn {
            padding: 10px 16px;
            border: 3px solid #8b7355;
            border-radius: 2px;
            background: #fffbf0;
            color: #5a4a3a;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.82rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 0 #5a4a3a;
            transition: all .15s;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .bp-filter-mine-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #5a4a3a; }
        .bp-filter-mine-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #5a4a3a; }
        .bp-filter-mine-btn.active {
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border-color: #4a5d23;
            box-shadow: 0 4px 0 #3d4f1c;
        }

        .bp-results-count {
            font-size: 0.78rem;
            font-weight: 700;
            color: #8b7355;
            padding: 0 2px;
            font-family: 'Montserrat', sans-serif;
            white-space: nowrap;
        }

        /* Dark theme filters */
        body.dark-theme .bp-search-wrap input,
        body.dark-theme .bp-sort-select,
        body.dark-theme .bp-filter-mine-btn {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #3a3a3a;
            box-shadow: 0 4px 0 #0a0a0a;
        }
        body.dark-theme .bp-search-wrap i { color: #666; }
        body.dark-theme .bp-search-wrap input::placeholder { color: #666; }
        body.dark-theme .bp-search-wrap input:focus,
        body.dark-theme .bp-sort-select:focus { border-color: #7cb342; }
        body.dark-theme .bp-sort-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23666'/%3E%3C/svg%3E");
        }
        body.dark-theme .bp-filter-mine-btn { color: #b0b0b0; }
        body.dark-theme .bp-filter-mine-btn.active {
            background: linear-gradient(180deg, #7cb342 0%, #558b2f 100%);
            color: white;
            border-color: #33691e;
            box-shadow: 0 4px 0 #1b5e20;
        }
        body.dark-theme .bp-results-count { color: #666; }
        /* ====== END BUILDPLATE FILTERS ====== */

        .bp-delete-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 9px 14px;
            background: linear-gradient(180deg, #c0392b 0%, #922b21 100%);
            color: white;
            border: 2px solid #7b241c;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.82rem;
            transition: all 0.15s;
            box-shadow: 0 4px 0 #641e16;
            text-transform: uppercase;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
            justify-content: center;
        }

        .bp-delete-btn:hover {
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #641e16;
        }

        .bp-delete-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #641e16;
        }

        .bp-delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ====== PROFILE / ACCOUNT STYLES ====== */
        .bp-logged-in-top {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bp-avatar {
            width: 42px;
            height: 42px;
            border-radius: 2px;
            object-fit: cover;
            border: 2px solid #4caf50;
            flex-shrink: 0;
        }
        .bp-avatar-placeholder {
            width: 42px;
            height: 42px;
            border-radius: 2px;
            background: linear-gradient(135deg, #6b8e23, #4a5d23);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
            border: 2px solid #4caf50;
        }
        .bp-profile-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(76,175,80,0.3);
        }
        .bp-profile-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.75rem;
            background: none;
            border: 2px solid #388e3c;
            color: #2e7d32;
            cursor: pointer;
            padding: 9px 4px;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            border-radius: 2px;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
            box-sizing: border-box;
        }
        .bp-profile-btn:hover { background: rgba(76,175,80,0.1); transform: translateY(-1px); }
        .bp-profile-btn.danger { border-color: #c62828; color: #c62828; }
        .bp-profile-btn.danger:hover { background: rgba(198,40,40,0.1); }
        body.dark-theme .bp-profile-btn { color: #a5d6a7; border-color: #4caf50; }
        body.dark-theme .bp-profile-btn.danger { color: #ef9a9a; border-color: #c62828; }
        .bp-profile-file-input { display: none; }
        .bp-email-text { color: #2e7d32; }
        body.dark-theme .bp-email-text { color: #ffffff; }
        .bp-profile-actions-delete {
            margin-top: 6px;
        }

        /* Avatar in card */
        .bp-card-avatar {
            width: 22px;
            height: 22px;
            border-radius: 2px;
            object-fit: cover;
            border: 1px solid #8b7355;
            flex-shrink: 0;
        }
        .bp-card-avatar-placeholder {
            width: 22px;
            height: 22px;
            border-radius: 2px;
            background: linear-gradient(135deg, #6b8e23, #4a5d23);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.65rem;
            flex-shrink: 0;
            border: 1px solid #4a5d23;
        }
        /* Modal for username change */
        .bp-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bp-modal {
            background: #f5eed9;
            border: 4px solid #8b7355;
            border-radius: 4px;
            padding: 28px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 8px 0 #5a4a3a, 0 12px 30px rgba(0,0,0,0.5);
        }
        body.dark-theme .bp-modal { background: #2a2a2a; border-color: #3a3a3a; color: #e0e0e0; }
        .bp-modal h3 {
            font-family: 'Orbitron', sans-serif;
            color: #4a5d23;
            margin-bottom: 16px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        body.dark-theme .bp-modal h3 { color: #81c784; }
        .bp-modal-btns { display: flex; gap: 10px; margin-top: 16px; }

        /* Captcha in auth box */
        .bp-auth-captcha {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            width: 100%;
            overflow: hidden;
        }

        /* ====== COOKIE BANNER ====== */
        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99999;
            background: #f5eed9;
            border-top: 4px solid #5a4a3a;
            box-shadow: 0 -8px 30px rgba(0,0,0,0.4);
            padding: 20px 28px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: space-between;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16,1,0.3,1);
        }
        .cookie-banner.show { transform: translateY(0); }
        body.dark-theme .cookie-banner {
            background: #2a2a2a;
            border-top-color: #3a3a3a;
        }
        .cookie-banner-text {
            flex: 1;
            min-width: 200px;
        }
        .cookie-banner-title {
            font-family: 'Orbitron', monospace;
            font-size: 13px;
            font-weight: 700;
            color: #4a5d23;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.dark-theme .cookie-banner-title { color: #81c784; }
        .cookie-banner-desc {
            font-size: 12px;
            font-weight: 600;
            color: #5a4a3a;
            line-height: 1.6;
            font-family: 'Montserrat', sans-serif;
        }
        body.dark-theme .cookie-banner-desc { color: #b0b0b0; }
        .cookie-banner-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .cookie-accept-btn {
            padding: 11px 24px;
            background: linear-gradient(180deg, #6b8e23 0%, #556b2f 100%);
            color: white;
            border: 2px solid #4a5d23;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.82rem;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 0 #3d4f1c;
            transition: all 0.15s;
        }
        .cookie-accept-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #3d4f1c; }
        .cookie-decline-btn {
            padding: 11px 20px;
            background: #ede8d6;
            color: #5a4a3a;
            border: 2px solid #8b7355;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.82rem;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 0 #5a4a3a;
            transition: all 0.15s;
        }
        .cookie-decline-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #5a4a3a; }
        body.dark-theme .cookie-decline-btn { background: #1a1a1a; color: #b0b0b0; border-color: #3a3a3a; }

        /* Cookie settings toggle in switcher */
        .cookie-settings-btn {
            padding: 10px 20px;
            border: 2px solid #5a4a3a;
            background: #f5eed9;
            color: #3e2723;
            cursor: pointer;
            border-radius: 0px;
            font-weight: 700;
            transition: all 0.15s;
            font-size: 0.85rem;
            box-shadow: 0 4px 0 #3e2f1f;
            text-transform: uppercase;
            font-family: 'Orbitron', monospace;
            letter-spacing: 1px;
        }
        .cookie-settings-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #3e2f1f; }
        body.dark-theme .cookie-settings-btn { color: #e0e0e0; background: #2a2a2a; border-color: #3a3a3a; box-shadow: 0 4px 0 #0a0a0a; }

        /* Cookie modal */
        .cookie-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.65);
            z-index: 99998;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .cookie-modal {
            background: #f5eed9;
            border: 4px solid #8b7355;
            border-radius: 4px;
            padding: 32px;
            max-width: 440px;
            width: 100%;
            box-shadow: 0 8px 0 #5a4a3a, 0 12px 30px rgba(0,0,0,0.5);
        }
        body.dark-theme .cookie-modal { background: #2a2a2a; border-color: #3a3a3a; color: #e0e0e0; }
        .cookie-modal h3 {
            font-family: 'Orbitron', monospace;
            color: #4a5d23;
            margin-bottom: 16px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        body.dark-theme .cookie-modal h3 { color: #81c784; }
        .cookie-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 2px solid #d4c5a0;
            gap: 12px;
        }
        body.dark-theme .cookie-toggle-row { border-bottom-color: #3a3a3a; }
        .cookie-toggle-row:last-of-type { border-bottom: none; }
        .cookie-toggle-info { flex: 1; }
        .cookie-toggle-name {
            font-weight: 800;
            font-size: 0.88rem;
            color: #3e2723;
            font-family: 'Montserrat', sans-serif;
            margin-bottom: 3px;
        }
        body.dark-theme .cookie-toggle-name { color: #e0e0e0; }
        .cookie-toggle-desc {
            font-size: 0.75rem;
            color: #7a6340;
            font-family: 'Montserrat', sans-serif;
            line-height: 1.4;
            font-weight: 600;
        }
        body.dark-theme .cookie-toggle-desc { color: #999; }
        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #c5b89a;
            border: 2px solid #8b7355;
            transition: 0.2s;
            border-radius: 2px;
        }
        .toggle-slider:before {
            position: absolute;
            content: '';
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.2s;
            border-radius: 1px;
        }
        .toggle-switch input:checked + .toggle-slider { background: #6b8e23; border-color: #4a5d23; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(18px); }
        .toggle-switch input:disabled + .toggle-slider { opacity: 0.6; cursor: not-allowed; }

        /* Auth required tooltip on locked actions */
        .auth-locked {
            position: relative;
            cursor: not-allowed !important;
            opacity: 0.55 !important;
        }
        .auth-locked::after {
            content: '🔒 Login required';
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #3e2723;
            color: white;
            font-size: 11px;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            padding: 6px 10px;
            border-radius: 2px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
            z-index: 100;
            border: 2px solid #8b7355;
        }
        .auth-locked:hover::after { opacity: 1; }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
                margin-top: 0;
            }

            .language-switcher {
                position: static;
                margin-bottom: 20px;
                justify-content: center;
            }

            .container {
                padding: 30px 20px;
            }

            .authors {
                grid-template-columns: 1fr;
            }

            .code-container {
                flex-direction: column;
            }

            .code-text {
                width: 100%;
            }

            .nav-tab {
                font-size: 0.68rem;
                padding: 10px 4px;
            }

            .nav-icon {
                font-size: 1.1rem;
            }
        }
    </style>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        // ⚠️ ЗАМЕНИТЕ НА СВОИ ДАННЫЕ с emailjs.com (бесплатно)
        // Инструкция: https://www.emailjs.com/docs/tutorial/overview/
        const EMAILJS_PUBLIC_KEY  = 'GekBvpWazW6ogvM3_';   // Account → API Keys
        const EMAILJS_SERVICE_ID  = 'service_2j4ldbe';           // Email Services
        const EMAILJS_VERIFY_TPL  = 'template_htad8aq';   // Email Templates (подтверждение)
        const EMAILJS_RESET_TPL   = 'template_rxtcd4f';    // Email Templates (сброс пароля)
        const SITE_URL = 'https://mcearthproject.qzz.io';        // URL вашего сайта

        (function() {
            if (EMAILJS_PUBLIC_KEY !== 'YOUR_EMAILJS_PUBLIC_KEY') {
                emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <div class="language-switcher">
            <button class="lang-btn active" onclick="switchLanguage('ru')">🇷🇺 RU</button>
            <button class="lang-btn" onclick="switchLanguage('en')">🇬🇧 EN</button>
            <button class="theme-btn" onclick="toggleTheme()">
                <span class="theme-icon">🌙</span>
            </button>
            <button class="cookie-settings-btn" onclick="showCookieModal()" title="Cookie Settings">🍪</button>
        </div>

        <h1>PROJECT EARTH</h1>
        <p class="subtitle" data-ru="Сохраним Minecraft Earth после закрытия" 
           data-en="Sustaining Minecraft Earth, beyond the closing">
            Сохраним Minecraft Earth после закрытия
        </p>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('home')" data-ru="Главная" data-en="Home"><span class="nav-icon">🏠</span><span>Главная</span></button>
            <button class="nav-tab" onclick="switchTab('news')" data-ru="Новости" data-en="News"><span class="nav-icon">📰</span><span>Новости</span></button>
            <button class="nav-tab" onclick="switchTab('buildplates')" data-ru="Buildplates" data-en="Buildplates"><span class="nav-icon">🏗️</span><span>Buildplates</span></button>
            <button class="nav-tab" id="reports-nav-tab" onclick="switchTab('reports')" data-ru="Жалобы" data-en="Reports" style="display:none;"><span class="nav-icon">🚨</span><span data-ru="Жалобы" data-en="Reports">Жалобы</span></button>
        </div>

        <!-- Home Tab Content -->
        <div id="home-tab" class="tab-content active">
        <div class="discord-banner">
            <a href="https://discord.gg/tWb8RFEMC" target="_blank" class="discord-btn">
                <i class="fab fa-discord"></i>
                <span data-ru="Присоединяйся к нашему Discord!" data-en="Join our Discord!">
                    Присоединяйся к нашему Discord!
                </span>
            </a>
        </div>

        <div class="section">
            <h2 class="section-title" data-ru="🌍 Что такое Project Earth?" 
                data-en="🌍 What is Project Earth?">
                🌍 Что такое Project Earth?
            </h2>
            <div class="info-card">
                <p data-ru="Мы создали сервер для Minecraft Earth на базе готового Vienna Docker и модифицируем клиент, чтобы позволить вам подключаться к нашим серверам. Это позволяет всем желающим продолжить играть в игру после закрытия официальных серверов. Начни свою новую игру в Minecraft Earth с нами!"
                   data-en="We've created a Minecraft Earth server based on the ready-made Vienna Docker and modify the client to allow you to connect to our servers. This allows anyone who wants to continue playing the game after the official servers closed. Start your new Minecraft Earth adventure with us!">
                    Мы создали сервер для Minecraft Earth на базе готового Vienna Docker и модифицируем клиент, чтобы позволить вам подключаться к нашим серверам. Это позволяет всем желающим продолжить играть в игру после закрытия официальных серверов. Начни свою новую игру в Minecraft Earth с нами!
                </p>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-ru="⚙️ Как это работает?" 
                data-en="⚙️ How Does It Work?">
                ⚙️ Как это работает?
            </h2>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3 data-ru="Используем Vienna Docker" data-en="Using Vienna Docker">
                            Используем Vienna Docker
                        </h3>    
                        <p data-ru="Мы запускаем сервер на базе готового Vienna - открытого сервера, сделанного на Docker для восстановления Minecraft Earth"
                           data-en="We run a server based on the ready-made Vienna - an open source Docker server, for restoring Minecraft Earth">
                            Мы запускаем сервер на базе готового Vienna - открытого сервера, сделанного на Docker для восстановления Minecraft Earth
                        </p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3 data-ru="Патчим клиент" data-en="Patch the Client">
                            Патчим клиент
                        </h3>
                        <p data-ru="Модифицируем приложение Minecraft Earth, чтобы оно подключалось к нашему серверу вместо официального"
                           data-en="We modify the Minecraft Earth app to connect to our server instead of the official one">
                            Модифицируем приложение Minecraft Earth, чтобы оно подключалось к нашему серверу вместо официального
                        </p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3 data-ru="Играйте!" data-en="Play!">
                            Играйте!
                        </h3>
                        <p data-ru="Начни новую игру и наслаждайся Minecraft Earth!"
                           data-en="Start a new game and enjoy Minecraft Earth!">
                            Начни новую игру и наслаждайся Minecraft Earth!
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-ru="🎮 Как начать играть?" 
                data-en="🎮 How to Start Playing?">
                🎮 Как начать играть?
            </h2>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3 data-ru="Установи ZeroTier One" data-en="Install ZeroTier One">
                            Установи ZeroTier One
                        </h3>
                        <p data-ru="Скачай и установи приложение ZeroTier One для своего устройства"
                           data-en="Download and install ZeroTier One app for your device">
                            Скачай и установи приложение ZeroTier One для своего устройства
                        </p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3 data-ru="Введи код сети" data-en="Enter Network Code">
                            Введи код сети
                        </h3>
                        <p data-ru="Введи следующий код в ZeroTier One:"
                           data-en="Enter this code in ZeroTier One:">
                            Введи следующий код в ZeroTier One:
                        </p>
                    </div>
                </div>
            </div>

            <div class="zerotier-code">
                <p data-ru="ZeroTier Network ID:" data-en="ZeroTier Network ID:">
                    ZeroTier Network ID:
                </p>
                <div class="code-container">
                    <p class="code-text">3b19b3a716030d76</p>
                    <button class="copy-btn" onclick="copyZeroTier()">
                        <i class="fas fa-copy"></i>
                        <span data-ru="Копировать" data-en="Copy">Копировать</span>
                    </button>
                </div>
            </div>

            <div class="steps">
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3 data-ru="Ожидай авторизацию" data-en="Wait for Authorization">
                            Ожидай авторизацию
                        </h3>
                        <p data-ru="Подожди, пока мы авторизуем тебя в сети 🙂"
                           data-en="Wait until we authorize you in the network 🙂">
                            Подожди, пока мы авторизуем тебя в сети 🙂
                        </p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h3 data-ru="Скачай APK" data-en="Download APK">
                            Скачай APK
                        </h3>
                        <p data-ru="Скачай модифицированное приложение Minecraft Earth из нашего Discord сервера"
                           data-en="Download the modified Minecraft Earth app from our Discord server">
                            Скачай модифицированное приложение Minecraft Earth из нашего Discord сервера
                        </p>
                    </div>
                </div>

                <div class="step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <h3 data-ru="Наслаждайся игрой!" data-en="Enjoy the Game!">
                            Наслаждайся игрой!
                        </h3>
                        <p data-ru="Включи ZeroTier One и запусти игру. Добро пожаловать обратно в Minecraft Earth! 😊"
                           data-en="Enable ZeroTier One and launch the game. Welcome back to Minecraft Earth! 😊">
                            Включи ZeroTier One и запусти игру. Добро пожаловать обратно в Minecraft Earth! 😊
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-ru="👥 Создатели" data-en="👥 Creators">
                👥 Создатели
            </h2>
            <div class="authors">
                <div class="author-card">
                    <div class="author-name">SuperDima8050</div>
                    <div class="author-role" data-ru="Помощник | Разработчик | Создатель сайта" 
                         data-en="Assistant | Developer | Website Creator">
                        Помощник | Разработчик | Создатель сайта
                    </div>
                    <div class="author-links">
                        <a href="https://discord.com/users/1203235739752595487" class="link" target="_blank">
                            <i class="fab fa-discord"></i>
                            <span>@superdima8050</span>
                        </a>
                        <a href="https://github.com/SuperDima8050" class="link" target="_blank">
                            <i class="fab fa-github"></i>
                            <span>github.com/SuperDima8050</span>
                        </a>
                        <a href="https://mcearthproject.qzz.io" class="link" target="_blank">
                            <i class="fas fa-globe"></i>
                            <span>mcearthproject.qzz.io</span>
                        </a>
                    </div>
                </div>

                <div class="author-card">
                    <div class="author-name">Kostyaniche</div>
                    <div class="author-role" data-ru="Гл. Разработчик проекта | Хост" 
                         data-en="Lead Developer | Host">
                        Гл. Разработчик проекта | Хост
                    </div>
                    <div class="author-links">
                        <a href="https://discord.com/users/1285524289361154061" class="link" target="_blank">
                            <i class="fab fa-discord"></i>
                            <span>@kostyaniche</span>
                        </a>
                    </div>
                </div>

                <div class="author-card">
                    <div class="author-name">Micheal65536</div>
                    <div class="author-role" data-ru="Основатель" data-en="Founder">
                        Основатель
                    </div>
                    <div class="author-links">
                        <a href="https://discord.com/users/864232575853658183" class="link" target="_blank">
                            <i class="fab fa-discord"></i>
                            <span>@micheal65536</span>
                        </a>
                    </div>
                </div>

                <div class="author-card">
                    <div class="author-name">Halolamemes</div>
                    <div class="author-role" data-ru="Помощник" data-en="Assistant">
                        Помощник
                    </div>
                    <div class="author-links">
                        <a href="https://discord.com/users/1122063385811496970" class="link" target="_blank">
                            <i class="fab fa-discord"></i>
                            <span>@halolamemes</span>
                        </a>
                    </div>
                </div>

                <div class="author-card">
                    <div class="author-name">Prostofanatdeltaruna</div>
                    <div class="author-role" data-ru="Помощник" data-en="Assistant">
                        Помощник
                    </div>
                    <div class="author-links">
                        <a href="https://discord.com/users/1438966243276099664" class="link" target="_blank">
                            <i class="fab fa-discord"></i>
                            <span>@prostofanatdeltaruna</span>
                             </a>
                        <a href="https://projectreviver.qzz.io" class="link" target="_blank">
                            <i class="fas fa-globe"></i>
                            <span>projectreviver.qzz.io</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
            
        <div class="section">
            <h2 class="section-title" data-ru="❓ Часто задаваемые вопросы" 
                data-en="❓ FAQ">
                ❓ Часто задаваемые вопросы
            </h2>
            
            <div class="faq-item">
                <div class="faq-question">
                    <i class="fas fa-question-circle"></i>
                    <span data-ru="Это бесплатно?" data-en="Is it free?">
                        Это бесплатно?
                    </span>
                </div>
                <div class="faq-answer" data-ru="Да! Project Earth полностью бесплатен для всех игроков." 
                     data-en="Yes! Project Earth is completely free for all players.">
                    Да! Project Earth полностью бесплатен для всех игроков.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question">
                    <i class="fas fa-question-circle"></i>
                    <span data-ru="Что такое Project Genoa?" data-en="What is Project Genoa?">
                        Что такое Project Genoa?
                    </span>
                </div>
                <div class="faq-answer" data-ru="Project Genoa - это открытый проект для воссоздания серверной части Minecraft Earth. Мы используем Vienna Docker для работы нашего сервера." 
                     data-en="Project Genoa is an open-source project to recreate the server-side of Minecraft Earth. We use their Vienna Docker to run our server">
                    Project Genoa - это открытый проект для воссоздания серверной части Minecraft Earth. Мы используем их Vienna Docker для работы нашего сервера.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question">
                    <i class="fas fa-question-circle"></i>
                    <span data-ru="Где скачать APK?" data-en="Where to download APK?">
                        Где скачать APK?
                    </span>
                </div>
                <div class="faq-answer" data-ru="Модифицированный APK доступен на нашем Discord сервере. Присоединяйтесь и следуйте инструкциям!" 
                     data-en="The modified APK is available on our Discord server. Join and follow the instructions!">
                    Модифицированный APK доступен на нашем Discord сервере. Присоединяйтесь и следуйте инструкциям!
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question">
                    <i class="fas fa-question-circle"></i>
                    <span data-ru="Нужен ли мне ZeroTier?" data-en="Do I need ZeroTier?">
                        Нужен ли мне ZeroTier?
                    </span>
                </div>
                <div class="faq-answer" data-ru="Да, ZeroTier необходим для подключения к нашему серверу. Это создаёт безопасную виртуальную сеть для игры." 
                     data-en="Yes, ZeroTier is required to connect to our server. It creates a secure virtual network for the game.">
                    Да, ZeroTier необходим для подключения к нашему серверу. Это создаёт безопасную виртуальную сеть для игры.
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" data-ru="🔗 Полезные ссылки" 
                data-en="🔗 Useful Links">
                🔗 Полезные ссылки
            </h2>
            <div class="info-card">
                <p style="margin-bottom: 15px;">
                    <strong>Project Genoa (API):</strong><br>
                    <a href="https://github.com/Project-Genoa" target="_blank" style="color: #667eea;">
                        <i class="fab fa-github"></i> github.com/Project-Genoa
                    </a>
                </p>
                <p style="margin-bottom: 15px;">
                    <strong data-ru="Наш Discord:" data-en="Our Discord:">Наш Discord:</strong><br>
                    <a href="https://discord.gg/tWb8RFEMC" target="_blank" style="color: #5865F2;">
                        <i class="fab fa-discord"></i> discord.gg/tWb8RFEMC
                    </a>
                </p>
                <p>
                    <strong data-ru="Reddit сообщество:" data-en="Reddit Community:">Reddit сообщество:</strong><br>
                    <a href="https://reddit.com/r/ProjectEarth" target="_blank" style="color: #FF4500;">
                        <i class="fab fa-reddit-alien"></i> r/ProjectEarth
                    </a>
                </p>
            </div>
        </div>
        </div>
        <!-- End Home Tab -->

        <!-- News Tab Content -->
        <div id="news-tab" class="tab-content">
            <div class="section">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
                    <h2 class="section-title" style="margin-bottom:0;border-bottom:none;padding-bottom:0;" data-ru="📰 Новости проекта" data-en="📰 Project News">📰 Новости проекта</h2>
                    <button class="copy-btn" onclick="showNewsAdminPanel()" style="font-size:0.8rem;padding:8px 14px;">
                        <i class="fas fa-plus"></i> <span data-ru="Добавить новость" data-en="Add News">Добавить новость</span>
                    </button>
                </div>
                <div id="news-container" class="news-container">
                    <div class="news-empty">
                        <i class="fas fa-newspaper"></i>
                        <p data-ru="Нет новостей" data-en="No news">Нет новостей</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- End News Tab -->

        <!-- Buildplates Tab Content -->
        <div id="buildplates-tab" class="tab-content">
            <div class="section">
                <h2 class="section-title" data-ru="🏗️ Поделиться Buildplate" data-en="🏗️ Share Buildplate">
                    🏗️ Поделиться Buildplate
                </h2>

                <!-- Upload Form -->
                <div class="bp-upload-card">
                    <div class="bp-form-row">
                        <label data-ru="Название" data-en="Name">Название</label>
                        <input type="text" id="bp-name" placeholder="Например, plains_16x16" data-placeholder-ru="Мой крутой Buildplate" data-placeholder-en="For example, plains_16x16" maxlength="60" />
                    </div>

                    <!-- AUTH BOX -->
                    <div id="bp-auth-section">
                        <!-- Not logged in -->
                        <div id="bp-auth-form" class="bp-auth-box">
                            <div class="bp-auth-title"><i class="fas fa-lock"></i> <span id="bp-auth-mode-title" data-ru="Войти / Зарегистрироваться" data-en="Login / Register">Войти / Зарегистрироваться</span></div>
                            <div class="bp-form-row" style="margin-bottom:10px;">
                                <label data-ru="Никнейм" data-en="Nickname">Никнейм</label>
                                <input type="text" id="bp-auth-nick" placeholder="Halolamemes" maxlength="40" />
                            </div>
                            <!-- Email — только при регистрации -->
                            <div class="bp-form-row" id="bp-email-row" style="margin-bottom:10px; display:none;">
                                <label data-ru="Email" data-en="Email">Email</label>
                                <input type="email" id="bp-auth-email" placeholder="you@example.com" maxlength="120" style="width:100%;padding:12px 14px;border:3px solid #8b7355;border-radius:2px;background:#f5eed9;color:#3e2723;font-family:Montserrat,sans-serif;font-size:1rem;font-weight:600;outline:none;transition:border-color .15s;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);" />
                            </div>
                            <div class="bp-form-row" style="margin-bottom:10px;">
                                <label data-ru="Пароль" data-en="Password">Пароль</label>
                                <div class="pass-wrap"><input type="password" id="bp-auth-pass" placeholder="••••••••" maxlength="100" /><button type="button" class="pass-toggle" onclick="togglePass('bp-auth-pass',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                            </div>
                            <!-- Подтверждение пароля — только при регистрации -->
                            <div class="bp-form-row" id="bp-pass2-row" style="margin-bottom:10px; display:none;">
                                <label data-ru="Повтори пароль" data-en="Confirm Password">Повтори пароль</label>
                                <div class="pass-wrap"><input type="password" id="bp-auth-pass2" placeholder="••••••••" maxlength="100" style="width:100%;padding:12px 44px 12px 14px;border:3px solid #8b7355;border-radius:2px;background:#f5eed9;color:#3e2723;font-family:Montserrat,sans-serif;font-size:1rem;font-weight:600;outline:none;transition:border-color .15s;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);" /><button type="button" class="pass-toggle" onclick="togglePass('bp-auth-pass2',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                            </div>
                            <button class="bp-submit-btn" style="margin-top:4px; font-size:0.85rem; padding:10px;" onclick="doAuth()">
                                <i class="fas fa-sign-in-alt"></i>
                                <span id="bp-auth-btn-text" data-ru="Войти" data-en="Login">Войти</span>
                            </button>
                            <div class="bp-auth-status" id="bp-auth-status"></div>
                            <div class="bp-auth-captcha" id="auth-captcha-wrap"></div>
                            <script>
                            (function() {
                                var wrap = document.getElementById('auth-captcha-wrap');
                                var isCompact = window.innerWidth <= 480;
                                var savedTheme = localStorage.getItem('theme');
                                var isDark = savedTheme === 'dark'
                                    || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
                                var div = document.createElement('div');
                                div.className = 'cf-turnstile';
                                div.id = 'auth-turnstile';
                                div.setAttribute('data-sitekey', '0x4AAAAAACZyA1UOix1SiYwF');
                                div.setAttribute('data-theme', isDark ? 'dark' : 'light');
                                div.setAttribute('data-size', isCompact ? 'compact' : 'normal');
                                wrap.appendChild(div);
                            })();
                            </script>
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px;margin-top:6px;">
                                <button class="bp-auth-toggle" onclick="toggleAuthMode()" id="bp-auth-toggle-btn" data-ru="Нет аккаунта? Зарегистрироваться" data-en="No account? Register">Нет аккаунта? Зарегистрироваться</button>
                                <button class="bp-auth-toggle" id="bp-forgot-btn" onclick="showForgotModal()" style="color:#e67e22;" data-ru="Забыл пароль?" data-en="Forgot password?">Забыл пароль?</button>
                            </div>

                        </div>
                        <!-- Logged in -->
                        <div id="bp-logged-in-box" class="bp-logged-in" style="display:none;">
                            <!-- Верхняя строка: аватар + имя + почта -->
                            <div class="bp-logged-in-top">
                                <div id="bp-profile-avatar-wrap">
                                    <div class="bp-avatar-placeholder" id="bp-avatar-placeholder"><i class="fas fa-user"></i></div>
                                    <img class="bp-avatar" id="bp-avatar-img" src="" alt="avatar" style="display:none;" />
                                </div>
                                <div style="flex:1;min-width:0;overflow:hidden;">
                                    <div class="bp-logged-in-name" id="bp-logged-in-name"></div>
                                    <div id="bp-email-verified-badge" style="display:none;margin-top:4px;" class="bp-email-text"></div>
                                    <div id="bp-join-date" style="display:none;font-size:0.72rem;font-weight:600;margin-top:3px;opacity:0.75;"></div>
                                </div>
                            </div>
                            <!-- Кнопки -->
                            <div class="bp-profile-actions">
                                <label class="bp-profile-btn" style="cursor:pointer;">
                                    <i class="fas fa-image"></i>
                                    <span data-ru="Иконка" data-en="Avatar">Иконка</span>
                                    <input type="file" class="bp-profile-file-input" id="bp-avatar-upload" accept=".png,.jpg,.jpeg,.gif,.webp" onchange="uploadAvatar(this)" />
                                </label>
                                <button class="bp-profile-btn" onclick="showRenameModal()">
                                    <i class="fas fa-pencil-alt"></i>
                                    <span data-ru="Имя" data-en="Username">Имя</span>
                                </button>
                                <button class="bp-profile-btn" onclick="showChangePassModal()">
                                    <i class="fas fa-key"></i>
                                    <span data-ru="Пароль" data-en="Password">Пароль</span>
                                </button>
                                <button class="bp-profile-btn" onclick="doLogout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span data-ru="Выйти" data-en="Logout">Выйти</span>
                                </button>
                            </div>
                            <div class="bp-profile-actions-delete">
                                <button class="bp-profile-btn danger" onclick="deleteAccount()">
                                    <i class="fas fa-trash-alt"></i>
                                    <span data-ru="Удалить аккаунт" data-en="Delete Account">Удалить аккаунт</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- hidden author field -->
                    <input type="hidden" id="bp-author" />

                    <div class="bp-form-row">
                        <label data-ru="Скриншот" data-en="Screenshot">Скриншот</label>
                        <label class="bp-file-label" id="bp-image-label-wrap" for="bp-image-input">
                            <i class="fas fa-image"></i>
                            <span id="bp-image-label" data-ru="Выбери или перетащи сюда..." data-en="Choose or drag here...">Выбери или перетащи сюда...</span>
                            <span class="bp-formats">PNG · JPEG · GIF · WebP</span>
                            <input type="file" id="bp-image-input" accept=".png,.jpg,.jpeg,.gif,.webp" />
                        </label>
                        <div class="bp-file-name" id="bp-image-name"></div>
                    </div>

                    <div class="bp-form-row">
                        <label data-ru="Файл Buildplate (world)" data-en="Buildplate File (world)">Файл Buildplate (world)</label>
                        <label class="bp-file-label" id="bp-world-label-wrap" for="bp-world-input">
                            <i class="fas fa-cube"></i>
                            <span id="bp-world-label" data-ru="Выбери или перетащи world файл..." data-en="Choose or drag world file...">Выбери или перетащи world файл...</span>
                            <input type="file" id="bp-world-input" />
                        </label>
                        <div class="bp-file-name" id="bp-world-name"></div>
                    </div>

                    <button class="bp-submit-btn" id="bp-submit-btn" onclick="uploadBuildplate()">
                        <i class="fas fa-upload"></i>
                        <span data-ru="Загрузить Buildplate" data-en="Upload Buildplate">Загрузить Buildplate</span>
                    </button>
                    <div class="bp-status" id="bp-status"></div>
                </div>

                <!-- Gallery -->
                <div class="bp-gallery-title" data-ru="📦 Buildplates сообщества" data-en="📦 Community Buildplates">
                    📦 Buildplates сообщества
                </div>

                <!-- Filters -->
                <div class="bp-filters" id="bp-filters" style="display:none;">
                    <div class="bp-search-wrap">
                        <i class="fas fa-search"></i>
                        <input type="text" id="bp-search"
                               data-placeholder-ru="Поиск по названию или автору..."
                               data-placeholder-en="Search by name or author..."
                               placeholder="Поиск по названию или автору..." />
                    </div>
                    <select class="bp-sort-select" id="bp-sort">
                        <option value="newest" data-ru="🕐 Сначала новые" data-en="🕐 Newest first">🕐 Сначала новые</option>
                        <option value="oldest" data-ru="🕰️ Сначала старые" data-en="🕰️ Oldest first">🕰️ Сначала старые</option>
                        <option value="liked" data-ru="👍 По лайкам" data-en="👍 Most liked">👍 По лайкам</option>
                        <option value="rating" data-ru="⭐ По рейтингу" data-en="⭐ By rating">⭐ По рейтингу</option>
                    </select>
                    <button class="bp-filter-mine-btn" id="bp-filter-mine"
                            data-ru="👤 Мои" data-en="👤 Mine"
                            onclick="toggleFilterMine()">👤 Мои</button>
                    <span class="bp-results-count" id="bp-results-count"></span>
                </div>

                <div id="bp-gallery">
                    <div class="bp-loading">
                        <i class="fas fa-spinner"></i>
                        <p data-ru="Загрузка..." data-en="Loading...">Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Buildplates Tab -->

        <!-- Reports Tab (Admin Only) -->
        <div id="reports-tab" class="tab-content">
            <div class="section">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
                    <h2 class="section-title" style="margin-bottom:0;border-bottom:none;padding-bottom:0;">🚨 <span data-ru="Жалобы" data-en="Reports">Жалобы</span></h2>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="copy-btn" id="reports-filter-pending" onclick="window.filterReports('pending')" style="font-size:0.78rem;padding:6px 12px;background:linear-gradient(180deg,#c62828,#8b1a1a);border-color:#8b1a1a;box-shadow:0 4px 0 #5a0d0d;">
                            ⏳ <span data-ru="Ожидают" data-en="Pending">Ожидают</span>
                        </button>
                        <button class="copy-btn" id="reports-filter-resolved" onclick="window.filterReports('resolved')" style="font-size:0.78rem;padding:6px 12px;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 4px 0 #222;">
                            ✅ <span data-ru="Решённые" data-en="Resolved">Решённые</span>
                        </button>
                    </div>
                </div>
                <div id="reports-container">
                    <div class="news-empty"><i class="fas fa-flag"></i><p data-ru="Нет жалоб" data-en="No reports">Нет жалоб</p></div>
                </div>
            </div>
        </div>
        <!-- End Reports Tab -->

        <div class="info-note">
            <i class="fas fa-info-circle"></i>
            <span data-ru="Этот проект создан фанатами и не связан с Mojang или Microsoft" 
                  data-en="This project is created by fans and is not affiliated with Mojang or Microsoft">
                Этот проект создан фанатами и не связан с Mojang или Microsoft
            </span>
        </div>
    </div>

    <!-- ===== COOKIE BANNER ===== -->
    <div class="cookie-banner" id="cookie-banner">
        <div class="cookie-banner-text">
            <div class="cookie-banner-title">🍪 Cookie Notice</div>
            <div class="cookie-banner-desc" data-ru="Мы используем cookies для сохранения сессии, лайков и настроек. Без них сайт не будет работать правильно." data-en="We use cookies to save your session, likes and preferences. Without them the site won't work correctly.">
                We use cookies to save your session, likes and preferences. Without them the site won't work correctly.
            </div>
        </div>
        <div class="cookie-banner-btns">
            <button class="cookie-accept-btn" onclick="acceptCookies()" data-ru="✔ Принять все" data-en="✔ Accept All">✔ Accept All</button>
            <button class="cookie-decline-btn" onclick="declineCookies()" data-ru="Только нужные" data-en="Essential Only">Essential Only</button>
        </div>
    </div>

    <!-- Supabase News System -->
    <script>
        // ========== NEWS SYSTEM (Supabase) ==========

        function makeLinksClickable(text) {
            if (!text) return '';
            return text.replace(/(https?:\/\/[^\s<>"]+)/g, '<a href="$1" target="_blank" rel="noopener" style="color:#6b8e23;word-break:break-all;">$1</a>');
        }

        async function loadNews() {
            const newsContainer = document.getElementById('news-container');
            const emptyHTML = `
                <div class="news-empty">
                    <i class="fas fa-newspaper"></i>
                    <p data-ru="Нет новостей" data-en="No news">${currentLang === 'ru' ? 'Нет новостей' : 'No news'}</p>
                </div>`;
            if (!sbClient) {
                newsContainer.innerHTML = emptyHTML;
                return;
            }
            newsContainer.innerHTML = '<div class="news-loading"><i class="fas fa-spinner fa-spin"></i><p data-ru="Загрузка новостей..." data-en="Loading news...">Загрузка новостей...</p></div>';

            let newsArray, error, isAdmin;
            try {
                const result = await Promise.all([
                    sbClient.from('news').select('*').order('created_at', { ascending: false }).limit(50),
                    checkNewsAdmin()
                ]);
                newsArray = result[0].data;
                error = result[0].error;
                isAdmin = result[1];
            } catch (e) {
                newsContainer.innerHTML = emptyHTML;
                return;
            }

            newsContainer.innerHTML = '';

            if (error || !newsArray || newsArray.length === 0) {
                newsContainer.innerHTML = emptyHTML;
                return;
            }

            const userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');

            newsArray.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';

                if (news.image_url) {
                    newsItem.classList.add('has-image');
                    newsItem.style.setProperty('--news-image', `url(${news.image_url})`);
                }

                const date = new Date(news.created_at);
                const formattedDateRu = date.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const formattedDateEn = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                const userLiked = userLikes[news.id] === 'like';
                const userDisliked = userLikes[news.id] === 'dislike';
                const likes = news.likes || 0;
                const dislikes = news.dislikes || 0;

                let authorHTML = '';
                if (news.author) {
                    const verifiedBadge = news.author_verified ? '<span class="verified-badge"><i class="fas fa-check"></i></span>' : '';
                    authorHTML = `<div class="news-author"><i class="fas fa-user"></i><span>${news.author}${verifiedBadge}</span></div>`;
                }

                const deleteBtn = isAdmin ? `
                    <button class="news-delete-btn" data-delete="true" title="${currentLang === 'ru' ? 'Удалить новость' : 'Delete news'}">
                        <i class="fas fa-trash"></i>
                    </button>` : '';

                newsItem.innerHTML = `
                    <div class="news-content-wrapper">
                        <div class="news-header">
                            <h3 class="news-title" data-ru="${news.title || 'Без названия'}" data-en="${news.title_en || news.title || 'Untitled'}">${currentLang === 'ru' ? (news.title || 'Без названия') : (news.title_en || news.title || 'Untitled')}</h3>
                            <div class="news-date">
                                <i class="fas fa-clock"></i>
                                <span data-ru="${formattedDateRu}" data-en="${formattedDateEn}">${currentLang === 'ru' ? formattedDateRu : formattedDateEn}</span>
                            </div>
                            ${authorHTML}
                        </div>
                        <div class="news-content">${makeLinksClickable(currentLang === 'ru' ? (news.content || '') : (news.content_en || news.content || ''))}</div>
                        <div class="news-footer">
                            <div class="like-buttons">
                                <button class="like-btn ${userLiked ? 'active' : ''}" data-action="like">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span class="like-count">${likes}</span>
                                </button>
                                <button class="like-btn dislike-btn ${userDisliked ? 'active' : ''}" data-action="dislike">
                                    <i class="fas fa-thumbs-down"></i>
                                    <span class="like-count">${dislikes}</span>
                                </button>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <button class="share-btn" data-share="true">
                                    <i class="fas fa-share-alt"></i>
                                    <span data-ru="Поделиться" data-en="Share">${currentLang === 'ru' ? 'Поделиться' : 'Share'}</span>
                                </button>
                                ${!isAdmin && currentAccount ? `<button class="news-delete-btn" data-report="true" title="${currentLang === 'ru' ? 'Пожаловаться' : 'Report'}" style="background:linear-gradient(180deg,#c62828,#8b1a1a);border-color:#8b1a1a;box-shadow:0 3px 0 #5a0d0d;"><i class="fas fa-flag"></i></button>` : ''}
                                ${deleteBtn}
                            </div>
                        </div>
                    </div>`;

                const likeBtn = newsItem.querySelector('[data-action="like"]');
                const dislikeBtn = newsItem.querySelector('[data-action="dislike"]');
                const shareBtn = newsItem.querySelector('[data-share="true"]');

                likeBtn.addEventListener('click', () => handleNewsLike(news.id, 'like', likeBtn, dislikeBtn));
                dislikeBtn.addEventListener('click', () => handleNewsLike(news.id, 'dislike', likeBtn, dislikeBtn));
                shareBtn.addEventListener('click', () => handleNewsShare(news, shareBtn));

                if (!isAdmin && currentAccount) {
                    const repBtn = newsItem.querySelector('[data-report="true"]');
                    if (repBtn) repBtn.addEventListener('click', () => showReportModal('news', news.id, news.title || 'Без названия', news.author, news.image_url || null));
                }

                if (isAdmin) {
                    const delBtn = newsItem.querySelector('[data-delete="true"]');
                    delBtn.addEventListener('click', () => confirmDeleteNews(news.id, news.title || 'Без названия', newsItem));
                }

                newsContainer.appendChild(newsItem);
            });
        }

        async function confirmDeleteNews(newsId, newsTitle, newsItemEl) {
            const ru = currentLang === 'ru';
            if (!confirm(ru ? `Удалить новость "${newsTitle}"?\nЭто действие нельзя отменить.` : `Delete news "${newsTitle}"?\nThis cannot be undone.`)) return;
            await deleteNews(newsId, newsItemEl);
        }

        async function deleteNews(newsId, newsItemEl) {
            const ru = currentLang === 'ru';
            const isAdmin = await checkNewsAdmin();
            if (!isAdmin) {
                showInfoBanner(ru ? '❌ У тебя нет прав удалять новости!' : '❌ You have no permission to delete news!', 'error');
                return;
            }
            const { data: deleted, error } = await sbClient.from('news').delete().eq('id', newsId).select();
            if (error) {
                showInfoBanner(ru ? '❌ Ошибка при удалении: ' + error.message : '❌ Delete error: ' + error.message, 'error');
                return;
            }
            if (!deleted || deleted.length === 0) {
                showInfoBanner(ru ? '❌ Не удалось удалить — нет прав или запись не найдена' : '❌ Could not delete — no permission or not found', 'error');
                return;
            }
            newsItemEl.style.transition = 'opacity 0.3s, transform 0.3s';
            newsItemEl.style.opacity = '0';
            newsItemEl.style.transform = 'scale(0.95)';
            setTimeout(() => newsItemEl.remove(), 300);
            showInfoBanner(ru ? '🗑️ Новость удалена!' : '🗑️ News deleted!', 'success');
        }

        window.deleteNews = deleteNews;

        async function handleNewsLike(newsId, action, likeBtn, dislikeBtn) {
            if (!currentAccount) {
                showInfoBanner(currentLang === 'ru' ? '🔒 Войди в аккаунт чтобы ставить лайки!' : '🔒 Login to like news!', 'error');
                return;
            }

            const userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');
            const currentAction = userLikes[newsId];

            const { data, error } = await sbClient.from('news').select('likes, dislikes').eq('id', newsId).single();
            if (error) return;

            let likes = data.likes || 0;
            let dislikes = data.dislikes || 0;

            if (currentAction === action) {
                if (action === 'like') likes = Math.max(0, likes - 1);
                else dislikes = Math.max(0, dislikes - 1);
                delete userLikes[newsId];
            } else {
                if (currentAction === 'like') { likes = Math.max(0, likes - 1); dislikes += 1; }
                else if (currentAction === 'dislike') { dislikes = Math.max(0, dislikes - 1); likes += 1; }
                else { if (action === 'like') likes += 1; else dislikes += 1; }
                userLikes[newsId] = action;
            }

            localStorage.setItem('userLikes', JSON.stringify(userLikes));
            likeBtn.querySelector('.like-count').textContent = likes;
            dislikeBtn.querySelector('.like-count').textContent = dislikes;

            if (userLikes[newsId] === 'like') { likeBtn.classList.add('active'); dislikeBtn.classList.remove('active'); }
            else if (userLikes[newsId] === 'dislike') { dislikeBtn.classList.add('active'); likeBtn.classList.remove('active'); }
            else { likeBtn.classList.remove('active'); dislikeBtn.classList.remove('active'); }

            await sbClient.from('news').update({ likes, dislikes }).eq('id', newsId);
        }

        async function handleNewsShare(news, shareBtn) {
            const shareData = { title: news.title, text: (news.content || '').substring(0, 100) + '...', url: window.location.href };
            try {
                if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                } else {
                    await navigator.clipboard.writeText(`${news.title}\n\n${news.content}\n\n${window.location.href}`);
                    const orig = shareBtn.innerHTML;
                    shareBtn.innerHTML = currentLang === 'ru' ? '<i class="fas fa-check"></i> <span>Скопировано!</span>' : '<i class="fas fa-check"></i> <span>Copied!</span>';
                    shareBtn.style.background = 'rgba(76,175,80,0.3)';
                    shareBtn.style.borderColor = '#4caf50';
                    setTimeout(() => { shareBtn.innerHTML = orig; shareBtn.style.background = ''; shareBtn.style.borderColor = ''; }, 2000);
                }
            } catch(e) {}
        }

        // ========== ADMIN PANEL FOR NEWS ==========
        async function checkNewsAdmin() {
            if (!currentAccount || !sbClient) return false;
            const { data } = await sbClient.from('news_admins').select('nick').ilike('nick', currentAccount.nick).limit(1);
            return data && data.length > 0;
        }

        async function showNewsAdminPanel() {
            const isAdmin = await checkNewsAdmin();
            if (!isAdmin) {
                showInfoBanner(currentLang === 'ru' ? '❌ У тебя нет прав публиковать новости!' : '❌ You have no permission to post news!', 'error');
                return;
            }
            const ru = currentLang === 'ru';
            const ex = document.getElementById('news-admin-modal'); if (ex) ex.remove();
            const overlay = document.createElement('div');
            overlay.className = 'bp-modal-overlay'; overlay.id = 'news-admin-modal';
            const inputStyle = 'width:100%;padding:10px 12px;border:3px solid #8b7355;border-radius:2px;background:#f5eed9;color:#3e2723;font-family:Montserrat,sans-serif;font-size:0.9rem;font-weight:600;outline:none;box-sizing:border-box;margin-top:4px;';
            overlay.innerHTML = `
                <div class="bp-modal" style="max-width:520px;">
                    <h3 style="font-family:Orbitron,sans-serif;color:#4a5d23;margin-bottom:16px;">📰 ${ru ? 'Добавить новость' : 'Add News'}</h3>
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;padding:10px;background:rgba(107,142,35,0.1);border-radius:3px;border:2px solid #8b7355;">
                        <i class="fas fa-user" style="color:#6b8e23;"></i>
                        <span style="font-family:Montserrat,sans-serif;font-size:0.85rem;font-weight:700;color:#3e2723;">${currentAccount.nick}${currentAccount.verified ? ' <span class=\"verified-badge\" title=\"Верифицирован\"><i class=\"fas fa-check\"></i></span>' : ''}</span>
                    </div>
                    <div class="bp-form-row" style="margin-bottom:10px;">
                        <label>${ru ? 'Заголовок (RU)' : 'Title (RU)'}</label>
                        <input id="nadmin-title" style="${inputStyle}" maxlength="200" />
                    </div>
                    <div class="bp-form-row" style="margin-bottom:10px;">
                        <label>${ru ? 'Заголовок (EN)' : 'Title (EN)'}</label>
                        <input id="nadmin-title-en" style="${inputStyle}" maxlength="200" />
                    </div>
                    <div class="bp-form-row" style="margin-bottom:10px;">
                        <label>${ru ? 'Текст (RU)' : 'Content (RU)'}</label>
                        <textarea id="nadmin-content" style="${inputStyle}height:100px;resize:vertical;" maxlength="5000"></textarea>
                    </div>
                    <div class="bp-form-row" style="margin-bottom:10px;">
                        <label>${ru ? 'Текст (EN)' : 'Content (EN)'}</label>
                        <textarea id="nadmin-content-en" style="${inputStyle}height:100px;resize:vertical;" maxlength="5000"></textarea>
                    </div>
                    <div class="bp-form-row" style="margin-bottom:10px;">
                        <label>${ru ? '🖼️ Изображение (необязательно)' : '🖼️ Image (optional)'}</label>
                        <label class="bp-file-label" id="nadmin-image-wrap" for="nadmin-image-input" style="cursor:pointer;">
                            <i class="fas fa-image" style="color:#6b8e23;font-size:1.3rem;"></i>
                            <span id="nadmin-image-label">${ru ? 'Выбери или перетащи сюда...' : 'Choose or drag here...'}</span>
                            <span class="bp-formats">PNG · JPEG · GIF · WebP</span>
                            <input type="file" id="nadmin-image-input" accept=".png,.jpg,.jpeg,.gif,.webp" />
                        </label>
                        <div class="bp-file-name" id="nadmin-image-name"></div>
                    </div>
                    <div id="nadmin-status" style="font-size:0.85rem;font-weight:600;font-family:Montserrat,sans-serif;margin-bottom:10px;min-height:20px;"></div>
                    <div style="display:flex;gap:10px;">
                        <button class="bp-submit-btn" style="flex:1;margin-top:0;font-size:0.85rem;padding:10px;" onclick="submitNews()">
                            <i class="fas fa-paper-plane"></i> ${ru ? 'Опубликовать' : 'Publish'}
                        </button>
                        <button class="bp-submit-btn" style="flex:1;margin-top:0;font-size:0.85rem;padding:10px;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;" onclick="document.getElementById('news-admin-modal').remove()">
                            ${ru ? 'Отмена' : 'Cancel'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
        }

        async function submitNews() {
            const ru = currentLang === 'ru';
            const title = document.getElementById('nadmin-title').value.trim();
            const titleEn = document.getElementById('nadmin-title-en').value.trim();
            const content = document.getElementById('nadmin-content').value.trim();
            const contentEn = document.getElementById('nadmin-content-en').value.trim();
            const imageFile = document.getElementById('nadmin-image-input')?.files[0] || null;
            const statusEl = document.getElementById('nadmin-status');

            if (!title || !content) {
                statusEl.textContent = ru ? '❌ Заголовок и текст обязательны!' : '❌ Title and content are required!';
                statusEl.style.color = '#c62828'; return;
            }

            if (imageFile) {
                const allowed = ['image/png','image/jpeg','image/gif','image/webp'];
                if (!allowed.includes(imageFile.type)) {
                    statusEl.textContent = ru ? '❌ Формат не поддерживается. PNG, JPEG, GIF, WebP' : '❌ Unsupported format. Use PNG, JPEG, GIF or WebP';
                    statusEl.style.color = '#c62828'; return;
                }
            }

            statusEl.textContent = ru ? '⏳ Публикуем...' : '⏳ Publishing...';
            statusEl.style.color = '#f57f17';

            let imageUrl = null;
            if (imageFile) {
                statusEl.textContent = ru ? '⏳ Загружаем изображение...' : '⏳ Uploading image...';
                const ext = imageFile.name.split('.').pop().toLowerCase();
                const imagePath = 'news/' + Date.now() + '_' + Math.random().toString(36).slice(2,8) + '.' + ext;
                const { error: imgError } = await sbClient.storage
                    .from('buildplates')
                    .upload(imagePath, imageFile, { cacheControl: '3600', upsert: false });
                if (imgError) {
                    statusEl.textContent = '❌ ' + (imgError.message || 'Upload error');
                    statusEl.style.color = '#c62828'; return;
                }
                const { data: urlData } = sbClient.storage.from('buildplates').getPublicUrl(imagePath);
                imageUrl = urlData.publicUrl;
                statusEl.textContent = ru ? '⏳ Сохраняем...' : '⏳ Saving...';
            }

            const { error } = await sbClient.from('news').insert([{
                title, title_en: titleEn || title,
                content, content_en: contentEn || content,
                image_url: imageUrl || null,
                author: currentAccount.nick,
                author_verified: currentAccount.verified || false,
                likes: 0, dislikes: 0
            }]);

            if (error) {
                statusEl.textContent = '❌ ' + (error.message || 'Error');
                statusEl.style.color = '#c62828'; return;
            }

            statusEl.textContent = ru ? '✅ Новость опубликована!' : '✅ News published!';
            statusEl.style.color = '#2e7d32';
            setTimeout(() => { document.getElementById('news-admin-modal')?.remove(); loadNews(); }, 1200);
        }

        window.showNewsAdminPanel = showNewsAdminPanel;
        window.submitNews = submitNews;

        // Скачивание через blob — красивое имя файла
        async function downloadWorld(url, name) {
            const ru = currentLang === 'ru';
            const btn = event.currentTarget;
            const origHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const blob = await resp.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                const safeName = (name || 'buildplate').replace(/[^a-zA-Za-яёА-ЯЁ0-9 _-]/g, '').trim().replace(/\s+/g, '_') || 'buildplate';
                a.download = safeName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            } catch(e) {
                showInfoBanner(ru ? '❌ Ошибка скачивания: ' + e.message : '❌ Download error: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = origHTML;
            }
        }
        window.downloadWorld = downloadWorld;

        window.loadNews = loadNews;
        window.addEventListener('languageChanged', loadNews);

        // ========== REPORTS SYSTEM ==========

        function showReportModal(postType, postId, postTitle, postAuthor, imageUrl) {
            const ru = currentLang === 'ru';
            const ex = document.getElementById('report-modal');
            if (ex) ex.remove();
            const overlay = document.createElement('div');
            overlay.id = 'report-modal';
            overlay.className = 'bp-modal-overlay';
            overlay.innerHTML = `
                <div class="bp-modal-box" style="max-width:420px;">
                    <div class="bp-modal-title"><i class="fas fa-flag" style="color:#c62828;"></i> ${ru ? 'Пожаловаться' : 'Report'}</div>
                    <div style="font-family:Montserrat,sans-serif;font-size:0.82rem;color:#8b7355;margin-bottom:14px;">
                        ${ru ? 'Пост:' : 'Post:'} <b>${postTitle}</b>
                    </div>
                    <div style="font-family:Montserrat,sans-serif;font-size:0.84rem;font-weight:700;color:#4a5d23;margin-bottom:8px;">
                        ${ru ? 'Причина жалобы:' : 'Reason:'}
                    </div>
                    <div id="report-reasons" style="display:flex;flex-direction:column;gap:7px;margin-bottom:12px;">
                        ${['spam','inappropriate','misinformation','copyright','other'].map(r => {
                            const labels = {
                                spam: ru ? '📢 Спам' : '📢 Spam',
                                inappropriate: ru ? '🔞 Неприемлемый контент' : '🔞 Inappropriate content',
                                misinformation: ru ? '❌ Ложная информация' : '❌ Misinformation',
                                copyright: ru ? '©️ Нарушение авторских прав' : '©️ Copyright violation',
                                other: ru ? '✏️ Другое' : '✏️ Other'
                            };
                            return `<label style="display:flex;align-items:center;gap:8px;font-family:Montserrat,sans-serif;font-size:0.83rem;cursor:pointer;">
                                <input type="radio" name="report-reason" value="${r}" style="accent-color:#6b8e23;"> ${labels[r]}
                            </label>`;
                        }).join('')}
                    </div>
                    <textarea id="report-details" placeholder="${ru ? 'Дополнительные детали (необязательно)...' : 'Additional details (optional)...'}" rows="3" style="width:100%;box-sizing:border-box;font-family:Montserrat,sans-serif;font-size:0.82rem;padding:8px;border:2px solid #6b8e23;border-radius:2px;background:#fffbf0;resize:vertical;margin-bottom:14px;"></textarea>
                    <div style="display:flex;gap:10px;">
                        <button class="bp-submit-btn" onclick="submitReport('${postType}','${postId}','${encodeURIComponent(postTitle)}','${encodeURIComponent(postAuthor||'')}','${encodeURIComponent(imageUrl||'')}')">
                            <i class="fas fa-flag"></i> ${ru ? 'Отправить жалобу' : 'Send report'}
                        </button>
                        <button class="bp-submit-btn" onclick="document.getElementById('report-modal').remove()" style="background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;flex:0 0 auto;">
                            ${ru ? 'Отмена' : 'Cancel'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
        }
        window.showReportModal = showReportModal;

        async function submitReport(postType, postId, postTitleEnc, postAuthorEnc, imageUrlEnc) {
            const ru = currentLang === 'ru';
            const reasonEl = document.querySelector('input[name="report-reason"]:checked');
            if (!reasonEl) { showInfoBanner(ru ? '❌ Выбери причину жалобы!' : '❌ Please select a reason!', 'error'); return; }
            const details = document.getElementById('report-details')?.value?.trim() || '';
            const postTitle = decodeURIComponent(postTitleEnc);
            const postAuthor = decodeURIComponent(postAuthorEnc);
            const imageUrl = decodeURIComponent(imageUrlEnc);
            const { error } = await sbClient.from('reports').insert([{
                post_type: postType,
                post_id: postId,
                post_title: postTitle,
                post_author: postAuthor,
                image_url: imageUrl || null,
                reporter_nick: currentAccount.nick,
                reason: reasonEl.value,
                details: details || null,
                status: 'pending'
            }]);
            if (error) { showInfoBanner('❌ ' + error.message, 'error'); return; }
            document.getElementById('report-modal')?.remove();
            showInfoBanner(ru ? '✅ Жалоба отправлена! Спасибо.' : '✅ Report sent! Thank you.', 'success');
        }
        window.submitReport = submitReport;

        let reportsCurrentFilter = 'pending';

        window.filterReports = function(filter) {
            reportsCurrentFilter = filter;
            const pending = document.getElementById('reports-filter-pending');
            const resolved = document.getElementById('reports-filter-resolved');
            if (filter === 'pending') {
                pending.style.background = 'linear-gradient(180deg,#c62828,#8b1a1a)';
                pending.style.borderColor = '#8b1a1a';
                pending.style.boxShadow = '0 4px 0 #5a0d0d';
                resolved.style.background = 'linear-gradient(180deg,#888,#555)';
                resolved.style.borderColor = '#333';
                resolved.style.boxShadow = '0 4px 0 #222';
            } else {
                resolved.style.background = 'linear-gradient(180deg,#6b8e23,#556b2f)';
                resolved.style.borderColor = '#4a5d23';
                resolved.style.boxShadow = '0 4px 0 #3d4f1c';
                pending.style.background = 'linear-gradient(180deg,#888,#555)';
                pending.style.borderColor = '#333';
                pending.style.boxShadow = '0 4px 0 #222';
            }
            window.loadReports();
        };

        window.loadReports = async function() {
            const ru = currentLang === 'ru';
            const container = document.getElementById('reports-container');
            if (!container) return;
            const isAdm = await checkNewsAdmin();
            if (!isAdm) {
                container.innerHTML = '<div class="news-empty"><i class="fas fa-lock"></i><p>Access denied</p></div>';
                return;
            }
            container.innerHTML = '<div class="news-loading"><i class="fas fa-spinner fa-spin"></i><p>Загрузка...</p></div>';
            const statusFilter = reportsCurrentFilter === 'pending' ? ['pending'] : ['approved', 'rejected'];
            const { data, error } = await sbClient.from('reports')
                .select('*')
                .in('status', statusFilter)
                .order('created_at', { ascending: false })
                .limit(100);
            if (error || !data || data.length === 0) {
                container.innerHTML = '<div class="news-empty"><i class="fas fa-flag"></i><p>' + (ru ? 'Нет жалоб' : 'No reports') + '</p></div>';
                return;
            }
            container.innerHTML = '';
            data.forEach(rep => {
                const card = document.createElement('div');
                card.style.cssText = 'background:#fffbf0;border:2px solid #6b8e23;border-radius:4px;padding:14px;margin-bottom:12px;box-shadow:0 4px 0 #4a5d23;';
                const reasonLabels = { spam: ru ? 'Спам' : 'Spam', inappropriate: ru ? 'Неприемлемый контент' : 'Inappropriate', misinformation: ru ? 'Ложная информация' : 'Misinformation', copyright: ru ? 'Авторские права' : 'Copyright', other: ru ? 'Другое' : 'Other' };
                const statusColors = { pending: '#c62828', approved: '#2e7d32', rejected: '#757575' };
                const statusLabels = { pending: ru ? '⏳ Ожидает' : '⏳ Pending', approved: ru ? '✅ Одобрена' : '✅ Approved', rejected: ru ? '❌ Отклонена' : '❌ Rejected' };
                const date = new Date(rep.created_at).toLocaleDateString(ru ? 'ru-RU' : 'en-US', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const imgPreview = rep.image_url ? `<div style="margin:8px 0;"><img src="${rep.image_url}" style="max-width:100%;max-height:120px;border-radius:3px;border:1px solid #6b8e23;object-fit:cover;" onerror="this.style.display='none'"></div>` : '';
                const actionBtns = rep.status === 'pending' ? `
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
                        <button onclick="resolveReport('${rep.id}','${rep.post_type}','${rep.post_id}','${encodeURIComponent(rep.image_url||'')}','${encodeURIComponent(rep.post_author||'')}','approve',false)" style="font-family:Montserrat,sans-serif;font-size:0.78rem;font-weight:700;padding:7px 12px;background:linear-gradient(180deg,#2e7d32,#1b5e20);color:#fff;border:2px solid #1b5e20;border-radius:2px;cursor:pointer;box-shadow:0 3px 0 #0a3d0a;">
                            ✅ ${ru ? 'Одобрить (удалить пост)' : 'Approve (delete post)'}
                        </button>
                        <button onclick="resolveReport('${rep.id}','${rep.post_type}','${rep.post_id}','${encodeURIComponent(rep.image_url||'')}','${encodeURIComponent(rep.post_author||'')}','approve',true)" style="font-family:Montserrat,sans-serif;font-size:0.78rem;font-weight:700;padding:7px 12px;background:linear-gradient(180deg,#b71c1c,#7f0000);color:#fff;border:2px solid #7f0000;border-radius:2px;cursor:pointer;box-shadow:0 3px 0 #4a0000;">
                            🚫 ${ru ? 'Удалить + забанить' : 'Delete + ban'}
                        </button>
                        <button onclick="resolveReport('${rep.id}','${rep.post_type}','${rep.post_id}','${encodeURIComponent(rep.image_url||'')}','${encodeURIComponent(rep.post_author||'')}','reject',false)" style="font-family:Montserrat,sans-serif;font-size:0.78rem;font-weight:700;padding:7px 12px;background:linear-gradient(180deg,#888,#555);color:#fff;border:2px solid #333;border-radius:2px;cursor:pointer;box-shadow:0 3px 0 #222;">
                            ❌ ${ru ? 'Отклонить' : 'Reject'}
                        </button>
                    </div>` : `<div style="font-family:Montserrat,sans-serif;font-size:0.78rem;color:${statusColors[rep.status]};font-weight:700;margin-top:8px;">${statusLabels[rep.status]}</div>`;
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
                        <div>
                            <span style="font-family:Orbitron,sans-serif;font-size:0.82rem;font-weight:700;color:#4a5d23;">${reasonLabels[rep.reason] || rep.reason}</span>
                            <span style="font-family:Montserrat,sans-serif;font-size:0.72rem;color:#8b7355;margin-left:8px;">${date}</span>
                        </div>
                        <span style="font-family:Montserrat,sans-serif;font-size:0.72rem;font-weight:700;color:${statusColors[rep.status]};background:rgba(0,0,0,0.05);padding:2px 7px;border-radius:10px;">${statusLabels[rep.status]}</span>
                    </div>
                    <div style="font-family:Montserrat,sans-serif;font-size:0.8rem;margin-bottom:4px;">
                        📄 <b>${ru ? 'Пост:' : 'Post:'}</b> ${rep.post_title || rep.post_id}
                        ${rep.post_author ? ` &nbsp;👤 <b>${ru ? 'Автор:' : 'Author:'}</b> ${rep.post_author}` : ''}
                    </div>
                    <div style="font-family:Montserrat,sans-serif;font-size:0.8rem;margin-bottom:4px;">
                        🚨 <b>${ru ? 'От:' : 'Reporter:'}</b> ${rep.reporter_nick}
                    </div>
                    ${rep.details ? `<div style="font-family:Montserrat,sans-serif;font-size:0.78rem;color:#5a4a3a;margin-bottom:4px;background:rgba(0,0,0,0.04);padding:6px 8px;border-radius:3px;">💬 ${rep.details}</div>` : ''}
                    ${imgPreview}
                    ${actionBtns}`;
                container.appendChild(card);
            });
        };

        window.resolveReport = async function(reportId, postType, postId, imageUrlEnc, postAuthorEnc, action, banUser) {
            const ru = currentLang === 'ru';
            const imageUrl = decodeURIComponent(imageUrlEnc);
            const postAuthor = decodeURIComponent(postAuthorEnc);
            const confirmMsg = banUser
                ? (ru ? 'Удалить пост И заблокировать автора?' : 'Delete post AND ban the author?')
                : action === 'approve'
                    ? (ru ? 'Удалить пост?' : 'Delete post?')
                    : (ru ? 'Отклонить жалобу?' : 'Reject this report?');
            if (!confirm(confirmMsg)) return;

            if (action === 'approve') {
                // Delete the post
                if (postType === 'news') {
                    await sbClient.from('news').delete().eq('id', postId);
                } else if (postType === 'buildplate') {
                    const { data: bp } = await sbClient.from('buildplates').select('image_path,world_path').eq('id', postId).single();
                    if (bp) {
                        const toRemove = [bp.image_path, bp.world_path].filter(Boolean);
                        if (toRemove.length) await sbClient.storage.from('buildplates').remove(toRemove).catch(() => {});
                    }
                    await sbClient.from('buildplates').delete().eq('id', postId);
                }
                // Delete image from storage if it's a direct URL in news
                if (imageUrl && postType === 'news' && imageUrl.includes('supabase')) {
                    try {
                        const parts = imageUrl.split('/object/public/buildplates/');
                        if (parts[1]) await sbClient.storage.from('buildplates').remove([parts[1]]);
                    } catch(e) {}
                }
                // Ban user if requested
                if (banUser && postAuthor) {
                    await sbClient.from('accounts').update({ banned: true }).ilike('nick', postAuthor);
                }
            }

            // Mark all reports for this post as resolved
            await sbClient.from('reports')
                .update({ status: action === 'approve' ? 'approved' : 'rejected', resolved_at: new Date().toISOString() })
                .eq('post_id', postId);

            showInfoBanner(
                action === 'approve'
                    ? (banUser ? (ru ? '🚫 Пост удалён, пользователь заблокирован!' : '🚫 Post deleted, user banned!') : (ru ? '✅ Пост удалён!' : '✅ Post deleted!'))
                    : (ru ? '❌ Жалоба отклонена.' : '❌ Report rejected.'),
                'success'
            );
            window.loadReports();
        };

    </script>

    <script>
        let currentLang = 'ru';

        function switchTab(tabName) {
            // Скрыть все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Убрать active со всех кнопок
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            // Показать выбранную вкладку
            const tabEl = document.getElementById(tabName + '-tab');
            if (tabEl) tabEl.classList.add('active');
            // Добавить active к нужной кнопке по onclick-атрибуту
            document.querySelectorAll('.nav-tab').forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("'" + tabName + "'")) {
                    btn.classList.add('active');
                }
            });
        }

        function switchLanguage(lang) {
            currentLang = lang;
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.documentElement.lang = lang;
            
            document.querySelectorAll('[data-ru][data-en]').forEach(element => {
                const text = lang === 'ru' ? element.getAttribute('data-ru') : element.getAttribute('data-en');
                const textSpan = element.querySelector('span:not(.nav-icon)');
                if (textSpan) {
                    textSpan.textContent = text;
                } else {
                    element.textContent = text;
                }
            });
            
            document.querySelectorAll('[data-placeholder-ru][data-placeholder-en]').forEach(input => {
                input.placeholder = lang === 'ru' ? input.getAttribute('data-placeholder-ru') : input.getAttribute('data-placeholder-en');
            });

            // Обновляем фильтры buildplates если они видны
            const sortSelect = document.getElementById('bp-sort');
            if (sortSelect) {
                sortSelect.querySelectorAll('option').forEach(opt => {
                    const label = opt.getAttribute(lang === 'ru' ? 'data-ru' : 'data-en');
                    if (label) opt.textContent = label;
                });
            }
            if (_bpAllData && _bpAllData.length > 0) applyBpFilters();

            localStorage.setItem('preferred-language', lang);

            // Обновляем динамически созданные кнопки скачать
            document.querySelectorAll('.bp-download-btn span').forEach(span => {
                span.textContent = lang === 'ru' ? 'Скачать' : 'Download';
            });

            // Dispatch event for news reload
            window.dispatchEvent(new Event('languageChanged'));
        }

        function toggleTheme() {
            const body = document.body;
            const themeBtn = document.querySelector('.theme-btn');
            const themeIcon = themeBtn.querySelector('.theme-icon');
            
            body.classList.toggle('dark-theme');
            const isDark = body.classList.contains('dark-theme');
            
            if (isDark) {
                themeIcon.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            }

            // Re-render captcha with correct theme
            rerenderAuthCaptcha(isDark ? 'dark' : 'light');
        }

        function rerenderAuthCaptcha(theme) {
            const wrap = document.getElementById('auth-captcha-wrap');
            if (!wrap) return;
            wrap.innerHTML = '';
            const isCompact = window.innerWidth <= 480;
            const div = document.createElement('div');
            div.className = 'cf-turnstile';
            div.id = 'auth-turnstile';
            div.setAttribute('data-sitekey', '0x4AAAAAACZyA1UOix1SiYwF');
            div.setAttribute('data-theme', theme || 'light');
            div.setAttribute('data-size', isCompact ? 'compact' : 'normal');
            wrap.appendChild(div);
            if (window.turnstile) window.turnstile.render(div);
        }

        function copyZeroTier() {
            const code = '3b19b3a716030d76';
            copyToClipboard(code);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showSuccess();
                }).catch(err => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            tempInput.style.position = 'fixed';
            tempInput.style.top = '0';
            tempInput.style.left = '0';
            tempInput.style.opacity = '0';
            document.body.appendChild(tempInput);
            tempInput.focus();
            tempInput.select();
            
            try {
                document.execCommand('copy');
                showSuccess();
            } catch (err) {
                console.error('Copy failed:', err);
            }
            
            document.body.removeChild(tempInput);
        }

        function showSuccess() {
            const btn = document.querySelector('.copy-btn');
            const originalHTML = btn.innerHTML;
            
            const copiedText = currentLang === 'ru' ? 
                '<i class="fas fa-check"></i> <span>Скопировано!</span>' : 
                '<i class="fas fa-check"></i> <span>Copied!</span>';
            
            btn.innerHTML = copiedText;
            btn.style.background = '#28a745';
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '';
            }, 2000);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('preferred-language');
            if (savedLang && savedLang !== 'ru') {
                const enBtn = document.querySelector('.lang-btn:nth-child(2)');
                enBtn.click();
            }

            // Проверяем сохранённую тему или используем системную
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.querySelector('.theme-icon');
            
            if (savedTheme) {
                // Если есть сохранённая тема - используем её
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-theme');
                    themeIcon.textContent = '☀️';
                } else {
                    themeIcon.textContent = '🌙';
                }
            } else {
                // Если нет сохранённой темы - определяем по системе
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    document.body.classList.add('dark-theme');
                    themeIcon.textContent = '☀️';
                } else {
                    themeIcon.textContent = '🌙';
                }
            }
            
            // Слушаем изменения системной темы (если пользователь не выбрал вручную)
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                const manualTheme = localStorage.getItem('theme');
                if (!manualTheme) {
                    // Только если пользователь не выбрал тему вручную
                    if (e.matches) {
                        document.body.classList.add('dark-theme');
                        themeIcon.textContent = '☀️';
                    } else {
                        document.body.classList.remove('dark-theme');
                        themeIcon.textContent = '🌙';
                    }
                }
            });
        });
    </script>
    <!-- Supabase Buildplates -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ⚠️ ЗАМЕНИТЕ НА ВАШИ ДАННЫЕ ИЗ SUPABASE DASHBOARD -> Settings -> API
        const SUPABASE_URL = 'https://sqlylxcnoqehorlgmztm.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_nhY94pR0kxA70QI__Zy_Hw_OD5nUm7F';

        let sbClient = null;
        try {
            if (SUPABASE_ANON_KEY === 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxbHlseGNub3FlaG9ybGdtenRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0OTUwMDgsImV4cCI6MjA4NzA3MTAwOH0.stZw4M4I3W0fbVD1X-rP8eDWYWyye2MTswqSTR_UC3Y') {
                console.warn('Supabase: вставь ANON KEY!');
            } else {
                sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch(e) {
            console.error('Supabase init error:', e);
        }

        // Загружаем новости после инициализации Supabase
        if (typeof window.loadNews === 'function') window.loadNews();

        // Обработчики выбора файлов
        document.getElementById('bp-image-input').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('bp-image-label').textContent = '✓ ' + file.name;
                document.getElementById('bp-image-name').textContent = '';
            }
        });

        // Drag-and-drop для bp-image
        (function() {
            const wrap = document.getElementById('bp-image-label-wrap');
            if (!wrap) return;
            const input = document.getElementById('bp-image-input');
            const nameEl = document.getElementById('bp-image-name');
            const labelSpan = document.getElementById('bp-image-label');
            const allowed = ['image/png','image/jpeg','image/gif','image/webp'];
            wrap.addEventListener('dragover', e => { e.preventDefault(); wrap.classList.add('drag-over'); });
            wrap.addEventListener('dragleave', e => { if (!wrap.contains(e.relatedTarget)) wrap.classList.remove('drag-over'); });
            wrap.addEventListener('drop', e => {
                e.preventDefault(); wrap.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (!file) return;
                if (!allowed.includes(file.type)) {
                    nameEl.style.color = '#c62828';
                    nameEl.textContent = currentLang === 'ru' ? '❌ Формат не поддерживается' : '❌ Unsupported format';
                    return;
                }
                const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files;
                labelSpan.textContent = '✓ ' + file.name;
                nameEl.style.color = ''; nameEl.textContent = '';
            });
        })();

        // Drag-and-drop для news image (модалка создаётся динамически)
        document.addEventListener('dragover', e => {
            const wrap = e.target.closest('#nadmin-image-wrap');
            if (wrap) { e.preventDefault(); wrap.classList.add('drag-over'); }
        });
        document.addEventListener('dragleave', e => {
            const wrap = e.target.closest('#nadmin-image-wrap');
            if (wrap && !wrap.contains(e.relatedTarget)) wrap.classList.remove('drag-over');
        });
        document.addEventListener('drop', e => {
            const wrap = e.target.closest('#nadmin-image-wrap');
            if (!wrap) return;
            e.preventDefault(); wrap.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (!file) return;
            const allowed = ['image/png','image/jpeg','image/gif','image/webp'];
            const nameEl = document.getElementById('nadmin-image-name');
            const labelSpan = document.getElementById('nadmin-image-label');
            if (!allowed.includes(file.type)) {
                if (nameEl) { nameEl.style.color = '#c62828'; nameEl.textContent = currentLang === 'ru' ? '❌ Формат не поддерживается' : '❌ Unsupported format'; }
                return;
            }
            const input = document.getElementById('nadmin-image-input');
            if (input) { const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files; }
            if (labelSpan) labelSpan.textContent = '✓ ' + file.name;
            if (nameEl) { nameEl.style.color = ''; nameEl.textContent = ''; }
        });
        document.addEventListener('change', e => {
            if (e.target.id !== 'nadmin-image-input') return;
            const file = e.target.files[0];
            const labelSpan = document.getElementById('nadmin-image-label');
            if (file && labelSpan) labelSpan.textContent = '✓ ' + file.name;
        });

        document.getElementById('bp-world-input').addEventListener('change', async function() {
            const file = this.files[0];
            const nameEl = document.getElementById('bp-world-name');
            if (!file) return;

            // PRE-CHECK: имя файла должно быть ровно "world" (без расширения)
            if (file.name.toLowerCase() !== 'world') {
                nameEl.style.color = '#c62828';
                nameEl.textContent = currentLang === 'ru'
                    ? '❌ Файл должен называться "world" (без расширения)!'
                    : '❌ File must be named "world" (no extension)!';
                this.value = '';
                return;
            }

            // PRE-CHECK: размер файла > 0
            if (file.size === 0) {
                nameEl.style.color = '#c62828';
                nameEl.textContent = currentLang === 'ru' ? '❌ Файл пустой!' : '❌ File is empty!';
                this.value = '';
                return;
            }

            nameEl.style.color = '#2e7d32';
            nameEl.textContent = '✓ ' + file.name + ' (' + formatSize(file.size) + ')';
        });

        // Drag-and-drop для world файла (через делегирование на document)
        document.addEventListener('dragover', e => {
            if (e.target.closest('#bp-world-label-wrap')) { e.preventDefault(); document.getElementById('bp-world-label-wrap').classList.add('drag-over'); }
        });
        document.addEventListener('dragleave', e => {
            const wrap = document.getElementById('bp-world-label-wrap');
            if (wrap && !wrap.contains(e.relatedTarget)) wrap.classList.remove('drag-over');
        });
        document.addEventListener('drop', e => {
            const wrap = document.getElementById('bp-world-label-wrap');
            if (!wrap || !wrap.contains(e.target)) return;
            e.preventDefault();
            wrap.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (!file) return;
            const nameEl = document.getElementById('bp-world-name');
            const labelSpan = document.getElementById('bp-world-label');
            const input = document.getElementById('bp-world-input');
            if (file.name.toLowerCase() !== 'world') {
                nameEl.style.color = '#c62828';
                nameEl.textContent = currentLang === 'ru'
                    ? '❌ Файл должен называться "world" (без расширения)!'
                    : '❌ File must be named "world" (no extension)!';
                return;
            }
            if (file.size === 0) {
                nameEl.style.color = '#c62828';
                nameEl.textContent = currentLang === 'ru' ? '❌ Файл пустой!' : '❌ File is empty!';
                return;
            }
            const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files;
            if (labelSpan) labelSpan.textContent = '✓ ' + file.name;
            nameEl.style.color = '#2e7d32';
            nameEl.textContent = '✓ ' + file.name + ' (' + formatSize(file.size) + ')';
        });

        // Проверка магических байт изображения
        async function checkImageMagicBytes(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arr = new Uint8Array(e.target.result);
                    // PNG: 89 50 4E 47
                    if (arr[0] === 0x89 && arr[1] === 0x50 && arr[2] === 0x4E && arr[3] === 0x47) {
                        resolve({ valid: true, type: 'png' });
                    // JPEG: FF D8 FF
                    } else if (arr[0] === 0xFF && arr[1] === 0xD8 && arr[2] === 0xFF) {
                        resolve({ valid: true, type: 'jpeg' });
                    } else {
                        resolve({ valid: false });
                    }
                };
                reader.readAsArrayBuffer(file.slice(0, 4));
            });
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1024 / 1024).toFixed(1) + ' MB';
        }

        // ========== AUTH SYSTEM ==========
        let currentAccount = null; // { nick, email, verified, email_verified, avatar_url }
        let authMode = 'login'; // 'login' | 'register'

        // Генерация случайного токена
        function generateToken(len = 48) {
            const arr = new Uint8Array(len);
            crypto.getRandomValues(arr);
            return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Хешируем пароль SHA-256
        async function hashPassword(pass) {
            const enc = new TextEncoder().encode(pass);
            const buf = await crypto.subtle.digest('SHA-256', enc);
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Отправка письма через EmailJS
        async function sendEmail(templateId, params) {
            if (EMAILJS_PUBLIC_KEY === 'YOUR_EMAILJS_PUBLIC_KEY') {
                console.warn('EmailJS не настроен — письмо не отправлено. Параметры:', params);
                return;
            }
            await emailjs.send(EMAILJS_SERVICE_ID, templateId, params);
        }

        function toggleAuthMode() {
            const ru = currentLang === 'ru';
            authMode = authMode === 'login' ? 'register' : 'login';
            const isReg = authMode === 'register';

            document.getElementById('bp-auth-btn-text').textContent = isReg
                ? (ru ? 'Зарегистрироваться' : 'Register')
                : (ru ? 'Войти' : 'Login');
            document.getElementById('bp-auth-mode-title').textContent = isReg
                ? (ru ? 'Регистрация' : 'Register')
                : (ru ? 'Войти' : 'Login');
            document.getElementById('bp-auth-toggle-btn').textContent = isReg
                ? (ru ? 'Уже есть аккаунт? Войти' : 'Already have account? Login')
                : (ru ? 'Нет аккаунта? Зарегистрироваться' : 'No account? Register');

            // Показываем/скрываем поля только для регистрации
            document.getElementById('bp-email-row').style.display  = isReg ? 'block' : 'none';
            document.getElementById('bp-pass2-row').style.display  = isReg ? 'block' : 'none';
            document.getElementById('bp-forgot-btn').style.display = isReg ? 'none'  : 'inline';

            document.getElementById('bp-auth-status').className = 'bp-auth-status';
            document.getElementById('bp-auth-status').textContent = '';
        }

        function showAuthStatus(type, msg) {
            const el = document.getElementById('bp-auth-status');
            el.className = 'bp-auth-status ' + type;
            el.textContent = msg;
        }

        async function doAuth() {
            const ru = currentLang === 'ru';
            const nick = document.getElementById('bp-auth-nick').value.trim();
            const pass = document.getElementById('bp-auth-pass').value;

            if (!nick) { showAuthStatus('err', ru ? '❌ Введи никнейм!' : '❌ Enter nickname!'); return; }
            if (!pass || pass.length < 4) { showAuthStatus('err', ru ? '❌ Пароль минимум 4 символа!' : '❌ Password min 4 chars!'); return; }
            if (!sbClient) { showAuthStatus('err', '❌ Supabase не подключён'); return; }

            // Проверка капчи
            const captchaVal = document.querySelector('[name="cf-turnstile-response"]')?.value;
            if (!captchaVal) {
                showAuthStatus('err', ru ? '❌ Пройди проверку капчи!' : '❌ Please complete the captcha!');
                return;
            }

            // Доп. валидация для регистрации
            if (authMode === 'register') {
                const email = document.getElementById('bp-auth-email').value.trim();
                const pass2 = document.getElementById('bp-auth-pass2').value;
                if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    showAuthStatus('err', ru ? '❌ Введи корректный Email!' : '❌ Enter a valid email!');
                    return;
                }
                if (pass !== pass2) {
                    showAuthStatus('err', ru ? '❌ Пароли не совпадают!' : '❌ Passwords do not match!');
                    return;
                }
            }

            showAuthStatus('info', ru ? '⏳ Проверяем...' : '⏳ Checking...');
            const passHash = await hashPassword(pass);

            try {
                const { data, error } = await sbClient
                    .from('accounts')
                    .select('nick, password_hash, verified, avatar_url, email, email_verified, banned')
                    .ilike('nick', nick)
                    .limit(1);
                if (error) throw error;

                if (authMode === 'register') {
                    if (data && data.length > 0) {
                        showAuthStatus('err', ru ? '❌ Этот ник уже занят!' : '❌ Nickname already taken!');
                        return;
                    }
                    const email = document.getElementById('bp-auth-email').value.trim();

                    // Проверяем уникальность email
                    const { data: emailCheck } = await sbClient.from('accounts').select('nick').ilike('email', email).limit(1);
                    if (emailCheck && emailCheck.length > 0) {
                        showAuthStatus('err', ru ? '❌ Этот email уже используется!' : '❌ Email already in use!');
                        return;
                    }

                    const verifyToken = generateToken();
                    const { error: insErr } = await sbClient.from('accounts').insert({
                        nick, password_hash: passHash, verified: false,
                        avatar_url: null, email, email_verified: false,
                        email_verify_token: verifyToken, reset_token: null, reset_token_expires: null
                    });
                    if (insErr) throw insErr;

                    // Отправляем письмо подтверждения
                    const verifyLink = `${SITE_URL}?verify=${verifyToken}`;
                    try {
                        await sendEmail(EMAILJS_VERIFY_TPL, {
                            to_email: email, to_name: nick,
                            verify_link: verifyLink, site_url: SITE_URL
                        });
                    } catch(emailErr) {}

                    // Не входим — показываем модальное окно "подтверди почту"
                    const exPending = document.getElementById('bp-verify-pending');
                    if (exPending) exPending.remove();
                    const pendingBox = document.createElement('div');
                    pendingBox.id = 'bp-verify-pending';
                    pendingBox.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
                    const gmailDomain = email.split('@')[1] || '';
                    let mailUrl = 'https://mail.google.com';
                    if (gmailDomain.includes('yandex') || gmailDomain.includes('ya.ru')) mailUrl = 'https://mail.yandex.ru';
                    else if (gmailDomain.includes('mail.ru') || gmailDomain.includes('bk.ru') || gmailDomain.includes('inbox.ru') || gmailDomain.includes('list.ru')) mailUrl = 'https://e.mail.ru';
                    const pendingTitle = ru ? 'Подтверди свой email!' : 'Verify your email!';
                    const pendingBody = ru ? ('Письмо отправлено на <b>' + email + '</b>.<br>Нажми на ссылку в письме — потом сможешь войти.') : ('Email sent to <b>' + email + '</b>.<br>Click the link — then you can log in.');
                    const pendingWarn = ru ? 'Аккаунт удалится через 24 часа если не подтвердишь.' : 'Account will be deleted in 24h if not verified.';
                    const pendingBtn = ru ? 'Открыть почту' : 'Open mail';
                    const pendingSpam = ru ? 'Проверь папку Спам если письмо не пришло.' : 'Check your Spam folder if you do not see it.';
                    pendingBox.innerHTML = '<div style="background:#fffbf0;border:3px solid #6b8e23;border-radius:6px;padding:28px 24px;text-align:center;box-shadow:0 8px 0 #4a5d23,0 20px 60px rgba(0,0,0,0.5);max-width:380px;width:100%;">'
                        + '<div style="font-size:2.5rem;margin-bottom:12px;">📧</div>'
                        + '<div style="font-family:Orbitron,sans-serif;font-size:1rem;font-weight:700;color:#4a5d23;margin-bottom:10px;">' + pendingTitle + '</div>'
                        + '<div style="font-family:Montserrat,sans-serif;font-size:0.83rem;font-weight:600;color:#5a4a3a;line-height:1.7;margin-bottom:10px;">' + pendingBody + '</div>'
                        + '<div style="font-family:Montserrat,sans-serif;font-size:0.76rem;color:#c62828;font-weight:700;margin-bottom:18px;">⏳ ' + pendingWarn + '</div>'
                        + '<a href="' + mailUrl + '" target="_blank" style="display:inline-block;font-family:Montserrat,sans-serif;font-size:0.85rem;font-weight:700;padding:10px 22px;background:linear-gradient(180deg,#6b8e23,#556b2f);color:#fff;border:2px solid #4a5d23;border-radius:2px;text-decoration:none;box-shadow:0 4px 0 #3d4f1c;">📬 ' + pendingBtn + '</a>'
                        + '<div style="font-family:Montserrat,sans-serif;font-size:0.72rem;color:#8b7355;margin-top:10px;">' + pendingSpam + '</div>'
                        + '</div>';
                    document.body.appendChild(pendingBox);
                } else {
                    if (!data || data.length === 0) {
                        showAuthStatus('err', ru ? '❌ Аккаунт не найден!' : '❌ Account not found!');
                        return;
                    }
                    const acc = data[0];
                    if (acc.password_hash !== passHash) {
                        showAuthStatus('err', ru ? '❌ Неверный пароль!' : '❌ Wrong password!');
                        return;
                    }
                    if (acc.banned) {
                        showAuthStatus('err', ru
                            ? '🚫 Твой аккаунт заблокирован.'
                            : '🚫 Your account has been banned.');
                        return;
                    }
                    if (!acc.email_verified) {
                        showAuthStatus('err', ru
                            ? '❌ Сначала подтверди email! Проверь почту.'
                            : '❌ Please verify your email first! Check your inbox.');
                        return;
                    }
                    showAuthStatus('ok', ru ? '✅ Вход выполнен!' : '✅ Logged in!');
                    setLoggedIn(acc.nick, acc.verified, acc.avatar_url, acc.email, acc.email_verified, acc.created_at);
                }
                if (window.turnstile) window.turnstile.reset('#auth-turnstile');
            } catch(e) {
                showAuthStatus('err', '❌ ' + (e.message || JSON.stringify(e)));
            }
        }

        function setLoggedIn(nick, verified, avatarUrl, email, emailVerified, joinDate) {
            currentAccount = { nick, verified, avatar_url: avatarUrl || null, email: email || null, email_verified: !!emailVerified, join_date: joinDate || null };
            document.getElementById('bp-author').value = nick;
            document.getElementById('bp-auth-form').style.display = 'none';
            const box = document.getElementById('bp-logged-in-box');
            box.style.display = 'block';

            // Имя + галочка
            document.getElementById('bp-logged-in-name').innerHTML =
                nick + (verified ? ' <span class="verified-badge" title="Верифицирован"><i class="fas fa-check"></i></span>' : '');

            // Email
            const badge = document.getElementById('bp-email-verified-badge');
            if (email) {
                badge.style.display = 'block';
                const maxLen = 18;
                const needToggle = email.length > maxLen;
                const short = needToggle ? email.substring(0, maxLen) + '...' : email;
                if (needToggle) {
                    badge.innerHTML = `<span style="font-size:0.78rem;font-weight:700;word-break:break-all;" id="bp-email-text">${short}</span><button id="bp-email-toggle" onclick="toggleEmail('${email.replace(/'/g,"\\'")}') " style="margin-left:5px;font-size:0.68rem;font-weight:700;background:none;border:1px solid currentColor;opacity:0.75;border-radius:3px;padding:1px 5px;cursor:pointer;color:inherit;font-family:'Montserrat',sans-serif;vertical-align:middle;">показать</button>`;
                } else {
                    badge.innerHTML = `<span style="font-size:0.78rem;font-weight:700;">${email}</span>`;
                }
            } else {
                badge.style.display = 'none';
            }

            // Дата регистрации
            const joinEl = document.getElementById('bp-join-date');
            if (joinDate) {
                const ru = currentLang === 'ru';
                const d = new Date(joinDate);
                const formatted = d.toLocaleDateString(ru ? 'ru-RU' : 'en-US', { day: '2-digit', month: 'long', year: 'numeric' });
                joinEl.style.display = 'block';
                joinEl.innerHTML = `<i class="fas fa-calendar-alt" style="margin-right:4px;opacity:0.7;"></i>${ru ? 'С нами с' : 'Joined'} ${formatted}`;
            } else {
                joinEl.style.display = 'none';
            }

            // Avatar
            const avatarImg = document.getElementById('bp-avatar-img');
            const avatarPh = document.getElementById('bp-avatar-placeholder');
            if (avatarUrl) {
                avatarImg.src = avatarUrl; avatarImg.style.display = 'block'; avatarPh.style.display = 'none';
            } else {
                avatarImg.style.display = 'none'; avatarPh.style.display = 'flex';
                avatarPh.innerHTML = '<i class="fas fa-user"></i>';
            }
            localStorage.setItem('bp_session', JSON.stringify({ nick, verified, avatar_url: avatarUrl || null, email: email || null, email_verified: !!emailVerified, join_date: joinDate || null }));

            // Show/hide reports tab for admins
            checkNewsAdmin().then(isAdm => {
                const rTab = document.getElementById('reports-nav-tab');
                if (rTab) rTab.style.display = isAdm ? '' : 'none';
            });
        }



        function togglePass(inputId, btn) {
            const input = document.getElementById(inputId);
            if (!input) return;
            const isHidden = input.type === 'password';
            input.type = isHidden ? 'text' : 'password';
            const icon = btn.querySelector('i');
            if (icon) {
                icon.className = isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
            }
        }

        function toggleEmail(fullEmail) {
            const ru = currentLang === 'ru';
            const textEl = document.getElementById('bp-email-text');
            const btnEl = document.getElementById('bp-email-toggle');
            if (!textEl || !btnEl) return;
            if (btnEl.dataset.open === '1') {
                textEl.textContent = fullEmail.substring(0, 18) + '...';
                btnEl.textContent = ru ? 'показать' : 'show';
                btnEl.dataset.open = '0';
            } else {
                textEl.textContent = fullEmail;
                btnEl.textContent = ru ? 'скрыть' : 'hide';
                btnEl.dataset.open = '1';
            }
        }

        function doLogout() {
            currentAccount = null;
            document.getElementById('bp-author').value = '';
            document.getElementById('bp-auth-form').style.display = 'block';
            document.getElementById('bp-logged-in-box').style.display = 'none';
            document.getElementById('bp-auth-nick').value = '';
            document.getElementById('bp-auth-pass').value = '';
            document.getElementById('bp-auth-status').className = 'bp-auth-status';
            localStorage.removeItem('bp_session');
            // Hide reports tab
            const rTab = document.getElementById('reports-nav-tab');
            if (rTab) rTab.style.display = 'none';
            if (window.turnstile) window.turnstile.reset('#auth-turnstile');
            else rerenderAuthCaptcha(document.body.classList.contains('dark-theme') ? 'dark' : 'light');
        }

        // ====== EMAIL VERIFICATION (через URL параметр ?verify=TOKEN) ======
        async function checkUrlTokens() {
            const params = new URLSearchParams(window.location.search);

            // --- Подтверждение email ---
            const verifyToken = params.get('verify');
            if (verifyToken && sbClient) {
                try {
                    const { data, error } = await sbClient.from('accounts')
                        .select('nick, email')
                        .eq('email_verify_token', verifyToken)
                        .limit(1);
                    if (!error && data && data.length > 0) {
                        await sbClient.from('accounts').update({ email_verified: true, email_verify_token: null }).eq('email_verify_token', verifyToken);
                        showInfoBanner('✅ Email подтверждён! Теперь ваш аккаунт верифицирован.', 'success');
                        // Обновляем сессию
                        const s = JSON.parse(localStorage.getItem('bp_session') || 'null');
                        if (s && s.nick && s.nick.toLowerCase() === data[0].nick.toLowerCase()) {
                            s.email_verified = true;
                            localStorage.setItem('bp_session', JSON.stringify(s));
                            if (currentAccount) currentAccount.email_verified = true;
                        }
                    } else {
                        showInfoBanner('❌ Ссылка подтверждения недействительна или уже использована.', 'error');
                    }
                } catch(e) { console.error(e); }
                window.history.replaceState({}, '', window.location.pathname);
            }

            // --- Сброс пароля ---
            const resetToken = params.get('reset');
            if (resetToken && sbClient) {
                window.history.replaceState({}, '', window.location.pathname);
                try {
                    const now = Date.now();
                    const { data, error } = await sbClient.from('accounts')
                        .select('nick, reset_token_expires')
                        .eq('reset_token', resetToken)
                        .limit(1);
                    if (!error && data && data.length > 0) {
                        if (data[0].reset_token_expires && data[0].reset_token_expires > now) {
                            showResetPasswordModal(resetToken, data[0].nick);
                        } else {
                            showInfoBanner('❌ Ссылка сброса пароля устарела. Запроси новую.', 'error');
                        }
                    } else {
                        showInfoBanner('❌ Неверная ссылка сброса пароля.', 'error');
                    }
                } catch(e) { console.error(e); }
            }
        }

        function showInfoBanner(msg, type) {
            const banner = document.createElement('div');
            banner.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:99999;padding:16px 28px;border-radius:4px;font-weight:700;font-family:Montserrat,sans-serif;font-size:0.95rem;box-shadow:0 8px 24px rgba(0,0,0,0.4);max-width:90vw;text-align:center;border:3px solid ${type==='success'?'#4caf50':'#f44336'};background:${type==='success'?'#c8e6c9':'#ffcdd2'};color:${type==='success'?'#1b5e20':'#b71c1c'};`;
            banner.textContent = msg;
            document.body.appendChild(banner);
            setTimeout(() => banner.remove(), 6000);
        }

        async function resendVerifyEmail(e) {
            e.preventDefault();
            const ru = currentLang === 'ru';
            if (!currentAccount || !currentAccount.email) return;
            try {
                const token = generateToken();
                await sbClient.from('accounts').update({ email_verify_token: token, email_verified: false }).ilike('nick', currentAccount.nick);
                await sendEmail(EMAILJS_VERIFY_TPL, {
                    to_email: currentAccount.email, to_name: currentAccount.nick,
                    verify_link: `${SITE_URL}?verify=${token}`, site_url: SITE_URL
                });
                showInfoBanner(ru ? '✅ Письмо отправлено! Проверь почту.' : '✅ Verification email sent!', 'success');
            } catch(err) { showInfoBanner('❌ ' + err.message, 'error'); }
        }

        // ====== ЗАБЫЛ ПАРОЛЬ ======
        function showForgotModal() {
            const ru = currentLang === 'ru';
            const ex = document.getElementById('bp-forgot-modal'); if (ex) ex.remove();
            const isDark = document.body.classList.contains('dark-theme');
            const inputStyle = `width:100%;padding:10px 12px;border:3px solid ${isDark?'#555':'#8b7355'};border-radius:2px;background:${isDark?'#3a3a3a':'#f5eed9'};color:${isDark?'#e0e0e0':'#3e2723'};font-family:Montserrat,sans-serif;font-size:1rem;font-weight:600;outline:none;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);`;
            const overlay = document.createElement('div');
            overlay.className = 'bp-modal-overlay'; overlay.id = 'bp-forgot-modal';
            overlay.innerHTML = `
                <div class="bp-modal">
                    <h3><i class="fas fa-envelope"></i> ${ru ? 'Сброс пароля' : 'Reset Password'}</h3>
                    <p style="font-size:0.85rem;color:${isDark?'#b0b0b0':'#5a4a3a'};margin-bottom:12px;font-family:Montserrat,sans-serif;">
                        ${ru ? 'Введи свой Email — пришлём ссылку для сброса пароля.' : 'Enter your email — we\'ll send a reset link.'}
                    </p>
                    <div class="bp-form-row">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">Email</label>
                        <input type="email" id="forgot-email-input" placeholder="you@example.com" style="${inputStyle}" />
                    </div>
                    <div id="forgot-status" style="font-size:0.82rem;font-weight:600;font-family:Montserrat,sans-serif;margin-top:6px;"></div>
                    <div class="bp-modal-btns">
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;" onclick="doForgotPassword()">
                            <i class="fas fa-paper-plane"></i> ${ru ? 'Отправить' : 'Send'}
                        </button>
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;" onclick="document.getElementById('bp-forgot-modal').remove()">
                            ${ru ? 'Отмена' : 'Cancel'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.getElementById('forgot-email-input').focus();
        }

        async function doForgotPassword() {
            const ru = currentLang === 'ru';
            const email = document.getElementById('forgot-email-input').value.trim();
            const statusEl = document.getElementById('forgot-status');
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                statusEl.textContent = ru ? '❌ Введи корректный Email' : '❌ Enter a valid email';
                statusEl.style.color = '#c62828'; return;
            }
            statusEl.textContent = ru ? '⏳ Ищем аккаунт...' : '⏳ Looking up account...';
            statusEl.style.color = '#f57f17';
            try {
                const { data } = await sbClient.from('accounts').select('nick, email').ilike('email', email).limit(1);
                // Всегда показываем успех — безопасность
                if (data && data.length > 0) {
                    const resetToken = generateToken();
                    const expires = Date.now() + 60 * 60 * 1000; // 1 час
                    await sbClient.from('accounts').update({ reset_token: resetToken, reset_token_expires: expires }).ilike('email', email);
                    await sendEmail(EMAILJS_RESET_TPL, {
                        to_email: email, to_name: data[0].nick,
                        reset_link: `${SITE_URL}?reset=${resetToken}`, site_url: SITE_URL
                    });
                }
                statusEl.textContent = ru
                    ? '✅ Если аккаунт существует — письмо отправлено!'
                    : '✅ If account exists — email sent!';
                statusEl.style.color = '#2e7d32';
            } catch(e) {
                statusEl.textContent = '❌ ' + (e.message || e);
                statusEl.style.color = '#c62828';
            }
        }

        // ====== СБРОС ПАРОЛЯ (из ссылки в письме) ======
        function showResetPasswordModal(resetToken, nick) {
            const ru = currentLang === 'ru';
            const ex = document.getElementById('bp-reset-modal'); if (ex) ex.remove();
            const isDark = document.body.classList.contains('dark-theme');
            const inputStyle = `width:100%;padding:10px 12px;border:3px solid ${isDark?'#555':'#8b7355'};border-radius:2px;background:${isDark?'#3a3a3a':'#f5eed9'};color:${isDark?'#e0e0e0':'#3e2723'};font-family:Montserrat,sans-serif;font-size:1rem;font-weight:600;outline:none;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);margin-top:4px;`;
            const overlay = document.createElement('div');
            overlay.className = 'bp-modal-overlay'; overlay.id = 'bp-reset-modal';
            overlay.innerHTML = `
                <div class="bp-modal">
                    <h3><i class="fas fa-key"></i> ${ru ? 'Новый пароль' : 'New Password'}</h3>
                    <p style="font-size:0.85rem;color:${isDark?'#b0b0b0':'#5a4a3a'};margin-bottom:12px;font-family:Montserrat,sans-serif;">
                        ${ru ? `Аккаунт: <b>${nick}</b>` : `Account: <b>${nick}</b>`}
                    </p>
                    <div class="bp-form-row">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?'Новый пароль':'New Password'}</label>
                        <div class="pass-wrap"><input type="password" id="reset-pass-input" placeholder="••••••••" maxlength="100" style="${inputStyle}" /><button type="button" class="pass-toggle" onclick="togglePass('reset-pass-input',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                    </div>
                    <div class="bp-form-row" style="margin-top:10px;">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?'Повтори пароль':'Confirm Password'}</label>
                        <div class="pass-wrap"><input type="password" id="reset-pass2-input" placeholder="••••••••" maxlength="100" style="${inputStyle}" /><button type="button" class="pass-toggle" onclick="togglePass('reset-pass2-input',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                    </div>
                    <div id="reset-status" style="font-size:0.82rem;font-weight:600;font-family:Montserrat,sans-serif;margin-top:6px;"></div>
                    <div class="bp-modal-btns">
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;" onclick="doResetPassword('${resetToken}')">
                            <i class="fas fa-check"></i> ${ru ? 'Сохранить' : 'Save'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            document.getElementById('reset-pass-input').focus();
        }

        async function doResetPassword(resetToken) {
            const ru = currentLang === 'ru';
            const pass = document.getElementById('reset-pass-input').value;
            const pass2 = document.getElementById('reset-pass2-input').value;
            const statusEl = document.getElementById('reset-status');
            if (!pass || pass.length < 4) { statusEl.textContent = ru ? '❌ Минимум 4 символа' : '❌ Min 4 chars'; statusEl.style.color='#c62828'; return; }
            if (pass !== pass2) { statusEl.textContent = ru ? '❌ Пароли не совпадают' : '❌ Passwords do not match'; statusEl.style.color='#c62828'; return; }
            statusEl.textContent = ru ? '⏳ Сохраняем...' : '⏳ Saving...';
            statusEl.style.color = '#f57f17';
            try {
                const hash = await hashPassword(pass);
                const { error } = await sbClient.from('accounts')
                    .update({ password_hash: hash, reset_token: null, reset_token_expires: null })
                    .eq('reset_token', resetToken);
                if (error) throw error;
                document.getElementById('bp-reset-modal').remove();
                showInfoBanner(ru ? '✅ Пароль изменён! Войди с новым паролем.' : '✅ Password changed! Login with your new password.', 'success');
            } catch(e) {
                statusEl.textContent = '❌ ' + (e.message || e); statusEl.style.color = '#c62828';
            }
        }

        // ====== СМЕНА ПАРОЛЯ (из профиля) ======
        function showChangePassModal() {
            const ru = currentLang === 'ru';
            const ex = document.getElementById('bp-chpass-modal'); if (ex) ex.remove();
            const isDark = document.body.classList.contains('dark-theme');
            const inputStyle = `width:100%;padding:10px 12px;border:3px solid ${isDark?'#555':'#8b7355'};border-radius:2px;background:${isDark?'#3a3a3a':'#f5eed9'};color:${isDark?'#e0e0e0':'#3e2723'};font-family:Montserrat,sans-serif;font-size:1rem;font-weight:600;outline:none;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);margin-top:4px;`;
            const overlay = document.createElement('div');
            overlay.className = 'bp-modal-overlay'; overlay.id = 'bp-chpass-modal';
            overlay.innerHTML = `
                <div class="bp-modal">
                    <h3><i class="fas fa-key"></i> ${ru ? 'Сменить пароль' : 'Change Password'}</h3>
                    <div class="bp-form-row">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?'Текущий пароль':'Current Password'}</label>
                        <div class="pass-wrap"><input type="password" id="chpass-old" placeholder="••••••••" maxlength="100" style="${inputStyle}" /><button type="button" class="pass-toggle" onclick="togglePass('chpass-old',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                    </div>
                    <div class="bp-form-row" style="margin-top:10px;">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?'Новый пароль':'New Password'}</label>
                        <div class="pass-wrap"><input type="password" id="chpass-new" placeholder="••••••••" maxlength="100" style="${inputStyle}" /><button type="button" class="pass-toggle" onclick="togglePass('chpass-new',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                    </div>
                    <div class="bp-form-row" style="margin-top:10px;">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?'Повтори новый пароль':'Confirm New Password'}</label>
                        <div class="pass-wrap"><input type="password" id="chpass-new2" placeholder="••••••••" maxlength="100" style="${inputStyle}" /><button type="button" class="pass-toggle" onclick="togglePass('chpass-new2',this)" tabindex="-1"><i class="fas fa-eye"></i></button></div>
                    </div>
                    <div id="chpass-status" style="font-size:0.82rem;font-weight:600;font-family:Montserrat,sans-serif;margin-top:6px;"></div>
                    <div class="bp-modal-btns">
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;" onclick="doChangePassword()">
                            <i class="fas fa-check"></i> ${ru ? 'Сохранить' : 'Save'}
                        </button>
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;" onclick="document.getElementById('bp-chpass-modal').remove()">
                            ${ru ? 'Отмена' : 'Cancel'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.getElementById('chpass-old').focus();
        }

        async function doChangePassword() {
            const ru = currentLang === 'ru';
            const oldPass = document.getElementById('chpass-old').value;
            const newPass = document.getElementById('chpass-new').value;
            const newPass2 = document.getElementById('chpass-new2').value;
            const statusEl = document.getElementById('chpass-status');

            if (!oldPass) { statusEl.textContent = ru?'❌ Введи текущий пароль':'❌ Enter current password'; statusEl.style.color='#c62828'; return; }
            if (!newPass || newPass.length < 4) { statusEl.textContent = ru?'❌ Новый пароль минимум 4 символа':'❌ New password min 4 chars'; statusEl.style.color='#c62828'; return; }
            if (newPass !== newPass2) { statusEl.textContent = ru?'❌ Пароли не совпадают':'❌ Passwords do not match'; statusEl.style.color='#c62828'; return; }

            statusEl.textContent = ru?'⏳ Проверяем...':'⏳ Checking...'; statusEl.style.color='#f57f17';
            try {
                const oldHash = await hashPassword(oldPass);
                const { data } = await sbClient.from('accounts').select('password_hash').ilike('nick', currentAccount.nick).limit(1);
                if (!data || data.length === 0 || data[0].password_hash !== oldHash) {
                    statusEl.textContent = ru?'❌ Неверный текущий пароль':'❌ Incorrect current password'; statusEl.style.color='#c62828'; return;
                }
                const newHash = await hashPassword(newPass);
                const { error } = await sbClient.from('accounts').update({ password_hash: newHash }).ilike('nick', currentAccount.nick);
                if (error) throw error;
                document.getElementById('bp-chpass-modal').remove();
                showInfoBanner(ru?'✅ Пароль успешно изменён!':'✅ Password changed successfully!', 'success');
            } catch(e) { statusEl.textContent = '❌ ' + (e.message||e); statusEl.style.color='#c62828'; }
        }

        // ====== PROFILE MANAGEMENT ======

        async function uploadAvatar(input) {
            const ru = currentLang === 'ru';
            if (!currentAccount || !sbClient) return;
            const file = input.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { alert(ru ? '❌ Файл слишком большой (макс 2MB)' : '❌ File too large (max 2MB)'); return; }
            try {
                const ext = file.name.split('.').pop().toLowerCase();
                const path = `avatars/${currentAccount.nick.replace(/[^a-zA-Z0-9_]/g,'_')}_${Date.now()}.${ext}`;
                const { error: upErr } = await sbClient.storage.from('buildplates').upload(path, file, { cacheControl: '3600', upsert: true });
                if (upErr) throw upErr;
                const { data: urlData } = sbClient.storage.from('buildplates').getPublicUrl(path);
                const avatarUrl = urlData.publicUrl;
                const { error: dbErr } = await sbClient.from('accounts').update({ avatar_url: avatarUrl }).ilike('nick', currentAccount.nick);
                if (dbErr) throw dbErr;
                currentAccount.avatar_url = avatarUrl;
                setLoggedIn(currentAccount.nick, currentAccount.verified, avatarUrl, currentAccount.email, currentAccount.email_verified);
                showInfoBanner(ru?'✅ Иконка обновлена!':'✅ Avatar updated!', 'success');
            } catch(e) { alert('❌ ' + (e.message || e)); }
        }

        function showRenameModal() {
            const ru = currentLang === 'ru';
            const ex = document.getElementById('bp-rename-modal'); if (ex) ex.remove();
            const isDark = document.body.classList.contains('dark-theme');
            const inputStyle = `width:100%;padding:10px 12px;border:3px solid ${isDark?'#555':'#8b7355'};border-radius:2px;background:${isDark?'#3a3a3a':'#f5eed9'};color:${isDark?'#e0e0e0':'#3e2723'};font-family:Montserrat,sans-serif;font-size:1rem;font-weight:600;outline:none;`;
            const overlay = document.createElement('div');
            overlay.className = 'bp-modal-overlay'; overlay.id = 'bp-rename-modal';
            overlay.innerHTML = `
                <div class="bp-modal">
                    <h3><i class="fas fa-pencil-alt"></i> ${ru ? 'Сменить имя' : 'Change Username'}</h3>
                    <div class="bp-form-row">
                        <label style="color:${isDark?'#e0e0e0':'#3e2723'};">${ru?'Новый никнейм':'New Nickname'}</label>
                        <input type="text" id="rename-input" value="${currentAccount.nick}" maxlength="40" style="${inputStyle}" />
                    </div>
                    <div id="rename-status" style="font-size:0.82rem;font-weight:600;font-family:Montserrat,sans-serif;margin-top:6px;"></div>
                    <div class="bp-modal-btns">
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;" onclick="doRename()">
                            <i class="fas fa-check"></i> ${ru?'Сохранить':'Save'}
                        </button>
                        <button class="bp-submit-btn" style="margin-top:0;font-size:0.85rem;padding:10px;flex:1;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;" onclick="document.getElementById('bp-rename-modal').remove()">
                            ${ru?'Отмена':'Cancel'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.getElementById('rename-input').focus();
        }

        async function doRename() {
            const ru = currentLang === 'ru';
            const newNick = document.getElementById('rename-input').value.trim();
            const statusEl = document.getElementById('rename-status');
            if (!newNick || newNick.length < 2) { statusEl.textContent = ru?'❌ Минимум 2 символа':'❌ Min 2 characters'; statusEl.style.color='#c62828'; return; }
            if (newNick.toLowerCase() === currentAccount.nick.toLowerCase()) { document.getElementById('bp-rename-modal').remove(); return; }
            statusEl.textContent = ru?'⏳ Проверяем...':'⏳ Checking...'; statusEl.style.color='#f57f17';
            try {
                const { data: ex } = await sbClient.from('accounts').select('nick').ilike('nick', newNick).limit(1);
                if (ex && ex.length > 0) { statusEl.textContent = ru?'❌ Ник занят!':'❌ Nickname taken!'; statusEl.style.color='#c62828'; return; }
                const { error } = await sbClient.from('accounts').update({ nick: newNick }).ilike('nick', currentAccount.nick);
                if (error) throw error;
                currentAccount.nick = newNick;
                setLoggedIn(newNick, currentAccount.verified, currentAccount.avatar_url, currentAccount.email, currentAccount.email_verified);
                document.getElementById('bp-rename-modal').remove();
                showInfoBanner(ru?`✅ Имя изменено на ${newNick}`:`✅ Username changed to ${newNick}`, 'success');
            } catch(e) { statusEl.textContent = '❌ '+(e.message||e); statusEl.style.color='#c62828'; }
        }

        async function deleteAccount() {
            const ru = currentLang === 'ru';
            if (!window.confirm(ru?`Удалить аккаунт "${currentAccount.nick}"? Это действие нельзя отменить!`:`Delete account "${currentAccount.nick}"? This cannot be undone!`)) return;
            if (!window.confirm(ru?'Вы уверены? Все ваши данные будут удалены.':'Are you sure? All your data will be deleted.')) return;
            try {
                const { error } = await sbClient.from('accounts').delete().ilike('nick', currentAccount.nick);
                if (error) throw error;
                doLogout();
                showInfoBanner(ru?'✅ Аккаунт удалён.':'✅ Account deleted.', 'success');
            } catch(e) { alert('❌ '+(e.message||e)); }
        }
        // ====== END PROFILE MANAGEMENT ======

        // Восстанавливаем сессию при загрузке страницы
        (function restoreSession() {
            try {
                const s = JSON.parse(localStorage.getItem('bp_session') || 'null');
                if (s && s.nick) setLoggedIn(s.nick, s.verified, s.avatar_url || null, s.email || null, s.email_verified || false, s.join_date || null);
            } catch(e) {}
        })();

        // Проверяем URL токены при загрузке (verify / reset)
        window.addEventListener('DOMContentLoaded', () => {
            if (sbClient) {
                checkUrlTokens();
            }
        });
        // ========== END AUTH SYSTEM ==========

                async function uploadBuildplate() {
            const name = document.getElementById('bp-name').value.trim();
            const author = document.getElementById('bp-author').value.trim();
            const imageFile = document.getElementById('bp-image-input').files[0];
            const worldFile = document.getElementById('bp-world-input').files[0];
            const submitBtn = document.getElementById('bp-submit-btn');
            const ru = currentLang === 'ru';

            if (!sbClient) {
                showBpStatus('error', ru
                    ? '❌ Вставь свой Publishable key (sb_publishable_...) в код вместо YOUR_ANON_KEY!'
                    : '❌ Insert your Publishable key (sb_publishable_...) into the code instead of YOUR_ANON_KEY!');
                return;
            }

            if (!currentAccount) { showBpStatus('error', ru ? '❌ Войди в аккаунт перед загрузкой!' : '❌ Login before uploading!'); return; }
            if (!name) { showBpStatus('error', ru ? '❌ Введи название!' : '❌ Enter a name!'); return; }
            if (!author) { showBpStatus('error', ru ? '❌ Введи свой никнейм!' : '❌ Enter your nickname!'); return; }

            if (!imageFile) {
                showBpStatus('error', ru ? '❌ Выбери изображение!' : '❌ Choose an image!');
                return;
            }
            if (!worldFile) {
                showBpStatus('error', ru ? '❌ Выбери world файл!' : '❌ Choose a world file!');
                return;
            }

            // Проверка имени world файла
            if (worldFile.name.toLowerCase() !== 'world') {
                showBpStatus('error', ru ? '❌ Файл должен называться "world" (без расширения)!' : '❌ File must be named "world" (no extension)!');
                return;
            }

            // Проверка размера world файла
            if (worldFile.size === 0) {
                showBpStatus('error', ru ? '❌ World файл пустой!' : '❌ World file is empty!');
                return;
            }

            // Проверка расширения изображения
            const imgExt = imageFile.name.split('.').pop().toLowerCase();
            if (!['png', 'jpg', 'jpeg'].includes(imgExt)) {
                showBpStatus('error', ru ? '❌ Изображение должно быть PNG или JPEG!' : '❌ Image must be PNG or JPEG!');
                return;
            }

            // Проверка магических байт изображения (реальный формат файла)
            const magicCheck = await checkImageMagicBytes(imageFile);
            if (!magicCheck.valid) {
                showBpStatus('error', ru ? '❌ Файл изображения повреждён или не является PNG/JPEG!' : '❌ Image file is corrupted or not a valid PNG/JPEG!');
                return;
            }

            // ── UPLOAD ────────────────────────────────────────────
            submitBtn.disabled = true;
            showBpStatus('', '');
            showBpStatus('success', ru ? '⏳ Загружаем изображение...' : '⏳ Uploading image...');

            let imagePath, worldPath;

            try {
                const timestamp = Date.now();
                const safeName = name.replace(/[^a-zA-Z0-9_\-]/g, '_').slice(0, 40);

                // Upload image
                imagePath = `images/${timestamp}_${safeName}.${imgExt}`;
                const { error: imgError } = await sbClient.storage
                    .from('buildplates')
                    .upload(imagePath, imageFile, { cacheControl: '3600', upsert: false });
                if (imgError) throw new Error(parseSbError(imgError, ru));

                showBpStatus('success', ru ? '⏳ Загружаем world файл...' : '⏳ Uploading world file...');

                // Upload world file
                worldPath = `worlds/${timestamp}_${safeName}_world`;
                const { error: worldError } = await sbClient.storage
                    .from('buildplates')
                    .upload(worldPath, worldFile, { cacheControl: '3600', upsert: false });
                if (worldError) throw new Error(parseSbError(worldError, ru));

                showBpStatus('success', ru ? '⏳ Сохраняем запись...' : '⏳ Saving record...');

                // Get public URLs
                const { data: imgData } = sbClient.storage.from('buildplates').getPublicUrl(imagePath);
                const { data: worldData } = sbClient.storage.from('buildplates').getPublicUrl(worldPath);

                // Save record to DB
                const { data: inserted, error: dbError } = await sbClient.from('buildplates').insert([{
                    name: name,
                    author: author,
                    image_url: imgData.publicUrl,
                    world_url: worldData.publicUrl,
                    created_at: new Date().toISOString()
                }]).select();
                if (dbError) throw new Error(parseSbError(dbError, ru));

                // ── POST-UPLOAD VERIFICATION ───────────────────────
                // Проверяем что запись реально появилась в БД
                if (!inserted || inserted.length === 0) {
                    throw new Error(ru ? 'Запись не была создана в базе данных!' : 'Record was not created in database!');
                }

                // Проверяем что файлы доступны по URL
                const [imgCheck, worldCheck] = await Promise.all([
                    fetch(imgData.publicUrl, { method: 'HEAD' }),
                    fetch(worldData.publicUrl, { method: 'HEAD' })
                ]);
                if (!imgCheck.ok) throw new Error(ru ? 'Изображение загружено, но недоступно!' : 'Image uploaded but not accessible!');
                if (!worldCheck.ok) throw new Error(ru ? 'World файл загружен, но недоступен!' : 'World file uploaded but not accessible!');

                // ── SUCCESS ───────────────────────────────────────
                // Сохраняем ID поста в localStorage (чтобы можно было удалить после перезагрузки)
                const myPosts = JSON.parse(localStorage.getItem('bp_my_posts') || '[]');
                myPosts.push({
                    id: inserted[0].id,
                    image_path: imagePath,
                    world_path: worldPath
                });
                localStorage.setItem('bp_my_posts', JSON.stringify(myPosts));

                showBpStatus('success', ru ? '✅ Buildplate успешно загружен и проверен!' : '✅ Buildplate uploaded and verified!');

                // Reset form
                document.getElementById('bp-name').value = '';
                document.getElementById('bp-image-input').value = '';
                document.getElementById('bp-world-input').value = '';
                document.getElementById('bp-image-name').textContent = '';
                document.getElementById('bp-world-name').textContent = '';

                loadBuildplates();

            } catch (err) {
                console.error(err);
                showBpStatus('error', '❌ ' + err.message);

                // Откатываем загруженные файлы если они были залиты
                if (imagePath) await sbClient.storage.from('buildplates').remove([imagePath]).catch(() => {});
                if (worldPath) await sbClient.storage.from('buildplates').remove([worldPath]).catch(() => {});
            } finally {
                submitBtn.disabled = false;
            }
        }

        function showBpStatus(type, message) {
            const el = document.getElementById('bp-status');
            el.className = 'bp-status' + (type ? ' ' + type : '');
            el.textContent = message;
            if (!type) el.style.display = 'none';
        }

        // ====== BUILDPLATE FILTER STATE ======
        let _bpAllData = [];
        let _bpAvatarMap = {};
        let _bpVerifiedMap = {};
        let _bpFilterMine = false;
        let _bpSearchTimer = null;

        function toggleFilterMine() {
            _bpFilterMine = !_bpFilterMine;
            const btn = document.getElementById('bp-filter-mine');
            if (btn) btn.classList.toggle('active', _bpFilterMine);
            applyBpFilters();
        }

        function applyBpFilters() {
            const ru = currentLang === 'ru';
            const searchVal = (document.getElementById('bp-search')?.value || '').toLowerCase().trim();
            const sortVal = document.getElementById('bp-sort')?.value || 'newest';
            const gallery = document.getElementById('bp-gallery');
            const countEl = document.getElementById('bp-results-count');

            const myPosts = JSON.parse(localStorage.getItem('bp_my_posts') || '[]');
            const myIds = myPosts.map(p => String(p.id));
            const myNicks = [...new Set(myPosts.map(p => (p.author || '').toLowerCase()).filter(Boolean))];
            if (currentAccount) myNicks.push(currentAccount.nick.toLowerCase());

            let filtered = _bpAllData.filter(bp => {
                if (_bpFilterMine) {
                    const isMine = myIds.includes(String(bp.id)) || (bp.author && myNicks.includes(bp.author.toLowerCase()));
                    if (!isMine) return false;
                }
                if (searchVal) {
                    const nameMatch = (bp.name || '').toLowerCase().includes(searchVal);
                    const authorMatch = (bp.author || '').toLowerCase().includes(searchVal);
                    if (!nameMatch && !authorMatch) return false;
                }
                return true;
            });

            // Sort
            filtered = [...filtered].sort((a, b) => {
                if (sortVal === 'newest') return new Date(b.created_at) - new Date(a.created_at);
                if (sortVal === 'oldest') return new Date(a.created_at) - new Date(b.created_at);
                if (sortVal === 'liked') return (b.likes || 0) - (a.likes || 0);
                if (sortVal === 'rating') return ((b.likes || 0) - (b.dislikes || 0)) - ((a.likes || 0) - (a.dislikes || 0));
                return 0;
            });

            // Update count
            if (countEl) {
                const total = _bpAllData.length;
                const shown = filtered.length;
                countEl.textContent = shown < total
                    ? (ru ? `${shown} из ${total}` : `${shown} of ${total}`)
                    : (ru ? `${total} buildplates` : `${total} buildplates`);
            }

            if (filtered.length === 0) {
                gallery.innerHTML = `<div class="bp-empty"><i class="fas fa-search"></i><p>${ru ? 'Ничего не найдено' : 'Nothing found'}</p></div>`;
                return;
            }

            gallery.innerHTML = '<div class="bp-grid"></div>';
            const grid = gallery.querySelector('.bp-grid');
            renderBpCards(filtered, grid, myIds, myNicks);
        }

        function renderBpCards(data, grid, myIds, myNicks) {
            const bpLikes = JSON.parse(localStorage.getItem('bp_likes') || '{}');
            const bpDislikes = JSON.parse(localStorage.getItem('bp_dislikes') || '{}');

            data.forEach(bp => {
                const isMine = myIds.includes(String(bp.id)) || (bp.author && myNicks.includes(bp.author.toLowerCase()));
                const card = document.createElement('div');
                card.className = 'bp-card';
                card.id = 'bp-card-' + bp.id;
                const isLiked = bpLikes[bp.id] === true;
                const likeCount = bp.likes || 0;
                const isDisliked = bpDislikes[bp.id] === true;
                const dislikeCount = bp.dislikes || 0;

                const authorLower = (bp.author || '').toLowerCase();
                const authorAvatar = _bpAvatarMap[authorLower];
                const avatarHtml = authorAvatar
                    ? `<img class="bp-card-avatar" src="${authorAvatar}" alt="" loading="lazy">`
                    : `<span class="bp-card-avatar-placeholder"><i class="fas fa-user"></i></span>`;

                card.innerHTML = `
                    ${bp.image_url
                        ? `<img class="bp-card-img" src="${bp.image_url}" alt="${escapeHtml(bp.name)}" loading="lazy">`
                        : `<div class="bp-card-img-placeholder">🏗️</div>`
                    }
                    <div class="bp-card-body">
                        <div class="bp-card-name">${escapeHtml(bp.name)}</div>
                        <div class="bp-card-meta">
                            <div class="bp-card-author">
                                ${avatarHtml}
                                <span>${escapeHtml(bp.author || (currentLang === 'ru' ? 'Неизвестно' : 'Unknown'))}</span>
                                ${_bpVerifiedMap[authorLower] ? `<span class="verified-badge" title="${currentLang === 'ru' ? 'Верифицированный автор' : 'Verified author'}"><i class="fas fa-check"></i></span>` : ''}
                            </div>
                            <div class="bp-card-date">
                                <i class="fas fa-calendar-alt"></i>
                                <span>${bp.created_at
                                    ? new Date(bp.created_at).toLocaleDateString(currentLang === 'ru' ? 'ru-RU' : 'en-US', { day: '2-digit', month: 'long', year: 'numeric' }) + ', ' + new Date(bp.created_at).toLocaleTimeString(currentLang === 'ru' ? 'ru-RU' : 'en-US', { hour: '2-digit', minute: '2-digit' })
                                    : (currentLang === 'ru' ? 'Дата неизвестна' : 'Unknown date')
                                }</span>
                            </div>
                        </div>
                        <div class="bp-card-actions">
                            ${currentAccount
                                ? `<button class="bp-download-btn" onclick="downloadWorld('${bp.world_url}', '${bp.name.replace(/[`'\\]/g, '')}')">
                                    <i class="fas fa-download"></i>
                                    <span>${currentLang === 'ru' ? 'Скачать' : 'Download'}</span>
                                   </button>`
                                : `<button class="bp-download-btn auth-locked" onclick="showInfoBanner(currentLang==='ru'?'🔒 Войди в аккаунт чтобы скачивать!':'🔒 Login to download buildplates!','error')" style="cursor:not-allowed;opacity:0.55;">
                                    <i class="fas fa-lock"></i>
                                    <span>${currentLang === 'ru' ? 'Войди' : 'Login'}</span>
                                   </button>`
                            }
                            <button class="bp-like-btn ${isLiked ? 'liked' : ''}" data-id="${bp.id}">
                                <i class="fas fa-thumbs-up"></i>
                                <span class="bp-like-count">${likeCount}</span>
                            </button>
                            <button class="bp-dislike-btn ${isDisliked ? 'disliked' : ''}" data-id="${bp.id}">
                                <i class="fas fa-thumbs-down"></i>
                                <span class="bp-dislike-count">${dislikeCount}</span>
                            </button>
                            <button class="bp-share-btn" data-id="${bp.id}">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                        ${isMine ? `
                        <button class="bp-delete-btn" onclick="deleteBuildplate('${bp.id}', this)">
                            <i class="fas fa-trash"></i>
                            <span>${currentLang === 'ru' ? 'Удалить' : 'Delete'}</span>
                        </button>` : ''}
                    </div>`;
                grid.appendChild(card);

                const likeBtn = card.querySelector('.bp-like-btn');
                const dislikeBtn = card.querySelector('.bp-dislike-btn');
                const shareBtn = card.querySelector('.bp-share-btn');
                if (likeBtn) likeBtn.addEventListener('click', () => handleBpLike(bp.id, likeBtn, dislikeBtn));
                if (dislikeBtn) dislikeBtn.addEventListener('click', () => handleBpDislike(bp.id, dislikeBtn, likeBtn));
                if (shareBtn) shareBtn.addEventListener('click', () => handleBpShare(bp.name, bp.world_url));
            });
        }

        async function loadBuildplates() {
            const gallery = document.getElementById('bp-gallery');
            const filtersEl = document.getElementById('bp-filters');

            if (!sbClient) {
                gallery.innerHTML = `<div class="bp-empty"><i class="fas fa-exclamation-triangle"></i><p>Вставь Publishable key в код (YOUR_ANON_KEY)</p></div>`;
                return;
            }

            gallery.innerHTML = '<div class="bp-loading"><i class="fas fa-spinner"></i><p>Загрузка...</p></div>';
            if (filtersEl) filtersEl.style.display = 'none';

            try {
                const { data, error } = await sbClient
                    .from('buildplates')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    gallery.innerHTML = `
                        <div class="bp-empty">
                            <i class="fas fa-cubes"></i>
                            <p>${currentLang === 'ru' ? 'Пока нет buildplates. Будь первым!' : 'No buildplates yet. Be the first!'}</p>
                        </div>`;
                    return;
                }

                // Fetch avatars + verified for all unique authors
                const authors = [...new Set(data.map(bp => bp.author).filter(Boolean))];
                _bpAvatarMap = {};
                _bpVerifiedMap = {};
                if (authors.length > 0) {
                    try {
                        const { data: accs } = await sbClient.from('accounts').select('nick, avatar_url, verified').in('nick', authors);
                        if (accs) accs.forEach(a => {
                            const key = a.nick.toLowerCase();
                            if (a.avatar_url) _bpAvatarMap[key] = a.avatar_url;
                            if (a.verified) _bpVerifiedMap[key] = true;
                        });
                    } catch(e) {}
                }

                _bpAllData = data;

                // Show filters & bind events
                if (filtersEl) {
                    filtersEl.style.display = 'flex';
                    // Update placeholder texts for current language
                    const searchInput = document.getElementById('bp-search');
                    if (searchInput) {
                        const attr = currentLang === 'ru' ? 'data-placeholder-ru' : 'data-placeholder-en';
                        searchInput.placeholder = searchInput.getAttribute(attr) || searchInput.placeholder;
                        searchInput.oninput = () => {
                            clearTimeout(_bpSearchTimer);
                            _bpSearchTimer = setTimeout(applyBpFilters, 250);
                        };
                    }
                    const sortSelect = document.getElementById('bp-sort');
                    if (sortSelect) {
                        // Update option labels for current language
                        sortSelect.querySelectorAll('option').forEach(opt => {
                            const label = opt.getAttribute(currentLang === 'ru' ? 'data-ru' : 'data-en');
                            if (label) opt.textContent = label;
                        });
                        sortSelect.onchange = applyBpFilters;
                    }
                    const mineBtn = document.getElementById('bp-filter-mine');
                    if (mineBtn) {
                        const label = mineBtn.getAttribute(currentLang === 'ru' ? 'data-ru' : 'data-en');
                        if (label) mineBtn.textContent = label;
                    }
                }

                applyBpFilters();

            } catch (err) {
                console.error(err);
                gallery.innerHTML = `<div class="bp-empty"><i class="fas fa-exclamation-triangle"></i><p>${currentLang === 'ru' ? 'Ошибка загрузки' : 'Load error'}: ${err.message}</p></div>`;
            }
        }

        // Расшифровка пустых ошибок Supabase {}
        function parseSbError(err, ru) {
            // Если ошибка пустая {}
            if (!err || (typeof err === 'object' && Object.keys(err).length === 0)) {
                return ru
                    ? 'Supabase: bucket "buildplates" не найден или нет прав. Проверь: 1) bucket создан 2) Storage политики разрешают INSERT 3) RLS таблицы разрешает INSERT'
                    : 'Supabase: bucket "buildplates" not found or no permissions. Check: 1) bucket exists 2) Storage policies allow INSERT 3) Table RLS allows INSERT';
            }
            const msg = err.message || err.error_description || err.error || JSON.stringify(err);
            // Известные коды ошибок
            if (msg.includes('Bucket not found') || msg.includes('bucket_not_found')) {
                return ru ? 'Bucket "buildplates" не существует. Создай его в Supabase Dashboard → Storage' : 'Bucket "buildplates" does not exist. Create it in Supabase Dashboard → Storage';
            }
            if (msg.includes('row-level security') || msg.includes('violates row') || msg.includes('new row')) {
                return ru ? 'RLS блокирует запись. Добавь политику INSERT для таблицы buildplates' : 'RLS is blocking insert. Add INSERT policy for buildplates table';
            }
            if (msg.includes('storage/unauthorized') || msg.includes('401') || msg.includes('403')) {
                return ru ? 'Нет прав на загрузку. Добавь политику INSERT для Storage bucket buildplates' : 'No upload permission. Add INSERT policy for Storage bucket buildplates';
            }
            if (msg.includes('mime') || msg.includes('content-type') || msg.includes('type')) {
                return ru ? 'Supabase отклонил тип файла. Убери ограничения MIME в настройках bucket' : 'Supabase rejected file type. Remove MIME restrictions in bucket settings';
            }
            return (ru ? 'Ошибка: ' : 'Error: ') + msg;
        }

        function escapeHtml(str) {
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        async function deleteBuildplate(id, btn) {
            const ru = currentLang === 'ru';
            const confirm = window.confirm(ru ? 'Удалить этот buildplate?' : 'Delete this buildplate?');
            if (!confirm) return;

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>${ru ? 'Удаление...' : 'Deleting...'}</span>`;

            try {
                // Получаем пути файлов из localStorage
                const myPosts = JSON.parse(localStorage.getItem('bp_my_posts') || '[]');
                const post = myPosts.find(p => String(p.id) === String(id));

                // Удаляем запись из БД
                const { data: deletedBp, error: dbError } = await sbClient.from('buildplates').delete().eq('id', id).select();
                if (dbError) throw new Error((ru ? 'Ошибка БД: ' : 'DB error: ') + dbError.message);
                if (!deletedBp || deletedBp.length === 0) throw new Error(ru ? 'Нет прав на удаление или запись не найдена' : 'No permission to delete or record not found');

                // Удаляем файлы из Storage
                if (post) {
                    const filesToRemove = [];
                    if (post.image_path) filesToRemove.push(post.image_path);
                    if (post.world_path) filesToRemove.push(post.world_path);
                    if (filesToRemove.length > 0) {
                        await sbClient.storage.from('buildplates').remove(filesToRemove).catch(e => console.warn('Storage remove:', e));
                    }

                    // Убираем из localStorage
                    const updated = myPosts.filter(p => String(p.id) !== String(id));
                    localStorage.setItem('bp_my_posts', JSON.stringify(updated));
                }

                // Анимация удаления карточки
                const card = document.getElementById('bp-card-' + id);
                if (card) {
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.8)';
                    setTimeout(() => { card.remove(); }, 300);
                }

            } catch (err) {
                console.error(err);
                alert('❌ ' + err.message);
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-trash"></i> <span>${ru ? 'Удалить' : 'Delete'}</span>`;
            }
        }

        const bpProcessing = {}; // блокировка от многократных кликов

        async function handleBpLike(id, likeBtn, dislikeBtn) {
            if (!currentAccount) {
                showInfoBanner(currentLang === 'ru' ? '🔒 Войди в аккаунт чтобы ставить лайки!' : '🔒 Login to like buildplates!', 'error');
                return;
            }
            if (bpProcessing[id]) return; // уже обрабатывается — игнорируем
            bpProcessing[id] = true;
            likeBtn.disabled = true;
            dislikeBtn.disabled = true;

            const bpLikes = JSON.parse(localStorage.getItem('bp_likes') || '{}');
            const bpDislikes = JSON.parse(localStorage.getItem('bp_dislikes') || '{}');
            const isLiked = bpLikes[id] === true;
            const isDisliked = bpDislikes[id] === true;

            try {
                const { data, error } = await sbClient.from('buildplates').select('likes, dislikes').eq('id', id).single();
                if (error) throw error;

                let newLikes = data.likes || 0;
                let newDislikes = data.dislikes || 0;

                if (isLiked) {
                    // Снимаем лайк
                    newLikes = Math.max(0, newLikes - 1);
                    delete bpLikes[id];
                    likeBtn.classList.remove('liked');
                } else {
                    // Ставим лайк, снимаем дизлайк если был
                    newLikes += 1;
                    bpLikes[id] = true;
                    likeBtn.classList.add('liked');
                    if (isDisliked) {
                        newDislikes = Math.max(0, newDislikes - 1);
                        delete bpDislikes[id];
                        dislikeBtn.classList.remove('disliked');
                        dislikeBtn.querySelector('.bp-dislike-count').textContent = newDislikes;
                    }
                }

                await sbClient.from('buildplates').update({ likes: newLikes, dislikes: newDislikes }).eq('id', id);
                localStorage.setItem('bp_likes', JSON.stringify(bpLikes));
                localStorage.setItem('bp_dislikes', JSON.stringify(bpDislikes));
                likeBtn.querySelector('.bp-like-count').textContent = newLikes;
            } catch (err) {
                console.error('Like error:', err);
            } finally {
                likeBtn.disabled = false;
                dislikeBtn.disabled = false;
                bpProcessing[id] = false;
            }
        }

        async function handleBpDislike(id, dislikeBtn, likeBtn) {
            if (!currentAccount) {
                showInfoBanner(currentLang === 'ru' ? '🔒 Войди в аккаунт чтобы ставить лайки!' : '🔒 Login to like buildplates!', 'error');
                return;
            }
            if (bpProcessing[id]) return; // уже обрабатывается — игнорируем
            bpProcessing[id] = true;
            likeBtn.disabled = true;
            dislikeBtn.disabled = true;

            const bpLikes = JSON.parse(localStorage.getItem('bp_likes') || '{}');
            const bpDislikes = JSON.parse(localStorage.getItem('bp_dislikes') || '{}');
            const isLiked = bpLikes[id] === true;
            const isDisliked = bpDislikes[id] === true;

            try {
                const { data, error } = await sbClient.from('buildplates').select('likes, dislikes').eq('id', id).single();
                if (error) throw error;

                let newLikes = data.likes || 0;
                let newDislikes = data.dislikes || 0;

                if (isDisliked) {
                    // Снимаем дизлайк
                    newDislikes = Math.max(0, newDislikes - 1);
                    delete bpDislikes[id];
                    dislikeBtn.classList.remove('disliked');
                } else {
                    // Ставим дизлайк, снимаем лайк если был
                    newDislikes += 1;
                    bpDislikes[id] = true;
                    dislikeBtn.classList.add('disliked');
                    if (isLiked) {
                        newLikes = Math.max(0, newLikes - 1);
                        delete bpLikes[id];
                        likeBtn.classList.remove('liked');
                        likeBtn.querySelector('.bp-like-count').textContent = newLikes;
                    }
                }

                await sbClient.from('buildplates').update({ likes: newLikes, dislikes: newDislikes }).eq('id', id);
                localStorage.setItem('bp_likes', JSON.stringify(bpLikes));
                localStorage.setItem('bp_dislikes', JSON.stringify(bpDislikes));
                dislikeBtn.querySelector('.bp-dislike-count').textContent = newDislikes;
            } catch (err) {
                console.error('Dislike error:', err);
            } finally {
                likeBtn.disabled = false;
                dislikeBtn.disabled = false;
                bpProcessing[id] = false;
            }
        }

        async function handleBpShare(name, worldUrl) {
            const ru = currentLang === 'ru';
            if (navigator.share) {
                try { await navigator.share({ title: name, url: worldUrl }); } catch (e) {}
            } else {
                try {
                    await navigator.clipboard.writeText(worldUrl);
                    alert(ru ? '✅ Ссылка скопирована!' : '✅ Link copied!');
                } catch (e) {
                    alert(ru ? '❌ Не удалось скопировать' : '❌ Could not copy');
                }
            }
        }

        // Load buildplates when tab is opened
        const origSwitchTab = window.switchTab;
        window.switchTab = function(tabName) {
            origSwitchTab && origSwitchTab.call(this, tabName);
            if (tabName === 'buildplates') loadBuildplates();
            if (tabName === 'news') { if (typeof window.loadNews === 'function') window.loadNews(); }
            if (tabName === 'reports') { if (typeof window.loadReports === 'function') window.loadReports(); }
        };

        // ========== COOKIE SYSTEM ==========
        const COOKIE_KEY = 'pe_cookie_consent';

        function getCookieConsent() {
            try { return JSON.parse(localStorage.getItem(COOKIE_KEY)); } catch(e) { return null; }
        }

        function saveCookieConsent(prefs) {
            try { localStorage.setItem(COOKIE_KEY, JSON.stringify({ ...prefs, date: Date.now() })); } catch(e) {}
        }

        function acceptCookies() {
            saveCookieConsent({ essential: true, functional: true, analytics: true });
            hideCookieBanner();
        }

        function declineCookies() {
            saveCookieConsent({ essential: true, functional: false, analytics: false });
            hideCookieBanner();
        }

        function hideCookieBanner() {
            const banner = document.getElementById('cookie-banner');
            if (banner) { banner.classList.remove('show'); }
        }

        function showCookieBanner() {
            const banner = document.getElementById('cookie-banner');
            if (banner) { setTimeout(() => banner.classList.add('show'), 800); }
        }

        function showCookieModal() {
            const ex = document.getElementById('cookie-modal-overlay'); if (ex) ex.remove();
            const prefs = getCookieConsent() || { essential: true, functional: true, analytics: true };
            const isDark = document.body.classList.contains('dark-theme');
            const ru = currentLang === 'ru';
            const overlay = document.createElement('div');
            overlay.className = 'cookie-modal-overlay'; overlay.id = 'cookie-modal-overlay';
            overlay.innerHTML = `
                <div class="cookie-modal">
                    <h3>🍪 ${ru ? 'Настройки Cookie' : 'Cookie Settings'}</h3>
                    <p style="font-size:0.82rem;font-family:Montserrat,sans-serif;color:${isDark?'#b0b0b0':'#5a4a3a'};margin-bottom:16px;line-height:1.6;font-weight:600;">
                        ${ru ? 'Управляй тем, какие данные мы сохраняем в твоём браузере.' : 'Control what data we store in your browser.'}
                    </p>

                    <div class="cookie-toggle-row">
                        <div class="cookie-toggle-info">
                            <div class="cookie-toggle-name">${ru ? '🔒 Необходимые' : '🔒 Essential'}</div>
                            <div class="cookie-toggle-desc">${ru ? 'Сессия, тема, язык. Без них сайт не работает.' : 'Session, theme, language. Required for the site to work.'}</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked disabled />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="cookie-toggle-row">
                        <div class="cookie-toggle-info">
                            <div class="cookie-toggle-name">${ru ? '⚙️ Функциональные' : '⚙️ Functional'}</div>
                            <div class="cookie-toggle-desc">${ru ? 'Запоминание аккаунта, загруженных buildplates.' : 'Remember your account and uploaded buildplates.'}</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="cookie-functional" ${prefs.functional !== false ? 'checked' : ''} />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="cookie-toggle-row">
                        <div class="cookie-toggle-info">
                            <div class="cookie-toggle-name">${ru ? '📊 Аналитика' : '📊 Analytics'}</div>
                            <div class="cookie-toggle-desc">${ru ? 'Лайки и дизлайки новостей и buildplates.' : 'News and buildplate likes/dislikes.'}</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="cookie-analytics" ${prefs.analytics !== false ? 'checked' : ''} />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;">
                        <button class="bp-submit-btn" style="flex:1;margin-top:0;font-size:0.82rem;padding:11px;" onclick="saveCookieFromModal()">
                            <i class="fas fa-check"></i> ${ru ? 'Сохранить' : 'Save'}
                        </button>
                        <button class="bp-submit-btn" style="flex:1;margin-top:0;font-size:0.82rem;padding:11px;background:linear-gradient(180deg,#888,#555);border-color:#333;box-shadow:0 5px 0 #222;" onclick="document.getElementById('cookie-modal-overlay').remove()">
                            ${ru ? 'Закрыть' : 'Close'}
                        </button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
        }

        function saveCookieFromModal() {
            const functional = document.getElementById('cookie-functional')?.checked ?? true;
            const analytics = document.getElementById('cookie-analytics')?.checked ?? true;
            saveCookieConsent({ essential: true, functional, analytics });
            document.getElementById('cookie-modal-overlay')?.remove();
            hideCookieBanner();
            showInfoBanner(currentLang === 'ru' ? '✅ Настройки cookie сохранены!' : '✅ Cookie settings saved!', 'success');
        }

        // Init cookie banner
        (function initCookies() {
            const consent = getCookieConsent();
            if (!consent) showCookieBanner();
        })();
        // ========== END COOKIE SYSTEM ==========
    </script>
</body>
</html>
